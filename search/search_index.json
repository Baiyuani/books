{"config":{"lang":["en","zh"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"Welcome","text":"<p>Only as a knowledge warehouse</p>"},{"location":"ansible/note/","title":"Note","text":"<p>\u91cd\u70b9</p>","tags":["automation","ansible","deployment"]},{"location":"ansible/note/#debug","title":"debug","text":"<pre><code>- name: \u67e5\u770b\u72b6\u6001\n  shell: docker info\n  register: docker \n- debug: var=docker.stdout_lines\n</code></pre>","tags":["automation","ansible","deployment"]},{"location":"ansible/note/#_1","title":"\u4fee\u6539\u4e3b\u673a\u5bc6\u7801","text":"<p>\u5bc6\u7801\u4e0d\u80fd\u4ee5\u660e\u6587\u4f20\u9012\uff0c\u6267\u884c\u524d\u9700\u8981\u52a0\u5bc6\uff01</p> <pre><code>ansible all -m user -a \"name=ubuntu shell=/bin/bash password=dify6S5vIW44 update_password=always\"\n</code></pre>","tags":["automation","ansible","deployment"]},{"location":"ansible/note/#shell","title":"shell","text":"<pre><code>ansible all -m shell -a 'echo Hello'\n\nansible -i inventory/localhost-inventory.ini all -m shell -a 'grep -q www.dachui.com /etc/hosts || echo \"192.168.182.21 www.dachui.com\" &gt;&gt; /etc/hosts; cat /etc/hosts'\n\nsed -i \"/www.dachui.com/a 192.168.182.21 www.dachui.com\" /etc/hosts || echo \"192.168.182.21 www.dachui.com\" &gt;&gt; /etc/hosts;cat /etc/hosts\nansible -i inventory/localhost-inventory.ini all -m shell -a 'sed -i \"/www.dachui.com/c 192.168.182.21 www.dachui.com\" /etc/hosts || echo \"192.168.182.21 www.dachui.com\" &gt;&gt; /etc/hosts;cat /etc/hosts'\n</code></pre>","tags":["automation","ansible","deployment"]},{"location":"ansible/note/#script","title":"script","text":"<pre><code>ansible all -m script -a \"run.sh\"\n</code></pre>","tags":["automation","ansible","deployment"]},{"location":"ansible/note/#hosts","title":"hosts","text":"<p>20240131 \u4ecek8s-playbooks\u7684hosts.j2\u4e2d\u79fb\u9664\uff0c</p> <pre><code>{% for host in groups['all'] %}\n{{ hostvars[host].ip | default(hostvars[host].ansible_default_ipv4.address) }} {{ hostvars[host].ansible_hostname }}\n{% endfor %}\n</code></pre>","tags":["automation","ansible","deployment"]},{"location":"cicd/docker_buildx/","title":"docker\u6784\u5efa\u591a\u67b6\u6784\u955c\u50cf","text":"<p>https://github.com/docker/buildx#manual-download</p>","tags":["docker","container"]},{"location":"cicd/docker_buildx/#_1","title":"\u521b\u5efa\u6784\u5efa\u5668","text":"<pre><code># \u521b\u5efa\u6784\u5efa\u5668\ndocker buildx create --name=multiarch --driver docker-container --use --bootstrap --platform linux/amd64,linux/386,linux/riscv64,linux/arm/v7,linux/arm/v6,linux/s390x,linux/ppc64le,linux/arm64\n\n# \u67e5\u770b\u6784\u5efa\u5668\ndocker buildx ls\n\n#\u5728\u955c\u50cf\u6784\u5efa\u65f6\u5982\u679c\u6ca1\u6709\u901a\u8fc7 --builder \u6307\u5b9a\u660e\u786e\u7684\u6784\u5efa\u5668\uff0c\u90a3\u4e48 buildx \u4f1a\u4f7f\u7528\u9ed8\u8ba4\u7684\u6784\u5efa\u5668\u3002\n\n# \u9ed8\u8ba4\u6784\u5efa\u5668 builder \u540d\u79f0\u540e\u4ee5 * \u6807\u8bb0\uff0c\u53ef\u4ee5\u901a\u8fc7 docker buildx use \u6765\u5207\u6362\u9ed8\u8ba4\u7684\u6784\u5efa\u5668\ndocker buildx use multiarch\n\n# \u901a\u8fc7 docker buildx inspect \u6765\u5355\u72ec\u67e5\u770b\u67d0\u4e00\u4e2a\u6307\u5b9a\u7684 builder \u6784\u5efa\u5668\u7684\u8be6\u7ec6\u4fe1\u606f\ndocker buildx inspect multiarch\n\n# \u6784\u5efa\u5668\u5728\u521b\u5efa\u6210\u529f\u540e\u72b6\u6001\u662f Status: inactive\uff0c \u9700\u8981\u901a\u8fc7 docker buildx inspect \u6dfb\u52a0 --bootstrap \u53c2\u6570\u6765\u542f\u52a8\u6784\u5efa\u5668\u540e\u624d\u80fd\u6b63\u5e38\u4f7f\u7528\u8be5\u6784\u5efa\u5668\u6784\u5efa\u955c\u50cf\u3002\n# docker buildx inspect --bootstrap --builder multiarch\n\n# \u5220\u9664\ndocker buildx rm multiarch\n</code></pre>","tags":["docker","container"]},{"location":"cicd/docker_buildx/#dockerfile","title":"\u4fee\u6539Dockerfile","text":"<pre><code>FROM  --platform=$TARGETPLATFORM golang AS builder\nARG TARGETPLATFORM\nARG BUILDPLATFORM\nWORKDIR /gobuild\nCOPY  get-cpu-os.go  .\nRUN go build get-cpu-os.go\n\nFROM --platform=$TARGETPLATFORM golang\nARG TARGETPLATFORM\nARG BUILDPLATFORM\nWORKDIR /gorun\nCOPY --from=builder /gobuild/get-cpu-os .\nCMD [\"./get-cpu-os\"]\n</code></pre>","tags":["docker","container"]},{"location":"cicd/docker_buildx/#_2","title":"\u5f00\u59cb\u6784\u5efa","text":"<pre><code># -t \u6307\u5b9a\u955c\u50cf\u5730\u5740\uff0c\u9700\u8981\u6307\u5b9a\u6b63\u786e\u7684registry+repo:tag\uff0c\u56e0\u4e3a\u6784\u5efa\u5b8c\u5c31\u8981\u63a8\u9001\u5230\u8fdc\u7a0b\u4ed3\u5e93\n# --push \u63a8\u9001\u5230\u8fdc\u7a0bregistry\ndocker buildx build --builder multiarch -t test:1 --platform linux/amd64,linux/arm64 --provenance=false --sbom=false --push .\n</code></pre>","tags":["docker","container"]},{"location":"cicd/docker_buildx/#buildxattestations","title":"\u9644\uff1a\u7981\u7528buildx\u7684attestations","text":"<pre><code># \u7b49\u540c\u4e8edocker manifest inspect\ndocker buildx imagetools inspect &lt;username&gt;/&lt;image&gt;:latest\n\n# \u8f93\u51fa\u5982\u4e0b\uff0c\u5305\u542bunknown\uff0c\u4f1a\u5f71\u54cd\u4e00\u4e9b\u955c\u50cf\u6784\u5efa\u5de5\u5177\u83b7\u53d6\u57fa\u7840\u955c\u50cf\u4fe1\u606f\nName:      oci.ketanyun.cn/open/openjdk:test\nMediaType: application/vnd.oci.image.index.v1+json\nDigest:    sha256:8c1ed60c573473130802d7bada0fb8ece18f580682801512dfa5f369575d39a7\n\nManifests:\n  Name:        oci.ketanyun.cn/open/openjdk:test@sha256:b906f0389fbb2a2ac098ec60da9ece830f5232d060aa109298264fd7f171a33c\n  MediaType:   application/vnd.oci.image.manifest.v1+json\n  Platform:    linux/amd64\n\n  Name:        oci.ketanyun.cn/open/openjdk:test@sha256:c242cd2a710b431245072a38698494e013f86efdc6f2dbb923b8932637826bf1\n  MediaType:   application/vnd.oci.image.manifest.v1+json\n  Platform:    linux/arm64\n\n  Name:        oci.ketanyun.cn/open/openjdk:test@sha256:aceebdd26e3cbe92610a19e85f21f043c22d4c2f907d8988cccb6dbcb08100d3\n  MediaType:   application/vnd.oci.image.manifest.v1+json\n  Platform:    unknown/unknown\n  Annotations:\n    vnd.docker.reference.digest: sha256:b906f0389fbb2a2ac098ec60da9ece830f5232d060aa109298264fd7f171a33c\n    vnd.docker.reference.type:   attestation-manifest\n\n  Name:        oci.ketanyun.cn/open/openjdk:test@sha256:344161645c61cf4ca9c4b36e438b626b12908e45916900d3bdddc4d170dbb7e4\n  MediaType:   application/vnd.oci.image.manifest.v1+json\n  Platform:    unknown/unknown\n  Annotations:\n    vnd.docker.reference.digest: sha256:c242cd2a710b431245072a38698494e013f86efdc6f2dbb923b8932637826bf1\n    vnd.docker.reference.type:   attestation-manifest\n</code></pre> <pre><code># \u901a\u8fc7\u5728build\u547d\u4ee4\u6dfb\u52a0\u4ee5\u4e0b\u53c2\u6570\u53ef\u89e3\u51b3\n--provenance=false --sbom=false\n\ndocker buildx build --builder multiarch -t test:1 --platform linux/amd64,linux/arm64 --provenance=false --sbom=false --push .\n</code></pre>","tags":["docker","container"]},{"location":"cicd/docker_buildx/#docker-desktopqemu","title":"\u5982\u679c\u6ca1\u6709\u4f7f\u7528docker desktop\uff0c\u5219\u9700\u8981\u624b\u52a8\u542f\u7528qemu","text":"<p>https://github.com/multiarch/qemu-user-static#getting-started</p> <pre><code>docker run --rm --privileged multiarch/qemu-user-static --reset -p yes\n</code></pre> <p>\u6216\u8005\u53c2\u8003docker\u5b98\u65b9\u6587\u6863\uff1ahttps://docs.docker.com/build/building/multi-platform/</p> <pre><code>docker run --privileged --rm tonistiigi/binfmt --install all\n</code></pre>","tags":["docker","container"]},{"location":"cicd/gradle/","title":"Gradle","text":"","tags":["ci/cd","gradle","java"]},{"location":"cicd/gradle/#gradle-plugin","title":"gradle plugin \u8bbe\u7f6e\u63d2\u4ef6\u4ed3\u5e93","text":"<p>\u7528\u4e8e\u89e3\u51b3\u9ed8\u8ba4\u4ed3\u5e93https://plugins.gradle.org/m2/\u56fd\u5185\u8bbf\u95ee\u7684\u7f51\u7edc\u95ee\u9898</p> <p>\u4fee\u6539\u9879\u76ee\u6839\u76ee\u5f55\u7684<code>settings.gradle</code></p> <pre><code>pluginManagement {\n  repositories {\n    maven {\n      url 'https://maven.aliyun.com/repository/public/'\n    }\n    maven {\n      url 'https://maven.aliyun.com/repository/spring/'\n    }    \n    maven {\n      url 'https://maven.aliyun.com/repository/spring-plugin/'\n    }\n    maven {\n      url 'https://maven.aliyun.com/repository/central/'\n    }\n    maven {\n      url 'https://maven.aliyun.com/repository/google/'\n    }\n    maven {\n      url 'https://maven.aliyun.com/repository/jcenter/'\n    }    \n    maven {\n      url 'https://maven.aliyun.com/repository/releases/'\n    }    \n    maven {\n      url 'https://maven.aliyun.com/repository/gradle-plugin/'\n    } \n    maven {\n      url 'https://maven.aliyun.com/repository/grails-core/'\n    }\n\n    mavenLocal()\n    mavenCentral()\n  }\n}\n</code></pre>","tags":["ci/cd","gradle","java"]},{"location":"cicd/shell_dockerfile/","title":"\u4f7f\u7528shell\u811a\u672c\u4f5c\u4e3a\u5bb9\u5668\u542f\u52a8\u547d\u4ee4","text":"<pre><code>FROM ...\n\n...\n\n# \u4f7f\u7528shell\u811a\u672c\u4f5c\u4e3a\u5bb9\u5668\u8fd0\u884c\u547d\u4ee4\u65f6\uff0c\u4e3b\u7a0b\u5e8f\u5e94\u4f7f\u7528exec\u6267\u884c\nENTRYPOINT [\"docker-entrypoint.sh\"] \n</code></pre> <pre><code># docker-entrypoint.sh\n#!/bin/bash\n...\n\n# \u4f7f\u7528exec \u6267\u884c\u547d\u4ee4\uff0c\u4f7f\u8be5\u547d\u4ee4\u7ee7\u627f\u5f53\u524dbash\u73af\u5883\u548cPID\u7b49\u3002\u8001\u7684bash\u5c06\u9000\u51fa\uff0c\u540c\u65f6exec\u8bed\u53e5\u4e4b\u540e\u7684\u4ee3\u7801\u4e5f\u4e0d\u4f1a\u88ab\u6267\u884c\n# \u8fd9\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u4f7fexec\u6267\u884c\u7684\u5b88\u62a4\u8fdb\u7a0b\u5728\u5bb9\u5668\u4e2d\u4f5c\u4e3a\u4e3b\u8fdb\u7a0b\u8fd0\u884c\uff0c\u5373PID=1\n# \u4f7f\u7a0b\u5e8f\u53ef\u4ee5\u6b63\u5e38\u63a5\u6536\u4fe1\u53f7\nexec \"$@\"\n</code></pre>","tags":["shell","docker"]},{"location":"cicd/shell_dockerfile/#other","title":"other","text":"<pre><code>#!/bin/bash -e\n#------\u4fee\u6539\u73af\u5883\u53d8\u91cf-------\nCONTAINER_ALREADY_STARTED=\"CONTAINER_ALREADY_STARTED_PLACEHOLDER\";\nif [ ! -e $CONTAINER_ALREADY_STARTED ]; then\n    touch $CONTAINER_ALREADY_STARTED;\n    echo \"-- First container startup --\";\n#    cat /usr/share/nginx/html/note/index.html;\n    # YOUR_JUST_ONCE_LOGIC_HERE\n    echo \"-- BUS_URL= $BUS_URL --\";\n    sed -i   \"s#BUS_URL#$BUS_URL#\"  /usr/share/nginx/html/note/index.html;\n    echo \"-- OAUTH_AUTHORITY_URL= $OAUTH_AUTHORITY_URL --\";\n    sed -i   \"s#OAUTH_AUTHORITY_URL#$OAUTH_AUTHORITY_URL#\"  /usr/share/nginx/html/note/index.html;\n    echo \"-- OAUTH_CLIENT_ID= $OAUTH_CLIENT_ID --\";\n    sed -i   \"s#OAUTH_CLIENT_ID#$OAUTH_CLIENT_ID#\"  /usr/share/nginx/html/note/index.html;\n    echo \"-- SSO_LOGOUT_URL= $SSO_LOGOUT_URL --\";\n    sed -i   \"s#SSO_LOGOUT_URL#$SSO_LOGOUT_URL#\"  /usr/share/nginx/html/note/index.html;\n    echo \"-- contextPath= $contextPath --\";\n    sed -i   \"s#contextPath#$contextPath#\"  /usr/share/nginx/html/note/index.html;\n\n#cat /usr/share/nginx/html/note/index.html;\nelse\n    echo \"-- Not first container startup --\"\nfi\n\n#------docker-entrypoint.sh \u9ed8\u8ba4--------\nfor hook in $(ls /startup-hooks); do\n  echo -n \"Found startup hook ${hook} ... \";\n  if [ -x \"/startup-hooks/${hook}\" ]; then\n    echo \"executing.\";\n    /startup-hooks/${hook};\n  else\n    echo 'not executable. Skipping.';\n  fi\ndone\n\n_quit () {\n  echo 'Caught sigquit, sending SIGQUIT to child';\n  kill -s QUIT $child;\n}\n\ntrap _quit SIGQUIT;\n\necho 'Starting child (nginx)';\nnginx -g 'daemon off;' &amp;\nchild=$!;\n\necho 'Waiting on child...';\nwait $child;\n</code></pre>","tags":["shell","docker"]},{"location":"go/build/","title":"Build","text":""},{"location":"go/build/#_1","title":"\u6784\u5efa\u65f6\u5d4c\u5165","text":"<pre><code>//\u5d4c\u5165\u6587\u4ef6\u6216\u6587\u4ef6\u5939\npackage main\n\nimport (\n    \"embed\"\n)\n\n//go:embed folder/single_file.txt\nvar fileString string\n\n//go:embed folder/single_file.txt\nvar fileByte []byte\n\n//go:embed folder/single_file.txt\n//go:embed folder/*.hash\nvar folder embed.FS\n\nfunc main() {\n\n    print(fileString)\n    print(string(fileByte))\n\n    content1, _ := folder.ReadFile(\"folder/file1.hash\")\n    print(string(content1))\n\n    content2, _ := folder.ReadFile(\"folder/file2.hash\")\n    print(string(content2))\n}\n</code></pre>"},{"location":"go/cli/","title":"Cli","text":""},{"location":"go/cli/#args","title":"\u547d\u4ee4\u884c\u53c2\u6570 Args","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"os\"\n)\n\nfunc main() {\n\n    argsWithProg := os.Args\n    argsWithoutProg := os.Args[1:]\n\n    arg := os.Args[3]\n\n    fmt.Println(argsWithProg)\n    fmt.Println(argsWithoutProg)\n    fmt.Println(arg)\n}\n</code></pre>"},{"location":"go/cli/#flag","title":"\u547d\u4ee4\u884c\u6807\u5fd7 flag","text":"<pre><code>package main\n\nimport (\n    \"flag\"\n    \"fmt\"\n)\n\nfunc main() {\n\n    wordPtr := flag.String(\"word\", \"foo\", \"a string\")\n\n    numbPtr := flag.Int(\"numb\", 42, \"an int\")\n    forkPtr := flag.Bool(\"fork\", false, \"a bool\")\n\n    var svar string\n    flag.StringVar(&amp;svar, \"svar\", \"bar\", \"a string var\")\n\n    flag.Parse()\n\n    fmt.Println(\"word:\", *wordPtr)\n    fmt.Println(\"numb:\", *numbPtr)\n    fmt.Println(\"fork:\", *forkPtr)\n    fmt.Println(\"svar:\", svar)\n    fmt.Println(\"tail:\", flag.Args())\n}\n</code></pre>"},{"location":"go/cli/#_1","title":"\u5b50\u547d\u4ee4","text":"<pre><code>package main\n\nimport (\n    \"flag\"\n    \"fmt\"\n    \"os\"\n)\n\nfunc main() {\n\n    fooCmd := flag.NewFlagSet(\"foo\", flag.ExitOnError)\n    fooEnable := fooCmd.Bool(\"enable\", false, \"enable\")\n    fooName := fooCmd.String(\"name\", \"\", \"name\")\n\n    barCmd := flag.NewFlagSet(\"bar\", flag.ExitOnError)\n    barLevel := barCmd.Int(\"level\", 0, \"level\")\n\n    if len(os.Args) &lt; 2 {\n        fmt.Println(\"expected 'foo' or 'bar' subcommands\")\n        os.Exit(1)\n    }\n\n    switch os.Args[1] {\n\n    case \"foo\":\n        fooCmd.Parse(os.Args[2:])\n        fmt.Println(\"subcommand 'foo'\")\n        fmt.Println(\"  enable:\", *fooEnable)\n        fmt.Println(\"  name:\", *fooName)\n        fmt.Println(\"  tail:\", fooCmd.Args())\n    case \"bar\":\n        barCmd.Parse(os.Args[2:])\n        fmt.Println(\"subcommand 'bar'\")\n        fmt.Println(\"  level:\", *barLevel)\n        fmt.Println(\"  tail:\", barCmd.Args())\n    default:\n        fmt.Println(\"expected 'foo' or 'bar' subcommands\")\n        os.Exit(1)\n    }\n}\n</code></pre>"},{"location":"go/error/","title":"Error","text":""},{"location":"go/error/#_1","title":"\u9519\u8bef\u5904\u7406","text":"<p>Go \u7a0b\u5e8f\u4f7f\u7528 error \u503c\u6765\u8868\u793a\u9519\u8bef\u72b6\u6001\u3002</p> <p>\u4e0e fmt.Stringer \u7c7b\u4f3c\uff0cerror \u7c7b\u578b\u662f\u4e00\u4e2a\u5185\u5efa\u63a5\u53e3\uff1a</p> <pre><code>type error interface {\n    Error() string\n}\n</code></pre> <p>Info</p> <p>\u4e0e fmt.Stringer \u7c7b\u4f3c\uff0cfmt \u5305\u5728\u6253\u5370\u503c\u65f6\u4e5f\u4f1a\u6ee1\u8db3 error\u3002</p> <p>\u901a\u5e38\u51fd\u6570\u4f1a\u8fd4\u56de\u4e00\u4e2a error \u503c\uff0c\u8c03\u7528\u7684\u5b83\u7684\u4ee3\u7801\u5e94\u5f53\u5224\u65ad\u8fd9\u4e2a\u9519\u8bef\u662f\u5426\u7b49\u4e8e nil \u6765\u8fdb\u884c\u9519\u8bef\u5904\u7406\u3002</p> <pre><code>i, err := strconv.Atoi(\"42\")\nif err != nil {\n    fmt.Printf(\"couldn't convert number: %v\\n\", err)\n    return\n}\nfmt.Println(\"Converted integer:\", i)\n</code></pre> <p>error \u4e3a nil \u65f6\u8868\u793a\u6210\u529f\uff1b\u975e nil \u7684 error \u8868\u793a\u5931\u8d25\u3002</p> <pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\ntype MyError struct {\n    When time.Time\n    What string\n}\n\nfunc (e *MyError) Error() string {\n    return fmt.Sprintf(\"at %v, %s\",\n        e.When, e.What)\n}\n\nfunc run() error {\n    return &amp;MyError{\n        time.Now(),\n        \"it didn't work\",\n    }\n}\n\nfunc main() {\n    if err := run(); err != nil {\n        fmt.Println(err)\n    }\n}\n</code></pre> <p>example: </p> <pre><code>package main\n\nimport (\n    \"errors\"\n    \"fmt\"\n)\n\nfunc f1(arg int) (int, error) {\n    if arg == 42 {\n\n        return -1, errors.New(\"can't work with 42\")\n\n    }\n\n    return arg + 3, nil\n}\n\ntype argError struct {\n    arg  int\n    prob string\n}\n\nfunc (e *argError) Error() string {\n    return fmt.Sprintf(\"%d - %s\", e.arg, e.prob)\n}\n\nfunc f2(arg int) (int, error) {\n    if arg == 42 {\n\n        return -1, &amp;argError{arg, \"can't work with it\"}\n    }\n    return arg + 3, nil\n}\n\nfunc main() {\n\n    for _, i := range []int{7, 42} {\n        if r, e := f1(i); e != nil {\n            fmt.Println(\"f1 failed:\", e)\n        } else {\n            fmt.Println(\"f1 worked:\", r)\n        }\n    }\n    for _, i := range []int{7, 42} {\n        if r, e := f2(i); e != nil {\n            fmt.Println(\"f2 failed:\", e)\n        } else {\n            fmt.Println(\"f2 worked:\", r)\n        }\n    }\n\n    _, e := f2(42)\n    if ae, ok := e.(*argError); ok {\n        fmt.Println(ae.arg)\n        fmt.Println(ae.prob)\n    }\n}\n</code></pre>"},{"location":"go/error/#panic","title":"panic\u6050\u614c","text":"<pre><code>package main\n\nimport \"os\"\n\nfunc main() {\n\n    panic(\"a problem\")  //\u76f4\u63a5\u89e6\u53d1\u6050\u614c\uff0c\u4ee3\u7801\u5c06\u5728\u8fd9\u91cc\u9000\u51fa\uff0c\u540e\u7eed\u4ee3\u7801\u4e0d\u4f1a\u88ab\u6267\u884c\n\n    _, err := os.Create(\"/tmp/file\")\n    if err != nil {\n        panic(err)\n    }\n}\n</code></pre>"},{"location":"go/error/#recover","title":"\u6062\u590drecover","text":"<p>recover\u53ef\u4ee5\u963b\u6b62panic\u4e2d\u6b62\u7a0b\u5e8f\uff0c\u5e76\u7ee7\u7eed\u6267\u884c</p> <pre><code>package main\n\nimport \"fmt\"\n\nfunc mayPanic() {\n    panic(\"a problem\")\n}\n\nfunc main() {\n\n    defer func() {\n        if r := recover(); r != nil {\n\n            fmt.Println(\"Recovered. Error:\\n\", r)\n        }\n    }()\n\n    mayPanic()\n\n    fmt.Println(\"After mayPanic()\")\n}\n</code></pre>"},{"location":"go/http/","title":"Http","text":""},{"location":"go/http/#http-client","title":"http client","text":"<pre><code>package main\n\nimport (\n    \"bufio\"\n    \"fmt\"\n    \"net/http\"\n)\n\nfunc main() {\n\n    resp, err := http.Get(\"https://gobyexample.com\")\n    if err != nil {\n        panic(err)\n    }\n    defer resp.Body.Close()\n\n    fmt.Println(\"Response status:\", resp.Status)\n\n    scanner := bufio.NewScanner(resp.Body)\n    for i := 0; scanner.Scan() &amp;&amp; i &lt; 5; i++ {\n        fmt.Println(scanner.Text())\n    }\n\n    if err := scanner.Err(); err != nil {\n        panic(err)\n    }\n}\n</code></pre>"},{"location":"go/http/#http-server","title":"http server","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"net/http\"\n)\n\nfunc hello(w http.ResponseWriter, req *http.Request) {\n\n    fmt.Fprintf(w, \"hello\\n\")\n}\n\nfunc headers(w http.ResponseWriter, req *http.Request) {\n\n    for name, headers := range req.Header {\n        for _, h := range headers {\n            fmt.Fprintf(w, \"%v: %v\\n\", name, h)\n        }\n    }\n}\n\nfunc main() {\n\n    http.HandleFunc(\"/hello\", hello)\n    http.HandleFunc(\"/headers\", headers)\n\n    http.ListenAndServe(\":8090\", nil)\n}\n</code></pre>"},{"location":"go/json/","title":"Json","text":""},{"location":"go/json/#json","title":"json","text":"<p>https://go.dev/blog/json</p> <p>example</p> json.go <pre><code>package main\n\nimport (\n    \"encoding/json\"\n    \"fmt\"\n    \"os\"\n)\n\ntype response1 struct {\n    Page   int\n    Fruits []string\n}\n\ntype response2 struct {\n    Page   int      `json:\"page\"`\n    Fruits []string `json:\"fruits\"`\n}\n\nfunc main() {\n\n    bolB, _ := json.Marshal(true)\n    fmt.Println(string(bolB))\n\n    intB, _ := json.Marshal(1)\n    fmt.Println(string(intB))\n\n    fltB, _ := json.Marshal(2.34)\n    fmt.Println(string(fltB))\n\n    strB, _ := json.Marshal(\"gopher\")\n    fmt.Println(string(strB))\n\n    slcD := []string{\"apple\", \"peach\", \"pear\"}\n    slcB, _ := json.Marshal(slcD)\n    fmt.Println(string(slcB))\n\n    mapD := map[string]int{\"apple\": 5, \"lettuce\": 7}\n    mapB, _ := json.Marshal(mapD)\n    fmt.Println(string(mapB))\n\n    res1D := &amp;response1{\n        Page:   1,\n        Fruits: []string{\"apple\", \"peach\", \"pear\"}}\n    res1B, _ := json.Marshal(res1D)\n    fmt.Println(string(res1B))\n\n    res2D := &amp;response2{\n        Page:   1,\n        Fruits: []string{\"apple\", \"peach\", \"pear\"}}\n    res2B, _ := json.Marshal(res2D)\n    fmt.Println(string(res2B))\n\n    byt := []byte(`{\"num\":6.13,\"strs\":[\"a\",\"b\"]}`)\n\n    var dat map[string]interface{}\n\n    if err := json.Unmarshal(byt, &amp;dat); err != nil {\n        panic(err)\n    }\n    fmt.Println(dat)\n\n    num := dat[\"num\"].(float64)\n    fmt.Println(num)\n\n    strs := dat[\"strs\"].([]interface{})\n    str1 := strs[0].(string)\n    fmt.Println(str1)\n\n    str := `{\"page\": 1, \"fruits\": [\"apple\", \"peach\"]}`\n    res := response2{}\n    json.Unmarshal([]byte(str), &amp;res)\n    fmt.Println(res)\n    fmt.Println(res.Fruits[0])\n\n    enc := json.NewEncoder(os.Stdout)\n    d := map[string]int{\"apple\": 5, \"lettuce\": 7}\n    enc.Encode(d)\n}\n</code></pre>"},{"location":"go/json/#_1","title":"\u7ed3\u6784\u4f53\u6807\u7b7e","text":"<p>\u7ed3\u6784\u4f53\u6807\u7b7e\uff08\u4f8b\u5982 json:\"artist\"\uff09\u6307\u5b9a\u5f53\u7ed3\u6784\u4f53\u7684\u5185\u5bb9\u5e8f\u5217\u5316\u4e3a JSON \u65f6\u5b57\u6bb5\u7684\u540d\u79f0\u5e94\u8be5\u662f\u4ec0\u4e48\u3002\u5982\u679c\u6ca1\u6709\u5b83\u4eec\uff0cJSON \u5c06\u4f7f\u7528\u7ed3\u6784\u4f53\u7684\u5927\u5199\u5b57\u6bb5\u540d\u79f0\u2014\u2014\u8fd9\u79cd\u98ce\u683c\u5728 JSON \u4e2d\u5e76\u4e0d\u5e38\u89c1\u3002</p> <pre><code>// album represents data about a record album.\ntype album struct {\n    ID     string  `json:\"id\"`\n    Title  string  `json:\"title\"`\n    Artist string  `json:\"artist\"`\n    Price  float64 `json:\"price\"`\n}\n</code></pre>"},{"location":"go/note/","title":"Note","text":"","tags":["go","dev"]},{"location":"go/note/#linux","title":"\u521d\u59cb\u5316\u9879\u76eelinux","text":"<pre><code>curl -O https://dl.google.com/go/go1.21.6.linux-amd64.tar.gz\n\nrm -rf /usr/local/go &amp;&amp; sudo tar -C /usr/local -xzf go1.21.6.linux-amd64.tar.gz\n\n# \u8bbe\u7f6ego\u73af\u5883\u53d8\u91cf\nsudo tee /etc/profile.d/go.sh &lt;&lt; 'EOF'\nexport GOROOT=/usr/local/go\nexport PATH=$PATH:/usr/local/go/bin\nEOF\n# \u8bbe\u7f6e\u4ee3\u7406\nsudo tee /etc/profile.d/custom_proxy.sh &lt;&lt; 'EOF'\nexport no_proxy=127.0.0.1,192.168.*,172.31.*,172.30.*,172.29.*,172.28.*,172.27.*,172.26.*,172.25.*,172.24.*,172.23.*,172.22.*,172.21.*,172.20.*,172.19.*,172.18.*,172.17.*,172.16.*,10.*,127.*,localhost,$(awk -F[\\#] '{print $1}' /etc/hosts | sed -r /^$/d | awk '{res=res$2\",\"}END{print res}')\nexport NO_PROXY=127.0.0.1,192.168.*,172.31.*,172.30.*,172.29.*,172.28.*,172.27.*,172.26.*,172.25.*,172.24.*,172.23.*,172.22.*,172.21.*,172.20.*,172.19.*,172.18.*,172.17.*,172.16.*,10.*,127.*,localhost,$(awk -F[\\#] '{print $1}' /etc/hosts | sed -r /^$/d | awk '{res=res$2\",\"}END{print res}')\nexport HTTPS_PROXY=http://192.168.182.1:29998\nexport https_proxy=http://192.168.182.1:29998\nexport HTTP_PROXY=http://192.168.182.1:29998\nexport http_proxy=http://192.168.182.1:29998\nEOF\n\ngo version\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#windows","title":"\u521d\u59cb\u5316\u9879\u76eewindows","text":"<pre><code>mkdir xxx\ncd xxx\n\n# \u751f\u6210go.mod\u6587\u4ef6\uff0c\u547d\u540d\u9879\u76ee\ngo mod init xxx\n\n# \u5c06\u9879\u76ee\u4e2d\u5e94\u7528\u7684\u5305\u4e0b\u8f7d\u5230\u672c\u5730\uff0c\u5e76\u751f\u6210go.sum\u7528\u4e8e\u9a8c\u8bc1\uff0c\u5e76\u66f4\u65b0go.mod\u3002\u81ea\u52a8\u68c0\u67e5\u5f53\u524d\u6a21\u5757\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u5e76\u79fb\u9664\u4e0d\u9700\u8981\u7684\u4f9d\u8d56\u9879\ngo mod tidy\n\n# \u7528\u4e8e\u66f4\u65b0\u6307\u5b9a\u7684\u5305\u53ca\u5176\u6240\u6709\u4f9d\u8d56\u5305\u5230\u6700\u65b0\u7248\u672c\uff0c\u5e76\u91cd\u65b0\u7f16\u8bd1\u5b89\u88c5\u5b83\u4eec\ngo get .\n\n# \u8fd0\u884cgo\u811a\u672c\ngo run helloworld.go\n\n# \u5c06\u7a0b\u5e8f\u6253\u5305\u4e3a\u53ef\u6267\u884c\u6587\u4ef6\ngo build helloworld.go\n\n# go install \u547d\u4ee4\u6784\u5efa\u5e76\u5b89\u88c5\u7531\u547d\u4ee4\u884c\u4e0a\u7684\u8def\u5f84\u547d\u540d\u7684\u5305\u3002 \n# \u53ef\u6267\u884c\u6587\u4ef6\uff08\u4e3b\u8981\u5305\uff09\u5b89\u88c5\u5230\u7531 GOBIN \u73af\u5883\u53d8\u91cf\u547d\u540d\u7684\u76ee\u5f55\uff0c\n# \u5982\u679c\u672a\u8bbe\u7f6e GOPATH \u73af\u5883\u53d8\u91cf\uff0c\u5219\u9ed8\u8ba4\u4e3a $GOPATH/bin \u6216 $HOME/go/bin\u3002 \n# $GOROOT \u4e2d\u7684\u53ef\u6267\u884c\u6587\u4ef6\u5b89\u88c5\u5728 $GOROOT/bin \u6216 $GOTOOLDIR \u800c\u4e0d\u662f $GOBIN\u3002 \n# \u6784\u5efa\u548c\u7f13\u5b58\u975e\u53ef\u6267\u884c\u5305\u4f46\u4e0d\u5b89\u88c5\u3002\ngo install golang.org/x/tools/gopls@latest\n\n# vscode ctrl+shift+P \ngo:install/update tools\n# \u7136\u540e\u52fe\u9009\u6240\u6709\uff0c\u5b89\u88c5\n\n# \u4fee\u6539go\u73af\u5883\u53d8\u91cf\ngo env -w GOBIN=/path/to/your/bin\n# go env -w GOBIN=C:\\path\\to\\your\\bin\n</code></pre> <pre><code>\u5de6\u5927\u62ec\u53f7\u4e0d\u80fd\u5728\u884c\u9996\u3002\n\u7a0b\u5e8f\u4ece main \u5305\u5f00\u59cb\u8fd0\u884c\u3002\n\u6309\u7167\u7ea6\u5b9a\uff0c\u5305\u540d\u4e0e\u5bfc\u5165\u8def\u5f84\u7684\u6700\u540e\u4e00\u4e2a\u5143\u7d20\u4e00\u81f4\u3002\u4f8b\u5982\uff0c\"math/rand\" \u5305\u4e2d\u7684\u6e90\u7801\u5747\u4ee5 package rand \u8bed\u53e5\u5f00\u59cb\u3002\n\u5728 Go \u4e2d\uff0c\u5982\u679c\u4e00\u4e2a\u540d\u5b57\u4ee5\u5927\u5199\u5b57\u6bcd\u5f00\u5934\uff0c\u90a3\u4e48\u5b83\u5c31\u662f\u5df2\u5bfc\u51fa\u7684\u3002\u4f8b\u5982\uff0cPizza \u5c31\u662f\u4e2a\u5df2\u5bfc\u51fa\u540d\uff0cPi \u4e5f\u540c\u6837\uff0c\u5b83\u5bfc\u51fa\u81ea math \u5305\u3002pizza \u548c pi \u5e76\u672a\u4ee5\u5927\u5199\u5b57\u6bcd\u5f00\u5934\uff0c\u6240\u4ee5\u5b83\u4eec\u662f\u672a\u5bfc\u51fa\u7684\u3002\u5728\u5bfc\u5165\u4e00\u4e2a\u5305\u65f6\uff0c\u4f60\u53ea\u80fd\u5f15\u7528\u5176\u4e2d\u5df2\u5bfc\u51fa\u7684\u540d\u5b57\u3002\u4efb\u4f55\u201c\u672a\u5bfc\u51fa\u201d\u7684\u540d\u5b57\u5728\u8be5\u5305\u5916\u5747\u65e0\u6cd5\u8bbf\u95ee\u3002\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#_1","title":"\u5305\u7ba1\u7406","text":"<pre><code># \u67e5\u770b\u6240\u6709\u53ef\u66f4\u65b0\u7684\u4f9d\u8d56\ngo list -m -u all\n\n# \u66f4\u65b0\u6240\u6709\u4f9d\u8d56\ngo get -u ./...\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#_2","title":"\u5355\u884c\u6ce8\u91ca","text":"<pre><code>// This is a comment\npackage main\nimport (\"fmt\")\n\nfunc main() {\n  // This is a comment\n  fmt.Println(\"Hello World!\")\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#_3","title":"\u591a\u884c\u6ce8\u91ca","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  /* The code below will print Hello World\n  to the screen, and it is amazing */\n  fmt.Println(\"Hello World!\")\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#_4","title":"\u8f93\u51fa","text":"<pre><code>//Println() \u51fd\u6570\u7c7b\u4f3c\u4e8e Print() \uff0c\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\u53c2\u6570\u4e4b\u95f4\u6dfb\u52a0\u4e86\u4e00\u4e2a\u7a7a\u683c\uff0c\u6700\u540e\u6dfb\u52a0\u4e86\u4e00\u4e2a\u6362\u884c\u7b26\npackage main\nimport (\"fmt\")\n\nfunc main() {\n  var i,j string = \"Hello\",\"World\"\n\n  fmt.Println(i,j)\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#printfhttpswwww3schoolscomgogo_formatting_verbsphp","title":"printf\u7684\u683c\u5f0f\u5316\u64cd\u4f5c\u8868(https://www.w3schools.com/go/go_formatting_verbs.php)","text":"<pre><code>//Printf() \u51fd\u6570\u9996\u5148\u6839\u636e\u7ed9\u5b9a\u7684\u683c\u5f0f\u5316\u52a8\u8bcd\u683c\u5f0f\u5316\u5176\u53c2\u6570\uff0c\u7136\u540e\u6253\u5370\n// %v   Prints the value in the default format\n// %#v  Prints the value in Go-syntax format\n// %T   Prints the type of the value\n// %%   Prints the % sign\npackage main\nimport (\"fmt\")\n\nfunc main() {\n  var i string = \"Hello\"\n  var j int = 15\n\n  fmt.Printf(\"i has value: %v and type: %T\\n\", i, i)\n  fmt.Printf(\"j has value: %v and type: %T\", j, j)\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#url","title":"url\u89e3\u6790","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"net\"\n    \"net/url\"\n)\n\nfunc main() {\n\n    s := \"postgres://user:pass@host.com:5432/path?k=v#f\"\n\n    u, err := url.Parse(s)\n    if err != nil {\n        panic(err)\n    }\n\n    fmt.Println(u.Scheme)\n\n    fmt.Println(u.User)\n    fmt.Println(u.User.Username())\n    p, _ := u.User.Password()\n    fmt.Println(p)\n\n    fmt.Println(u.Host)\n    host, port, _ := net.SplitHostPort(u.Host)\n    fmt.Println(host)\n    fmt.Println(port)\n\n    fmt.Println(u.Path)\n    fmt.Println(u.Fragment)\n\n    fmt.Println(u.RawQuery)\n    m, _ := url.ParseQuery(u.RawQuery)\n    fmt.Println(m)\n    fmt.Println(m[\"k\"][0])\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#xml","title":"xml","text":"","tags":["go","dev"]},{"location":"go/note/#_5","title":"\u968f\u673a\u6570","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"math/rand\"\n    \"time\"\n)\n\nfunc main() {\n\n    fmt.Print(rand.Intn(100), \",\")\n    fmt.Print(rand.Intn(100))\n    fmt.Println()\n\n    fmt.Println(rand.Float64())\n\n    fmt.Print((rand.Float64()*5)+5, \",\")\n    fmt.Print((rand.Float64() * 5) + 5)\n    fmt.Println()\n\n    s1 := rand.NewSource(time.Now().UnixNano())\n    r1 := rand.New(s1)\n\n    fmt.Print(r1.Intn(100), \",\")\n    fmt.Print(r1.Intn(100))\n    fmt.Println()\n\n    s2 := rand.NewSource(42)\n    r2 := rand.New(s2)\n    fmt.Print(r2.Intn(100), \",\")\n    fmt.Print(r2.Intn(100))\n    fmt.Println()\n    s3 := rand.NewSource(42)\n    r3 := rand.New(s3)\n    fmt.Print(r3.Intn(100), \",\")\n    fmt.Print(r3.Intn(100))\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#_6","title":"\u4ece\u5b57\u7b26\u4e32\u4e2d\u89e3\u6790\u6570\u5b57","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"strconv\"\n)\n\nfunc main() {\n\n    f, _ := strconv.ParseFloat(\"1.234\", 64)\n    fmt.Println(f)\n\n    i, _ := strconv.ParseInt(\"123\", 0, 64)\n    fmt.Println(i)\n\n    d, _ := strconv.ParseInt(\"0x1c8\", 0, 64)\n    fmt.Println(d)\n\n    u, _ := strconv.ParseUint(\"789\", 0, 64)\n    fmt.Println(u)\n\n    k, _ := strconv.Atoi(\"135\")\n    fmt.Println(k)\n\n    _, e := strconv.Atoi(\"wat\")\n    fmt.Println(e)\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#sha256","title":"sha256","text":"<pre><code>package main\n\nimport (\n    \"crypto/sha256\"\n    \"fmt\"\n)\n\nfunc main() {\n    s := \"sha256 this string\"\n\n    h := sha256.New()\n\n    h.Write([]byte(s))\n\n    bs := h.Sum(nil)\n\n    fmt.Println(s)\n    fmt.Printf(\"%x\\n\", bs)\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#base64","title":"base64","text":"<pre><code>package main\n\nimport (\n    b64 \"encoding/base64\"\n    \"fmt\"\n)\n\nfunc main() {\n\n    data := \"abc123!?$*&amp;()'-=@~\"\n\n    sEnc := b64.StdEncoding.EncodeToString([]byte(data))\n    fmt.Println(sEnc)\n\n    sDec, _ := b64.StdEncoding.DecodeString(sEnc)\n    fmt.Println(string(sDec))\n    fmt.Println()\n\n    uEnc := b64.URLEncoding.EncodeToString([]byte(data))\n    fmt.Println(uEnc)\n    uDec, _ := b64.URLEncoding.DecodeString(uEnc)\n    fmt.Println(string(uDec))\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#line-filters","title":"Line Filters","text":"<pre><code>package main\n\nimport (\n    \"bufio\"\n    \"fmt\"\n    \"os\"\n    \"strings\"\n)\n\nfunc main() {\n\n    scanner := bufio.NewScanner(os.Stdin)\n\n    for scanner.Scan() {\n\n        ucl := strings.ToUpper(scanner.Text())\n\n        fmt.Println(ucl)\n    }\n\n    if err := scanner.Err(); err != nil {\n        fmt.Fprintln(os.Stderr, \"error:\", err)\n        os.Exit(1)\n    }\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#_7","title":"\u83b7\u53d6\u73af\u5883\u53d8\u91cf","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"os\"\n    \"strings\"\n)\n\nfunc main() {\n\n    os.Setenv(\"FOO\", \"1\")\n    fmt.Println(\"FOO:\", os.Getenv(\"FOO\"))\n    fmt.Println(\"BAR:\", os.Getenv(\"BAR\"))\n\n    fmt.Println()\n    for _, e := range os.Environ() {\n        pair := strings.SplitN(e, \"=\", 2)\n        fmt.Println(pair[0])\n    }\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#_8","title":"\u8c03\u7528\u5176\u4ed6\u7a0b\u5e8f","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"io\"\n    \"os/exec\"\n)\n\nfunc main() {\n\n    dateCmd := exec.Command(\"date\")\n\n    dateOut, err := dateCmd.Output()\n    if err != nil {\n        panic(err)\n    }\n    fmt.Println(\"&gt; date\")\n    fmt.Println(string(dateOut))\n\n    _, err = exec.Command(\"date\", \"-x\").Output()\n    if err != nil {\n        switch e := err.(type) {\n        case *exec.Error:\n            fmt.Println(\"failed executing:\", err)\n        case *exec.ExitError:\n            fmt.Println(\"command exit rc =\", e.ExitCode())\n        default:\n            panic(err)\n        }\n    }\n\n    grepCmd := exec.Command(\"grep\", \"hello\")\n\n    grepIn, _ := grepCmd.StdinPipe()\n    grepOut, _ := grepCmd.StdoutPipe()\n    grepCmd.Start()\n    grepIn.Write([]byte(\"hello grep\\ngoodbye grep\"))\n    grepIn.Close()\n    grepBytes, _ := io.ReadAll(grepOut)\n    grepCmd.Wait()\n\n    fmt.Println(\"&gt; grep hello\")\n    fmt.Println(string(grepBytes))\n\n    lsCmd := exec.Command(\"bash\", \"-c\", \"ls -a -l -h\")\n    lsOut, err := lsCmd.Output()\n    if err != nil {\n        panic(err)\n    }\n    fmt.Println(\"&gt; ls -a -l -h\")\n    fmt.Println(string(lsOut))\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#go","title":"\u8c03\u7528\u5176\u4ed6\u7a0b\u5e8f\uff0c\u5b8c\u5168\u66ff\u6362GO\u8fdb\u7a0b","text":"<pre><code>package main\n\nimport (\n    \"os\"\n    \"os/exec\"\n    \"syscall\"\n)\n\nfunc main() {\n\n    binary, lookErr := exec.LookPath(\"ls\")\n    if lookErr != nil {\n        panic(lookErr)\n    }\n\n    args := []string{\"ls\", \"-a\", \"-l\", \"-h\"}\n\n    env := os.Environ()\n\n    execErr := syscall.Exec(binary, args, env)\n    if execErr != nil {\n        panic(execErr)\n    }\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#signal","title":"signal","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"os\"\n    \"os/signal\"\n    \"syscall\"\n)\n\nfunc main() {\n\n    sigs := make(chan os.Signal, 1)\n\n    signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM)\n\n    done := make(chan bool, 1)\n\n    go func() {\n\n        sig := &lt;-sigs\n        fmt.Println()\n        fmt.Println(sig)\n        done &lt;- true\n    }()\n\n    fmt.Println(\"awaiting signal\")\n    &lt;-done\n    fmt.Println(\"exiting\")\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#exit","title":"exit","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"os\"\n)\n\nfunc main() {\n    //\u4f7f\u7528 os.Exit \u65f6\u4e0d\u4f1a\u8fd0\u884c defer\n    defer fmt.Println(\"!\")\n\n    os.Exit(3)\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/note/#_9","title":"\u8bfb\u53d6\u73af\u5883\u53d8\u91cf","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"os\"\n)\n\nfunc imageForMemcached() (string, error) {\n    var imageEnvVar = \"MEMCACHED_IMAGE\"\n    image, found := os.LookupEnv(imageEnvVar)\n    if !found {\n        return \"\", fmt.Errorf(\"Unable to find %s environment variable with the image\", imageEnvVar)\n    }\n    return image, nil\n}\n\nfunc main() {\n    i, err := imageForMemcached()\n    if err != nil {\n        fmt.Println(err)\n    } else {\n        fmt.Println(i)\n    }\n}\n</code></pre>","tags":["go","dev"]},{"location":"go/%E4%B8%AD%E6%96%AD/","title":"\u4e2d\u65ad","text":""},{"location":"go/%E4%B8%AD%E6%96%AD/#context","title":"Context","text":"<p>Context \u8de8 API \u8fb9\u754c\u548c goroutine \u643a\u5e26\u622a\u6b62\u65e5\u671f\u3001\u53d6\u6d88\u4fe1\u53f7\u548c\u5176\u4ed6\u8bf7\u6c42\u8303\u56f4\u7684\u503c</p> <pre><code>package main\n\nimport (\n    \"fmt\"\n    \"net/http\"\n    \"time\"\n)\n\nfunc hello(w http.ResponseWriter, req *http.Request) {\n\n    ctx := req.Context()\n    fmt.Println(\"server: hello handler started\")\n    defer fmt.Println(\"server: hello handler ended\")\n\n    select {\n    case &lt;-time.After(10 * time.Second):\n        fmt.Fprintf(w, \"hello\\n\")\n    case &lt;-ctx.Done():\n\n        err := ctx.Err()\n        fmt.Println(\"server:\", err)\n        internalError := http.StatusInternalServerError\n        http.Error(w, err.Error(), internalError)\n    }\n}\n\nfunc main() {\n\n    http.HandleFunc(\"/hello\", hello)\n    http.ListenAndServe(\":8090\", nil)\n}\n</code></pre> <pre><code>$ go run context-in-http-servers.go &amp;\n\n\n$ curl localhost:8090/hello\nserver: hello handler started\n^C\nserver: context canceled\nserver: hello handler ended\n</code></pre>"},{"location":"go/%E5%87%BD%E6%95%B0/","title":"\u51fd\u6570","text":""},{"location":"go/%E5%87%BD%E6%95%B0/#_1","title":"\u5b9a\u4e49\u4e00\u4e2a\u51fd\u6570","text":"<pre><code>func FunctionName() {\n  // code to be executed\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc myMessage() {\n  fmt.Println(\"I just got executed!\")\n}\n\nfunc main() {\n  myMessage() // call the function\n}\n</code></pre>"},{"location":"go/%E5%87%BD%E6%95%B0/#_2","title":"\u4f20\u9012\u53c2\u6570","text":"<pre><code>func FunctionName(param1 type, param2 type, param3 type) {\n  // code to be executed\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc familyName(fname string) {\n  fmt.Println(\"Hello\", fname, \"Refsnes\")\n}\n\nfunc main() {\n  familyName(\"Liam\")\n  familyName(\"Jenny\")\n  familyName(\"Anja\")\n}\n</code></pre>"},{"location":"go/%E5%87%BD%E6%95%B0/#return","title":"return","text":"<pre><code>func FunctionName(param1 type, param2 type) type {\n  // code to be executed\n  return output\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc myFunction(x int, y int) int {\n  return x + y\n}\n\nfunc main() {\n  fmt.Println(myFunction(1, 2))\n}\n</code></pre>"},{"location":"go/%E5%87%BD%E6%95%B0/#_3","title":"\u4e3a\u8fd4\u56de\u503c\u547d\u540d","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc myFunction(x int, y int) (result int) {\n  result = x + y\n  return\n}\n\nfunc main() {\n  fmt.Println(myFunction(1, 2))\n}\n</code></pre> <pre><code>//\u4e5f\u53ef\u4ee5\u8fd9\u6837\u5199\npackage main\nimport (\"fmt\")\n\nfunc myFunction(x int, y int) (result int) {\n  result = x + y\n  return result\n}\n\nfunc main() {\n  fmt.Println(myFunction(1, 2))\n}\n</code></pre>"},{"location":"go/%E5%87%BD%E6%95%B0/#_4","title":"\u5c06\u8fd4\u56de\u503c\u5b58\u50a8\u5728\u53d8\u91cf\u4e2d","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc myFunction(x, y int) (result int) {\n  result = x + y\n  return\n}\n\nfunc main() {\n  total := myFunction(1, 2)\n  fmt.Println(total)\n}\n</code></pre>"},{"location":"go/%E5%87%BD%E6%95%B0/#_5","title":"\u591a\u4e2a\u8fd4\u56de\u503c","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc myFunction(x int, y string) (result int, txt1 string) {\n  result = x + x\n  txt1 = y + \" World!\"\n  return\n}\n\nfunc main() {\n  a, b := myFunction(5, \"Hello\")\n  fmt.Println(a, b)\n}\n</code></pre> <pre><code>//\u5982\u679c\u4e0d\u60f3\u4f7f\u7528\u67d0\u4e9b\u8fd4\u56de\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a\u4e0b\u5212\u7ebf (_)\uff0c\u4ee5\u7701\u7565\u8be5\u503c\npackage main\nimport (\"fmt\")\n\nfunc myFunction(x int, y string) (result int, txt1 string) {\n  result = x + x\n  txt1 = y + \" World!\"\n  return\n}\n\nfunc main() {\n   _, b := myFunction(5, \"Hello\")\n  fmt.Println(b)\n}\n</code></pre>"},{"location":"go/%E5%87%BD%E6%95%B0/#defer","title":"defer","text":"<pre><code>//defer \u8bed\u53e5\u4f1a\u5c06\u51fd\u6570\u63a8\u8fdf\u5230\u5916\u5c42\u51fd\u6570\u8fd4\u56de\u4e4b\u540e\u6267\u884c\u3002\n\n//\u63a8\u8fdf\u8c03\u7528\u7684\u51fd\u6570\u5176\u53c2\u6570\u4f1a\u7acb\u5373\u6c42\u503c\uff0c\u4f46\u76f4\u5230\u5916\u5c42\u51fd\u6570\u8fd4\u56de\u524d\u8be5\u51fd\u6570\u90fd\u4e0d\u4f1a\u88ab\u8c03\u7528\u3002\n\npackage main\n\nimport \"fmt\"\n\nfunc main() {\n    defer fmt.Println(\"world\")\n\n    fmt.Println(\"hello\")\n}\n//----------------------------------------------------------------\nhello\nworld\n</code></pre>"},{"location":"go/%E5%87%BD%E6%95%B0/#defer_1","title":"defer\u6808","text":"<pre><code>package main\n\nimport \"fmt\"\n//\u63a8\u8fdf\u7684\u51fd\u6570\u8c03\u7528\u4f1a\u88ab\u538b\u5165\u4e00\u4e2a\u6808\u4e2d\u3002\u5f53\u5916\u5c42\u51fd\u6570\u8fd4\u56de\u65f6\uff0c\u88ab\u63a8\u8fdf\u7684\u51fd\u6570\u4f1a\u6309\u7167\u540e\u8fdb\u5148\u51fa\u7684\u987a\u5e8f\u8c03\u7528\u3002\nfunc main() {\n    fmt.Println(\"counting\")\n\n    for i := 0; i &lt; 10; i++ {\n        defer fmt.Println(i)\n    }\n\n    fmt.Println(\"done\")\n}\n//----------------------------------------------------------------\ncounting\ndone\n9\n8\n7\n6\n5\n4\n3\n2\n1\n0\n</code></pre>"},{"location":"go/%E5%87%BD%E6%95%B0/#_6","title":"\u9012\u5f52","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc testcount(x int) int {\n  if x == 11 {\n    return 0\n  }\n  fmt.Println(x)\n  return testcount(x + 1)\n}\n\nfunc main(){\n  testcount(1)\n}\n</code></pre> <pre><code>package main\n\nimport \"fmt\"\n\nfunc fact(n int) int {\n    if n == 0 {\n        return 1\n    }\n    return n * fact(n-1)\n}\n\nfunc main() {\n    fmt.Println(fact(7))\n\n    var fib func(n int) int\n\n    fib = func(n int) int {\n        if n &lt; 2 {\n            return n\n        }\n\n        return fib(n-1) + fib(n-2)\n    }\n\n    fmt.Println(fib(7))\n}\n</code></pre>"},{"location":"go/%E5%87%BD%E6%95%B0/#_7","title":"\u53ef\u53d8\u53c2\u6570\u51fd\u6570","text":"<pre><code>package main\n\nimport \"fmt\"\n//\u8fd9\u662f\u4e00\u4e2a\u5c06\u4efb\u610f\u6570\u91cf\u7684\u6574\u6570\u4f5c\u4e3a\u53c2\u6570\u7684\u51fd\u6570\u3002\u5728\u51fd\u6570\u5185\u90e8\uff0cnums \u7684\u7c7b\u578b\u7b49\u540c\u4e8e []int\u3002\u6211\u4eec\u53ef\u4ee5\u8c03\u7528 len(nums)\uff0c\u7528\u8303\u56f4\u8fed\u4ee3\u5b83\uff0c\u7b49\u7b49\nfunc sum(nums ...int) {\n    fmt.Print(nums, \" \")\n    total := 0\n\n    for _, num := range nums {\n        total += num\n    }\n    fmt.Println(total)\n}\n\nfunc main() {\n\n    sum(1, 2)\n    sum(1, 2, 3)\n\n    nums := []int{1, 2, 3, 4}\n    sum(nums...)\n}\n</code></pre>"},{"location":"go/%E5%87%BD%E6%95%B0/#closures","title":"\u95ed\u5305Closures","text":"<pre><code>package main\n\nimport \"fmt\"\n//\u8fd9\u4e2a\u51fd\u6570 intSeq \u8fd4\u56de\u53e6\u4e00\u4e2a\u51fd\u6570\uff0c\u6211\u4eec\u5728 intSeq \u7684\u4e3b\u4f53\u4e2d\u533f\u540d\u5b9a\u4e49\u5b83\u3002\u8fd4\u56de\u7684\u51fd\u6570\u5173\u95ed\u53d8\u91cf i \u4ee5\u5f62\u6210\u95ed\u5305\nfunc intSeq() func() int {\n    i := 0\n    return func() int {\n        i++\n        return i\n    }\n}\n\nfunc main() {\n    //\u8c03\u7528 intSeq\uff0c\u5c06\u7ed3\u679c\uff08\u4e00\u4e2a\u51fd\u6570\uff09\u8d4b\u503c\u7ed9 nextInt\u3002\u8fd9\u4e2a\u51fd\u6570\u503c\u6355\u83b7\u5b83\u81ea\u5df1\u7684 i \u503c\uff0c\u5b83\u4f1a\u5728\u6211\u4eec\u6bcf\u6b21\u8c03\u7528 nextInt \u65f6\u66f4\u65b0\n    nextInt := intSeq()\n\n    fmt.Println(nextInt())\n    fmt.Println(nextInt())\n    fmt.Println(nextInt())\n\n    newInts := intSeq()\n    fmt.Println(newInts())\n}\n</code></pre>"},{"location":"go/%E5%87%BD%E6%95%B0/#_8","title":"\u533f\u540d\u51fd\u6570","text":"<pre><code>func(msg string) {\n        fmt.Println(msg)\n    }(\"going\")\n</code></pre>"},{"location":"go/%E5%8F%98%E9%87%8F/","title":"\u53d8\u91cf","text":""},{"location":"go/%E5%8F%98%E9%87%8F/#_1","title":"\u53d8\u91cf","text":"<p>Info</p> <ul> <li>int- stores integers (whole numbers), such as 123 or -123</li> <li>float32- stores floating point numbers, with decimals, such as 19.99 or -19.99</li> <li>string - stores text, such as \"Hello World\". String values are surrounded by double quotes</li> <li>bool- stores values with two states: true or false</li> </ul> <pre><code>//\u58f0\u660e\u4e00\u4e2a\u53d8\u91cf\u548c\u5b83\u7684\u7c7b\u578b\u3002\u53ef\u4ee5\u5728\u51fd\u6570\u5185\u90e8\u548c\u5916\u90e8\u4f7f\u7528\uff0c\u53ef\u4ee5\u58f0\u660e\u548c\u8d4b\u503c\u5206\u5f00\u8fdb\u884c\nvar variablename type = value\n\n//\u53ea\u58f0\u660e\u503c\uff0c\u7c7b\u578b\u662f\u7531\u89e3\u91ca\u5668\u4ece\u503c\u4e2d\u63a8\u65ad\u51fa\u6765\u3002\u4e0d\u80fd\u4f7f\u7528 := \u58f0\u660e\u4e00\u4e2a\u53d8\u91cf\uff0c\u800c\u4e0d\u7ed9\u5b83\u8d4b\u503c\u3002\n//\u51fd\u6570\u5916\u7684\u6bcf\u4e2a\u8bed\u53e5\u90fd\u5fc5\u987b\u4ee5\u5173\u952e\u5b57\u5f00\u59cb\uff08var, func \u7b49\u7b49\uff09\uff0c\u56e0\u6b64 := \u7ed3\u6784\u4e0d\u80fd\u5728\u51fd\u6570\u5916\u4f7f\u7528\u3002\nvariablename := value\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var student1 string = \"John\" //type is string\n  var student2 = \"Jane\" //type is inferred\n  x := 2 //type is inferred\n\n  fmt.Println(student1)\n  fmt.Println(student2)\n  fmt.Println(x)\n}\n</code></pre>"},{"location":"go/%E5%8F%98%E9%87%8F/#_2","title":"\u6ca1\u6709\u521d\u59cb\u503c\u7684\u53d8\u91cf","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var a string\n  var b int\n  var c bool\n\n  fmt.Println(a)\n  fmt.Println(b)\n  fmt.Println(c)\n}\n</code></pre>"},{"location":"go/%E5%8F%98%E9%87%8F/#_3","title":"\u591a\u53d8\u91cf\u58f0\u660e","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var a, b, c, d int = 1, 3, 5, 7\n\n  fmt.Println(a)\n  fmt.Println(b)\n  fmt.Println(c)\n  fmt.Println(d)\n}\n</code></pre>"},{"location":"go/%E5%8F%98%E9%87%8F/#_4","title":"\u5728\u5757\u4e2d\u8fdb\u884c\u53d8\u91cf\u58f0\u660e","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n)\n\nfunc main() {\n    var (\n        a int\n        b int    = 1\n        c string = \"hello\"\n    )\n\n    fmt.Println(a)\n    fmt.Println(b)\n    fmt.Println(c)\n}\n</code></pre>"},{"location":"go/%E5%8F%98%E9%87%8F/#_5","title":"\u53d8\u91cf\u547d\u540d\u89c4\u5219","text":"<p>Info</p> <ul> <li>A variable name must start with a letter or an underscore character (_)</li> <li>A variable name cannot start with a digit</li> <li>A variable name can only contain alpha-numeric characters and underscores (a-z, A-Z, 0-9, and _ )</li> <li>Variable names are case-sensitive (age, Age and AGE are three different variables)</li> <li>There is no limit on the length of the variable name</li> <li>A variable name cannot contain spaces</li> <li>The variable name cannot be any Go keywords</li> </ul>"},{"location":"go/%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C/","title":"\u5b57\u7b26\u4e32\u64cd\u4f5c","text":""},{"location":"go/%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C/#_1","title":"\u5b57\u7b26\u4e32\u51fd\u6570","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    s \"strings\"\n)\n\nvar p = fmt.Println\n\nfunc main() {\n\n    p(\"Contains:  \", s.Contains(\"test\", \"es\"))\n    p(\"Count:     \", s.Count(\"test\", \"t\"))\n    p(\"HasPrefix: \", s.HasPrefix(\"test\", \"te\"))\n    p(\"HasSuffix: \", s.HasSuffix(\"test\", \"st\"))\n    p(\"Index:     \", s.Index(\"test\", \"e\"))\n    p(\"Join:      \", s.Join([]string{\"a\", \"b\"}, \"-\"))\n    p(\"Repeat:    \", s.Repeat(\"a\", 5))\n    p(\"Replace:   \", s.Replace(\"foo\", \"o\", \"0\", -1))   // -1 \u66ff\u6362\u6240\u6709\n    p(\"Replace:   \", s.Replace(\"foo\", \"o\", \"0\", 1))   // \u66ff\u6362\u4e0b\u6807\u4e3a1\u7684o\n    p(\"Split:     \", s.Split(\"a-b-c-d-e\", \"-\"))\n    p(\"ToLower:   \", s.ToLower(\"TEST\"))\n    p(\"ToUpper:   \", s.ToUpper(\"test\"))\n}\n</code></pre>"},{"location":"go/%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C/#_2","title":"\u5b57\u7b26\u4e32\u683c\u5f0f\u5316","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"os\"\n)\n\ntype point struct {\n    x, y int\n}\n\nfunc main() {\n\n    p := point{1, 2}\n    fmt.Printf(\"struct1: %v\\n\", p)\n\n    fmt.Printf(\"struct2: %+v\\n\", p)\n\n    fmt.Printf(\"struct3: %#v\\n\", p)\n\n    fmt.Printf(\"type: %T\\n\", p)\n\n    fmt.Printf(\"bool: %t\\n\", true)\n\n    fmt.Printf(\"int: %d\\n\", 123)\n\n    fmt.Printf(\"bin: %b\\n\", 14)\n\n    fmt.Printf(\"char: %c\\n\", 33)\n\n    fmt.Printf(\"hex: %x\\n\", 456)\n\n    fmt.Printf(\"float1: %f\\n\", 78.9)\n\n    fmt.Printf(\"float2: %e\\n\", 123400000.0)\n    fmt.Printf(\"float3: %E\\n\", 123400000.0)\n\n    fmt.Printf(\"str1: %s\\n\", \"\\\"string\\\"\")\n\n    fmt.Printf(\"str2: %q\\n\", \"\\\"string\\\"\")\n\n    fmt.Printf(\"str3: %x\\n\", \"hex this\")\n\n    fmt.Printf(\"pointer: %p\\n\", &amp;p)\n\n    fmt.Printf(\"width1: |%6d|%6d|\\n\", 12, 345)\n\n    fmt.Printf(\"width2: |%6.2f|%6.2f|\\n\", 1.2, 3.45)\n\n    fmt.Printf(\"width3: |%-6.2f|%-6.2f|\\n\", 1.2, 3.45)\n\n    fmt.Printf(\"width4: |%6s|%6s|\\n\", \"foo\", \"b\")\n\n    fmt.Printf(\"width5: |%-6s|%-6s|\\n\", \"foo\", \"b\")\n\n    s := fmt.Sprintf(\"sprintf: a %s\", \"string\")\n    fmt.Println(s)\n\n    fmt.Fprintf(os.Stderr, \"io: an %s\\n\", \"error\")\n}\n</code></pre>"},{"location":"go/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/","title":"\u5b9a\u65f6\u4efb\u52a1","text":""},{"location":"go/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/#timers","title":"Timers\u8ba1\u65f6\u5668","text":"<p>\u672a\u6765\u67d0\u65f6\u95f4\u70b9\u8fd0\u884c\u4ee3\u7801</p> <pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n\n    timer1 := time.NewTimer(2 * time.Second)\n\n    &lt;-timer1.C  //\u8ba1\u65f6\u5668\u4ee3\u8868\u672a\u6765\u7684\u5355\u4e2a\u4e8b\u4ef6\u3002\u4f60\u544a\u8bc9\u8ba1\u65f6\u5668\u4f60\u60f3\u7b49\u591a\u4e45\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u4e2a\u901a\u9053\uff0c\u4f1a\u5728\u90a3\u4e2a\u65f6\u95f4\u5f97\u5230\u901a\u77e5\u3002\u8be5\u8ba1\u65f6\u5668\u5c06\u7b49\u5f85 2 \u79d2\u3002\n    fmt.Println(\"Timer 1 fired\")\n\n    timer2 := time.NewTimer(time.Second)\n    go func() {\n        &lt;-timer2.C\n        fmt.Println(\"Timer 2 fired\")\n    }()\n    stop2 := timer2.Stop()\n    if stop2 {\n        fmt.Println(\"Timer 2 stopped\")\n    }\n\n    time.Sleep(2 * time.Second)\n}\n</code></pre>"},{"location":"go/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/#tickers","title":"Tickers\u5b9a\u65f6\u5668","text":"<p>\u5b9a\u671f\u91cd\u590d\u6267\u884c\u4ee3\u7801</p> <pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n\n    ticker := time.NewTicker(500 * time.Millisecond)\n    done := make(chan bool)\n\n    go func() {\n        for {\n            select {\n            case &lt;-done:\n                return\n            case t := &lt;-ticker.C:\n                fmt.Println(\"Tick at\", t)\n            }\n        }\n    }()\n\n    time.Sleep(1600 * time.Millisecond)\n    ticker.Stop()\n    done &lt;- true\n    fmt.Println(\"Ticker stopped\")\n}\n</code></pre>"},{"location":"go/%E5%B8%B8%E9%87%8F/","title":"\u5e38\u91cf","text":""},{"location":"go/%E5%B8%B8%E9%87%8F/#_1","title":"\u5e38\u91cf","text":"<p>\u5982\u679c\u4e00\u4e2a\u53d8\u91cf\u5e94\u8be5\u6709\u4e00\u4e2a\u4e0d\u80fd\u6539\u53d8\u7684\u56fa\u5b9a\u503c\uff0c\u53ef\u4ee5\u4f7f\u7528 const \u5173\u952e\u5b57\u3002</p> <pre><code>//\u5e38\u91cf\u7684value\u5fc5\u987b\u5728\u58f0\u660e\u65f6\u8d4b\u503c\nconst CONSTNAME type = value\n</code></pre> <p>Info</p> <ul> <li>\u5e38\u91cf\u540d\u901a\u5e38\u7528\u5927\u5199\u5b57\u6bcd\u4e66\u5199\uff08\u4fbf\u4e8e\u4e0e\u53d8\u91cf\u8bc6\u522b\u548c\u533a\u5206\uff09</li> <li>\u5e38\u91cf\u53ef\u4ee5\u5728\u51fd\u6570\u5185\u90e8\u548c\u5916\u90e8\u58f0\u660e</li> </ul> <pre><code>//\u7c7b\u578b\u5316\u5e38\u91cf\npackage main\nimport (\"fmt\")\n\nconst A int = 1\n\nfunc main() {\n  fmt.Println(A)\n}\n</code></pre> <pre><code>//\u65e0\u7c7b\u578b\u5e38\u91cf\u5728\u6ca1\u6709\u7c7b\u578b\u7684\u60c5\u51b5\u4e0b\u58f0\u660e\uff0c\u5e38\u91cf\u7684\u7c7b\u578b\u7531\u89e3\u91ca\u5668\u63a8\u65ad\npackage main\nimport (\"fmt\")\n\nconst A = 1\n\nfunc main() {\n  fmt.Println(A)\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nconst (\n  A int = 1\n  B = 3.14\n  C = \"Hi!\"\n)\n\nfunc main() {\n  fmt.Println(A)\n  fmt.Println(B)\n  fmt.Println(C)\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/","title":"\u5e76\u53d1","text":""},{"location":"go/%E5%B9%B6%E5%8F%91/#goroutine","title":"goroutine","text":"<p>Info</p> <ul> <li>Go \u7a0b\uff08goroutine\uff09\u662f\u7531 Go \u8fd0\u884c\u65f6\u7ba1\u7406\u7684\u8f7b\u91cf\u7ea7\u7ebf\u7a0b\u3002</li> <li>Go \u7a0b\u5728\u76f8\u540c\u7684\u5730\u5740\u7a7a\u95f4\u4e2d\u8fd0\u884c\uff0c\u56e0\u6b64\u5728\u8bbf\u95ee\u5171\u4eab\u7684\u5185\u5b58\u65f6\u5fc5\u987b\u8fdb\u884c\u540c\u6b65\u3002</li> <li>sync \u5305\u63d0\u4f9b\u4e86\u8fd9\u79cd\u80fd\u529b</li> </ul> <pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc say(s string) {\n    for i := 0; i &lt; 5; i++ {\n        time.Sleep(100 * time.Millisecond)\n        fmt.Println(s)\n    }\n}\n\nfunc main() {\n    go say(\"world\")  //\u4f1a\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 Go \u7a0b\u5e76\u6267\u884csay(\"world\")\n    say(\"hello\")\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#_1","title":"\u4fe1\u9053","text":"<p>\u4fe1\u9053\u662f\u5e26\u6709\u7c7b\u578b\u7684\u7ba1\u9053\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u5b83\u7528\u4fe1\u9053\u64cd\u4f5c\u7b26 &lt;- \u6765\u53d1\u9001\u6216\u8005\u63a5\u6536\u503c\u3002</p> <p>ch &lt;- v // \u5c06 v \u53d1\u9001\u81f3\u4fe1\u9053 ch\u3002 v := &lt;-ch // \u4ece ch \u63a5\u6536\u503c\u5e76\u8d4b\u4e88 v\u3002 \uff08\u201c\u7bad\u5934\u201d\u5c31\u662f\u6570\u636e\u6d41\u7684\u65b9\u5411\u3002\uff09</p> <p>\u548c\u6620\u5c04\u4e0e\u5207\u7247\u4e00\u6837\uff0c\u4fe1\u9053\u5728\u4f7f\u7528\u524d\u5fc5\u987b\u521b\u5efa\uff1a</p> <p>ch := make(chan int) \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u53d1\u9001\u548c\u63a5\u6536\u64cd\u4f5c\u5728\u53e6\u4e00\u7aef\u51c6\u5907\u597d\u4e4b\u524d\u90fd\u4f1a\u963b\u585e\u3002\u8fd9\u4f7f\u5f97 Go \u7a0b\u53ef\u4ee5\u5728\u6ca1\u6709\u663e\u5f0f\u7684\u9501\u6216\u7ade\u6001\u53d8\u91cf\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u540c\u6b65\u3002</p> <p>\u4ee5\u4e0b\u793a\u4f8b\u5bf9\u5207\u7247\u4e2d\u7684\u6570\u8fdb\u884c\u6c42\u548c\uff0c\u5c06\u4efb\u52a1\u5206\u914d\u7ed9\u4e24\u4e2a Go \u7a0b\u3002\u4e00\u65e6\u4e24\u4e2a Go \u7a0b\u5b8c\u6210\u4e86\u5b83\u4eec\u7684\u8ba1\u7b97\uff0c\u5b83\u5c31\u80fd\u7b97\u51fa\u6700\u7ec8\u7684\u7ed3\u679c\u3002</p> <pre><code>package main\n\nimport \"fmt\"\n\nfunc sum(s []int, c chan int) {\n    sum := 0\n    for _, v := range s {\n        sum += v\n    }\n    c &lt;- sum // \u5c06\u548c\u9001\u5165 c\n}\n\nfunc main() {\n    s := []int{7, 2, 8, -9, 4, 0}\n\n    c := make(chan int)\n    go sum(s[:len(s)/2], c)\n    go sum(s[len(s)/2:], c)\n    x, y := &lt;-c, &lt;-c // \u4ece c \u4e2d\u63a5\u6536\n\n    fmt.Println(x, y, x+y)\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#_2","title":"\u5e26\u7f13\u51b2\u7684\u4fe1\u9053","text":"<p>\u4fe1\u9053\u53ef\u4ee5\u662f \u5e26\u7f13\u51b2\u7684\u3002</p> <p>\u5c06\u7f13\u51b2\u957f\u5ea6\u4f5c\u4e3a\u7b2c\u4e8c\u4e2a\u53c2\u6570\u63d0\u4f9b\u7ed9 make \u6765\u521d\u59cb\u5316\u4e00\u4e2a\u5e26\u7f13\u51b2\u7684\u4fe1\u9053\uff1a ch := make(chan int, 100) \u4ec5\u5f53\u4fe1\u9053\u7684\u7f13\u51b2\u533a\u586b\u6ee1\u540e\uff0c\u5411\u5176\u53d1\u9001\u6570\u636e\u65f6\u624d\u4f1a\u963b\u585e\u3002\u5f53\u7f13\u51b2\u533a\u4e3a\u7a7a\u65f6\uff0c\u63a5\u53d7\u65b9\u4f1a\u963b\u585e\u3002</p> <p>\u4fee\u6539\u793a\u4f8b\u586b\u6ee1\u7f13\u51b2\u533a\uff0c\u7136\u540e\u770b\u770b\u4f1a\u53d1\u751f\u4ec0\u4e48\u3002</p> <pre><code>package main\n\nimport \"fmt\"\n\nfunc main() {\n    ch := make(chan int, 1)\n    ch &lt;- 1\n    ch &lt;- 2\n    fmt.Println(&lt;-ch)\n    fmt.Println(&lt;-ch)\n}\n</code></pre> <pre><code>//\u56e0\u4e3a\u8fd9\u4e2a\u901a\u9053\u662f\u7f13\u51b2\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u503c\u53d1\u9001\u5230\u901a\u9053\u4e2d\u800c\u65e0\u9700\u76f8\u5e94\u7684\u5e76\u53d1\u63a5\u6536\u3002\npackage main\n\nimport \"fmt\"\n\nfunc main() {\n\n    messages := make(chan string, 2)\n\n    messages &lt;- \"buffered\"\n    messages &lt;- \"channel\"\n\n    fmt.Println(&lt;-messages)\n    fmt.Println(&lt;-messages)\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#_3","title":"\u4fe1\u9053\u540c\u6b65\u5316","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc worker(done chan bool) {\n    fmt.Print(\"working...\")\n    time.Sleep(time.Second)\n    fmt.Println(\"done\")\n\n    done &lt;- true  // done \u901a\u9053\u5c06\u7528\u4e8e\u901a\u77e5\u53e6\u4e00\u4e2a goroutine \u8be5\u51fd\u6570\u7684\u5de5\u4f5c\u5df2\u5b8c\u6210\u3002\n}\n\nfunc main() {\n\n    done := make(chan bool, 1)\n    go worker(done)\n\n    &lt;-done  //\u963b\u585e\uff0c\u76f4\u5230\u6211\u4eec\u6536\u5230\u6765\u81ea\u901a\u9053\u4e0a\u5de5\u4f5c\u4eba\u5458\u7684\u901a\u77e5\u3002\u5982\u679c\u4ece\u8be5\u7a0b\u5e8f\u4e2d\u5220\u9664\u4e86 &lt;- done \u884c\uff0c\u5219\u8be5\u7a0b\u5e8f\u751a\u81f3\u4f1a\u5728 worker \u542f\u52a8\u4e4b\u524d\u9000\u51fa\u3002\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#_4","title":"\u4fe1\u9053\u65b9\u5411","text":"<pre><code>package main\n\nimport \"fmt\"\n//\u6b64ping\u51fd\u6570\u4ec5\u63a5\u53d7\u7528\u4e8e\u53d1\u9001\u503c\u7684\u901a\u9053\u3002\u5c1d\u8bd5\u5728\u6b64\u901a\u9053\u4e0a\u63a5\u6536\u5c06\u662f\u4e00\u4e2a\u7f16\u8bd1\u65f6\u9519\u8bef\u3002\nfunc ping(pings chan&lt;- string, msg string) {\n    pings &lt;- msg\n}\n//\u8be5pong\u51fd\u6570\u63a5\u53d7\u4e00\u4e2a\u7528\u4e8e\u63a5\u6536 ( pings) \u7684\u901a\u9053\u548c\u4e00\u4e2a\u7528\u4e8e\u53d1\u9001 ( ) \u7684\u901a\u9053pongs\u3002\nfunc pong(pings &lt;-chan string, pongs chan&lt;- string) {\n    msg := &lt;-pings\n    pongs &lt;- msg\n}\n\nfunc main() {\n    pings := make(chan string, 1)\n    pongs := make(chan string, 1)\n    ping(pings, \"passed message\")\n    pong(pings, pongs)\n    fmt.Println(&lt;-pongs)\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#select","title":"select \u8bed\u53e5","text":"<p>select \u8bed\u53e5\u4f7f\u4e00\u4e2a Go \u7a0b\u53ef\u4ee5\u7b49\u5f85\u591a\u4e2a\u901a\u4fe1\u64cd\u4f5c\u3002</p> <p>select \u4f1a\u963b\u585e\u5230\u67d0\u4e2a\u5206\u652f\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c\u4e3a\u6b62\uff0c\u8fd9\u65f6\u5c31\u4f1a\u6267\u884c\u8be5\u5206\u652f\u3002\u5f53\u591a\u4e2a\u5206\u652f\u90fd\u51c6\u5907\u597d\u65f6\u4f1a\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u6267\u884c\u3002</p> <pre><code>package main\n\nimport \"fmt\"\n\nfunc fibonacci(c, quit chan int) {\n    x, y := 0, 1\n    for {\n        select {\n        case c &lt;- x:\n            x, y = y, x+y\n        case &lt;-quit:\n            fmt.Println(\"quit\")\n            return\n        }\n    }\n}\n\nfunc main() {\n    c := make(chan int)\n    quit := make(chan int)\n    go func() {\n        for i := 0; i &lt; 10; i++ {\n            fmt.Println(&lt;-c)\n        }\n        quit &lt;- 0\n    }()\n    fibonacci(c, quit)\n}\n</code></pre> <p>example:</p> <pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n\n    c1 := make(chan string)\n    c2 := make(chan string)\n\n    go func() {\n        time.Sleep(1 * time.Second)\n        c1 &lt;- \"one\"\n    }()\n    go func() {\n        time.Sleep(2 * time.Second)\n        c2 &lt;- \"two\"\n    }()\n\n    for i := 0; i &lt; 2; i++ {\n        select {\n        case msg1 := &lt;-c1:\n            fmt.Println(\"received\", msg1)\n        case msg2 := &lt;-c2:\n            fmt.Println(\"received\", msg2)\n        }\n    }\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#_5","title":"\u8d85\u65f6","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n\n    c1 := make(chan string, 1)\n    go func() {\n        time.Sleep(2 * time.Second)\n        c1 &lt;- \"result 1\"\n    }()\n\n    select {\n    case res := &lt;-c1:\n        fmt.Println(res)\n    case &lt;-time.After(1 * time.Second):\n        fmt.Println(\"timeout 1\")\n    }\n\n    c2 := make(chan string, 1)\n    go func() {\n        time.Sleep(2 * time.Second)\n        c2 &lt;- \"result 2\"\n    }()\n    select {\n    case res := &lt;-c2:\n        fmt.Println(res)\n    case &lt;-time.After(3 * time.Second):\n        fmt.Println(\"timeout 2\")\n    }\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#_6","title":"\u975e\u963b\u585e\u4fe1\u9053","text":"<p>\u5f53 select \u4e2d\u7684\u5176\u5b83\u5206\u652f\u90fd\u6ca1\u6709\u51c6\u5907\u597d\u65f6\uff0cdefault \u5206\u652f\u5c31\u4f1a\u6267\u884c\u3002</p> <p>\u4e3a\u4e86\u5728\u5c1d\u8bd5\u53d1\u9001\u6216\u8005\u63a5\u6536\u65f6\u4e0d\u53d1\u751f\u963b\u585e\uff0c\u53ef\u4f7f\u7528 default \u5206\u652f\uff1a</p> <pre><code>select {\ncase i := &lt;-c:\n    // \u4f7f\u7528 i\ndefault:\n    // \u4ece c \u4e2d\u63a5\u6536\u4f1a\u963b\u585e\u65f6\u6267\u884c\n}\n</code></pre> <pre><code>package main\n\nimport \"fmt\"\n\nfunc main() {\n    messages := make(chan string)\n    signals := make(chan bool)\n\n    select {\n    case msg := &lt;-messages:\n        fmt.Println(\"received message\", msg)\n    default:\n        fmt.Println(\"no message received\")\n    }\n\n    msg := \"hi\"\n    select {\n    case messages &lt;- msg:\n        fmt.Println(\"sent message\", msg)\n    default:\n        fmt.Println(\"no message sent\")\n    }\n\n    select {\n    case msg := &lt;-messages:\n        fmt.Println(\"received message\", msg)\n    case sig := &lt;-signals:\n        fmt.Println(\"received signal\", sig)\n    default:\n        fmt.Println(\"no activity\")\n    }\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#range-close","title":"range \u548c close","text":"<p>Info</p> <ul> <li> <p>\u53d1\u9001\u8005\u53ef\u901a\u8fc7 close \u5173\u95ed\u4e00\u4e2a\u4fe1\u9053\u6765\u8868\u793a\u6ca1\u6709\u9700\u8981\u53d1\u9001\u7684\u503c\u4e86\u3002\u63a5\u6536\u8005\u53ef\u4ee5\u901a\u8fc7\u4e3a\u63a5\u6536\u8868\u8fbe\u5f0f\u5206\u914d\u7b2c\u4e8c\u4e2a\u53c2\u6570\u6765\u6d4b\u8bd5\u4fe1\u9053\u662f\u5426\u88ab\u5173\u95ed\uff1a\u82e5\u6ca1\u6709\u503c\u53ef\u4ee5\u63a5\u6536\u4e14\u4fe1\u9053\u5df2\u88ab\u5173\u95ed\uff0c\u90a3\u4e48\u5728\u6267\u884c\u5b8c <pre><code>v, ok := &lt;-ch \n</code></pre> \u4e4b\u540e ok \u4f1a\u88ab\u8bbe\u7f6e\u4e3a false\u3002</p> </li> <li> <p>\u5faa\u73af for i := range c \u4f1a\u4e0d\u65ad\u4ece\u4fe1\u9053\u63a5\u6536\u503c\uff0c\u76f4\u5230\u5b83\u88ab\u5173\u95ed\u3002</p> </li> </ul> <p>Note</p> <p>\u6ce8\u610f\uff1a \u53ea\u6709\u53d1\u9001\u8005\u624d\u80fd\u5173\u95ed\u4fe1\u9053\uff0c\u800c\u63a5\u6536\u8005\u4e0d\u80fd\u3002\u5411\u4e00\u4e2a\u5df2\u7ecf\u5173\u95ed\u7684\u4fe1\u9053\u53d1\u9001\u6570\u636e\u4f1a\u5f15\u53d1\u7a0b\u5e8f\u6050\u614c\uff08panic\uff09\u3002</p> <p>\u8fd8\u8981\u6ce8\u610f\uff1a \u4fe1\u9053\u4e0e\u6587\u4ef6\u4e0d\u540c\uff0c\u901a\u5e38\u60c5\u51b5\u4e0b\u65e0\u9700\u5173\u95ed\u5b83\u4eec\u3002\u53ea\u6709\u5728\u5fc5\u987b\u544a\u8bc9\u63a5\u6536\u8005\u4e0d\u518d\u6709\u9700\u8981\u53d1\u9001\u7684\u503c\u65f6\u624d\u6709\u5fc5\u8981\u5173\u95ed\uff0c\u4f8b\u5982\u7ec8\u6b62\u4e00\u4e2a range \u5faa\u73af\u3002</p> <pre><code>package main\n\nimport (\n    \"fmt\"\n)\n\nfunc fibonacci(n int, c chan int) {\n    x, y := 0, 1\n    for i := 0; i &lt; n; i++ {\n        c &lt;- x\n        x, y = y, x+y\n    }\n    close(c)\n}\n\nfunc main() {\n    c := make(chan int, 10)\n    go fibonacci(cap(c), c)\n    for i := range c {\n        fmt.Println(i)\n    }\n}\n</code></pre> <p>close example:</p> <pre><code>package main\n\nimport \"fmt\"\n\nfunc main() {\n    jobs := make(chan int, 5)\n    done := make(chan bool)\n\n    go func() {\n        for {\n            j, more := &lt;-jobs\n            if more {\n                fmt.Println(\"received job\", j)\n            } else {\n                fmt.Println(\"received all jobs\")\n                done &lt;- true\n                return\n            }\n        }\n    }()\n\n    for j := 1; j &lt;= 3; j++ {\n        jobs &lt;- j\n        fmt.Println(\"sent job\", j)\n    }\n    close(jobs)\n    fmt.Println(\"sent all jobs\")\n\n    &lt;-done\n}\n</code></pre> <p>range example: </p> <pre><code>package main\n\nimport \"fmt\"\n\nfunc main() {\n\n    queue := make(chan string, 2)\n    queue &lt;- \"one\"\n    queue &lt;- \"two\"\n    close(queue)\n\n    for elem := range queue {\n        fmt.Println(elem)\n    }\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#worker-pool","title":"worker pool","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc worker(id int, jobs &lt;-chan int, results chan&lt;- int) {\n    for j := range jobs {\n        fmt.Println(\"worker\", id, \"started  job\", j)\n        time.Sleep(time.Second)\n        fmt.Println(\"worker\", id, \"finished job\", j)\n        results &lt;- j * 2\n    }\n}\n\nfunc main() {\n\n    const numJobs = 5\n    jobs := make(chan int, numJobs)\n    results := make(chan int, numJobs)\n\n    for w := 1; w &lt;= 3; w++ {\n        go worker(w, jobs, results)\n    }\n\n    for j := 1; j &lt;= numJobs; j++ {\n        jobs &lt;- j\n    }\n    close(jobs)\n\n    for a := 1; a &lt;= numJobs; a++ {\n        &lt;-results\n    }\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#waitgroups","title":"WaitGroups","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"sync\"\n    \"time\"\n)\n\nfunc worker(id int) {\n    fmt.Printf(\"Worker %d starting\\n\", id)\n\n    time.Sleep(time.Second)\n    fmt.Printf(\"Worker %d done\\n\", id)\n}\n\nfunc main() {\n\n    var wg sync.WaitGroup\n\n    for i := 1; i &lt;= 5; i++ {\n        wg.Add(1)\n\n        i := i\n\n        go func() {\n            defer wg.Done()\n            worker(i)\n        }()\n    }\n\n    wg.Wait()\n\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#_7","title":"\u901f\u7387\u9650\u5236","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n\n    requests := make(chan int, 5)\n    for i := 1; i &lt;= 5; i++ {\n        requests &lt;- i\n    }\n    close(requests)\n\n    limiter := time.Tick(200 * time.Millisecond)\n\n    for req := range requests {\n        &lt;-limiter\n        fmt.Println(\"request\", req, time.Now())\n    }\n\n    burstyLimiter := make(chan time.Time, 3)\n\n    for i := 0; i &lt; 3; i++ {\n        burstyLimiter &lt;- time.Now()\n    }\n\n    go func() {\n        for t := range time.Tick(200 * time.Millisecond) {\n            burstyLimiter &lt;- t\n        }\n    }()\n\n    burstyRequests := make(chan int, 5)\n    for i := 1; i &lt;= 5; i++ {\n        burstyRequests &lt;- i\n    }\n    close(burstyRequests)\n    for req := range burstyRequests {\n        &lt;-burstyLimiter\n        fmt.Println(\"request\", req, time.Now())\n    }\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#_8","title":"\u539f\u5b50\u8ba1\u6570\u5668","text":""},{"location":"go/%E5%B9%B6%E5%8F%91/#syncmutex","title":"\u4e92\u65a5 sync.Mutex","text":"<p>Info</p> <ul> <li> <p>\u6211\u4eec\u5df2\u7ecf\u770b\u5230\u4fe1\u9053\u975e\u5e38\u9002\u5408\u5728\u5404\u4e2a Go \u7a0b\u95f4\u8fdb\u884c\u901a\u4fe1\u3002\u4f46\u662f\u5982\u679c\u6211\u4eec\u5e76\u4e0d\u9700\u8981\u901a\u4fe1\u5462\uff1f\u6bd4\u5982\u8bf4\uff0c\u82e5\u6211\u4eec\u53ea\u662f\u60f3\u4fdd\u8bc1\u6bcf\u6b21\u53ea\u6709\u4e00\u4e2a Go \u7a0b\u80fd\u591f\u8bbf\u95ee\u4e00\u4e2a\u5171\u4eab\u7684\u53d8\u91cf\uff0c\u4ece\u800c\u907f\u514d\u51b2\u7a81\uff1f</p> </li> <li> <p>\u8fd9\u91cc\u6d89\u53ca\u7684\u6982\u5ff5\u53eb\u505a \u4e92\u65a5\uff08mutualexclusion\uff09\uff0c\u6211\u4eec\u901a\u5e38\u4f7f\u7528 \u4e92\u65a5\u9501\uff08Mutex\uff09 \u8fd9\u4e00\u6570\u636e\u7ed3\u6784\u6765\u63d0\u4f9b\u8fd9\u79cd\u673a\u5236\u3002</p> </li> <li> <p>Go \u6807\u51c6\u5e93\u4e2d\u63d0\u4f9b\u4e86 sync.Mutex \u4e92\u65a5\u9501\u7c7b\u578b\u53ca\u5176\u4e24\u4e2a\u65b9\u6cd5\uff1a</p> <ol> <li> <p>Lock Unlock \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u4ee3\u7801\u524d\u8c03\u7528 Lock \u65b9\u6cd5\uff0c\u5728\u4ee3\u7801\u540e\u8c03\u7528 Unlock \u65b9\u6cd5\u6765\u4fdd\u8bc1\u4e00\u6bb5\u4ee3\u7801\u7684\u4e92\u65a5\u6267\u884c\u3002\u53c2\u89c1 Inc \u65b9\u6cd5\u3002</p> </li> <li> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u7528 defer \u8bed\u53e5\u6765\u4fdd\u8bc1\u4e92\u65a5\u9501\u4e00\u5b9a\u4f1a\u88ab\u89e3\u9501\u3002\u53c2\u89c1 Value \u65b9\u6cd5\u3002</p> </li> </ol> </li> </ul> <pre><code>package main\n\nimport (\n    \"fmt\"\n    \"sync\"\n    \"time\"\n)\n\n// SafeCounter \u7684\u5e76\u53d1\u4f7f\u7528\u662f\u5b89\u5168\u7684\u3002\ntype SafeCounter struct {\n    v   map[string]int\n    mux sync.Mutex\n}\n\n// Inc \u589e\u52a0\u7ed9\u5b9a key \u7684\u8ba1\u6570\u5668\u7684\u503c\u3002\nfunc (c *SafeCounter) Inc(key string) {\n    c.mux.Lock()\n    // Lock \u4e4b\u540e\u540c\u4e00\u65f6\u523b\u53ea\u6709\u4e00\u4e2a goroutine \u80fd\u8bbf\u95ee c.v\n    c.v[key]++\n    c.mux.Unlock()\n}\n\n// Value \u8fd4\u56de\u7ed9\u5b9a key \u7684\u8ba1\u6570\u5668\u7684\u5f53\u524d\u503c\u3002\nfunc (c *SafeCounter) Value(key string) int {\n    c.mux.Lock()\n    // Lock \u4e4b\u540e\u540c\u4e00\u65f6\u523b\u53ea\u6709\u4e00\u4e2a goroutine \u80fd\u8bbf\u95ee c.v\n    defer c.mux.Unlock()\n    return c.v[key]\n}\n\nfunc main() {\n    c := SafeCounter{v: make(map[string]int)}\n    for i := 0; i &lt; 1000; i++ {\n        go c.Inc(\"somekey\")\n    }\n\n    time.Sleep(time.Second)\n    fmt.Println(c.Value(\"somekey\"))\n}\n</code></pre> <p>example: </p> <pre><code>package main\n\nimport (\n    \"fmt\"\n    \"sync\"\n)\n\ntype Container struct {\n    mu       sync.Mutex\n    counters map[string]int\n}\n\nfunc (c *Container) inc(name string) {\n\n    c.mu.Lock()\n    defer c.mu.Unlock()\n    c.counters[name]++\n}\n\nfunc main() {\n    c := Container{\n\n        counters: map[string]int{\"a\": 0, \"b\": 0},\n    }\n\n    var wg sync.WaitGroup\n\n    doIncrement := func(name string, n int) {\n        for i := 0; i &lt; n; i++ {\n            c.inc(name)\n        }\n        wg.Done()\n    }\n\n    wg.Add(3)\n    go doIncrement(\"a\", 10000)\n    go doIncrement(\"a\", 10000)\n    go doIncrement(\"b\", 10000)\n\n    wg.Wait()\n    fmt.Println(c.counters)\n}\n</code></pre>"},{"location":"go/%E5%B9%B6%E5%8F%91/#goroutines","title":"\u6709\u72b6\u6001\u7684 Goroutines","text":""},{"location":"go/%E6%8C%87%E9%92%88Pointers/","title":"\u6307\u9488Pointers","text":""},{"location":"go/%E6%8C%87%E9%92%88Pointers/#_1","title":"\u6307\u9488","text":"<p>Info</p> <ul> <li> <p><code>&amp;</code> \u64cd\u4f5c\u7b26\u4f1a\u751f\u6210\u4e00\u4e2a\u6307\u5411\u5176\u64cd\u4f5c\u6570\u7684\u6307\u9488\u3002</p> </li> <li> <p><code>*</code> \u64cd\u4f5c\u7b26\u8868\u793a\u6307\u9488\u6307\u5411\u7684\u5e95\u5c42\u503c\u3002</p> </li> <li> <p>\u7b80\u5355\u6765\u8bf4\uff0c\u901a\u8fc7<code>&amp;</code>\u8bbe\u7f6e\u6307\u9488\uff0c\u901a\u8fc7<code>*</code>\u4f7f\u7528\u6307\u9488\u3002</p> </li> </ul> <pre><code>//zeroval \u4e0d\u4f1a\u66f4\u6539 main \u4e2d\u7684 i\uff0c\u4f46 zeroptr \u4f1a\u66f4\u6539\uff0c\u56e0\u4e3a\u5b83\u5f15\u7528\u4e86\u8be5\u53d8\u91cf\u7684\u5185\u5b58\u5730\u5740\u3002\npackage main\n\nimport \"fmt\"\n\nfunc zeroval(ival int) {\n    ival = 0\n}\n//zeroptr \u6709\u4e00\u4e2a *int \u53c2\u6570\uff0c\u8fd9\u610f\u5473\u7740\u5b83\u9700\u8981\u4e00\u4e2a int \u6307\u9488\u3002\u7136\u540e\u51fd\u6570\u4f53\u4e2d\u7684 *iptr \u4ee3\u7801\u5c06\u6307\u9488\u4ece\u5176\u5185\u5b58\u5730\u5740\u53d6\u6d88\u5f15\u7528\u5230\u8be5\u5730\u5740\u7684\u5f53\u524d\u503c\u3002\u4e3a\u53d6\u6d88\u5f15\u7528\u7684\u6307\u9488\u8d4b\u503c\u4f1a\u66f4\u6539\u5f15\u7528\u5730\u5740\u5904\u7684\u503c\u3002\nfunc zeroptr(iptr *int) {\n    *iptr = 0\n}\n\nfunc main() {\n    i := 1\n    fmt.Println(\"initial:\", i)\n\n    zeroval(i)\n    fmt.Println(\"zeroval:\", i)\n    //&amp;i \u8bed\u6cd5\u7ed9\u51fa\u4e86 i \u7684\u5185\u5b58\u5730\u5740\uff0c\u5373\u6307\u5411 i \u7684\u6307\u9488\n    zeroptr(&amp;i)\n    fmt.Println(\"zeroptr:\", i)\n\n    fmt.Println(\"pointer:\", &amp;i)\n}\n</code></pre>"},{"location":"go/%E6%8E%92%E5%BA%8F/","title":"\u6392\u5e8f","text":""},{"location":"go/%E6%8E%92%E5%BA%8F/#_1","title":"\u6392\u5e8f","text":"<p>\u6392\u5e8f\u65b9\u6cd5\u7279\u5b9a\u4e8e\u5185\u7f6e\u7c7b\u578b\uff1b\u8fd9\u662f\u5b57\u7b26\u4e32\u7684\u793a\u4f8b\u3002\u8bf7\u6ce8\u610f\uff0c\u6392\u5e8f\u662f\u5c31\u5730\u8fdb\u884c\u7684\uff0c\u56e0\u6b64\u5b83\u4f1a\u66f4\u6539\u7ed9\u5b9a\u7684\u5207\u7247\u5e76\u4e14\u4e0d\u4f1a\u8fd4\u56de\u65b0\u7684\u5207\u7247\u3002</p> <pre><code>package main\n\nimport (\n    \"fmt\"\n    \"sort\"\n)\n\nfunc main() {\n\n    strs := []string{\"c\", \"a\", \"b\"}\n    sort.Strings(strs)\n    fmt.Println(\"Strings:\", strs)\n\n    ints := []int{7, 2, 4}\n    sort.Ints(ints)\n    fmt.Println(\"Ints:   \", ints)\n\n    s := sort.IntsAreSorted(ints)  //\u68c0\u67e5\u5207\u7247\u662f\u5426\u5df2\u7ecf\u6392\u5e8f\n    fmt.Println(\"Sorted: \", s)\n}\n</code></pre>"},{"location":"go/%E6%8E%92%E5%BA%8F/#_2","title":"\u6309\u51fd\u6570\u6392\u5e8f","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"sort\"\n)\n//\u6309\u957f\u5ea6\u6392\u5e8f\ntype byLength []string\n\nfunc (s byLength) Len() int {\n    return len(s)\n}\nfunc (s byLength) Swap(i, j int) {\n    s[i], s[j] = s[j], s[i]\n}\nfunc (s byLength) Less(i, j int) bool {\n    return len(s[i]) &lt; len(s[j])\n}\n\nfunc main() {\n    fruits := []string{\"peach\", \"banana\", \"kiwi\"}\n    sort.Sort(byLength(fruits))\n    fmt.Println(fruits)\n}\n</code></pre>"},{"location":"go/%E6%8E%A5%E5%8F%A3interface/","title":"\u63a5\u53e3interface","text":""},{"location":"go/%E6%8E%A5%E5%8F%A3interface/#_1","title":"\u63a5\u53e3","text":"<p>Info</p> <p>\u63a5\u53e3 \u662f\u7531\u4e00\u7ec4\u65b9\u6cd5\u7b7e\u540d\u5b9a\u4e49\u7684\u96c6\u5408</p> <p>\u63a5\u53e3\u7c7b\u578b\u7684\u53d8\u91cf\u53ef\u4ee5\u4fdd\u5b58\u4efb\u4f55\u5b9e\u73b0\u4e86\u8fd9\u4e9b\u65b9\u6cd5\u7684\u503c</p> <pre><code>type Abser interface {\n    Abs() float64\n}\n</code></pre>"},{"location":"go/%E6%8E%A5%E5%8F%A3interface/#_2","title":"\u63a5\u53e3\u4e0e\u9690\u5f0f\u5b9e\u73b0","text":"<p>\u7c7b\u578b\u901a\u8fc7\u5b9e\u73b0\u4e00\u4e2a\u63a5\u53e3\u7684\u6240\u6709\u65b9\u6cd5\u6765\u5b9e\u73b0\u8be5\u63a5\u53e3\u3002</p>"},{"location":"go/%E6%8E%A5%E5%8F%A3interface/#_3","title":"\u63a5\u53e3\u503c","text":"<p>Info</p> <p>\u63a5\u53e3\u4e5f\u662f\u503c\u3002\u5b83\u4eec\u53ef\u4ee5\u50cf\u5176\u5b83\u503c\u4e00\u6837\u4f20\u9012\u3002</p> <p>\u63a5\u53e3\u503c\u53ef\u4ee5\u7528\u4f5c\u51fd\u6570\u7684\u53c2\u6570\u6216\u8fd4\u56de\u503c\u3002</p> <p>\u5728\u5185\u90e8\uff0c\u63a5\u53e3\u503c\u53ef\u4ee5\u770b\u505a\u5305\u542b\u503c\u548c\u5177\u4f53\u7c7b\u578b\u7684\u5143\u7ec4\uff1a</p> <p><pre><code>(value, type)\n</code></pre> \u63a5\u53e3\u503c\u4fdd\u5b58\u4e86\u4e00\u4e2a\u5177\u4f53\u5e95\u5c42\u7c7b\u578b\u7684\u5177\u4f53\u503c\u3002</p> <p>\u63a5\u53e3\u503c\u8c03\u7528\u65b9\u6cd5\u65f6\u4f1a\u6267\u884c\u5176\u5e95\u5c42\u7c7b\u578b\u7684\u540c\u540d\u65b9\u6cd5\u3002</p>"},{"location":"go/%E6%8E%A5%E5%8F%A3interface/#nil","title":"\u5e95\u5c42\u503c\u4e3a nil \u7684\u63a5\u53e3\u503c","text":"<p>Info</p> <p>\u5373\u4fbf\u63a5\u53e3\u5185\u7684\u5177\u4f53\u503c\u4e3a nil\uff0c\u65b9\u6cd5\u4ecd\u7136\u4f1a\u88ab nil \u63a5\u6536\u8005\u8c03\u7528\u3002</p> <p>\u5728\u4e00\u4e9b\u8bed\u8a00\u4e2d\uff0c\u8fd9\u4f1a\u89e6\u53d1\u4e00\u4e2a\u7a7a\u6307\u9488\u5f02\u5e38\uff0c\u4f46\u5728 Go \u4e2d\u901a\u5e38\u4f1a\u5199\u4e00\u4e9b\u65b9\u6cd5\u6765\u4f18\u96c5\u5730\u5904\u7406\u5b83\uff08\u5982\u672c\u4f8b\u4e2d\u7684 M \u65b9\u6cd5\uff09\u3002</p> <p>\u6ce8\u610f: \u4fdd\u5b58\u4e86 nil \u5177\u4f53\u503c\u7684\u63a5\u53e3\u5176\u81ea\u8eab\u5e76\u4e0d\u4e3a nil\u3002</p> <pre><code>package main\n\nimport \"fmt\"\n\ntype I interface {\n    M()\n}\n\ntype T struct {\n    S string\n}\n\nfunc (t *T) M() {\n    if t == nil {\n        fmt.Println(\"&lt;nil&gt;\")\n        return\n    }\n    fmt.Println(t.S)\n}\n\nfunc main() {\n    var i I\n\n    var t *T\n    i = t\n    describe(i)\n    i.M()\n\n    i = &amp;T{\"hello\"}\n    describe(i)\n    i.M()\n}\n\nfunc describe(i I) {\n    fmt.Printf(\"(%v, %T)\\n\", i, i)\n}\n</code></pre>"},{"location":"go/%E6%8E%A5%E5%8F%A3interface/#nil_1","title":"nil \u63a5\u53e3\u503c","text":"<p>nil \u63a5\u53e3\u503c\u65e2\u4e0d\u4fdd\u5b58\u503c\u4e5f\u4e0d\u4fdd\u5b58\u5177\u4f53\u7c7b\u578b\u3002</p> <p>\u4e3a nil \u63a5\u53e3\u8c03\u7528\u65b9\u6cd5\u4f1a\u4ea7\u751f\u8fd0\u884c\u65f6\u9519\u8bef\uff0c\u56e0\u4e3a\u63a5\u53e3\u7684\u5143\u7ec4\u5185\u5e76\u672a\u5305\u542b\u80fd\u591f\u6307\u660e\u8be5\u8c03\u7528\u54ea\u4e2a \u5177\u4f53 \u65b9\u6cd5\u7684\u7c7b\u578b\u3002</p> <pre><code>package main\n\nimport \"fmt\"\n\ntype I interface {\n    M()\n}\n\nfunc main() {\n    var i I\n    describe(i)\n    i.M()\n}\n\nfunc describe(i I) {\n    fmt.Printf(\"(%v, %T)\\n\", i, i)\n}\n</code></pre>"},{"location":"go/%E6%8E%A5%E5%8F%A3interface/#_4","title":"\u7a7a\u63a5\u53e3","text":"<p>\u6307\u5b9a\u4e86\u96f6\u4e2a\u65b9\u6cd5\u7684\u63a5\u53e3\u503c\u88ab\u79f0\u4e3a \u7a7a\u63a5\u53e3\uff1a</p> <p><code>interface{}</code> \u7a7a\u63a5\u53e3\u53ef\u4fdd\u5b58\u4efb\u4f55\u7c7b\u578b\u7684\u503c\u3002\uff08\u56e0\u4e3a\u6bcf\u4e2a\u7c7b\u578b\u90fd\u81f3\u5c11\u5b9e\u73b0\u4e86\u96f6\u4e2a\u65b9\u6cd5\u3002\uff09</p> <p>\u7a7a\u63a5\u53e3\u88ab\u7528\u6765\u5904\u7406\u672a\u77e5\u7c7b\u578b\u7684\u503c\u3002\u4f8b\u5982\uff0cfmt.Print \u53ef\u63a5\u53d7\u7c7b\u578b\u4e3a interface{} \u7684\u4efb\u610f\u6570\u91cf\u7684\u53c2\u6570\u3002</p> <pre><code>package main\n\nimport \"fmt\"\n\nfunc main() {\n    var i interface{}\n    describe(i)\n\n    i = 42\n    describe(i)\n\n    i = \"hello\"\n    describe(i)\n}\n\nfunc describe(i interface{}) {\n    fmt.Printf(\"(%v, %T)\\n\", i, i)\n}\n</code></pre>"},{"location":"go/%E6%8E%A5%E5%8F%A3interface/#_5","title":"\u7c7b\u578b\u65ad\u8a00","text":"<p>\u7c7b\u578b\u65ad\u8a00 \u63d0\u4f9b\u4e86\u8bbf\u95ee\u63a5\u53e3\u503c\u5e95\u5c42\u5177\u4f53\u503c\u7684\u65b9\u5f0f\u3002</p> <p><code>t := i.(T)</code> \u8be5\u8bed\u53e5\u65ad\u8a00\u63a5\u53e3\u503c i \u4fdd\u5b58\u4e86\u5177\u4f53\u7c7b\u578b T\uff0c\u5e76\u5c06\u5176\u5e95\u5c42\u7c7b\u578b\u4e3a T \u7684\u503c\u8d4b\u4e88\u53d8\u91cf t\u3002</p> <p>\u82e5 i \u5e76\u672a\u4fdd\u5b58 T \u7c7b\u578b\u7684\u503c\uff0c\u8be5\u8bed\u53e5\u5c31\u4f1a\u89e6\u53d1\u4e00\u4e2a\u6050\u614c\u3002</p> <p>\u4e3a\u4e86 \u5224\u65ad \u4e00\u4e2a\u63a5\u53e3\u503c\u662f\u5426\u4fdd\u5b58\u4e86\u4e00\u4e2a\u7279\u5b9a\u7684\u7c7b\u578b\uff0c\u7c7b\u578b\u65ad\u8a00\u53ef\u8fd4\u56de\u4e24\u4e2a\u503c\uff1a\u5176\u5e95\u5c42\u503c\u4ee5\u53ca\u4e00\u4e2a\u62a5\u544a\u65ad\u8a00\u662f\u5426\u6210\u529f\u7684\u5e03\u5c14\u503c\u3002</p> <p><code>t, ok := i.(T)</code> \u82e5 i \u4fdd\u5b58\u4e86\u4e00\u4e2a T\uff0c\u90a3\u4e48 t \u5c06\u4f1a\u662f\u5176\u5e95\u5c42\u503c\uff0c\u800c ok \u4e3a true\u3002</p> <p>\u5426\u5219\uff0cok \u5c06\u4e3a false \u800c t \u5c06\u4e3a T \u7c7b\u578b\u7684\u96f6\u503c\uff0c\u7a0b\u5e8f\u5e76\u4e0d\u4f1a\u4ea7\u751f\u6050\u614c\u3002</p> <p>\u8bf7\u6ce8\u610f\u8fd9\u79cd\u8bed\u6cd5\u548c\u8bfb\u53d6\u4e00\u4e2a\u6620\u5c04\u65f6\u7684\u76f8\u540c\u4e4b\u5904\u3002</p> <pre><code>package main\n\nimport \"fmt\"\n\nfunc main() {\n    var i interface{} = \"hello\"\n\n    s := i.(string)\n    fmt.Println(s)\n\n    s, ok := i.(string)\n    fmt.Println(s, ok)\n\n    f, ok := i.(float64)\n    fmt.Println(f, ok)\n\n    f = i.(float64) // \u62a5\u9519(panic)\n    fmt.Println(f)\n}\n</code></pre>"},{"location":"go/%E6%8E%A5%E5%8F%A3interface/#_6","title":"\u7c7b\u578b\u9009\u62e9","text":"<p>\u7c7b\u578b\u9009\u62e9 \u662f\u4e00\u79cd\u6309\u987a\u5e8f\u4ece\u51e0\u4e2a\u7c7b\u578b\u65ad\u8a00\u4e2d\u9009\u62e9\u5206\u652f\u7684\u7ed3\u6784\u3002</p> <p>\u7c7b\u578b\u9009\u62e9\u4e0e\u4e00\u822c\u7684 switch \u8bed\u53e5\u76f8\u4f3c\uff0c\u4e0d\u8fc7\u7c7b\u578b\u9009\u62e9\u4e2d\u7684 case \u4e3a\u7c7b\u578b\uff08\u800c\u975e\u503c\uff09\uff0c \u5b83\u4eec\u9488\u5bf9\u7ed9\u5b9a\u63a5\u53e3\u503c\u6240\u5b58\u50a8\u7684\u503c\u7684\u7c7b\u578b\u8fdb\u884c\u6bd4\u8f83\u3002</p> <p><code>switch v := i.(type)</code> { case T: // v \u7684\u7c7b\u578b\u4e3a T case S: // v \u7684\u7c7b\u578b\u4e3a S default: // \u6ca1\u6709\u5339\u914d\uff0cv \u4e0e i \u7684\u7c7b\u578b\u76f8\u540c } \u7c7b\u578b\u9009\u62e9\u4e2d\u7684\u58f0\u660e\u4e0e\u7c7b\u578b\u65ad\u8a00 i.(T) \u7684\u8bed\u6cd5\u76f8\u540c\uff0c\u53ea\u662f\u5177\u4f53\u7c7b\u578b T \u88ab\u66ff\u6362\u6210\u4e86\u5173\u952e\u5b57 type\u3002</p> <p>\u6b64\u9009\u62e9\u8bed\u53e5\u5224\u65ad\u63a5\u53e3\u503c i \u4fdd\u5b58\u7684\u503c\u7c7b\u578b\u662f T \u8fd8\u662f S\u3002\u5728 T \u6216 S \u7684\u60c5\u51b5\u4e0b\uff0c\u53d8\u91cf v \u4f1a\u5206\u522b\u6309 T \u6216 S \u7c7b\u578b\u4fdd\u5b58 i \u62e5\u6709\u7684\u503c\u3002\u5728\u9ed8\u8ba4\uff08\u5373\u6ca1\u6709\u5339\u914d\uff09\u7684\u60c5\u51b5\u4e0b\uff0c\u53d8\u91cf v \u4e0e i \u7684\u63a5\u53e3\u7c7b\u578b\u548c\u503c\u76f8\u540c\u3002</p> <pre><code>package main\n\nimport \"fmt\"\n\nfunc do(i interface{}) {\n    switch v := i.(type) {\n    case int:\n        fmt.Printf(\"Twice %v is %v\\n\", v, v*2)\n    case string:\n        fmt.Printf(\"%q is %v bytes long\\n\", v, len(v))\n    default:\n        fmt.Printf(\"I don't know about type %T!\\n\", v)\n    }\n}\n\nfunc main() {\n    do(21)\n    do(\"hello\")\n    do(true)\n}\n</code></pre>"},{"location":"go/%E6%8E%A5%E5%8F%A3interface/#stringer","title":"Stringer","text":"<p>fmt \u5305\u4e2d\u5b9a\u4e49\u7684 Stringer \u662f\u6700\u666e\u904d\u7684\u63a5\u53e3\u4e4b\u4e00\u3002</p> <pre><code>type Stringer interface {\n    String() string\n}\n</code></pre> <p>Stringer \u662f\u4e00\u4e2a\u53ef\u4ee5\u7528\u5b57\u7b26\u4e32\u63cf\u8ff0\u81ea\u5df1\u7684\u7c7b\u578b\u3002fmt \u5305\uff08\u8fd8\u6709\u5f88\u591a\u5305\uff09\u90fd\u901a\u8fc7\u6b64\u63a5\u53e3\u6765\u6253\u5370\u503c\u3002</p> <pre><code>package main\n\nimport \"fmt\"\n\ntype Person struct {\n    Name string\n    Age  int\n}\n\nfunc (p Person) String() string {\n    return fmt.Sprintf(\"%v (%v years)\", p.Name, p.Age)\n}\n\nfunc main() {\n    a := Person{\"Arthur Dent\", 42}\n    z := Person{\"Zaphod Beeblebrox\", 9001}\n    fmt.Println(a, z)\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/","title":"\u6570\u636e\u7c7b\u578b","text":""},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#types","title":"Types","text":"<p>Go \u662f\u9759\u6001\u7c7b\u578b\u7684\uff0c\u8fd9\u610f\u5473\u7740\u4e00\u65e6\u5b9a\u4e49\u4e86\u53d8\u91cf\u7c7b\u578b\uff0c\u5b83\u5c31\u53ea\u80fd\u5b58\u50a8\u8be5\u7c7b\u578b\u7684\u6570\u636e\u3002</p>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#go","title":"Go \u7684\u57fa\u672c\u7c7b\u578b","text":"Type Description <code>bool</code> <code>string</code> <code>int  int8  int16  int32  int64</code> <code>uint uint8 uint16 uint32 uint64 uintptr</code> <code>byte</code> uint8 \u7684\u522b\u540d <code>rune</code> int32 \u7684\u522b\u540d,\u8868\u793a\u4e00\u4e2a Unicode \u7801\u70b9 <code>float32 float64</code> <code>complex64 complex128</code>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#_1","title":"\u7c7b\u578b\u8f6c\u6362","text":"<pre><code>//\u8868\u8fbe\u5f0f T(v) \u5c06\u503c v \u8f6c\u6362\u4e3a\u7c7b\u578b T\u3002\nvar i int = 42\nvar f float64 = float64(i)\nvar u uint = uint(f)\n\ni := 42\nf := float64(i)\nu := uint(f)\n\n\npackage main\n\nimport (\n    \"fmt\"\n    \"math\"\n)\n\nfunc main() {\n    var x, y int = 3, 4\n    var f float64 = math.Sqrt(float64(x*x + y*y))\n    var z uint = f\n    fmt.Println(x, y, z)\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#boolean","title":"Boolean","text":"<pre><code>package main\nimport (\"fmt\")\n\n\nfunc main() {\n  var b1 bool = true // typed declaration with initial value\n  var b2 = true // untyped declaration with initial value\n  var b3 bool // typed declaration without initial value\n  b4 := true // untyped declaration with initial value\n\n  fmt.Println(b1) // Returns true\n  fmt.Println(b2) // Returns true\n  fmt.Println(b3) // Returns false\n  fmt.Println(b4) // Returns true\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#integer","title":"Integer","text":"<p>Info</p> <ul> <li>Signed integers - can store both positive and negative values</li> <li>Unsigned integers - can only store non-negative values</li> </ul> <pre><code>package main\nimport (\"fmt\")\n\n//Signed integers\nfunc main() {\n  var x int = 500\n  var y int = -4500\n  fmt.Printf(\"Type: %T, value: %v\", x, x)\n  fmt.Printf(\"Type: %T, value: %v\", y, y)\n}\n</code></pre> <p></p> <pre><code>package main\nimport (\"fmt\")\n//Unsigned Integers\nfunc main() {\n  var x uint = 500\n  var y uint = 4500\n  fmt.Printf(\"Type: %T, value: %v\", x, x)\n  fmt.Printf(\"Type: %T, value: %v\", y, y)\n}\n</code></pre> <p></p>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#float","title":"Float","text":"<p>\u6d6e\u70b9\u6570\u636e\u7c7b\u578b\u7528\u4e8e\u5b58\u50a8\u5e26\u5c0f\u6570\u70b9\u7684\u6b63\u6570\u548c\u8d1f\u6570\uff0c\u4f8b\u5982 35.3\u3001-2.34 \u6216 3597.34987</p> <p></p> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var x float64 = 1.7e+308\n  var y float32 = 3.4e+38\n  fmt.Printf(\"Type: %T, value: %v\", x, x)\n  fmt.Printf(\"Type: %T, value: %v\", y, y)\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#string","title":"String","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var txt1 string = \"Hello!\"\n  var txt2 string\n  txt3 := \"World 1\"\n\n  fmt.Printf(\"Type: %T, value: %v\\n\", txt1, txt1)\n  fmt.Printf(\"Type: %T, value: %v\\n\", txt2, txt2)\n  fmt.Printf(\"Type: %T, value: %v\\n\", txt3, txt3)\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#array","title":"Array","text":"<p>\u6570\u7ec4\u7528\u4e8e\u5728\u5355\u4e2a\u53d8\u91cf\u4e2d\u5b58\u50a8\u76f8\u540c\u7c7b\u578b\u7684\u591a\u4e2a\u503c\uff0c\u800c\u4e0d\u662f\u4e3a\u6bcf\u4e2a\u503c\u58f0\u660e\u5355\u72ec\u7684\u53d8\u91cf</p> \u65b9\u5f0f\u4e00\u65b9\u5f0f\u4e8cExample1Example2Example3 <pre><code>var array_name = [length]datatype{values} // here length is defined\n\nor\n\nvar array_name = [...]datatype{values} // here length is inferred\n</code></pre> <pre><code>//\narray_name := [length]datatype{values} // here length is defined\n\nor\n\narray_name := [...]datatype{values} // here length is inferred\n</code></pre> <pre><code>package main\n\nimport (\n    \"fmt\"\n)\n\nfunc main() {\n    var arr1 = [3]int{1, 2, 3}\n    arr2 := [5]int{4, 5, 6, 7, 8}\n\n    fmt.Println(arr1)\n    fmt.Println(arr2)\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var arr1 = [...]int{1,2,3}\n  arr2 := [...]int{4,5,6,7,8}\n\n  fmt.Println(arr1)\n  fmt.Println(arr2)\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var cars = [4]string{\"Volvo\", \"BMW\", \"Ford\", \"Mazda\"}\n  fmt.Print(cars)\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#_2","title":"\u83b7\u53d6\u6570\u7ec4\u4e2d\u7684\u5143\u7d20","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  prices := [3]int{10,20,30}\n\n  fmt.Println(prices[0])\n  fmt.Println(prices[2])\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#_3","title":"\u4fee\u6539\u6570\u7ec4\u4e2d\u7684\u5143\u7d20","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  prices := [3]int{10,20,30}\n\n  prices[2] = 50\n  fmt.Println(prices)\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#_4","title":"\u6570\u7ec4\u521d\u59cb\u5316","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n)\n//\u5982\u679c\u6570\u7ec4\u6216\u5176\u5143\u7d20\u4e4b\u4e00\u5c1a\u672a\u5728\u4ee3\u7801\u4e2d\u521d\u59cb\u5316\uff0c\u5219\u4f1a\u4e3a\u5176\u5206\u914d\u5176\u7c7b\u578b\u7684\u9ed8\u8ba4\u503c\u3002\nfunc main() {\n    arr1 := [5]int{}              //not initialized\n    arr2 := [5]int{1, 2}          //partially initialized\n    arr3 := [5]int{1, 2, 3, 4, 5} //fully initialized\n\n    fmt.Println(arr1)\n    fmt.Println(arr2)\n    fmt.Println(arr3)\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#_5","title":"\u521d\u59cb\u5316\u6307\u5b9a\u5143\u7d20","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  arr1 := [5]int{1:10,2:40}\n\n  fmt.Println(arr1)\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#_6","title":"\u83b7\u53d6\u6570\u636e\u957f\u5ea6","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  arr1 := [4]string{\"Volvo\", \"BMW\", \"Ford\", \"Mazda\"}\n  arr2 := [...]int{1,2,3,4,5,6}\n\n  fmt.Println(len(arr1))\n  fmt.Println(len(arr2))\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#slices","title":"\u5207\u7247Slices","text":"<p>Info</p> <ul> <li>\u7c7b\u4f3c\u4e8e\u6570\u7ec4\uff0c\u5728\u5355\u4e2a\u53d8\u91cf\u4e2d\u58f0\u660e\u591a\u4e2avalues\uff0c\u4f46\u5207\u7247\u7684\u957f\u5ea6\u53ef\u4ee5\u6839\u636e\u9700\u8981\u589e\u51cf</li> <li>\u5207\u7247\u5c31\u50cf\u6570\u7ec4\u7684\u5f15\u7528\u3002\u5207\u7247\u5e76\u4e0d\u5b58\u50a8\u4efb\u4f55\u6570\u636e\uff0c\u5b83\u53ea\u662f\u63cf\u8ff0\u4e86\u5e95\u5c42\u6570\u7ec4\u4e2d\u7684\u4e00\u6bb5\u3002</li> <li>\u66f4\u6539\u5207\u7247\u7684\u5143\u7d20\u4f1a\u4fee\u6539\u5176\u5e95\u5c42\u6570\u7ec4\u4e2d\u5bf9\u5e94\u7684\u5143\u7d20\u3002</li> <li>\u4e0e\u5b83\u5171\u4eab\u5e95\u5c42\u6570\u7ec4\u7684\u5207\u7247\u90fd\u4f1a\u89c2\u6d4b\u5230\u8fd9\u4e9b\u4fee\u6539\u3002</li> </ul> \u53ef\u7528\u4ee5\u4e0b\u65b9\u5f0f\u521b\u5efasliceExample <pre><code>Using the []datatype{values} format\nCreate a slice from an array\nUsing the make() function\n</code></pre> <pre><code>slice_name := []datatype{values}\n\nmyslice := []int{} //\u7a7a\u503cslice\n\nvar myslice []int  //\u96f6\u503cslice\uff0cslice\u7684\u96f6\u503c\u662fnil\n\nmyslice := []int{1,2,3}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\n//\u83b7\u53d6slice\u7684\u957f\u5ea6\u548c\u5bb9\u91cf\nfunc main() {\n  myslice1 := []int{}\n  fmt.Println(len(myslice1))\n  fmt.Println(cap(myslice1))\n  fmt.Println(myslice1)\n\n  myslice2 := []string{\"Go\", \"Slices\", \"Are\", \"Powerful\"}\n  fmt.Println(len(myslice2))\n  fmt.Println(cap(myslice2))\n  fmt.Println(myslice2)\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#_7","title":"\u4ece\u6570\u7ec4\u521b\u5efa\u5207\u7247","text":"<p>Info</p> <p>\u5207\u7247\u4ece\u6570\u7ec4\u7684\u7b2c\u4e8c\u4e2a\u5143\u7d20\u5f00\u59cb\uff0c\u503c\u4e3a 12\u3002\u5207\u7247\u53ef\u4ee5\u589e\u957f\u5230\u6570\u7ec4\u7684\u672b\u5c3e\u3002\u8fd9\u610f\u5473\u7740\u5207\u7247\u7684\u5bb9\u91cf\u4e3a 4\u3002\u5982\u679c myslice \u4ece\u5143\u7d20 0 \u5f00\u59cb\uff0c\u5219\u5207\u7247\u5bb9\u91cf\u5c06\u4e3a 6\u3002</p> <pre><code>var myarray = [length]datatype{values} // An array\nmyslice := myarray[start:end] // A slice made from the arra\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  arr1 := [6]int{10, 11, 12, 13, 14,15}\n  myslice := arr1[2:4] //\u5b83\u4f1a\u9009\u62e9\u4e00\u4e2a\u534a\u5f00\u533a\u95f4\uff0c\u5305\u62ec\u7b2c\u4e00\u4e2a\u5143\u7d20\uff0c\u4f46\u6392\u9664\u6700\u540e\u4e00\u4e2a\u5143\u7d20\u3002\n\n  fmt.Printf(\"myslice = %v\\n\", myslice)\n  fmt.Printf(\"length = %d\\n\", len(myslice))\n  fmt.Printf(\"capacity = %d\\n\", cap(myslice))\n}\n</code></pre> <p>Note</p> <p>\u5bf9\u4e8e\u6570\u7ec4 <code>var a [10]int</code> \u6765\u8bf4\uff0c\u4ee5\u4e0b\u5207\u7247\u662f\u7b49\u4ef7\u7684\uff1a <code>a[0:10]</code> <code>a[:10]</code> <code>a[0:]</code> <code>a[:]</code></p>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#slice","title":"\u76f4\u63a5\u521b\u5efaslice","text":"<pre><code>[3]bool{true, true, false}\n\n//\u76f4\u63a5\u5b9a\u4e49\u4e00\u4e2aslice\uff0c\u5373\u6ca1\u6709\u4ece\u6570\u7ec4\u4e2d\u521b\u5efaslice\u65f6\uff0c\u76f8\u5f53\u4e8e\u521b\u5efa\u4e00\u4e2a\u548c\u4e0a\u9762\u76f8\u540c\u7684\u6570\u7ec4\uff0c\u7136\u540e\u6784\u5efa\u4e00\u4e2a\u5f15\u7528\u4e86\u5b83\u7684\u5207\u7247\n[]bool{true, true, false}\n</code></pre> <pre><code>//\u4f7f\u7528 make() \u51fd\u6570\u521b\u5efa\u5207\u7247.\u5982\u679c capacity \u53c2\u6570\u6ca1\u6709\u5b9a\u4e49\uff0c\u5219\u7b49\u4e8e length\u3002\nslice_name := make([]type, length, capacity)\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  myslice1 := make([]int, 5, 10)\n  fmt.Printf(\"myslice1 = %v\\n\", myslice1)\n  fmt.Printf(\"length = %d\\n\", len(myslice1))\n  fmt.Printf(\"capacity = %d\\n\", cap(myslice1))\n\n  // with omitted capacity\n  myslice2 := make([]int, 5)\n  fmt.Printf(\"myslice2 = %v\\n\", myslice2)\n  fmt.Printf(\"length = %d\\n\", len(myslice2))\n  fmt.Printf(\"capacity = %d\\n\", cap(myslice2))\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#slice_1","title":"\u4eceslice\u4e2d\u83b7\u53d6\u5143\u7d20","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  prices := []int{10,20,30}\n\n  fmt.Println(prices[0])\n  fmt.Println(prices[2])\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#slice_2","title":"\u4fee\u6539slice\u4e2d\u7684\u5143\u7d20","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  prices := []int{10,20,30}\n  prices[2] = 50\n  fmt.Println(prices[0])\n  fmt.Println(prices[2])\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#slice_3","title":"\u5411slice\u4e2d\u8ffd\u52a0","text":"<pre><code>slice_name = append(slice_name, element1, element2, ...)\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  myslice1 := []int{1, 2, 3, 4, 5, 6}\n  fmt.Printf(\"myslice1 = %v\\n\", myslice1)\n  fmt.Printf(\"length = %d\\n\", len(myslice1))\n  fmt.Printf(\"capacity = %d\\n\", cap(myslice1))\n\n  myslice1 = append(myslice1, 20, 21)\n  fmt.Printf(\"myslice1 = %v\\n\", myslice1)\n  fmt.Printf(\"length = %d\\n\", len(myslice1))\n  fmt.Printf(\"capacity = %d\\n\", cap(myslice1))\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#sliceslice","title":"\u5c06\u4e00\u4e2aslice\u8ffd\u52a0\u5230\u53e6\u4e00\u4e2aslice","text":"<pre><code>//\u5c06\u4e00\u4e2a\u5207\u7247\u7684\u5143\u7d20\u9644\u52a0\u5230\u53e6\u4e00\u4e2a\u5207\u7247\u65f6\uff0cslice2 \u4e4b\u540e\u7684\u201c...\u201d\u662f\u5fc5\u9700\u7684\u3002\nslice3 = append(slice1, slice2...)\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  myslice1 := []int{1,2,3}\n  myslice2 := []int{4,5,6}\n  myslice3 := append(myslice1, myslice2...)\n\n  fmt.Printf(\"myslice3=%v\\n\", myslice3)\n  fmt.Printf(\"length=%d\\n\", len(myslice3))\n  fmt.Printf(\"capacity=%d\\n\", cap(myslice3))\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#slice_4","title":"\u4fee\u6539slice\u7684\u957f\u5ea6","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  arr1 := [6]int{9, 10, 11, 12, 13, 14} // An array\n  myslice1 := arr1[1:5] // Slice array\n  fmt.Printf(\"myslice1 = %v\\n\", myslice1)\n  fmt.Printf(\"length = %d\\n\", len(myslice1))\n  fmt.Printf(\"capacity = %d\\n\", cap(myslice1))\n\n  myslice1 = arr1[1:3] // Change length by re-slicing the array\n  fmt.Printf(\"myslice1 = %v\\n\", myslice1)\n  fmt.Printf(\"length = %d\\n\", len(myslice1))\n  fmt.Printf(\"capacity = %d\\n\", cap(myslice1))\n\n  myslice1 = append(myslice1, 20, 21, 22, 23) // Change length by appending items\n  fmt.Printf(\"myslice1 = %v\\n\", myslice1)\n  fmt.Printf(\"length = %d\\n\", len(myslice1))\n  fmt.Printf(\"capacity = %d\\n\", cap(myslice1))\n}\n</code></pre> <pre><code>package main\n\nimport \"fmt\"\n\nfunc main() {\n    s := []int{2, 3, 5, 7, 11, 13}\n    printSlice(s)\n\n    // \u622a\u53d6\u5207\u7247\u4f7f\u5176\u957f\u5ea6\u4e3a 0\n    s = s[:0]\n    printSlice(s)\n\n    // \u62d3\u5c55\u5176\u957f\u5ea6\n    s = s[:4]\n    printSlice(s)\n\n    // \u820d\u5f03\u524d\u4e24\u4e2a\u503c\n    s = s[2:]\n    printSlice(s)\n}\n\nfunc printSlice(s []int) {\n    fmt.Printf(\"len=%d cap=%d %v\\n\", len(s), cap(s), s)\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#_8","title":"\u5185\u5b58\u4f18\u5316","text":"<p>\u5982\u679c\u6570\u7ec4\u5f88\u5927\u800c\u53ea\u9700\u8981\u51e0\u4e2a\u5143\u7d20\uff0c\u6700\u597d\u4f7f\u7528 copy() \u51fd\u6570\u590d\u5236\u8fd9\u4e9b\u5143\u7d20\u3002copy() \u51fd\u6570\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5e95\u5c42\u6570\u7ec4\uff0c\u5176\u4e2d\u4ec5\u5305\u542b\u5207\u7247\u6240\u9700\u7684\u5143\u7d20\u3002\u8fd9\u5c06\u51cf\u5c11\u7a0b\u5e8f\u4f7f\u7528\u7684\u5185\u5b58\u3002</p> <pre><code>copy(dest, src)\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  numbers := []int{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15}\n  // Original slice\n  fmt.Printf(\"numbers = %v\\n\", numbers)\n  fmt.Printf(\"length = %d\\n\", len(numbers))\n  fmt.Printf(\"capacity = %d\\n\", cap(numbers))\n\n  // Create copy with only needed numbers\n  neededNumbers := numbers[:len(numbers)-10]\n  numbersCopy := make([]int, len(neededNumbers))\n  copy(numbersCopy, neededNumbers)\n\n  fmt.Printf(\"numbersCopy = %v\\n\", numbersCopy)\n  fmt.Printf(\"length = %d\\n\", len(numbersCopy))\n  fmt.Printf(\"capacity = %d\\n\", cap(numbersCopy))\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#_9","title":"\u6bd4\u8f83","text":""},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#slice_5","title":"\u6bd4\u8f83\u4e24\u4e2aslice","text":"<pre><code>package main\n\nfunc equalWithStringSlice(a, b []string) bool {\n    if len(a) != len(b) { // \u957f\u5ea6\u4e0d\u540c\uff0c\u76f4\u63a5\u8fd4\u56de false\n        return false\n    }\n\n    if (a == nil) != (b == nil) {\n        return false\n    }\n\n    for i, v := range a { // \u6bcf\u4e2a\u5143\u7d20\u9010\u4e00\u6bd4\u8f83\n        if v != b[i] {\n            return false\n        }\n    }\n    return true\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#struct","title":"\u6bd4\u8f83\u4e24\u4e2astruct","text":"<pre><code>// \u540c\u4e00\u4e2astruct\u7684\u4e24\u4e2a\u5b9e\u4f8b\u53ef\u6bd4\u8f83\u4e5f\u4e0d\u53ef\u6bd4\u8f83\uff0c\u5f53\u7ed3\u6784\u4e0d\u5305\u542b\u4e0d\u53ef\u76f4\u63a5\u6bd4\u8f83\u6210\u5458\u53d8\u91cf\u65f6\u53ef\u76f4\u63a5\u6bd4\u8f83\uff0c\u5426\u5219\u4e0d\u53ef\u76f4\u63a5\u6bd4\u8f83\u3002\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528reflect.DeepEqual\ntype S struct {\n    Name    string\n    Age     int\n    Address *int\n}\n\nfunc main() {\n    a := S{\n        Name:    \"aa\",\n        Age:     1,\n        Address: new(int),\n    }\n    b := S{\n        Name:    \"aa\",\n        Age:     1,\n        Address: new(int),\n    }\n\n   fmt.Println(a == b)\n}\n</code></pre>"},{"location":"go/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/#reflectdeepequal","title":"reflect.DeepEqual\u6bd4\u8f83\u4efb\u610f\u53d8\u91cf","text":"<pre><code>// \u8fd9\u79cd\u65b9\u6cd5\u867d\u7136\u5f88\u7b80\u6d01\uff0c\u4f46\u662f\u7531\u4e8e\u4f7f\u7528\u4e86\u53cd\u5c04\u548c\u9012\u5f52\uff0c\u6548\u7387\u6bd4\u8f83\u4f4e\u3002\npackage main\n\nimport \"reflect\"\n\nfunc equalWithReflect(a, b []int) bool {\n    return reflect.DeepEqual(a, b)\n}\n</code></pre>"},{"location":"go/%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/","title":"\u6587\u4ef6\u548c\u76ee\u5f55","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"os\"\n)\n\nfunc main() {\n\n    f := createFile(\"/tmp/defer.txt\")\n    defer closeFile(f)\n    writeFile(f)\n}\n\nfunc createFile(p string) *os.File {\n    fmt.Println(\"creating\")\n    f, err := os.Create(p)\n    if err != nil {\n        panic(err)\n    }\n    return f\n}\n\nfunc writeFile(f *os.File) {\n    fmt.Println(\"writing\")\n    fmt.Fprintln(f, \"data\")\n\n}\n\nfunc closeFile(f *os.File) {\n    fmt.Println(\"closing\")\n    err := f.Close()\n\n    if err != nil {\n        fmt.Fprintf(os.Stderr, \"error: %v\\n\", err)\n        os.Exit(1)\n    }\n}\n</code></pre>"},{"location":"go/%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/#_1","title":"\u8bfb\u53d6\u6587\u4ef6","text":"<pre><code>package main\n\nimport (\n    \"bufio\"\n    \"fmt\"\n    \"io\"\n    \"os\"\n)\n\nfunc check(e error) {\n    if e != nil {\n        panic(e)\n    }\n}\n\nfunc main() {\n\n    dat, err := os.ReadFile(\"/tmp/dat\")\n    check(err)\n    fmt.Print(string(dat))\n\n    f, err := os.Open(\"/tmp/dat\")\n    check(err)\n\n    b1 := make([]byte, 5)\n    n1, err := f.Read(b1)\n    check(err)\n    fmt.Printf(\"%d bytes: %s\\n\", n1, string(b1[:n1]))\n\n    o2, err := f.Seek(6, 0)\n    check(err)\n    b2 := make([]byte, 2)\n    n2, err := f.Read(b2)\n    check(err)\n    fmt.Printf(\"%d bytes @ %d: \", n2, o2)\n    fmt.Printf(\"%v\\n\", string(b2[:n2]))\n\n    o3, err := f.Seek(6, 0)\n    check(err)\n    b3 := make([]byte, 2)\n    n3, err := io.ReadAtLeast(f, b3, 2)\n    check(err)\n    fmt.Printf(\"%d bytes @ %d: %s\\n\", n3, o3, string(b3))\n\n    _, err = f.Seek(0, 0)\n    check(err)\n\n    r4 := bufio.NewReader(f)\n    b4, err := r4.Peek(5)\n    check(err)\n    fmt.Printf(\"5 bytes: %s\\n\", string(b4))\n\n    f.Close()\n}\n</code></pre>"},{"location":"go/%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/#_2","title":"\u5199\u5165\u6587\u4ef6","text":"<pre><code>package main\n\nimport (\n    \"bufio\"\n    \"fmt\"\n    \"os\"\n)\n\nfunc check(e error) {\n    if e != nil {\n        panic(e)\n    }\n}\n\nfunc main() {\n\n    d1 := []byte(\"hello\\ngo\\n\")\n    err := os.WriteFile(\"/tmp/dat1\", d1, 0644)\n    check(err)\n\n    f, err := os.Create(\"/tmp/dat2\")\n    check(err)\n\n    defer f.Close()\n\n    d2 := []byte{115, 111, 109, 101, 10}\n    n2, err := f.Write(d2)\n    check(err)\n    fmt.Printf(\"wrote %d bytes\\n\", n2)\n\n    n3, err := f.WriteString(\"writes\\n\")\n    check(err)\n    fmt.Printf(\"wrote %d bytes\\n\", n3)\n\n    f.Sync()  //\u53d1\u51fa Sync \u4ee5\u5c06\u5199\u5165\u5237\u65b0\u5230\u7a33\u5b9a\u5b58\u50a8\u3002\n\n    w := bufio.NewWriter(f)\n    n4, err := w.WriteString(\"buffered\\n\")\n    check(err)\n    fmt.Printf(\"wrote %d bytes\\n\", n4)\n\n    w.Flush()  //\u4f7f\u7528 Flush \u786e\u4fdd\u6240\u6709\u7f13\u51b2\u64cd\u4f5c\u90fd\u5df2\u5e94\u7528\u4e8e\u5e95\u5c42\u7f16\u5199\u5668\u3002\n\n}\n</code></pre>"},{"location":"go/%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/#filepath","title":"\u6587\u4ef6\u8def\u5f84 filepath","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"path/filepath\"\n    \"strings\"\n)\n\nfunc main() {\n\n    p := filepath.Join(\"dir1\", \"dir2\", \"filename\")\n    fmt.Println(\"p:\", p)\n\n    fmt.Println(filepath.Join(\"dir1//\", \"filename\"))\n    fmt.Println(filepath.Join(\"dir1/../dir1\", \"filename\"))\n\n    fmt.Println(\"Dir(p):\", filepath.Dir(p))\n    fmt.Println(\"Base(p):\", filepath.Base(p))\n\n    fmt.Println(filepath.IsAbs(\"dir/file\"))\n    fmt.Println(filepath.IsAbs(\"/dir/file\"))\n\n    filename := \"config.json\"\n\n    ext := filepath.Ext(filename)\n    fmt.Println(ext)\n\n    fmt.Println(strings.TrimSuffix(filename, ext))\n\n    //Rel \u67e5\u627e\u57fa\u548c\u76ee\u6807\u4e4b\u95f4\u7684\u76f8\u5bf9\u8def\u5f84\u3002\u5982\u679c target \u4e0d\u80fd\u76f8\u5bf9\u4e8e base\uff0c\u5b83\u4f1a\u8fd4\u56de\u4e00\u4e2a\u9519\u8bef\u3002\n    rel, err := filepath.Rel(\"a/b\", \"a/b/t/file\")\n    if err != nil {\n        panic(err)\n    }\n    fmt.Println(rel)\n\n    rel, err = filepath.Rel(\"a/b\", \"a/c/t/file\")\n    if err != nil {\n        panic(err)\n    }\n    fmt.Println(rel)\n}\n</code></pre>"},{"location":"go/%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/#directories","title":"\u76ee\u5f55Directories","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"os\"\n    \"path/filepath\"\n)\n\nfunc check(e error) {\n    if e != nil {\n        panic(e)\n    }\n}\n\nfunc main() {\n\n    err := os.Mkdir(\"subdir\", 0755)\n    check(err)\n\n    defer os.RemoveAll(\"subdir\")\n\n    createEmptyFile := func(name string) {\n        d := []byte(\"\")\n        check(os.WriteFile(name, d, 0644))\n    }\n\n    createEmptyFile(\"subdir/file1\")\n\n    err = os.MkdirAll(\"subdir/parent/child\", 0755)\n    check(err)\n\n    createEmptyFile(\"subdir/parent/file2\")\n    createEmptyFile(\"subdir/parent/file3\")\n    createEmptyFile(\"subdir/parent/child/file4\")\n\n    c, err := os.ReadDir(\"subdir/parent\")\n    check(err)\n\n    fmt.Println(\"Listing subdir/parent\")\n    for _, entry := range c {\n        fmt.Println(\" \", entry.Name(), entry.IsDir())\n    }\n\n    err = os.Chdir(\"subdir/parent/child\")\n    check(err)\n\n    c, err = os.ReadDir(\".\")\n    check(err)\n\n    fmt.Println(\"Listing subdir/parent/child\")\n    for _, entry := range c {\n        fmt.Println(\" \", entry.Name(), entry.IsDir())\n    }\n\n    err = os.Chdir(\"../../..\")\n    check(err)\n\n    fmt.Println(\"Visiting subdir\")\n    err = filepath.Walk(\"subdir\", visit) //\u4e3a filepath.Walk \u9012\u5f52\u627e\u5230\u7684\u6bcf\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\u8c03\u7528 visit\u3002\n}\n\nfunc visit(p string, info os.FileInfo, err error) error {\n    if err != nil {\n        return err\n    }\n    fmt.Println(\" \", p, info.IsDir())\n    return nil\n}\n</code></pre>"},{"location":"go/%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/#_3","title":"\u4e34\u65f6\u6587\u4ef6\u548c\u76ee\u5f55","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"os\"\n    \"path/filepath\"\n)\n\nfunc check(e error) {\n    if e != nil {\n        panic(e)\n    }\n}\n\nfunc main() {\n\n    f, err := os.CreateTemp(\"\", \"sample\")\n    check(err)\n\n    fmt.Println(\"Temp file name:\", f.Name())\n\n    defer os.Remove(f.Name())\n\n    _, err = f.Write([]byte{1, 2, 3, 4})\n    check(err)\n\n    dname, err := os.MkdirTemp(\"\", \"sampledir\")\n    check(err)\n    fmt.Println(\"Temp dir name:\", dname)\n\n    defer os.RemoveAll(dname)\n\n    fname := filepath.Join(dname, \"file1\")\n    err = os.WriteFile(fname, []byte{1, 2}, 0666)\n    check(err)\n}\n</code></pre>"},{"location":"go/%E6%96%87%E6%9C%AC%E6%A8%A1%E6%9D%BF/","title":"\u6587\u672c\u6a21\u677f","text":""},{"location":"go/%E6%96%87%E6%9C%AC%E6%A8%A1%E6%9D%BF/#_1","title":"\u6587\u672c\u6a21\u677f","text":"<pre><code>package main\n\nimport (\n    \"os\"\n    \"text/template\"\n)\n\nfunc main() {\n\n    t1 := template.New(\"t1\")\n    t1, err := t1.Parse(\"Value is {{.}}\\n\")\n    if err != nil {\n        panic(err)\n    }\n\n    t1 = template.Must(t1.Parse(\"Value: {{.}}\\n\"))\n\n    t1.Execute(os.Stdout, \"some text\")\n    t1.Execute(os.Stdout, 5)\n    t1.Execute(os.Stdout, []string{\n        \"Go\",\n        \"Rust\",\n        \"C++\",\n        \"C#\",\n    })\n\n    Create := func(name, t string) *template.Template {\n        return template.Must(template.New(name).Parse(t))\n    }\n\n    t2 := Create(\"t2\", \"Name: {{.Name}}\\n\")\n\n    t2.Execute(os.Stdout, struct {\n        Name string\n    }{\"Jane Doe\"})\n\n    t2.Execute(os.Stdout, map[string]string{\n        \"Name\": \"Mickey Mouse\",\n    })\n\n    t3 := Create(\"t3\",\n        \"{{if . -}} yes {{else -}} no {{end}}\\n\")\n    t3.Execute(os.Stdout, \"not empty\")\n    t3.Execute(os.Stdout, \"\")\n\n    t4 := Create(\"t4\",\n        \"Range: {{range .}}{{.}} {{end}}\\n\")\n    t4.Execute(os.Stdout,\n        []string{\n            \"Go\",\n            \"Rust\",\n            \"C++\",\n            \"C#\",\n        })\n}\n</code></pre>"},{"location":"go/%E6%96%B9%E6%B3%95/","title":"\u65b9\u6cd5","text":""},{"location":"go/%E6%96%B9%E6%B3%95/#_1","title":"\u65b9\u6cd5","text":"<p>Info</p> <ul> <li> <p>Go \u6ca1\u6709\u7c7b\u3002\u4e0d\u8fc7\u4f60\u53ef\u4ee5\u4e3a\u7ed3\u6784\u4f53\u7c7b\u578b\u5b9a\u4e49\u65b9\u6cd5\u3002</p> </li> <li> <p>\u65b9\u6cd5\u5c31\u662f\u4e00\u7c7b\u5e26\u7279\u6b8a\u7684 \u63a5\u6536\u8005 \u53c2\u6570\u7684\u51fd\u6570\u3002</p> </li> <li> <p>\u65b9\u6cd5\u63a5\u6536\u8005\u5728\u5b83\u81ea\u5df1\u7684\u53c2\u6570\u5217\u8868\u5185\uff0c\u4f4d\u4e8e func \u5173\u952e\u5b57\u548c\u65b9\u6cd5\u540d\u4e4b\u95f4\u3002</p> </li> </ul> <pre><code>//\u5728\u6b64\u4f8b\u4e2d\uff0cAbs \u65b9\u6cd5\u62e5\u6709\u4e00\u4e2a\u540d\u4e3a v\uff0c\u7c7b\u578b\u4e3a Vertex \u7684\u63a5\u6536\u8005\u3002\npackage main\n\nimport (\n    \"fmt\"\n    \"math\"\n)\n\ntype Vertex struct {\n    X, Y float64\n}\n\nfunc (v Vertex) Abs() float64 {\n    return math.Sqrt(v.X*v.X + v.Y*v.Y)\n}\n\nfunc main() {\n    v := Vertex{3, 4}\n    fmt.Println(v.Abs())\n}\n</code></pre>"},{"location":"go/%E6%96%B9%E6%B3%95/#_2","title":"\u65b9\u6cd5\u5373\u51fd\u6570","text":"\u6b63\u5e38\u51fd\u6570\u4e5f\u53ef\u4ee5\u4e3a\u975e\u7ed3\u6784\u4f53\u7c7b\u578b\u58f0\u660e\u65b9\u6cd5 <pre><code>//\u8fd9\u4e2a Abs \u7684\u5199\u6cd5\u5c31\u662f\u4e2a\u6b63\u5e38\u7684\u51fd\u6570\uff0c\u529f\u80fd\u5e76\u6ca1\u6709\u4ec0\u4e48\u53d8\u5316\npackage main\n\nimport (\n    \"fmt\"\n    \"math\"\n)\n\ntype Vertex struct {\n    X, Y float64\n}\n\nfunc Abs(v Vertex) float64 {\n    return math.Sqrt(v.X*v.X + v.Y*v.Y)\n}\n\nfunc main() {\n    v := Vertex{3, 4}\n    fmt.Println(Abs(v))\n}\n</code></pre> <pre><code>//\u4e5f\u53ef\u4ee5\u4e3a\u975e\u7ed3\u6784\u4f53\u7c7b\u578b\u58f0\u660e\u65b9\u6cd5\npackage main\n\nimport (\n    \"fmt\"\n    \"math\"\n)\n\ntype MyFloat float64\n\nfunc (f MyFloat) Abs() float64 {\n    if f &lt; 0 {\n        return float64(-f)\n    }\n    return float64(f)\n}\n\nfunc main() {\n    f := MyFloat(-math.Sqrt2)\n    fmt.Println(f.Abs())\n}\n</code></pre>"},{"location":"go/%E6%96%B9%E6%B3%95/#_3","title":"\u6307\u9488\u63a5\u6536\u8005","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"math\"\n)\n\ntype Vertex struct {\n    X, Y float64\n}\n//\u503c\u63a5\u6536\u8005\nfunc (v Vertex) Abs() float64 {\n    return math.Sqrt(v.X*v.X + v.Y*v.Y)\n}\n//\u6307\u9488\u63a5\u6536\u8005\n//\u6307\u9488\u63a5\u6536\u8005\u7684\u65b9\u6cd5\u53ef\u4ee5\u4fee\u6539\u63a5\u6536\u8005\u6307\u5411\u7684\u503c\uff08\u5c31\u50cf Scale \u5728\u8fd9\u505a\u7684\uff09\u3002\u7531\u4e8e\u65b9\u6cd5\u7ecf\u5e38\u9700\u8981\u4fee\u6539\u5b83\u7684\u63a5\u6536\u8005\uff0c\u6307\u9488\u63a5\u6536\u8005\u6bd4\u503c\u63a5\u6536\u8005\u66f4\u5e38\u7528\nfunc (v *Vertex) Scale(f float64) {\n    v.X = v.X * f\n    v.Y = v.Y * f\n}\n\nfunc main() {\n    v := Vertex{3, 4}\n    fmt.Println(v.Abs())\n    v.Scale(10)\n    fmt.Println(v.Abs())\n}\n</code></pre>"},{"location":"go/%E6%97%A5%E5%BF%97/","title":"\u65e5\u5fd7","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"log\"\n\n    \"example.com/greetings\"\n)\n\nfunc main() {\n    // Set properties of the predefined Logger, including\n    // the log entry prefix and a flag to disable printing\n    // the time, source file, and line number.\n    log.SetPrefix(\"greetings: \")\n    log.SetFlags(0)\n\n    // Request a greeting message.\n    message, err := greetings.Hello(\"\")\n    // If an error was returned, print it to the console and\n    // exit the program.\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // If no error was returned, print the returned message\n    // to the console.\n    fmt.Println(message)\n}\n</code></pre>"},{"location":"go/%E6%97%B6%E9%97%B4/","title":"\u65f6\u95f4","text":""},{"location":"go/%E6%97%B6%E9%97%B4/#time","title":"time","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n    p := fmt.Println\n\n    now := time.Now()\n    p(now)\n\n    then := time.Date(\n        2009, 11, 17, 20, 34, 58, 651387237, time.UTC)\n    p(then)\n\n    p(then.Year())\n    p(then.Month())\n    p(then.Day())\n    p(then.Hour())\n    p(then.Minute())\n    p(then.Second())\n    p(then.Nanosecond())\n    p(then.Location())\n\n    p(then.Weekday())\n\n    p(then.Before(now))\n    p(then.After(now))\n    p(then.Equal(now))\n\n    diff := now.Sub(then)\n    p(diff)\n\n    p(diff.Hours())\n    p(diff.Minutes())\n    p(diff.Seconds())\n    p(diff.Nanoseconds())\n\n    p(then.Add(diff))\n    p(then.Add(-diff))\n}\n</code></pre>"},{"location":"go/%E6%97%B6%E9%97%B4/#epoch","title":"Epoch","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n\n    now := time.Now()\n    fmt.Println(now)\n\n    fmt.Println(now.Unix())  //\u65f6\u95f4\u6233\n    fmt.Println(now.UnixMilli())\n    fmt.Println(now.UnixNano())\n\n    fmt.Println(time.Unix(now.Unix(), 0))\n    fmt.Println(time.Unix(0, now.UnixNano()))\n}\n</code></pre>"},{"location":"go/%E6%97%B6%E9%97%B4/#_1","title":"\u65f6\u95f4\u683c\u5f0f\u5316/\u89e3\u6790","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n    p := fmt.Println\n\n    t := time.Now()\n    p(t.Format(time.RFC3339))\n\n    t1, e := time.Parse(\n        time.RFC3339,\n        \"2012-11-01T22:08:41+00:00\")\n    p(t1)\n\n    p(t.Format(\"3:04PM\"))\n    p(t.Format(\"Mon Jan _2 15:04:05 2006\"))\n    p(t.Format(\"2006-01-02T15:04:05.999999-07:00\"))\n    form := \"3 04 PM\"\n    t2, e := time.Parse(form, \"8 41 PM\")\n    p(t2)\n\n    fmt.Printf(\"%d-%02d-%02dT%02d:%02d:%02d-00:00\\n\",\n        t.Year(), t.Month(), t.Day(),\n        t.Hour(), t.Minute(), t.Second())\n\n    ansic := \"Mon Jan _2 15:04:05 2006\"\n    _, e = time.Parse(ansic, \"8:41PM\")\n    p(e)\n}\n</code></pre>"},{"location":"go/%E6%98%A0%E5%B0%84map/","title":"\u6620\u5c04map","text":"<p>Info</p> <p>Maps are used to store data values in key:value pairs.</p> <p>Each element in a map is a key:value pair.</p> <p>A map is an unordered and changeable collection that does not allow duplicates.</p> <p>The length of a map is the number of its elements. You can find it using the len() function.</p> <p>The default value of a map is nil.</p> <p>Maps hold references to an underlying hash table.</p> <p>Go has multiple ways for creating maps.</p>"},{"location":"go/%E6%98%A0%E5%B0%84map/#map","title":"\u96f6\u503cmap","text":"\u6620\u5c04\u7684\u96f6\u503c\u4e3a nil \u3002nil \u6620\u5c04\u65e2\u6ca1\u6709\u952e\uff0c\u4e5f\u4e0d\u80fd\u6dfb\u52a0\u952e\u3002Example <pre><code>var a = map[KeyType]ValueType{key1:value1, key2:value2,...}\nb := map[KeyType]ValueType{key1:value1, key2:value2,...}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var a = map[string]string{\"brand\": \"Ford\", \"model\": \"Mustang\", \"year\": \"1964\"}\n  b := map[string]int{\"Oslo\": 1, \"Bergen\": 2, \"Trondheim\": 3, \"Stavanger\": 4}\n\n  fmt.Printf(\"a\\t%v\\n\", a)\n  fmt.Printf(\"b\\t%v\\n\", b)\n}\n</code></pre> <p>Note</p> <p>\u6ce8\u610f\uff1a\u4ee3\u7801\u4e2d\u5b9a\u4e49\u7684\u5730\u56fe\u5143\u7d20\u7684\u987a\u5e8f\u4e0e\u5176\u5b58\u50a8\u65b9\u5f0f\u4e0d\u540c\u3002\u6570\u636e\u7684\u5b58\u50a8\u65b9\u5f0f\u53ef\u4ee5\u4ece\u5730\u56fe\u4e2d\u9ad8\u6548\u5730\u68c0\u7d22\u6570\u636e</p> <pre><code>//\u4f7f\u7528make()\u51fd\u6570\u58f0\u660emap\nvar a = make(map[KeyType]ValueType)\nb := make(map[KeyType]ValueType)\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var a = make(map[string]string) // The map is empty now\n  a[\"brand\"] = \"Ford\"\n  a[\"model\"] = \"Mustang\"\n  a[\"year\"] = \"1964\"\n                                 // a is no longer empty\n  b := make(map[string]int)\n  b[\"Oslo\"] = 1\n  b[\"Bergen\"] = 2\n  b[\"Trondheim\"] = 3\n  b[\"Stavanger\"] = 4\n\n  fmt.Printf(\"a\\t%v\\n\", a)\n  fmt.Printf(\"b\\t%v\\n\", b)\n}\n</code></pre>"},{"location":"go/%E6%98%A0%E5%B0%84map/#map_1","title":"\u7a7amap","text":"<p>Note</p> <p>\u6ce8\u610f\uff1amake() \u51fd\u6570\u662f\u521b\u5efa\u7a7a\u6620\u5c04\u7684\u6b63\u786e\u65b9\u6cd5\u3002\u5982\u679c\u4f60\u4ee5\u4e0d\u540c\u7684\u65b9\u5f0f\u5236\u4f5c\u4e00\u4e2a\u7a7a\u6620\u5c04\u5e76\u5199\u5165\u5b83\uff0c\u5b83\u4f1a\u5bfc\u81f4\u8fd0\u884c\u65f6\u6050\u614c\u3002</p> <pre><code>//\u521b\u5efa\u4e00\u4e2a\u7a7amap\nvar a map[KeyType]ValueType\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var a = make(map[string]string)\n  var b map[string]string\n\n  fmt.Println(a == nil)\n  fmt.Println(b == nil)\n}\n</code></pre>"},{"location":"go/%E6%98%A0%E5%B0%84map/#key","title":"\u5141\u8bb8\u7684key\u7c7b\u578b","text":"<ul> <li> Booleans</li> <li> Numbers</li> <li> Strings</li> <li> Arrays</li> <li> Pointers</li> <li> Structs</li> <li> Interfaces (as long as the dynamic type supports equality)</li> <li> Slices</li> <li> Maps</li> <li> Functions</li> </ul>"},{"location":"go/%E6%98%A0%E5%B0%84map/#value","title":"\u5141\u8bb8\u7684value\u7c7b\u578b","text":"<ul> <li> Any</li> </ul>"},{"location":"go/%E6%98%A0%E5%B0%84map/#map_2","title":"map\u5143\u7d20\u64cd\u4f5c","text":""},{"location":"go/%E6%98%A0%E5%B0%84map/#map_3","title":"\u83b7\u53d6map\u4e2d\u7684\u5143\u7d20","text":"<pre><code>value = map_name[key]\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var a = make(map[string]string)\n  a[\"brand\"] = \"Ford\"\n  a[\"model\"] = \"Mustang\"\n  a[\"year\"] = \"1964\"\n\n  fmt.Printf(a[\"brand\"])\n}\n</code></pre>"},{"location":"go/%E6%98%A0%E5%B0%84map/#map_4","title":"\u66f4\u65b0\u548c\u6dfb\u52a0map\u5143\u7d20","text":"<pre><code>map_name[key] = value\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var a = make(map[string]string)\n  a[\"brand\"] = \"Ford\"\n  a[\"model\"] = \"Mustang\"\n  a[\"year\"] = \"1964\"\n\n  fmt.Println(a)\n\n  a[\"year\"] = \"1970\" // Updating an element\n  a[\"color\"] = \"red\" // Adding an element\n\n  fmt.Println(a)\n}\n</code></pre>"},{"location":"go/%E6%98%A0%E5%B0%84map/#_1","title":"\u5220\u9664\u5143\u7d20","text":"<pre><code>delete(map_name, key)\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var a = make(map[string]string)\n  a[\"brand\"] = \"Ford\"\n  a[\"model\"] = \"Mustang\"\n  a[\"year\"] = \"1964\"\n\n  fmt.Println(a)\n\n  delete(a,\"year\")\n\n  fmt.Println(a)\n}\n</code></pre>"},{"location":"go/%E6%98%A0%E5%B0%84map/#map_5","title":"\u68c0\u67e5map\u4e2d\u7684\u7279\u5b9a\u5143\u7d20","text":"<pre><code>val, ok := map_name[key]\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var a = map[string]string{\"brand\": \"Ford\", \"model\": \"Mustang\", \"year\": \"1964\", \"day\":\"\"}\n\n  val1, ok1 := a[\"brand\"] // Checking for existing key and its value\n  val2, ok2 := a[\"color\"] // Checking for non-existing key and its value\n  val3, ok3 := a[\"day\"]   // Checking for existing key and its value\n  //\u5982\u679c\u53ea\u60f3\u68c0\u67e5\u67d0\u4e2akey\u662f\u5426\u5b58\u5728\uff0c\u53ef\u4ee5\u7528\u7a7a\u767d\u6807\u8bc6\u7b26\uff08_\uff09\u4ee3\u66ffval\u3002\n  _, ok4 := a[\"model\"]    // Only checking for existing key and not its value\n\n  fmt.Println(val1, ok1)\n  fmt.Println(val2, ok2)\n  fmt.Println(val3, ok3)\n  fmt.Println(ok4)\n}\n</code></pre>"},{"location":"go/%E6%98%A0%E5%B0%84map/#_2","title":"\u6620\u5c04\u662f\u5bf9\u54c8\u5e0c\u8868\u7684\u5f15\u7528","text":"<p>\u5982\u679c\u4e24\u4e2a\u6620\u5c04\u53d8\u91cf\u5f15\u7528\u540c\u4e00\u4e2a\u54c8\u5e0c\u8868\uff0c\u5219\u66f4\u6539\u4e00\u4e2a\u53d8\u91cf\u7684\u5185\u5bb9\u4f1a\u5f71\u54cd\u53e6\u4e00\u4e2a\u53d8\u91cf\u7684\u5185\u5bb9\u3002</p> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  var a = map[string]string{\"brand\": \"Ford\", \"model\": \"Mustang\", \"year\": \"1964\"}\n  b := a\n\n  fmt.Println(a)\n  fmt.Println(b)\n\n  b[\"year\"] = \"1970\"\n  fmt.Println(\"After change to b:\")\n\n  fmt.Println(a)\n  fmt.Println(b)\n}\n</code></pre>"},{"location":"go/%E6%98%A0%E5%B0%84map/#map_6","title":"\u904d\u5386map","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  a := map[string]int{\"one\": 1, \"two\": 2, \"three\": 3, \"four\": 4}\n\n  for k, v := range a {\n    fmt.Printf(\"%v : %v, \", k, v)\n  }\n}\n</code></pre>"},{"location":"go/%E6%98%A0%E5%B0%84map/#map_7","title":"\u4ee5\u6307\u5b9a\u6761\u4ef6\u904d\u5386map","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  a := map[string]int{\"one\": 1, \"two\": 2, \"three\": 3, \"four\": 4}\n\n  var b = []string{}             // defining the order\n  b = append(b, \"one\", \"two\", \"three\", \"four\")\n\n  for k, v := range a {        // loop with no order\n    fmt.Printf(\"%v : %v, \", k, v)\n  }\n\n  fmt.Println()\n\n  for _, element := range b {  // loop with the defined order\n    fmt.Printf(\"%v : %v, \", element, a[element])\n  }\n}\n</code></pre>"},{"location":"go/%E6%AD%A3%E5%88%99/","title":"\u6b63\u5219","text":""},{"location":"go/%E6%AD%A3%E5%88%99/#regexp","title":"regexp","text":"<p>example</p> <pre><code>package main\n\nimport (\n    \"bytes\"\n    \"fmt\"\n    \"regexp\"\n)\n\nfunc main() {\n\n    match, _ := regexp.MatchString(\"p([a-z]+)ch\", \"peach\")\n    fmt.Println(match)\n\n    r, _ := regexp.Compile(\"p([a-z]+)ch\")\n\n    fmt.Println(r.MatchString(\"peach\"))\n\n    fmt.Println(r.FindString(\"peach punch\"))\n\n    fmt.Println(\"idx:\", r.FindStringIndex(\"peach punch\"))\n\n    fmt.Println(r.FindStringSubmatch(\"peach punch\"))\n\n    fmt.Println(r.FindStringSubmatchIndex(\"peach punch\"))\n\n    fmt.Println(r.FindAllString(\"peach punch pinch\", -1))\n\n    fmt.Println(\"all:\", r.FindAllStringSubmatchIndex(\n        \"peach punch pinch\", -1))\n\n    fmt.Println(r.FindAllString(\"peach punch pinch\", 2))\n\n    fmt.Println(r.Match([]byte(\"peach\")))\n\n    r = regexp.MustCompile(\"p([a-z]+)ch\")\n    fmt.Println(\"regexp:\", r)\n\n    fmt.Println(r.ReplaceAllString(\"a peach\", \"&lt;fruit&gt;\"))\n\n    in := []byte(\"a peach\")\n    out := r.ReplaceAllFunc(in, bytes.ToUpper)\n    fmt.Println(string(out))\n}\n</code></pre>"},{"location":"go/%E6%B3%9B%E5%9E%8BGenerics/","title":"\u6cdb\u578bGenerics","text":""},{"location":"go/%E6%B3%9B%E5%9E%8BGenerics/#generics","title":"Generics","text":"<p>\u4f7f\u7528\u6cdb\u578b\uff0c\u53ef\u4ee5\u58f0\u660e\u548c\u4f7f\u7528\u51fd\u6570\u6216\u7c7b\u578b\uff0c\u8fd9\u4e9b\u51fd\u6570\u6216\u7c7b\u578b\u88ab\u7f16\u5199\u4e3a\u4e0e\u8c03\u7528\u4ee3\u7801\u63d0\u4f9b\u7684\u4e00\u7ec4\u7c7b\u578b\u4e2d\u7684\u4efb\u4f55\u4e00\u4e2a\u4e00\u8d77\u5de5\u4f5c\u3002</p> <p>\u6559\u7a0b</p> <p>example</p> <pre><code>package main\n\nimport \"fmt\"\n\nfunc MapKeys[K comparable, V any](m map[K]V) []K {\n    r := make([]K, 0, len(m))\n    for k := range m {\n        r = append(r, k)\n    }\n    return r\n}\n\ntype List[T any] struct {\n    head, tail *element[T]\n}\n\ntype element[T any] struct {\n    next *element[T]\n    val  T\n}\n\nfunc (lst *List[T]) Push(v T) {\n    if lst.tail == nil {\n        lst.head = &amp;element[T]{val: v}\n        lst.tail = lst.head\n    } else {\n        lst.tail.next = &amp;element[T]{val: v}\n        lst.tail = lst.tail.next\n    }\n}\n\nfunc (lst *List[T]) GetAll() []T {\n    var elems []T\n    for e := lst.head; e != nil; e = e.next {\n        elems = append(elems, e.val)\n    }\n    return elems\n}\n\nfunc main() {\n    var m = map[int]string{1: \"2\", 2: \"4\", 4: \"8\"}\n\n    fmt.Println(\"keys:\", MapKeys(m))\n\n    _ = MapKeys[int, string](m)\n\n    lst := List[int]{}\n    lst.Push(10)\n    lst.Push(13)\n    lst.Push(23)\n    fmt.Println(\"list:\", lst.GetAll())\n}\n</code></pre>"},{"location":"go/%E6%B5%8B%E8%AF%95/","title":"\u6d4b\u8bd5","text":""},{"location":"go/%E6%B5%8B%E8%AF%95/#_1","title":"\u5355\u5143\u6d4b\u8bd5","text":"<pre><code>package main\n\nimport (\n    \"fmt\"\n    \"testing\"\n)\n\nfunc IntMin(a, b int) int {\n    if a &lt; b {\n        return a\n    }\n    return b\n}\n\nfunc TestIntMinBasic(t *testing.T) {\n    ans := IntMin(2, -2)\n    if ans != -2 {\n\n        t.Errorf(\"IntMin(2, -2) = %d; want -2\", ans)\n    }\n}\n\nfunc TestIntMinTableDriven(t *testing.T) {\n    var tests = []struct {\n        a, b int\n        want int\n    }{\n        {0, 1, 0},\n        {1, 0, 0},\n        {2, -2, -2},\n        {0, -1, -1},\n        {-1, 0, -1},\n    }\n\n    for _, tt := range tests {\n\n        testname := fmt.Sprintf(\"%d,%d\", tt.a, tt.b)\n        t.Run(testname, func(t *testing.T) {\n            ans := IntMin(tt.a, tt.b)\n            if ans != tt.want {\n                t.Errorf(\"got %d, want %d\", ans, tt.want)\n            }\n        })\n    }\n}\n\nfunc BenchmarkIntMin(b *testing.B) {\n\n    for i := 0; i &lt; b.N; i++ {\n        IntMin(1, 2)\n    }\n}\n</code></pre> <pre><code># \u8fd0\u884c\u5f53\u524d\u76ee\u5f55\u4e2d\u7684\u6240\u6709\u6d4b\u8bd5\ngo test\n\n# \u8f93\u51fa\u8be6\u7ec6\u4fe1\u606f\ngo test -v\n</code></pre>"},{"location":"go/%E6%B5%8B%E8%AF%95/#fuzzing","title":"\u6a21\u7cca\u6d4b\u8bd5fuzzing","text":"<p>vscode\u7684debug\u529f\u80fd</p> <pre><code>## \u8fd0\u884c\u6a21\u7cca\u6d4b\u8bd5\ngo test -fuzz=Fuzz\n\n## \u9650\u5236\u6d4b\u8bd5\u65f6\u95f4\ngo test -fuzz=Fuzz -fuzztime 10s\n</code></pre>"},{"location":"go/%E7%BB%93%E6%9E%84%E4%BD%93struct/","title":"\u7ed3\u6784\u4f53struct","text":"<p>\u7528\u4e8e\u5c06\u4e0d\u540c\u6570\u636e\u7c7b\u578b\u7684\u6210\u5458\u96c6\u5408\u521b\u5efa\u5230\u5355\u4e2a\u53d8\u91cf\u4e2d</p> <p>Info</p> <p>\u6570\u7ec4\u7528\u4e8e\u5c06\u76f8\u540c\u6570\u636e\u7c7b\u578b\u7684\u591a\u4e2a\u503c\u5b58\u50a8\u5230\u5355\u4e2a\u53d8\u91cf\u4e2d\uff0c\u800c\u7ed3\u6784\u7528\u4e8e\u5c06\u4e0d\u540c\u6570\u636e\u7c7b\u578b\u7684\u591a\u4e2a\u503c\u5b58\u50a8\u5230\u5355\u4e2a\u53d8\u91cf\u4e2d\u3002</p> <pre><code>type struct_name struct {\n  member1 datatype;\n  member2 datatype;\n  member3 datatype;\n  ...\n}\n\ntype Person struct {\n  name string\n  age int\n  job string\n  salary int\n}\n</code></pre> <pre><code>//\u83b7\u53d6struct\u53c2\u6570\npackage main\nimport (\"fmt\")\n\ntype Person struct {\n  name string\n  age int\n  job string\n  salary int\n}\n\nfunc main() {\n  var pers1 Person\n  var pers2 Person\n\n  // Pers1 specification\n  pers1.name = \"Hege\"\n  pers1.age = 45\n  pers1.job = \"Teacher\"\n  pers1.salary = 6000\n\n  // Pers2 specification\n  pers2.name = \"Cecilie\"\n  pers2.age = 24\n  pers2.job = \"Marketing\"\n  pers2.salary = 4500\n\n  // Access and print Pers1 info\n  fmt.Println(\"Name: \", pers1.name)\n  fmt.Println(\"Age: \", pers1.age)\n  fmt.Println(\"Job: \", pers1.job)\n  fmt.Println(\"Salary: \", pers1.salary)\n\n  // Access and print Pers2 info\n  fmt.Println(\"Name: \", pers2.name)\n  fmt.Println(\"Age: \", pers2.age)\n  fmt.Println(\"Job: \", pers2.job)\n  fmt.Println(\"Salary: \", pers2.salary)\n}\n</code></pre>"},{"location":"go/%E7%BB%93%E6%9E%84%E4%BD%93struct/#_1","title":"\u7ed3\u6784\u4f53\u6307\u9488","text":"<pre><code>//\u5982\u679c\u6211\u4eec\u6709\u4e00\u4e2a\u6307\u5411\u7ed3\u6784\u4f53\u7684\u6307\u9488 p\uff0c\u90a3\u4e48\u53ef\u4ee5\u901a\u8fc7 (*p).X \u6765\u8bbf\u95ee\u5176\u5b57\u6bb5 X\u3002\u4e0d\u8fc7\u8fd9\u4e48\u5199\u592a\u5570\u55e6\u4e86\uff0c\u6240\u4ee5\u8bed\u8a00\u4e5f\u5141\u8bb8\u6211\u4eec\u4f7f\u7528\u9690\u5f0f\u95f4\u63a5\u5f15\u7528\uff0c\u76f4\u63a5\u5199 p.X \u5c31\u53ef\u4ee5\u3002\n\npackage main\n\nimport \"fmt\"\n\ntype Vertex struct {\n    X int\n    Y int\n}\n\nfunc main() {\n    v := Vertex{1, 2}\n    p := &amp;v\n    p.X = 1e9\n    fmt.Println(v)\n}\n</code></pre>"},{"location":"go/%E7%BB%93%E6%9E%84%E4%BD%93struct/#struct","title":"\u5c06struct\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9\u51fd\u6570","text":"<pre><code>package main\nimport (\"fmt\")\n\ntype Person struct {\n  name string\n  age int\n  job string\n  salary int\n}\n\nfunc main() {\n  var pers1 Person\n  var pers2 Person\n\n  // Pers1 specification\n  pers1.name = \"Hege\"\n  pers1.age = 45\n  pers1.job = \"Teacher\"\n  pers1.salary = 6000\n\n  // Pers2 specification\n  pers2.name = \"Cecilie\"\n  pers2.age = 24\n  pers2.job = \"Marketing\"\n  pers2.salary = 4500\n\n  // Print Pers1 info by calling a function\n  printPerson(pers1)\n\n  // Print Pers2 info by calling a function\n  printPerson(pers2)\n}\n\nfunc printPerson(pers Person) {\n  fmt.Println(\"Name: \", pers.name)\n  fmt.Println(\"Age: \", pers.age)\n  fmt.Println(\"Job: \", pers.job)\n  fmt.Println(\"Salary: \", pers.salary)\n}\n</code></pre> <pre><code>package main\n\nimport \"fmt\"\n\ntype person struct {\n    name string\n    age  int\n}\n\nfunc newPerson(name string) *person {\n\n    p := person{name: name}\n    p.age = 42\n    return &amp;p\n}\n\nfunc main() {\n\n    fmt.Println(person{\"Bob\", 20})\n\n    fmt.Println(person{name: \"Alice\", age: 30})\n\n    fmt.Println(person{name: \"Fred\"}) // age: 0 \u88ab\u9690\u5f0f\u8d4b\u503c\n\n    fmt.Println(&amp;person{name: \"Ann\", age: 40})\n\n    fmt.Println(newPerson(\"Jon\"))\n\n    s := person{name: \"Sean\", age: 50}\n    fmt.Println(s.name)\n\n    sp := &amp;s\n    fmt.Println(sp.age)\n\n    sp.age = 51\n    fmt.Println(sp.age)\n    //\u533f\u540dstruct\n    dog := struct {\n        name   string\n        isGood bool\n    }{\n        \"Rex\",\n        true,\n    }\n    fmt.Println(dog)\n}\n</code></pre>"},{"location":"go/%E7%BB%93%E6%9E%84%E4%BD%93struct/#_2","title":"\u7ed3\u6784\u4f53\u5d4c\u5165","text":"<pre><code>package main\n\nimport \"fmt\"\n\ntype base struct {\n    num int\n}\n\nfunc (b base) describe() string {\n    return fmt.Sprintf(\"base with num=%v\", b.num)\n}\n\ntype container struct {\n    base\n    str string\n}\n\nfunc main() {\n\n    co := container{\n        base: base{\n            num: 1,\n        },\n        str: \"some name\",\n    }\n\n    fmt.Printf(\"co={num: %v, str: %v}\\n\", co.num, co.str)\n\n    fmt.Println(\"also num:\", co.base.num)\n\n    fmt.Println(\"describe:\", co.describe())\n\n    type describer interface {\n        describe() string\n    }\n\n    var d describer = co\n    fmt.Println(\"describer:\", d.describe())\n}\n</code></pre>"},{"location":"go/%E7%BB%93%E6%9E%84%E4%BD%93struct/#_3","title":"\u7ed3\u6784\u4f53\u6807\u7b7e","text":"<p>\u7ed3\u6784\u4f53\u6807\u7b7e\uff08\u4f8b\u5982 json:\"artist\"\uff09\u6307\u5b9a\u5f53\u7ed3\u6784\u4f53\u7684\u5185\u5bb9\u5e8f\u5217\u5316\u4e3a JSON \u65f6\u5b57\u6bb5\u7684\u540d\u79f0\u5e94\u8be5\u662f\u4ec0\u4e48\u3002\u5982\u679c\u6ca1\u6709\u5b83\u4eec\uff0cJSON \u5c06\u4f7f\u7528\u7ed3\u6784\u4f53\u7684\u5927\u5199\u5b57\u6bb5\u540d\u79f0\u2014\u2014\u8fd9\u79cd\u98ce\u683c\u5728 JSON \u4e2d\u5e76\u4e0d\u5e38\u89c1\u3002</p> <pre><code>// album represents data about a record album.\ntype album struct {\n    ID     string  `json:\"id\"`\n    Title  string  `json:\"title\"`\n    Artist string  `json:\"artist\"`\n    Price  float64 `json:\"price\"`\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/","title":"\u8bed\u6cd5","text":""},{"location":"go/%E8%AF%AD%E6%B3%95/#if","title":"if","text":""},{"location":"go/%E8%AF%AD%E6%B3%95/#if_1","title":"\u5355if","text":"\u8bed\u6cd5Example <pre><code>if condition {\n  // code to be executed if condition is true\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  x:= 20\n  y:= 18\n  if x &gt; y {\n    fmt.Println(\"x is greater than y\")\n  }\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#if-else","title":"if else","text":"\u8bed\u6cd5Example <pre><code>if condition {\n  // code to be executed if condition is true\n} else {\n  // code to be executed if condition is false\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  time := 20\n  if (time &lt; 18) {\n    fmt.Println(\"Good day.\")\n  } else {\n    fmt.Println(\"Good evening.\")\n  }\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#else-if","title":"else if","text":"\u8bed\u6cd5Example <pre><code>if condition1 {\n   // code to be executed if condition1 is true\n} else if condition2 {\n   // code to be executed if condition1 is false and condition2 is true\n} else {\n   // code to be executed if condition1 and condition2 are both false\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  time := 22\n  if time &lt; 10 {\n    fmt.Println(\"Good morning.\")\n  } else if time &lt; 20 {\n    fmt.Println(\"Good day.\")\n  } else {\n    fmt.Println(\"Good evening.\")\n  }\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#if_2","title":"\u5d4c\u5957if","text":"\u8bed\u6cd5Example <pre><code>if condition1 {\n   // code to be executed if condition1 is true\n  if condition2 {\n     // code to be executed if both condition1 and condition2 are true\n  }\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  num := 20\n  if num &gt;= 10 {\n    fmt.Println(\"Num is more than 10.\")\n    if num &gt; 15 {\n      fmt.Println(\"Num is also more than 15.\")\n     }\n  } else {\n    fmt.Println(\"Num is less than 10.\")\n  }\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#if_3","title":"if \u7684\u7b80\u77ed\u8bed\u53e5","text":"<pre><code>//\u540c for \u4e00\u6837\uff0c if \u8bed\u53e5\u53ef\u4ee5\u5728\u6761\u4ef6\u8868\u8fbe\u5f0f\u524d\u6267\u884c\u4e00\u4e2a\u7b80\u5355\u7684\u8bed\u53e5\u3002\n//\u8be5\u8bed\u53e5\u58f0\u660e\u7684\u53d8\u91cf\u4f5c\u7528\u57df\u4ec5\u5728 if \u4e4b\u5185\u3002\npackage main\n\nimport (\n    \"fmt\"\n    \"math\"\n)\n\nfunc pow(x, n, lim float64) float64 {\n    if v := math.Pow(x, n); v &lt; lim {\n        return v\n    }\n    return lim\n}\n\nfunc main() {\n    fmt.Println(\n        pow(3, 2, 10),\n        pow(3, 3, 20),\n    )\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#switch","title":"switch","text":"<p>Info</p> <p>switch \u7684 case \u8bed\u53e5\u4ece\u4e0a\u5230\u4e0b\u987a\u6b21\u6267\u884c\uff0c\u76f4\u5230\u5339\u914d\u6210\u529f\u65f6\u505c\u6b62\uff08Go \u81ea\u52a8\u63d0\u4f9b\u4e86\u6bcf\u4e2a case \u540e\u9762\u6240\u9700\u7684 break \u8bed\u53e5\u3002\u9664\u975e\u4ee5fallthrough\u7ed3\u5c3e\u3002</p>"},{"location":"go/%E8%AF%AD%E6%B3%95/#single-case","title":"single-case","text":"\u8bed\u6cd5Example <pre><code>//single-case\nswitch expression {\ncase x:\n   // code block\ncase y:\n   // code block\ncase z:\n...\ndefault:\n   // code block\n}\n</code></pre> <pre><code>package main\n\nimport (\n    \"fmt\"\n)\n\nfunc main() {\n    day := 1\n\n    switch day {\n    case 1:\n        fmt.Println(\"Monday\")\n    case 2:\n        fmt.Println(\"Tuesday\")\n    case 3:\n        fmt.Println(\"Wednesday\")\n    case 4:\n        fmt.Println(\"Thursday\")\n    case 5:\n        fmt.Println(\"Friday\")\n    case 6:\n        fmt.Println(\"Saturday\")\n    case 7:\n        fmt.Println(\"Sunday\")\n    default:\n        fmt.Println(\"Not a weekday\")\n    }\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#multi-case","title":"multi-case","text":"\u8bed\u6cd5Example <pre><code>//multi-case\nswitch expression {\ncase x,y:\n   // code block if expression is evaluated to x or y\ncase v,w:\n   // code block if expression is evaluated to v or w\ncase z:\n...\ndefault:\n   // code block if expression is not found in any cases\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n   day := 5\n\n   switch day {\n   case 1,3,5:\n    fmt.Println(\"Odd weekday\")\n   case 2,4:\n     fmt.Println(\"Even weekday\")\n   case 6,7:\n    fmt.Println(\"Weekend\")\n  default:\n    fmt.Println(\"Invalid day of day number\")\n  }\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#fallthrough","title":"fallthrough","text":"<pre><code>//\u5982\u679c\u4e00\u4e2acase\u4e2d\u7684\u8bed\u53e5\u4ee5fallthrough\u7ed3\u5c3e\uff0c\u5f53\u6761\u4ef6\u547d\u4e2d\u8be5case\u65f6\uff0c\u6267\u884c\u8be5case\u4e2d\u7684\u8bed\u53e5\uff0c\u7136\u540e\u5ffd\u7565\u4e0b\u4e00\u4e2acase\u7684\u6761\u4ef6\uff0c\u76f4\u63a5\u6267\u884c\u4e0b\u4e00\u4e2acase\u4e2d\u7684\u8bed\u53e5\uff0c\u76f4\u5230\u67d0\u4e00\u4e2acase\u4e2d\u4e0d\u518d\u4ee5fallthrough\u7ed3\u5c3e\u65f6\u9000\u51faswitch\npackage main\n\nimport (\n    \"fmt\"\n    \"runtime\"\n)\n\nfunc main() {\n    fmt.Print(\"Go runs on \")\n    switch os := runtime.GOOS; os {\n    case \"darwin\":\n        fmt.Println(\"OS X.\")\n\n    case \"linux\":\n        fmt.Println(\"Linux.\")\n        fallthrough\n\n    case \"darwinasd\":\n        fmt.Println(\"darwinasd.\")\n        fallthrough\n\n    default:\n        // freebsd, openbsd,\n        // plan9, windows...\n        fmt.Printf(\"%s.\\n\", os)\n    }\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#switch_1","title":"\u6ca1\u6709\u6761\u4ef6\u7684switch","text":"<pre><code>//\u8fd9\u79cd\u5f62\u5f0f\u80fd\u5c06\u4e00\u957f\u4e32 if-then-else \u5199\u5f97\u66f4\u52a0\u6e05\u6670\u3002\npackage main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n    t := time.Now()\n    switch {\n    case t.Hour() &lt; 12:\n        fmt.Println(\"Good morning!\")\n    case t.Hour() &lt; 17:\n        fmt.Println(\"Good afternoon.\")\n    default:\n        fmt.Println(\"Good evening.\")\n    }\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#loop","title":"loop","text":"<p>for\u662fGo\u4e2d\u552f\u4e00\u7684\u5faa\u73af</p> \u8bed\u6cd5Example <pre><code>//for \u5faa\u73af\u6700\u591a\u53ef\u4ee5\u5305\u542b\u4e09\u4e2a\u8bed\u53e5\n//\u521d\u59cb\u5316\u8bed\u53e5\uff1a\u5728\u7b2c\u4e00\u6b21\u8fed\u4ee3\u524d\u6267\u884c\n//\u6761\u4ef6\u8868\u8fbe\u5f0f\uff1a\u5728\u6bcf\u6b21\u8fed\u4ee3\u524d\u6c42\u503c\n//\u540e\u7f6e\u8bed\u53e5\uff1a\u5728\u6bcf\u6b21\u8fed\u4ee3\u7684\u7ed3\u5c3e\u6267\u884c\nfor statement1; statement2; statement3 {\n   // code to be executed for each iteration\n}\n</code></pre> <pre><code>package main\n\nimport \"fmt\"\n\nfunc main() {\n\n    i := 1\n    //for \u662f Go \u4e2d\u7684 \u201cwhile\u201d\n    for i &lt;= 3 {\n        fmt.Println(i)\n        i = i + 1\n    }\n\n    for j := 7; j &lt;= 9; j++ {\n        fmt.Println(j)\n    }\n\n    for {\n        fmt.Println(\"loop\")\n        break\n    }\n\n    for n := 0; n &lt;= 5; n++ {\n        if n%2 == 0 {\n            continue\n        }\n        fmt.Println(n)\n    }\n}\n</code></pre> <p>Info</p> <ul> <li> <p>statement1 \u521d\u59cb\u5316\u5faa\u73af\u8ba1\u6570\u5668\u503c\u3002</p> </li> <li> <p>statement2 \u4e3a\u6bcf\u6b21\u5faa\u73af\u8fed\u4ee3\u8ba1\u7b97\u3002\u5982\u679c\u5b83\u7684\u8ba1\u7b97\u7ed3\u679c\u4e3a TRUE\uff0c\u5219\u5faa\u73af\u7ee7\u7eed\u3002\u5982\u679c\u5b83\u7684\u8ba1\u7b97\u7ed3\u679c\u4e3a FALSE\uff0c\u5219\u5faa\u73af\u7ed3\u675f\u3002 </p> </li> <li> <p>statement3 \u589e\u52a0\u5faa\u73af\u8ba1\u6570\u5668\u503c\u3002</p> </li> </ul> <p>Note</p> <p>\u6ce8\u610f\uff1a\u8fd9\u4e9b\u8bed\u53e5\u4e0d\u9700\u8981\u4f5c\u4e3a\u5faa\u73af\u53c2\u6570\u51fa\u73b0\u3002\u4f46\u662f\uff0c\u5b83\u4eec\u9700\u8981\u4ee5\u67d0\u79cd\u5f62\u5f0f\u51fa\u73b0\u5728\u4ee3\u7801\u4e2d</p>"},{"location":"go/%E8%AF%AD%E6%B3%95/#continue","title":"continue","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  for i:=0; i &lt; 5; i++ {\n    if i == 3 {\n      continue\n    }\n   fmt.Println(i)\n  }\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#break","title":"break","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  for i:=0; i &lt; 5; i++ {\n    if i == 3 {\n      break\n    }\n   fmt.Println(i)\n  }\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#_1","title":"\u5d4c\u5957","text":"<pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  adj := [2]string{\"big\", \"tasty\"}\n  fruits := [3]string{\"apple\", \"orange\", \"banana\"}\n  for i:=0; i &lt; len(adj); i++ {\n    for j:=0; j &lt; len(fruits); j++ {\n      fmt.Println(adj[i],fruits[j])\n    }\n  }\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#range","title":"range","text":"\u8bed\u6cd5Example <pre><code>for index, value := array|slice|map {\n   // code to be executed for each iteration\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  fruits := [3]string{\"apple\", \"orange\", \"banana\"}\n  for idx, val := range fruits {\n     fmt.Printf(\"%v\\t%v\\n\", idx, val)\n  }\n}\n</code></pre>"},{"location":"go/%E8%AF%AD%E6%B3%95/#_2","title":"\u4ec5\u83b7\u53d6\u503c\u6216\u7d22\u5f15","text":"<pre><code>//\u8981\u4ec5\u83b7\u53d6\u503c\u6216\u7d22\u5f15\u53ef\u4ee5\u4f7f\u7528\u4e0b\u5212\u7ebf (_) \u7701\u7565\u5176\u4ed6\u8f93\u51fa\npackage main\nimport (\"fmt\")\n\nfunc main() {\n  fruits := [3]string{\"apple\", \"orange\", \"banana\"}\n  for _, val := range fruits {\n     fmt.Printf(\"%v\\n\", val)\n  }\n}\n</code></pre> <pre><code>package main\nimport (\"fmt\")\n\nfunc main() {\n  fruits := [3]string{\"apple\", \"orange\", \"banana\"}\n\n  for idx, _ := range fruits {\n     fmt.Printf(\"%v\\n\", idx)\n  }\n}\n</code></pre>"},{"location":"go/kubebuilder/note/","title":"Note","text":"","tags":["go","k8s","k8s-operator"]},{"location":"go/kubebuilder/note/#_1","title":"\u9650\u5236\u6240\u6709\u63a7\u5236\u5668\u5c06\u76d1\u89c6\u8d44\u6e90\u7684\u547d\u540d\u7a7a\u95f4","text":"<p><code>cmd/main.go:main()</code></p> <pre><code>    mgr, err := ctrl.NewManager(ctrl.GetConfigOrDie(), ctrl.Options{\n        Scheme: scheme,\n        Cache: cache.Options{\n            DefaultNamespaces: map[string]cache.Config{\n                namespace: {},\n            },\n        },\n        Metrics: server.Options{\n            BindAddress: metricsAddr,\n        },\n        WebhookServer:          webhook.NewServer(webhook.Options{Port: 9443}),\n        HealthProbeBindAddress: probeAddr,\n        LeaderElection:         enableLeaderElection,\n        LeaderElectionID:       \"80807133.tutorial.kubebuilder.io\",\n    })\n</code></pre>","tags":["go","k8s","k8s-operator"]},{"location":"go/kubebuilder/note/#_2","title":"\u652f\u6301\u65e7\u96c6\u7fa4\u7248\u672c","text":"<p>https://book.kubebuilder.io/cronjob-tutorial/new-api</p> <p>\u4e0e Go API \u7c7b\u578b\u4e00\u8d77\u521b\u5efa\u7684\u9ed8\u8ba4 CustomResourceDefinition \u6e05\u5355\u4f7f\u7528 API version v1\u3002\u5982\u679c\u60a8\u7684\u9879\u76ee\u6253\u7b97\u652f\u6301\u65e9\u4e8e v1.16 \u7684 Kubernetes \u96c6\u7fa4\u7248\u672c\uff0c\u5219\u5fc5\u987b \u4eceMakefile \u53d8\u91cf\u4e2d\u8bbe\u7f6e--crd-version v1beta1</p> <p>https://book.kubebuilder.io/cronjob-tutorial/webhook-implementation</p> <p>\u4e0e Go webhook \u5b9e\u73b0\u4e00\u8d77\u521b\u5efa\u7684\u9ed8\u8ba4 WebhookConfiguration \u6e05\u5355\u4f7f\u7528 API version v1\u3002\u5982\u679c\u60a8\u7684\u9879\u76ee\u6253\u7b97\u652f\u6301 v1.16 \u4e4b\u524d\u7684 Kubernetes \u96c6\u7fa4\u7248\u672c\uff0c\u8bf7\u8bbe\u7f6e--webhook-version v1beta1\u3002</p>","tags":["go","k8s","k8s-operator"]},{"location":"go/kubebuilder/readme/","title":"\u521d\u59cb\u5316\u9879\u76ee","text":"<ul> <li>\u73af\u5883\u51c6\u5907     <pre><code>go version v1.20.0+\ndocker version 17.03+.\nkubectl version v1.11.3+.\nAccess to a Kubernetes v1.11.3+ cluster.\n</code></pre></li> </ul> <pre><code>sudo apt install make\n</code></pre> <ul> <li>\u5b89\u88c5kubebuilder</li> </ul> <pre><code># download kubebuilder and install locally.\ncurl -L -o kubebuilder \"https://go.kubebuilder.io/dl/latest/$(go env GOOS)/$(go env GOARCH)\"\nchmod +x kubebuilder &amp;&amp; mv kubebuilder /usr/local/bin/\n\n# \u547d\u4ee4\u884c\u8865\u5168\ncat &lt;&lt; 'EOF' &gt;&gt; ~/.bashrc\n# kubebuilder autocompletion\nif [ -f /usr/local/share/bash-completion/bash_completion ]; then\n. /usr/local/share/bash-completion/bash_completion\nfi\n. &lt;(kubebuilder completion bash)\nEOF\n</code></pre> <ul> <li>\u521b\u5efa\u9879\u76ee</li> </ul> <pre><code>KB_PROJECT=\"test-app\"\nKB_DOMAIN=\"baiyuani.top\"\n\nmkdir -p ~/projects/${KB_PROJECT}\ncd ~/projects/${KB_PROJECT}\nkubebuilder init --domain ${KB_DOMAIN} --repo ${KB_DOMAIN}/${KB_PROJECT}\n</code></pre> <ul> <li>\u521b\u5efaapi</li> </ul> <pre><code>kubebuilder create api --group apps --version v1alpha1 --kind Guestbook\n\n# \u4f7f\u7528deploy-image/v1-alpha\u63d2\u4ef6\nkubebuilder create api \\\n--group apps \\\n--version v1alpha1 \\\n--kind SshTunnel \\\n--image=synin/ssh:latest \\\n--image-container-command=\"ssh,-D,0.0.0.0:1337,-Ng,sshtunnel@gpt.xxx.com\" \\\n--image-container-port=\"1337\" \\\n--run-as-user=\"1001\" \\\n--plugins=\"deploy-image/v1-alpha\" \\\n--make=false\n</code></pre> <ul> <li>\u5b89\u88c5</li> </ul> <pre><code># \u751f\u6210\nmake manifests\n# \u5b89\u88c5crd\nmake install\n# \u8fd0\u884c\nmake run\n</code></pre> <ul> <li>\u521b\u5efacr</li> </ul> <pre><code># \u7f16\u8f91\u540e\u518d\u6267\u884c\nkubectl apply -k config/samples/\n</code></pre> <ul> <li>\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c</li> </ul> <pre><code>make docker-build docker-push IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag\nmake deploy IMG=&lt;some-registry&gt;/&lt;project-name&gt;:tag\n</code></pre> <ul> <li>\u5378\u8f7d</li> </ul> <pre><code># \u5220\u9664crd\nmake uninstall\n# \u5378\u8f7dcontroller \nmake undeploy\n</code></pre> <ul> <li>\u5b9e\u73b0webhooks</li> </ul> <p>https://book.kubebuilder.io/cronjob-tutorial/webhook-implementation</p> <pre><code>kubebuilder create webhook --group batch --version v1 --kind CronJob --defaulting --programmatic-validation\n# \u4e0e Go webhook \u5b9e\u73b0\u4e00\u8d77\u521b\u5efa\u7684\u9ed8\u8ba4 WebhookConfiguration \u6e05\u5355\u4f7f\u7528 API version v1\u3002\u5982\u679c\u60a8\u7684\u9879\u76ee\u6253\u7b97\u652f\u6301 v1.16 \u4e4b\u524d\u7684 Kubernetes \u96c6\u7fa4\u7248\u672c\uff0c\u8bf7\u8bbe\u7f6e--webhook-version v1beta1\n</code></pre> <pre><code>helm install \\\n  cert-manager jetstack/cert-manager \\\n  --namespace cert-manager \\\n  --create-namespace \\\n  --set installCRDs=true \\\n  --set prometheus.enabled=false \\\n  --set webhook.timeoutSeconds=10 \\\n  --set ingressShim.defaultIssuerName=letsencrypt-prod \\\n  --set ingressShim.defaultIssuerKind=ClusterIssuer \\\n  --set ingressShim.defaultIssuerGroup=cert-manager.io\n</code></pre>","tags":["go","k8s","k8s-operator"]},{"location":"kubernetes/containerd/","title":"Containerd","text":"","tags":["container"]},{"location":"kubernetes/containerd/#crictl-load","title":"crictl load\u955c\u50cf","text":"<pre><code># \u67e5\u770b\u547d\u540d\u7a7a\u95f4\nctr ns ls\nNAME    LABELS \ndefault        \nk8s.io \n\n# k8s\u4f7f\u7528\u7684\u955c\u50cf\u4f4d\u4e8ek8s.io\u4e2d\nctr -n k8s.io images ls\n\n# \u8f7d\u5165\u955c\u50cf\u5230k8s.io\u547d\u540d\u7a7a\u95f4\nctr -n k8s.io images import openjdk.tar.gz \n\n# \u67e5\u770b\u521a\u8f7d\u5165\u7684\u955c\u50cf\ncrictl images\n</code></pre>","tags":["container"]},{"location":"kubernetes/helm/","title":"Helm","text":"","tags":["helm","kubernetes"]},{"location":"kubernetes/helm/#1","title":"1.\u5e38\u7528\u547d\u4ee4","text":"<pre><code>#\u83b7\u53d6release\u5b9e\u9645\u52a0\u8f7d\u7684\u6a21\u677f\nhelm get manifest rancher\nhelm get all rancher\n\n#\u67e5\u627erepo\u4e2dcharts\u7684\u7248\u672c\nhelm search repo --versions\nhelm search repo --versions rancher-stable/rancher\n# -l \u663e\u793a\u6240\u6709\u7248\u672c\nhelm search repo gitlab/gitlab -l\n\n#\u83b7\u53d6charts\u5305\nhelm fetch rancher-stable/rancher\n#\u83b7\u53d6\u6307\u5b9a\u7248\u672c\u7684charts\u5305\nhelm fetch rancher-stable/rancher --version=2.4.8\n#\u83b7\u53d6charts\u5305\u5e76\u89e3\u538b\u5230\u5f53\u524d\u76ee\u5f55\nhelm fetch rancher-stable/rancher --untar\n</code></pre>","tags":["helm","kubernetes"]},{"location":"kubernetes/helm/#2-charts","title":"2. \u6d4b\u8bd5\u5b89\u88c5charts\uff0c\u5e76\u8f93\u51fa\u6a21\u677f","text":"<pre><code>helm install ./first-chart --debug --dry-run\n</code></pre>","tags":["helm","kubernetes"]},{"location":"kubernetes/helm/#3-charts","title":"3. charts\u5e38\u7528\u51fd\u6570","text":"<pre><code>quote  \u52a0\u4e0a\u53cc\u5f15\u53f7\nupper  \u8f6c\u6362\u5927\u5c0f\u5199\nrepeat NUM  \u5bf9\u7ed9\u5b9a\u7684\u5b57\u7b26\u4e32\u8fdb\u884c\u4e00\u5b9a\u6b21\u6570\u7684\u56de\u663e\ndefault STR  \u5728\u6a21\u677f\u5185\u90e8\u6307\u5b9a\u4e00\u4e2a\u9ed8\u8ba4\u503c\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6240\u6709\u7684\u9ed8\u8ba4\u503c\u90fd\u5e94\u8be5\u5728values.yaml\u6587\u4ef6\u5185\u6307\u5b9a\uff0c\u9664\u975e\u662f\u4e00\u4e9b\u8fd0\u7b97\u7ed3\u679c\nempty  \u5982\u679c\u7ed9\u5b9a\u7684\u503c\u88ab\u8ba4\u4e3a\u662f\u7a7a\u7684\uff0c\u5219empty\u51fd\u6570\u8fd4\u56detrue\uff0c\u5426\u5219\u8fd4\u56defalse\u3002\u5728Go\u6a21\u677f\u6761\u4ef6\u4e2d\uff0c\u7a7a\u503c\u662f\u4e3a\u4f60\u8ba1\u7b97\u51fa\u6765\u7684\u3002\u8fd9\u6837\u4f60\u5f88\u5c11\u9700\u8981 if empty .Foo \uff0c\u4ec5\u4f7f\u7528 if .Foo \u5373\u53ef\u3002\n</code></pre>","tags":["helm","kubernetes"]},{"location":"kubernetes/helm/#4","title":"4. \u8fd0\u884c\u7b26","text":"<p>\u8fd0\u7b97\u7b26\u88ab\u5b9e\u73b0\u4e3a\u8fd4\u56de\u5e03\u5c14\u503c\u7684\u51fd\u6570\u3002\u8981\u4f7f\u7528<code>eq</code>\u3001<code>ne</code>\u3001<code>lt</code>\u3001<code>gt</code>\u3001<code>and</code>\u3001<code>or</code>\u3001<code>not</code>\u7b49\u7b49\uff0c\u5c31\u8981\u628a\u8fd0\u7b97\u7b26\u653e\u5728\u8bed\u53e5\u7684\u524d\u9762\uff0c\u540e\u9762\u8ddf\u7740\u5b83\u7684\u53c2\u6570\uff0c\u5c31\u50cf\u51fd\u6570\u4e00\u6837\u3002\u8981\u5c06\u591a\u4e2a\u64cd\u4f5c\u94fe\u63a5\u5728\u4e00\u8d77\uff0c\u53ef\u4ee5\u7528\u62ec\u53f7\u5c06\u5b83\u4eec\u5206\u9694\u5f00\u3002</p> <pre><code>{{/* include the body of this if statement when the variable .Values.fooString exists and is set to \"foo\" */}}\n{{ if and .Values.fooString (eq .Values.fooString \"foo\") }}\n    {{ ... }}\n{{ end }}\n\n\n{{/* include the body of this if statement when the variable .Values.anUnsetVariable is set or .values.aSetVariable is not set */}}\n{{ if or .Values.anUnsetVariable (not .Values.aSetVariable) }}\n   {{ ... }}\n{{ end }}\n</code></pre>","tags":["helm","kubernetes"]},{"location":"kubernetes/helm/#5","title":"5. \u4ece\u96c6\u7fa4\u4e2d\u83b7\u53d6\u4fe1\u606f","text":"<pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: {{ include \"apis.qappSecretName\" . | lower }}\n  namespace: {{ .Release.Namespace }}\n  labels: {{- include \"apis.labels\" . | nindent 4 }}\ntype: Opaque\ndata:\n  {{- if .Release.IsInstall }}\n  OAUTH_CLIENT_ID: \"\"\n  OAUTH_CLIENT_SECRET: \"\"\n  {{- else }}\n  {{- $secretObj := (lookup \"v1\" \"Secret\" .Release.Namespace (include \"apis.qappSecretName\" .))  }}\n  {{- $secretData := (get $secretObj \"data\") | default dict }}\n  OAUTH_CLIENT_ID: {{ (get $secretData \"OAUTH_CLIENT_ID\")  | quote }}\n  OAUTH_CLIENT_SECRET: {{ (get $secretData \"OAUTH_CLIENT_SECRET\")  | quote }}\n  {{- end }}\n</code></pre>","tags":["helm","kubernetes"]},{"location":"kubernetes/helm/#6-range","title":"6. \u5faa\u73af range","text":"<pre><code>{{ if .Values.envVarsSecret }}\napiVersion: v1\nkind: Secret\nmetadata:\n  name: {{ printf \"%s-envvars\" (include \"common.names.fullname\" .) }}\n  namespace: {{ .Release.Namespace }}\n  labels: {{- include \"common.labels.standard\" . | nindent 4 }}\n    {{- if .Values.commonLabels }}\n    {{- include \"common.tplvalues.render\" ( dict \"value\" .Values.commonLabels \"context\" $ ) | nindent 4 }}\n    {{- end }}\n  {{- if .Values.commonAnnotations }}\n  annotations: {{- include \"common.tplvalues.render\" ( dict \"value\" .Values.commonAnnotations \"context\" $ ) | nindent 4 }}\n  {{- end }}\ntype: Opaque\ndata:\n{{- range $key, $val := .Values.envVarsSecret }}\n  {{- $key | nindent 2 }}: {{ $val | b64enc | quote }}\n{{- end }}\n{{- end }}\n</code></pre>","tags":["helm","kubernetes"]},{"location":"kubernetes/helm/#7-dependencies","title":"7. dependencies","text":"<pre><code># Charts.yaml\ndependencies:\n# \u8be5condition\u4ee3\u8868\u53c2\u6570fileapi-v2.enabled\u4ec5\u660e\u786e\u4e3abool false\u65f6\uff0c\u53d6\u6d88\u5b89\u88c5\u5b50charts fileapi-v2\uff0c\u5176\u4ed6\u60c5\u51b5\u5747\u4ee5true\u5904\u7406\n- condition: fileapi-v2.enabled\n  name: fileapi-v2\n  repository: https://git.ketanyun.cn/api/v4/projects/1611/packages/helm/stable\n  version: 1.5.11\n</code></pre>","tags":["helm","kubernetes"]},{"location":"kubernetes/etcd/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/","title":"etcdctl","text":"<p>https://chromium.googlesource.com/external/github.com/coreos/etcd/+/release-3.0/etcdctl/README.md</p> <pre><code># \u67e5\u770b\u6210\u5458\u5217\u8868\netcdctl --endpoints 127.0.0.1:2379 \\\n    --cert=/etc/kubernetes/pki/etcd/server.crt \\\n    --key=/etc/kubernetes/pki/etcd/server.key \\\n    --cacert=/etc/kubernetes/pki/etcd/ca.crt \\\n    member list -w table\n\n# \u67e5\u770bleader\netcdctl --endpoints 127.0.0.1:2379 \\\n    --cert=/etc/kubernetes/pki/etcd/server.crt \\\n    --key=/etc/kubernetes/pki/etcd/server.key \\\n    --cacert=/etc/kubernetes/pki/etcd/ca.crt \\\n    endpoint status --cluster -w table\n\n# \u67e5\u770b\u5f53\u524d\u8282\u70b9\u7684\u5065\u5eb7\u72b6\u6001\netcdctl --endpoints 127.0.0.1:2379 \\\n    --cert=/etc/kubernetes/pki/etcd/server.crt \\\n    --key=/etc/kubernetes/pki/etcd/server.key \\\n    --cacert=/etc/kubernetes/pki/etcd/ca.crt \\\n    endpoint health\n\n# \u5bf9\u5f53\u524d\u6570\u636e\u8fdb\u884c\u5feb\u7167\u5907\u4efd\netcdctl --endpoints 127.0.0.1:2379 \\\n    --cert=/etc/kubernetes/pki/etcd/server.crt \\\n    --key=/etc/kubernetes/pki/etcd/server.key \\\n    --cacert=/etc/kubernetes/pki/etcd/ca.crt \\\n    snapshot save etcd-backup.db\n\n# \u67e5\u770b\u5feb\u7167\u6587\u4ef6\netcdctl --endpoints 127.0.0.1:2379 \\\n    --cert=/etc/kubernetes/pki/etcd/server.crt \\\n    --key=/etc/kubernetes/pki/etcd/server.key \\\n    --cacert=/etc/kubernetes/pki/etcd/ca.crt \\\n    snapshot status etcd-backup.db -w table\n</code></pre>","tags":["etcd","kubernetes"]},{"location":"kubernetes/etcd/%E6%88%90%E5%91%98%E6%95%B0%E6%8D%AE%E6%8D%9F%E5%9D%8F/","title":"\u6210\u5458\u6570\u636e\u635f\u574f","text":"<p>https://etcd.io/docs/v3.4/op-guide/data_corruption/</p>","tags":["etcd","kubernetes"]},{"location":"kubernetes/etcd/%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D/","title":"k8s\u6258\u7ba1\u7684etcd\u7684\u707e\u96be\u6062\u590d","text":"<p>https://etcd.io/docs/v3.4/op-guide/recovery/</p> <pre><code>--name\uff1a\u6bcf\u4e2aetcd\u4e0e/etc/kubernetes/manifests/etcd.yaml\u4e2d\u7684--name=\u8981\u6c42\u4e00\u81f4\n--initial-cluster\uff1a\u4e5f\u5c31\u662f\u96c6\u7fa4\u4e2d\u6240\u6709\u7684 initial-advertise-peer-urls \u7684\u5408\u96c6\u3002\u53ef\u4ee5\u4ecemaster3\u7684/etc/kubernetes/manifests/etcd.yaml\u4e2d\u83b7\u53d6\n--initial-cluster-token\uff1aetcd-cluster-1\uff0c\u8282\u70b9\u7684 token \u503c\uff0c\u8bbe\u7f6e\u8be5\u503c\u540e\u96c6\u7fa4\u5c06\u751f\u6210\u552f\u4e00 id\uff0c\u5e76\u4e3a\u6bcf\u4e2a\u8282\u70b9\u4e5f\u751f\u6210\u552f\u4e00 id\uff0c\u5f53\u4f7f\u7528\u76f8\u540c\u914d\u7f6e\u6587\u4ef6\u518d\u542f\u52a8\u4e00\u4e2a\u96c6\u7fa4\u65f6\uff0c\u53ea\u8981\u8be5 token \u503c\u4e0d\u4e00\u6837\uff0cetcd \u96c6\u7fa4\u5c31\u4e0d\u4f1a\u76f8\u4e92\u5f71\u54cd\u3002\n--initial-advertise-peer-urls\uff1a\u5efa\u8bae\u7528\u4e8e\u8282\u70b9\u4e4b\u95f4\u901a\u4fe1\u7684url\uff0c\u8282\u70b9\u95f4\u5c06\u4ee5\u8be5\u503c\u8fdb\u884c\u901a\u4fe1\u3002\u53ef\u4ee5\u4ecemaster\u5404\u81ea\u7684/etc/kubernetes/manifests/etcd.yaml\u4e2d\u83b7\u53d6\n</code></pre> <pre><code># \u767b\u5f55\u83b7\u53d6\u6700\u8fd1\u4e00\u6b21\u7684\u5907\u4efd\u8282\u70b9\uff0c\u83b7\u53d6\u5907\u4efd\u6587\u4ef6\u3002\nkubectl get po -n kube-system -o wide | grep etcd-backup \n\n# \u5907\u4efd\u6587\u4ef6\u4e0a\u4f20\u5230\u6240\u6709master\n\n# \u6240\u6709master\u6267\u884c\nsystemctl stop kubelet\n# \u505c\u6b62etcd\uff0c\u6240\u6709master\u6267\u884c\ndocker ps -a | grep etcd_etcd | awk '{system(\"docker stop \"$1\"\")}'\n\n# master\u670d\u52a1\u5668\u6309\u987a\u5e8f\u6267\u884c\nETCDCTL_API=3 etcdctl snapshot restore etcd-backup-2023-05-27.db \\\n  --name k8s-master1 \\\n  --initial-cluster k8s-master3=https://192.168.182.17:2380,k8s-master1=https://192.168.182.15:2380,k8s-master2=https://192.168.182.16:2380 \\\n  --initial-cluster-token etcd-cluster-1 \\\n  --initial-advertise-peer-urls https://192.168.182.15:2380\nmv k8s-master1.etcd/member/* /var/lib/etcd/member/\n\nETCDCTL_API=3 etcdctl snapshot restore etcd-backup-2023-05-27.db \\\n  --name k8s-master2 \\\n  --initial-cluster k8s-master3=https://192.168.182.17:2380,k8s-master1=https://192.168.182.15:2380,k8s-master2=https://192.168.182.16:2380 \\\n  --initial-cluster-token etcd-cluster-1 \\\n  --initial-advertise-peer-urls https://192.168.182.16:2380 \nmv k8s-master2.etcd/member/* /var/lib/etcd/member/\n\nETCDCTL_API=3 etcdctl snapshot restore etcd-backup-2023-05-27.db \\\n  --name k8s-master3 \\\n  --initial-cluster k8s-master3=https://192.168.182.17:2380,k8s-master1=https://192.168.182.15:2380,k8s-master2=https://192.168.182.16:2380 \\\n  --initial-cluster-token etcd-cluster-1 \\\n  --initial-advertise-peer-urls https://192.168.182.17:2380\nmv k8s-master3.etcd/member/* /var/lib/etcd/member/\n\n# \u542f\u52a8\u6240\u6709master\u7684kubelet\nsystemctl start kubelet\n\n# \u7b49\u5f851-2min,\u68c0\u67e5etcd\u8fd0\u884c\u72b6\u6001\uff0c\u65e5\u5fd7\uff0c\u6392\u67e5\u9519\u8bef\n\n# \u67e5\u770b\u662f\u5426\u6709\u9057\u7559\u7684\u6545\u969cetcd\u5bb9\u5668\uff0c\u9700\u8981\u5220\u9664\uff0c\u6240\u6709master\u6267\u884c\ndocker ps -a | grep etcd_etcd\ndocker rm \n\n# \u91cd\u542f\u5176\u4ed6\u96c6\u7fa4\u7ec4\u4ef6\uff0c\u6240\u6709master\u6267\u884c\ndocker ps |grep -E 'k8s_kube-apiserver|k8s_kube-controller-manager|k8s_kube-scheduler' | awk '{system(\"docker restart \"$1\"\")}'\n\n# \u786e\u8ba4\u6240\u6709\u7684\u96c6\u7fa4\u7ec4\u4ef6\u72b6\u6001\u6b63\u5e38\nkubectl get pods -n kube-system\n\n# \u91cd\u542f\u6240\u6709\u670d\u52a1\u5668\u7684kubelet\nsystemctl restart kubelet\n</code></pre>","tags":["etcd","kubernetes"]},{"location":"kubernetes/k8s-applications/Kafka/","title":"Kafka","text":"<p>https://github.com/bitnami/charts/tree/main/bitnami/kafka</p> <pre><code># kafka 21.1.1\nhelm repo add bitnami https://charts.bitnami.com/bitnami\nhelm upgrade --install kafka bitnami/kafka -n {NS} \\\n--set global.storageClass='nfs-client' \\\n--set heapOpts='-Xmx1024m -Xms1024m' \\\n--set allowEveryoneIfNoAclFound=true \n\n\n\n--set superUsers='root' \\\n--set autoCreateTopicsEnable=true \\\n--set deleteTopicEnable=false \\\n</code></pre> <ul> <li>\u6d4b\u8bd5 <pre><code># \u5f00\u4e24\u4e2a\u7ec8\u7aef\nkubectl run kafka-client --restart='Never' --image docker.io/bitnami/kafka:3.4.0-debian-11-r2 --namespace saas --command -- sleep infinity\nkubectl exec --tty -i kafka-client --namespace saas -- bash\n\n# \u5206\u522b\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\nPRODUCER:\n    kafka-console-producer.sh \\\n        --broker-list kafka-0.kafka-headless.saas.svc.cluster.local:9092 \\\n        --topic test\n\nCONSUMER:\n    kafka-console-consumer.sh \\\n        --bootstrap-server kafka.saas.svc.cluster.local:9092 \\\n        --topic test \\\n        --from-beginning\n\n# \u5728\u751f\u4ea7\u8005\u7ec8\u7aef\u8f93\u5165\uff0c\u53ef\u4ee5\u5728\u6d88\u8d39\u8005\u7ec8\u7aef\u770b\u5230\u6d88\u606f\u5373\u4e3a\u6b63\u5e38        \n</code></pre></li> </ul> <pre><code># \u5217\u51fatopic\nkafka-topics.sh --bootstrap-server kafka.saas.svc.cluster.local:9092 --list\n</code></pre>"},{"location":"kubernetes/k8s-applications/db12c-oracle-db/","title":"Db12c oracle db","text":""},{"location":"kubernetes/k8s-applications/db12c-oracle-db/#oracle","title":"\u4f7f\u7528oracle\u8d26\u53f7\u521b\u5efa\u955c\u50cf\u62c9\u53d6\u5bc6\u94a5","text":"<pre><code>kubectl create secret docker-registry oracle-office-zhdong -n $NS \\\n--docker-username= \\\n--docker-password='' \\\n--docker-server=container-registry.oracle.com  \\\n--dry-run=client -o yaml | kubectl apply -f -\n</code></pre>"},{"location":"kubernetes/k8s-applications/db12c-oracle-db/#_1","title":"\u521b\u5efa\u6570\u636e\u5377","text":"<pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: db12c-oracle-db\n  namespace: ketanyun\nspec:\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 30Gi\n  storageClassName: nfs-client\n  volumeMode: Filesystem\n</code></pre>"},{"location":"kubernetes/k8s-applications/db12c-oracle-db/#oracle_1","title":"\u8bbe\u7f6eoracle\u5bc6\u7801","text":"<pre><code>kubectl create secret generic db12c-oracle-db -n ketanyun \\\n--from-literal=oracle_pwd='' \\\n--dry-run=client -o yaml | kubectl apply -f -\n</code></pre>"},{"location":"kubernetes/k8s-applications/db12c-oracle-db/#_2","title":"\u90e8\u7f72","text":"<pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  annotations:\n    description: Oracle db12c\n  labels:\n    k8s-app: db12c-oracle-db\n    qcloud-app: db12c-oracle-db\n  name: db12c-oracle-db\n  namespace: ketanyun\nspec:\n  serviceName: db12c-oracle-db\n  podManagementPolicy: OrderedReady\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      k8s-app: db12c-oracle-db\n      qcloud-app: db12c-oracle-db\n  updateStrategy:\n    rollingUpdate:\n      partition: 0\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        k8s-app: db12c-oracle-db\n        qcloud-app: db12c-oracle-db\n    spec:\n      containers:\n      - env:\n        - name: DB_SID\n          value: ORCL\n        - name: DB_PDB\n          value: prod\n        - name: DB_PASSWD\n          valueFrom:\n            secretKeyRef:\n              key: oracle_pwd\n              name: db12c-oracle-db\n              optional: false\n        - name: DB_DOMAIN\n          value: local\n        - name: DB_MEMORY\n          value: 2Gi\n        - name: DB_BUNDLE\n          value: basic\n        image: container-registry.oracle.com/database/enterprise:12.2.0.1\n        imagePullPolicy: IfNotPresent\n        name: oracle-db\n        ports:\n        - containerPort: 1521\n          protocol: TCP\n        readinessProbe:\n          exec:\n            command:\n            - /bin/sh\n            - -c\n            - /home/oracle/setup/healthcheck.sh\n          failureThreshold: 3\n          initialDelaySeconds: 360\n          periodSeconds: 40\n          successThreshold: 1\n          timeoutSeconds: 20\n        resources:\n          limits:\n            cpu: \"2\"\n            memory: 4Gi\n          requests:\n            cpu: 500m\n            memory: 1Gi\n        terminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n        volumeMounts:\n        - mountPath: /dev/shm\n          name: dshm\n        - mountPath: /ORCL\n          name: db12c-oracle-db\n      dnsPolicy: ClusterFirst\n      imagePullSecrets:\n      - name: oracle-office-zhdong\n      restartPolicy: Always\n      securityContext:\n        fsGroup: 54321\n        runAsUser: 54321\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - emptyDir:\n          medium: Memory\n        name: dshm\n#      - name: datamount\n#        persistentVolumeClaim:\n#          claimName: db12c-oracle-db\n  volumeClaimTemplates:\n  - metadata:\n      name: db12c-oracle-db\n    spec:\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 200Gi\n      storageClassName: nfs-client\n\n---\n\napiVersion: v1\nkind: Service\nmetadata:\n  annotations:\n    description: Oracle db12c\n  name: db12c-oracle-db\n  namespace: ketanyun\nspec:\n  ports:\n  - name: tcp-1521\n    port: 1521\n    protocol: TCP\n    targetPort: 1521\n  selector:\n    k8s-app: db12c-oracle-db\n    qcloud-app: db12c-oracle-db\n  sessionAffinity: None\n  type: ClusterIP\n</code></pre>"},{"location":"kubernetes/k8s-applications/redis/","title":"redis","text":""},{"location":"kubernetes/k8s-applications/redis/#helmredis","title":"\u4f7f\u7528helm\u90e8\u7f72redis","text":"<pre><code>helm repo add bitnami https://charts.bitnami.com/bitnami\nhelm repo update\n\n\n# \u5355\u8282\u70b9\uff0c\u6ca1\u5bc6\u7801\nhelm install redis bitnami/redis -n dev \\\n--version=16.9.10 \\\n--set global.storageClass='nfs-client' \\\n--set master.persistence.size='30Gi' \\\n--set architecture='standalone' \\\n--set auth.enabled='false' \n\n\n# \u96c6\u7fa4\u6a21\u5f0f\uff0c\u6709\u5bc6\u7801\nhelm install redis-cluster bitnami/redis -n dev \\\n--version=16.9.10 \\\n--set global.storageClass='nfs-client' \\\n--set master.persistence.size='30Gi' \\\n--set replica.persistence.size='30Gi' \\\n--set global.redis.password='qqq...AAA!!!' \n</code></pre>"},{"location":"kubernetes/k8s-applications/gitlab/config/","title":"\u914d\u7f6e","text":"","tags":["gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/config/#oauth","title":"\u5bf9\u63a5oauth","text":"","tags":["gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/config/#1-sso","title":"1. sso\u521b\u5efa\u5e94\u7528","text":"<p>\u8d26\u53f7\u4e3b\u4f53\u9009\u62e9openid\uff0cscope\u52fe\u9009\u6388\u6743\u7801\u8ba4\u8bc1\u7684openid\u548cprofile</p>","tags":["gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/config/#2-gitlabgitlabrb","title":"2. \u914d\u7f6egitlab\uff0c\u4fee\u6539\u914d\u7f6e\u6587\u4ef6gitlab.rb","text":"<ul> <li> <p>omniauth\u914d\u7f6e\u8bf4\u660e</p> </li> <li> <p>oauth2\u914d\u7f6e\u8bf4\u660e</p> </li> </ul> <pre><code># \u8ba4\u8bc1\u5bf9\u63a5\u914d\u7f6e\ngitlab_rails['omniauth_enabled'] = true\ngitlab_rails['omniauth_block_auto_created_users'] = true\ngitlab_rails['omniauth_allow_single_sign_on'] = ['oauth2_generic']\ngitlab_rails['omniauth_external_providers'] = ['oauth2_generic','openid_connect']\ngitlab_rails['omniauth_providers'] = [\n  {\n    name: \"oauth2_generic\",\n    label: \"Login with xxxxx\", # optional label for login button, defaults to \"Oauth2 Generic\"\n    app_id: \"&lt;your_app_client_id&gt;\",\n    app_secret: \"&lt;your_app_client_secret&gt;\",\n    args: {\n      client_options: {\n        site: \"https://oauth.site\",\n        user_info_url: \"/sso/oauth2/userinfo\",\n        authorize_url: \"/sso/oauth2/authorize\",\n        token_url: \"/sso/oauth2/token\"\n      },\n      user_response_structure: {\n        root_path: [],\n        id_path: [\"sub\"],\n        attributes: {\n          name: \"name\",\n          nickname: \"userName\",\n          email: \"email\"\n        }\n      },\n      authorize_params: {\n        scope: \"openid profile\"\n      },\n      strategy_class: \"OmniAuth::Strategies::OAuth2Generic\"\n    }\n  }\n]\n</code></pre>","tags":["gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/install/","title":"\u5b89\u88c5gitlab","text":"","tags":["gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/install/#dockerpod","title":"\u4f7f\u7528docker\u955c\u50cf\u5b89\u88c5\uff08\u6240\u6709\u7ec4\u4ef6\u8fd0\u884c\u5728\u4e00\u4e2apod\u91cc\uff09","text":"<p>gitlab-ce-single.yaml</p> <pre><code>kubectl label node &lt;nodeName&gt; node-role.kubernetes.io/critical-apps=gitlab\nkubectl taint nodes &lt;node-name&gt; node-role.kubernetes.io/critical-apps=gitlab:NoSchedule\n\nkubectl create ns gitlab\nkubectl -n gitlab create -f gitlab-ce-single.yaml\n</code></pre> <ul> <li>\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e<code>/etc/gitlab/gitlab.rb</code>\uff0c\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u540e\u91cd\u542fpod</li> </ul> <pre><code># \u90e8\u7f72\u540e\u9996\u8981\u914d\u7f6e\uff0cgitlab\u7684\u8bbf\u95ee\u5730\u5740\u3002\u5f71\u54cd\u5728\u5e73\u53f0\u4e0a\u663e\u793a\u7684url\u5730\u5740\uff0c\u586b\u5199\u771f\u6b63\u7684\u5916\u90e8\u8bbf\u95ee\u534f\u8bae+\u57df\u540d\nexternal_url 'https://gitlab.local.site'\nnginx['enable'] = true\nnginx['client_max_body_size'] = '2048m'\n# \u76d1\u542c\u7aef\u53e3\u6307\u5b9a\u4e3a80\uff0c\u534f\u8bae\u4e3ahttp\u3002ssl\u8bc1\u4e66\u5728\u5916\u90e8\u4ee3\u7406\u4e0a\u914d\u7f6e\uff0c\u4f8b\u5982ingress\nnginx['listen_port'] = 80\nnginx['listen_https'] = false\n#nginx['redirect_http_to_https'] = true\n#nginx['redirect_http_to_https_port'] = 80\n#nginx['ssl_certificate'] = \"/etc/gitlab/ssl/git.ketanyun.cn.crt\"\n#nginx['ssl_certificate_key'] = \"/etc/gitlab/ssl/git.ketanyun.cn.key\"\n\n# \u955c\u50cf\u5e93registry\u670d\u52a1\u5668\u542f\u7528.\n# registry_external_url \u534f\u8bae\u914d\u7f6e\u4e3ahttps\u65f6\u8981\u6c42gitlab\u672c\u5730\u5fc5\u987b\u6709\u8bc1\u4e66\uff0c\u53ef\u4ee5\u914d\u7f6e\u4e3ahttp\uff0c\u8bc1\u4e66\u5728ingress\u4e0a\u914d\u7f6e\nregistry_external_url 'http://registry.local.site'\nregistry['enable'] = true\nregistry['registry_http_addr'] = \"0.0.0.0:5000\"\n# gitlab\u8bbe\u7f6e\u542f\u7528\u955c\u50cf\u5e93\u3002host\u548cport\u586b\u955c\u50cf\u5e93\u663e\u793a\u5728gitlab\u4e0a\u7684\u5730\u5740\ngitlab_rails['registry_enabled'] = true\ngitlab_rails['registry_host'] = \"registry.local.site\"\n#gitlab_rails['registry_port'] = \"80\"\ngitlab_rails['registry_path'] = \"/var/opt/gitlab/gitlab-rails/shared/registry\"\n</code></pre> <p>\u4e0b\u4e00\u6b65\uff0c\u5b89\u88c5minio</p>","tags":["gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/install/#helm","title":"\u4f7f\u7528helm\u5b89\u88c5","text":"<p>Note</p> <p>\u6240\u6709\u7ec4\u4ef6\u90fd\u9700\u8981\u8fd0\u884c Kubernetes 1.20 \u6216\u66f4\u9ad8\u7248\u672c\u7684\u96c6\u7fa4\u624d\u80fd\u5de5\u4f5c</p> <p>\u5b98\u65b9charts\u6587\u6863</p> <p>\u5b89\u88c5\u6587\u6863</p> <pre><code>#\u8bbe\u7f6e\u9ed8\u8ba4\u7684storageClass\nkubectl patch storageclass nfs-client -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}'\n\n# appVersion: v16.8.1\n# certmanager\u548cingress\u6700\u597d\u5355\u72ec\u88c5\nhelm repo add gitlab https://charts.gitlab.io/\nhelm repo update\nhelm upgrade --install gitlab gitlab/gitlab -n gitlab --create-namespace \\\n  --timeout 900s \\\n  --set global.hosts.domain=example.com \\\n  --set global.hosts.externalIP=10.10.10.10 \\\n  --set certmanager-issuer.email=me@example.com \\\n  --set postgresql.image.tag=13.6.0 \\\n  --version=7.8.1 \\\n  --set certmanager.install=false \\\n  --set nginx-ingress.enabled=false \\\n  --set prometheus.install=false \\\n  --set postgresql.persistence.size='1Ti' \\\n  --set minio.persistence.size='1Ti' \\\n  --set redis.master.persistence.size='50Gi' \\\n  --set gitlab.gitaly.persistence.size='1Ti' \\\n  --set global.edition=ce  # \u9ed8\u8ba4\u90e8\u7f72ee\u4f01\u4e1a\u7248\uff0cce\u9700\u8981\u660e\u786e\u6307\u5b9a\n\n# \u90e8\u7f72\u4e4b\u540e\uff0c\u9700\u8981\u4fee\u6539gitlab\u76844\u4e2aingress\u7684ingressClass\u3002charts\u76ee\u524d\u6ca1\u6709\u53c2\u6570\u53ef\u914d\u7f6e\n</code></pre> <pre><code>kubectl get secret &lt;name&gt;-gitlab-initial-root-password -ojsonpath='{.data.password}' | base64 --decode ; echo\n</code></pre>","tags":["gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/install/#_1","title":"\u95ee\u9898\u8bb0\u5f55","text":"<p>ingress\u5f00\u542fhostport\uff0c\u9700\u8981\u7ed1\u5b9a\u4e3b\u673a\u768422\u7aef\u53e3\uff0c\u6240\u4ee5\u9700\u8981\u63d0\u524d\u5c06\u4e3b\u673a\u7684ssh\u670d\u52a1\u7aef\u53e3\u4fee\u6539\u4e00\u4e2a</p>","tags":["gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/minio/","title":"Minio","text":"","tags":["minio","gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/minio/#minio","title":"\u5b89\u88c5minio","text":"<pre><code>helm repo add minio https://charts.min.io/\n\n# rootUser \u7ba1\u7406\u5458\u7528\u6237\n# users \u521b\u5efa\u666e\u901a\u7528\u6237\uff0csecretKey\u4e3a\u7528\u6237\u7684\u5bc6\u7801\n# svcaccts \u521b\u5efaservice account\u7ed9gitlab-runner\u4f7f\u7528\u3002\u6ce8\u610faccessKey\u548csecretKey\u9700\u8981\u6ee1\u8db3\u590d\u6742\u5ea6\u8981\u6c42\nhelm install runner-cache-minio minio/minio \\\n--namespace gitlab --create-namespace \\\n--version 5.0.15 \\\n--set mode='standalone' \\\n--set persistence.storageClass='nfs-client' \\\n--set persistence.size='500Gi' \\\n--set rootUser='minio' \\\n--set rootPassword='' \\\n--set buckets[0].name=runner,buckets[0].policy=none,buckets[0].purge=false \\\n--set users[0].accessKey=runner,users[0].secretKey=fgGft567gs,users[0].policy=readwrite \\\n--set svcaccts[0].accessKey=GbbNXEe1c2s1hj9srvWp,svcaccts[0].secretKey=pEhzoHydH3zEYPVO7NEsXsHznHy4lfJvkuNqJTrn,svcaccts[0].user=runner \\\n--set consoleIngress.enabled=true \\\n--set consoleIngress.hosts[0]='minio.xxx.xxx' \\\n--set consoleIngress.ingressClassName=nginx \\\n--set resources.requests.memory='128Mi' \\\n--set resources.requests.cpu='100m' \\\n--set customCommands[0].command='ilm add --expiry-days 180 myminio/runner' \\\n--set-string customCommandJob.annotations.\"helm\\.sh/hook-weight\"=\"5\"\n</code></pre> <p>\u4e0b\u4e00\u6b65\uff0c\u5b89\u88c5gitlab-runner</p>","tags":["minio","gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/minio/#helm-values","title":"\u8bbe\u7f6e\u5b58\u50a8\u6876\u751f\u547d\u5468\u671f(\u914d\u7f6e\u65b9\u6cd5\u8bf4\u660e\uff0c\u9ed8\u8ba4\u5df2\u901a\u8fc7helm values\u8bbe\u7f6e)","text":"<p>\u5b89\u88c5\u540e\u5efa\u8bae\u4e3abucket\u914d\u7f6elifecycle\uff0c\u9632\u6b62\u6570\u636e\u6301\u7eed\u589e\u957f\u6700\u7ec8\u5199\u6ee1\u78c1\u76d8\u3002console\u9875\u9762\u64cd\u4f5c\u6216\u8005\u4f7f\u7528<code>mc</code>\u547d\u4ee4\u884c</p>","tags":["minio","gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/minio/#minio-console","title":"minio console\u9875\u9762\u64cd\u4f5c","text":"<p>\u8bbf\u95eeminio-console -&gt; Buckets -&gt; runner -&gt; Lifecycle -&gt; Add Lifecycle Rule -&gt; After \u586b\u5199\u6570\u636e\u4fdd\u7559\u591a\u5c11\u5929 -&gt; save</p>","tags":["minio","gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/minio/#mc-ilm","title":"mc ilm \u8bbe\u7f6e\u5bf9\u8c61\u751f\u547d\u5468\u671f","text":"<p>https://min.io/docs/minio/linux/reference/minio-mc.html</p> <pre><code>## \u5b89\u88c5mc\u547d\u4ee4\u884c\n\nwget https://dl.min.io/client/mc/release/linux-amd64/mc\nchmod +x mc\n</code></pre> <pre><code>## \u6dfb\u52a0minio\u914d\u7f6e\n./mc config host add ketanyun http://10.244.163.88:9000\n\n## \u5217\u51fa\u6240\u6709host\n./mc config host list\n\n## \u67e5\u770b\u4e00\u4e2ahost\u4e2d\u7684\u6240\u6709buckets\n./mc ls ketanyun\n\n## \u6dfb\u52a0ilm\u7b56\u7565\uff0c\u6570\u636e\u4fdd\u7559180\u5929\n./mc ilm add --expiry-days 180 ketanyun/runner\n\n## \u67e5\u770b\u6307\u5b9abucket\u7684ilm\u7b56\u7565\uff08\u751f\u547d\u5468\u671f\u7b56\u7565\uff09\n./mc ilm ls ketanyun/runner\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Expiration for latest version (Expiration)                                            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 ID                   \u2502 STATUS  \u2502 PREFIX \u2502 TAGS \u2502 DAYS TO EXPIRE \u2502 EXPIRE DELETEMARKER \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 ci9t02ik5q2hvnbimsc0 \u2502 Enabled \u2502 -      \u2502 -    \u2502            180 \u2502 false               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n## \u79fb\u9664\u6307\u5b9a\u7684ilm\u7b56\u7565\n./mc ilm rm --id \"ci9t02ik5q2hvnbimsc0\" ketanyun/runner\n</code></pre>","tags":["minio","gitlab"]},{"location":"kubernetes/k8s-applications/gitlab/runner/","title":"Runner","text":"","tags":["gitlab","runner"]},{"location":"kubernetes/k8s-applications/gitlab/runner/#gitlab-runner","title":"\u90e8\u7f72gitlab-runner","text":"<p>20240111</p> <p>\u5b98\u65b9\u6587\u6863</p>","tags":["gitlab","runner"]},{"location":"kubernetes/k8s-applications/gitlab/runner/#cdservice-account","title":"\u521b\u5efacd\u7528\u7684service account","text":"<pre><code>kubectl create sa -n gitlab gitlab-cd\n</code></pre>","tags":["gitlab","runner"]},{"location":"kubernetes/k8s-applications/gitlab/runner/#2","title":"\u6388\u6743(\u4f18\u5148\u4f7f\u7528\u65b9\u6cd52)","text":"<ol> <li> <p>\u6388\u6743\u96c6\u7fa4\u7ba1\u7406\u5458\u6743\u9650\uff08\u4e0d\u5efa\u8bae\uff0c\u6709\u96c6\u7fa4\u5b89\u5168\u98ce\u9669\uff09     <pre><code>NS=gitlab\nkubectl create clusterrolebinding gitlab-cd-${NS}-cluster-admin --clusterrole=cluster-admin --serviceaccount=${NS}:gitlab-cd\nunset NS\n</code></pre></p> </li> <li> <p>\u81ea\u5b9a\u4e49\u6743\u9650\uff08\u5efa\u8bae\uff0c\u4ec5\u6388\u6743\u5fc5\u987b\u7684\u6743\u9650\uff0c\u53ef\u540e\u671f\u52a8\u6001\u8c03\u6574\uff09     <pre><code>NS=gitlab\nkubectl apply -f gitlab-cd-clusterrole.yaml\nkubectl create clusterrolebinding gitlab-cd-${NS}-cluster-permission --clusterrole=gitlab-cd --serviceaccount=${NS}:gitlab-cd\nunset NS\n</code></pre></p> </li> </ol> <p>gitlab-cd-clusterrole.yaml</p>","tags":["gitlab","runner"]},{"location":"kubernetes/k8s-applications/gitlab/runner/#_1","title":"\u5b89\u88c5","text":"<pre><code>helm repo add gitlab https://charts.gitlab.io\nhelm search repo -l gitlab/gitlab-runner\n\n# \u5c06minio\u94fe\u63a5\u5bc6\u94a5\u4fdd\u5b58\u5230secret\nkubectl create secret generic runner-minio-access \\\n    -n gitlab \\\n    --from-literal=accesskey=\"GbbNXEe1c2s1hj9srvWp\" \\\n    --from-literal=secretkey=\"pEhzoHydH3zEYPVO7NEsXsHznHy4lfJvkuNqJTrn\"\n\n# runnerToken\u4ecegitlab\u9875\u9762\uff0c\u521b\u5efarunner\u65f6\u83b7\u53d6\n# appVersion: 16.8.0\nhelm upgrade --install gitlab-runner -f gitlab-runner-values.yaml gitlab/gitlab-runner \\\n--create-namespace --namespace gitlab \\\n--version 0.61.0 \\\n--set runnerToken='' \\\n--set gitlabUrl=https://gitlab.example.com \\\n--set image.registry='docker.io' \\\n--set image.image='gitlab/gitlab-runner' \\\n--set image.tag='v16.8.0' \\\n--set runners.cache.secretName='runner-minio-access' \\\n--set rbac.create=true \\\n--set podSecurityContext.runAsUser=999 \\\n--set podSecurityContext.fsGroup=999 \n\n# \u6807\u8bb0\u6784\u5efa\u8282\u70b9\uff0c\u4ec5\u5141\u8bb8\u6784\u5efa\u5728\u6ee1\u8db3\u6761\u4ef6\u7684\u8282\u70b9\u8fd0\u884c\nkubectl label node &lt;nodeName&gt; node-role.kubernetes.io/gitlab=runner\nkubectl taint nodes &lt;node-name&gt; node-role.kubernetes.io/gitlab=runner:NoSchedule\n</code></pre> <p>gitlab-runner-values.yaml</p>","tags":["gitlab","runner"]},{"location":"kubernetes/k8s-applications/mariadb/","title":"Mariadb","text":"<p>\u6587\u6863\u5206\u4e3a\u90e8\u7f72\u548c\u5907\u4efd\u4e24\u90e8\u5206\uff0c\u64cd\u4f5c\u65f6\u8bf7\u4e0d\u8981\u9057\u6f0f\u5907\u4efd</p>"},{"location":"kubernetes/k8s-applications/mariadb/#_1","title":"\u90e8\u7f72","text":"<p>\u6807\u51c6\u5b89\u88c5\u8981\u6c42\u4f7f\u7528helm\u90e8\u7f72</p>"},{"location":"kubernetes/k8s-applications/mariadb/#helm","title":"\u4e00\u3001helm\u90e8\u7f72","text":"<ul> <li>charts</li> </ul>"},{"location":"kubernetes/k8s-applications/mariadb/#0","title":"0. \u51c6\u5907\u5de5\u4f5c","text":"<ul> <li>\u9700\u8981\u53ef\u7528\u7684\u5b58\u50a8\u7c7b\uff0c\u751f\u4ea7\u73af\u5883\u8981\u6c42\u4f7f\u7528<code>local-path</code>\uff0c\u975e\u751f\u4ea7\u4e0d\u505a\u8981\u6c42\u3002\u5b89\u88c5local-path-provisioner</li> <li>\u8bc4\u4f30\u90e8\u7f72\u65b9\u5f0f\uff0c\u540e\u97621.2.3. \u4e09\u9009\u4e00</li> </ul>"},{"location":"kubernetes/k8s-applications/mariadb/#1-helmmariadb","title":"1. helm\u90e8\u7f72mariadb(\u6b63\u5f0f\u73af\u5883\uff0c\u4e3b\u4ece)","text":"<ul> <li> <p>\u6b63\u5f0f\u73af\u5883\u90e8\u7f72\uff0c\u8981\u6c42mariadb\u5355\u72ec\u8fd0\u884c\u5728\u56fa\u5b9a\u7684\u8282\u70b9\u4e0a\uff0c\u5e76\u4e14\u4f7f\u7528<code>local-path</code>\u3002\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u8282\u70b9<code>mariadb-primary</code>\u548c<code>mariadb-secondary</code>\u5206\u522b\u8fd0\u884c\u4e3b\u5e93\u548c\u4ece\u5e93\uff0c\u5177\u4f53\u64cd\u4f5c\u65f6\u53ef\u4ee5\u4fee\u6539\u4e3a\u6b63\u786e\u7684\u8282\u70b9\u540d\u79f0\u3002</p> </li> <li> <p>\u4fee\u6539values.yaml\u4e2d<code>primary.configuration</code>\u548c<code>secondary.configuration</code>\u7684<code>innodb_buffer_pool_size</code>\uff0c\u8bbe\u7f6e\u4e3a\u670d\u52a1\u5668\u5185\u5b58\u768450%</p> </li> </ul> <pre><code>#auth.rootPassword \u6570\u636e\u5e93root\u5bc6\u7801\n#architecture replication\u8868\u793a\u4e3b\u4ece\n#global.storageClass \u6307\u5b9a\u96c6\u7fa4\u5b58\u50a8\u7c7b\uff0c\u6b63\u5f0f\u73af\u5883\u4e0d\u5141\u8bb8\u4f7f\u7528nfs\n#primary.persistence.size \u6570\u636e\u5377\u5927\u5c0f\n#-n ketanyun  \u5b89\u88c5\u5728\u54ea\u4e2a\u547d\u540d\u7a7a\u95f4\n\n# \u5c06\u8fd0\u884c\u6570\u636e\u5e93\u7684\u8282\u70b9\u6807\u8bb0\u6c61\u70b9\uff0c\u963b\u6b62\u5176\u4ed6pod\u8c03\u5ea6\nkubectl taint nodes mariadb-primary node-role.kubernetes.io/mariadb=primary:NoSchedule\nkubectl taint nodes mariadb-secondary node-role.kubernetes.io/mariadb=secondary:NoSchedule\n\n# \u4fee\u6539\u4ee5\u4e0b\u5b89\u88c5\u547d\u4ee4\u4e2d\u7684root\u5bc6\u7801\uff0c\u786e\u8ba4nodeSelector\u662f\u5426\u6b63\u786e\nhelm upgrade --install mariadb-local mariadb-10.5.1.tgz -f values.yaml  \\\n-n default --create-namespace \\\n--version=10.5.1 \\\n--set global.storageClass=local-path  \\\n--set image.tag=10.5.22 \\\n--set auth.rootPassword='' \\\n--set architecture=replication \\\n--set primary.nodeSelector='kubernetes.io/hostname: mariadb-primary' \\\n--set primary.tolerations[0].key='node-role.kubernetes.io/mariadb' \\\n--set primary.tolerations[0].operator='Equal' \\\n--set primary.tolerations[0].value='primary' \\\n--set primary.tolerations[0].effect='NoSchedule' \\\n--set primary.persistence.size=20Gi  \\\n--set primary.extraEnvVars[0].name='TZ' \\\n--set primary.extraEnvVars[0].value='Asia/Shanghai' \\\n--set primary.priorityClassName='system-cluster-critical' \\\n--set secondary.nodeSelector='kubernetes.io/hostname: mariadb-secondary' \\\n--set secondary.tolerations[0].key='node-role.kubernetes.io/mariadb' \\\n--set secondary.tolerations[0].operator='Equal' \\\n--set secondary.tolerations[0].value='secondary' \\\n--set secondary.tolerations[0].effect='NoSchedule' \\\n--set secondary.persistence.size=20Gi  \\\n--set secondary.extraEnvVars[0].name='TZ' \\\n--set secondary.extraEnvVars[0].value='Asia/Shanghai' \\\n--set secondary.priorityClassName='system-cluster-critical'\n</code></pre>"},{"location":"kubernetes/k8s-applications/mariadb/#2-helmmariadb","title":"2. helm\u90e8\u7f72mariadb(\u6b63\u5f0f\u73af\u5883\uff0c\u5355\u673a)","text":"<ul> <li> <p>\u6b63\u5f0f\u73af\u5883\u90e8\u7f72\uff0c\u8981\u6c42mariadb\u5355\u72ec\u8fd0\u884c\u5728\u56fa\u5b9a\u7684\u8282\u70b9\u4e0a\uff0c\u5e76\u4e14\u4f7f\u7528<code>local-path</code>\u3002</p> </li> <li> <p>\u4fee\u6539values.yaml\u4e2d<code>primary.configuration</code>\u7684<code>innodb_buffer_pool_size</code>\uff0c\u8bbe\u7f6e\u4e3a\u670d\u52a1\u5668\u5185\u5b58\u768480%</p> </li> </ul> <pre><code>#auth.rootPassword \u6570\u636e\u5e93root\u5bc6\u7801\n#architecture replication\u8868\u793a\u4e3b\u4ece\n#global.storageClass \u6307\u5b9a\u96c6\u7fa4\u5b58\u50a8\u7c7b\uff0c\u6b63\u5f0f\u73af\u5883\u4e0d\u5141\u8bb8\u4f7f\u7528nfs\n#primary.persistence.size \u6570\u636e\u5377\u5927\u5c0f\n#-n ketanyun  \u5b89\u88c5\u5728\u54ea\u4e2a\u547d\u540d\u7a7a\u95f4\n\n# \u5c06\u8fd0\u884c\u6570\u636e\u5e93\u7684\u8282\u70b9\u6807\u8bb0\u6c61\u70b9\uff0c\u963b\u6b62\u5176\u4ed6pod\u8c03\u5ea6\nkubectl taint nodes mariadb node-role.kubernetes.io/mariadb=primary:NoSchedule\n\n# \u4fee\u6539\u4ee5\u4e0b\u5b89\u88c5\u547d\u4ee4\u4e2d\u7684root\u5bc6\u7801\uff0c\u786e\u8ba4nodeSelector\u662f\u5426\u6b63\u786e\nhelm upgrade --install mariadb mariadb-10.5.1.tgz -f values.yaml  \\\n-n default --create-namespace \\\n--version=10.5.1 \\\n--set global.storageClass=local-path  \\\n--set image.tag=10.5.22 \\\n--set auth.rootPassword='' \\\n--set architecture=standalone \\\n--set primary.nodeSelector='kubernetes.io/hostname: mariadb' \\\n--set primary.tolerations[0].key='node-role.kubernetes.io/mariadb' \\\n--set primary.tolerations[0].operator='Equal' \\\n--set primary.tolerations[0].value='primary' \\\n--set primary.tolerations[0].effect='NoSchedule' \\\n--set primary.persistence.size=20Gi  \\\n--set primary.extraEnvVars[0].name='TZ' \\\n--set primary.extraEnvVars[0].value='Asia/Shanghai' \\\n--set primary.priorityClassName='system-cluster-critical'\n</code></pre>"},{"location":"kubernetes/k8s-applications/mariadb/#3-helmmariadbnfs","title":"3. helm\u90e8\u7f72mariadb(\u4f7f\u7528\u4e86nfs\uff0c\u4ec5\u5141\u8bb8\u6d4b\u8bd5\u73af\u5883\u4f7f\u7528)","text":"<ul> <li> <p>\u4fee\u6539values.yaml\u4e2d<code>primary.configuration</code>\u7684<code>innodb_buffer_pool_size</code>\uff0c\u8bbe\u7f6e\u4e3a\u670d\u52a1\u5668\u5185\u5b58\u768480%</p> </li> <li> <p>\u8bf4\u660e: \u6d4b\u8bd5\u73af\u5883\u5b89\u88c5mariadb,\u4e00\u822c\u6765\u8bf4\u4e0d\u9700\u8981\u5355\u72ec\u6307\u5b9a\u5230\u4e00\u4e2a\u8282\u70b9\u4e0a(\u6216\u8005\u53ef\u80fd\u6574\u4e2a\u73af\u5883\u5c31\u4e00\u4e2a\u8282\u70b9),\u6b64\u65f6\u4e0d\u9700\u8981taint\u8282\u70b9,\u76f4\u63a5\u5b89\u88c5,\u540c\u65f6\u5e94\u8be5\u914d\u7f6eresources,\u907f\u514d\u6570\u636e\u5e93\u8d44\u6e90\u4f7f\u7528\u8fc7\u591a</p> </li> </ul> <pre><code>#auth.rootPassword \u6570\u636e\u5e93root\u5bc6\u7801\n#architecture standalone\u8868\u793a\u5355\u8282\u70b9\uff0c\u4e0d\u505a\u4e3b\u4ece\n#global.storageClass \u6307\u5b9a\u96c6\u7fa4\u5b58\u50a8\u7c7b\n#primary.persistence.size \u6570\u636e\u5377\u5927\u5c0f\n#-n ketanyun  \u5b89\u88c5\u5728\u54ea\u4e2a\u547d\u540d\u7a7a\u95f4\n\n# \u4fee\u6539\u4ee5\u4e0b\u5b89\u88c5\u547d\u4ee4\u4e2d\u7684root\u5bc6\u7801\uff0c\u786e\u8ba4nodeSelector\u662f\u5426\u6b63\u786e\nhelm upgrade --install mariadb mariadb-10.5.1.tgz -f values.yaml  \\\n-n default --create-namespace \\\n--version=10.5.1 \\\n--set image.tag=10.5.22 \\\n--set auth.rootPassword='' \\\n--set architecture=standalone \\\n--set global.storageClass=nfs-client  \\\n--set primary.persistence.size=20Gi  \\\n--set primary.nodeSelector='kubernetes.io/hostname: k8s-node1' \\\n--set primary.resources.limits.cpu='1'  \\\n--set primary.resources.limits.memory='4Gi'  \\\n--set primary.extraEnvVars[0].name='TZ' \\\n--set primary.extraEnvVars[0].value='Asia/Shanghai' \n</code></pre>"},{"location":"kubernetes/k8s-applications/mariadb/#4","title":"4. \u90e8\u7f72\u540e\u68c0\u67e5","text":"<ul> <li>\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u68c0\u67e5mariadb\u5bf9\u5e94\u7684pv\uff0c\u662f\u5426\u6b63\u786e\u5bf9\u5e94\u4e86\u8282\u70b9\uff0c\u4ee5\u53ca\u5b58\u50a8\u8def\u5f84\u662f\u5426\u6b63\u786e</li> </ul> <pre><code>ubuntu@k8s-node1:~$ kubectl get pvc -n saas | grep mariadb\ndata-mariadb-0                                  Bound    pvc-fcf2e3a1-f2c2-48d3-bcae-ed5b7a8d579d   20Gi       RWO            local-path     8d\n\nubuntu@k8s-node1:~$ kubectl describe pv pvc-fcf2e3a1-f2c2-48d3-bcae-ed5b7a8d579d\nName:              pvc-fcf2e3a1-f2c2-48d3-bcae-ed5b7a8d579d\nLabels:            &lt;none&gt;\nAnnotations:       pv.kubernetes.io/provisioned-by: rancher.io/local-path\nFinalizers:        [kubernetes.io/pv-protection]\nStorageClass:      local-path\nStatus:            Bound\nClaim:             saas/data-mariadb-0\nReclaim Policy:    Retain\nAccess Modes:      RWO\nVolumeMode:        Filesystem\nCapacity:          20Gi\nNode Affinity:     \n  Required Terms:  \n    Term 0:        kubernetes.io/hostname in [k8s-node1]   # \u786e\u8ba4\u8282\u70b9\u662f\u5426\u6b63\u786e\nMessage:           \nSource:\n    Type:          HostPath (bare host directory volume)\n    Path:          /data/local-path-provisioner/pvc-fcf2e3a1-f2c2-48d3-bcae-ed5b7a8d579d_saas_data-mariadb-0   # \u786e\u8ba4\u5b58\u50a8\u8def\u5f84\u662f\u5426\u6b63\u786e\n    HostPathType:  DirectoryOrCreate\nEvents:            &lt;none&gt;\n</code></pre>"},{"location":"kubernetes/k8s-applications/mariadb/#mariadbhelm","title":"\u4e8c\u3001\u865a\u62df\u5316\u90e8\u7f72mariadb\uff08\u4ec5\u505a\u8bb0\u5f55\uff0c\u6b63\u5f0f\u90e8\u7f72\u8981\u6c42\u4f7f\u7528helm\u5728\u96c6\u7fa4\u4e2d\uff09","text":"<p>\u6ce8\u610f\uff1a\u6570\u636e\u5e93\u9700\u8981\u548c\u5317\u4eac\u65f6\u95f4\u4e00\u81f4\uff0c\u6545\u5b89\u88c5\u524d\u5fc5\u987b\u8bbe\u7f6e\u670d\u52a1\u5668\u65f6\u533a<code>timedatectl set-timezone Asia/Shanghai</code>\uff0c\u5e76\u914d\u7f6e\u65f6\u95f4\u540c\u6b65\u670d\u52a1</p> <ul> <li>\u5b89\u88c5</li> </ul> <p>\u8bbf\u95ee\u94fe\u63a5\u83b7\u53d6\u5b89\u88c5\u6e90\uff0c\u5efa\u8bae\u7248\u672c10.5</p> <pre><code># ubuntu20.04\u8f6f\u4ef6\u6e90\nsudo apt-get install apt-transport-https curl\nsudo curl -o /etc/apt/trusted.gpg.d/mariadb_release_signing_key.asc 'https://mariadb.org/mariadb_release_signing_key.asc'\nsudo sh -c \"echo 'deb https://mirrors.aliyun.com/mariadb/repo/10.5/ubuntu focal main' &gt;&gt;/etc/apt/sources.list\"\n\n# \u5b89\u88c5\nsudo apt-get update\nsudo apt-get install mariadb-server\n</code></pre> <ul> <li>\u914d\u7f6e</li> </ul> <p>\u53c2\u8003mysql\u53c2\u6570\u90e8\u7f72\u89c4\u8303\u914d\u7f6e\u53c2\u6570</p>"},{"location":"kubernetes/k8s-applications/mariadb/#_2","title":"\u5b9a\u671f\u5907\u4efd","text":"<p>\u53c2\u8003backup/README.md</p>"},{"location":"kubernetes/k8s-applications/mariadb/mariadb-operator/","title":"Mariadb operator","text":""},{"location":"kubernetes/k8s-applications/mariadb/mariadb-operator/#mariadb-operator","title":"mariadb-operator","text":"<p>https://github.com/mariadb-operator/mariadb-operator</p> <pre><code>helm repo add mariadb-operator https://mariadb-operator.github.io/mariadb-operator\nhelm install mariadb-operator mariadb-operator/mariadb-operator\n\n\nkubectl apply -f examples/manifests/config\nkubectl apply -f examples/manifests/mariadb_v1alpha1_mariadb.yaml\n\nkubectl apply -f examples/manifests/mariadb_v1alpha1_database.yaml\nkubectl apply -f examples/manifests/mariadb_v1alpha1_user.yaml\nkubectl apply -f examples/manifests/mariadb_v1alpha1_grant.yaml\n\nkubectl apply -f examples/manifests/sqljobs\n</code></pre>"},{"location":"kubernetes/k8s-applications/mysql/xtrabackup/","title":"xtrabackup","text":""},{"location":"kubernetes/k8s-applications/mysql/xtrabackup/#xtrabackupmysqlmariadbmariadb-backup","title":"xtrabackup\uff08\u4ec5mysql\u3002mariadb\u9700\u4f7f\u7528MariaDB Backup\u3002\uff09","text":"<p>\u4e0b\u8f7d</p>"},{"location":"kubernetes/k8s-applications/mysql/xtrabackup/#1","title":"1.\u5b89\u88c5","text":"<pre><code>tar -xf Percona-XtraBackup-2.4.26-r19de43b-focal-x86_64-bundle.tar\napt install libcurl4-openssl-dev libev4\ndpkg -i percona-xtrabackup-24_2.4.26-1.focal_amd64.deb\n</code></pre>"},{"location":"kubernetes/k8s-applications/mysql/xtrabackup/#2","title":"2.\u4f7f\u7528","text":"\u5e38\u7528\u9009\u9879 \u542b\u4e49 --host \u4e3b\u673a\u540d --user \u7528\u6237\u540d --port \u7aef\u53e3\u53f7 --password \u5bc6\u7801 --databases \u6570\u636e\u5e93\u540d --no-timestamp \u4e0d\u7528\u65e5\u671f\u547d\u540d\u5b58\u50a8\u5907\u4efd\u6587\u4ef6\u7684\u5b50\u76ee\u5f55\u540d --redo-only \u65e5\u5fd7\u5408\u5e76 --apply-log \u51c6\u5907\u6062\u590d\u6570\u636e --copy-back \u62f7\u8d1d\u6570\u636e --incremental \u76ee\u5f55\u540d \u589e\u91cf\u5907\u4efd --incremental-basedir=\u76ee\u5f55\u540d \u589e\u91cf\u5907\u4efd\u65f6,\u6307\u5b9a\u4e0a\u4e00\u6b21\u5907\u4efd\u6570\u636e\u5b58\u50a8\u7684\u76ee\u5f55\u540d --incremental-dir=\u76ee\u5f55\u540d \u51c6\u5907\u6062\u590d\u6570\u636e\u65f6,\u6307\u5b9a\u589e\u91cf\u5907\u4efd\u6570\u636e\u5b58\u50a8\u7684\u76ee\u5f55\u540d --export \u5bfc\u51fa\u8868\u4fe1\u606f <pre><code>--databases=\"\u5e93\"\n--databases=\"\u5e931 \u5e932\"\n--databases=\"\u5e931.\u8868\"\n</code></pre>"},{"location":"kubernetes/k8s-applications/mysql/xtrabackup/#3","title":"3.\u573a\u666f\u53c2\u8003","text":"<ul> <li> <p>\u5168\u91cf\u5907\u4efd\u548c\u6062\u590d <pre><code>#\u5907\u4efd\u6240\u6709\u6570\u636e,\u4e0d\u6307\u5b9a\u5e93\u65f6\u4e3a\u5907\u4efd\u6240\u6709\ninnobackupex --host \u5730\u5740 --port \u7aef\u53e3\u53f7 --user root --password PASSWORD --databases=\u5e93 \u76ee\u5f55 --no-timestamp  \n\n#\u6062\u590d:\n#\n#\u505c\u6b62\u6570\u636e\u5e93\u670d\u52a1\n#\u6e05\u7a7a\u6570\u636e\u76ee\u5f55\u4e0b\u7684\u6570\u636e\n#\u51c6\u5907\u6062\u590d\u6570\u636e\n#\u6062\u590d\u6570\u636e\n#\u4fee\u6539\u6570\u636e\u76ee\u5f55\u4e0b\u6587\u4ef6\u7684\u6240\u6709\u8005/\u7ec4\u4e3amysql\n#\u542f\u52a8\u6570\u636e\u5e93\u670d\u52a1\n#\u7ba1\u7406\u5458\u767b\u5f55\u67e5\u770b\u6570\u636e\nsystemctl stop mysqld   #\u5173\u95ed\u670d\u52a1\nrm -rf /var/lib/mysql/*  #\u6e05\u7a7a\u6570\u636e\ninnobackupex --apply-log \u5907\u4efd\u6587\u4ef6\u8def\u5f84  #\u51c6\u5907\u6062\u590d\u6570\u636e\ninnobackupex --copy-back \u5907\u4efd\u6587\u4ef6\u8def\u5f84  #\u62f7\u8d1d\u6570\u636e\u5230\u6570\u636e\u5e93\u76ee\u5f55\u4e0b\nchown -R mysql:mysql /var/lib/mysql/*  #\u4fee\u6539\u6743\u9650\n</code></pre></p> </li> <li> <p>\u589e\u91cf\u5907\u4efd\u548c\u6062\u590d</p> </li> </ul> <p>\u589e\u91cf\u5907\u4efd: \u5907\u4efd\u76ee\u5f55/xtrabackup_checkpoints\u6587\u4ef6:</p> <ul> <li>lsn:\u65e5\u5fd7\u5e8f\u5217\u53f7</li> </ul> backup_type \u542b\u4e49 full-backuped \u5b8c\u5168\u5907\u4efd incremental \u589e\u91cf\u5907\u4efd log-applied \u5df2\u5e94\u7528(\u5df2\u51c6\u5907\u597d\u6062\u590d\u6570\u636e) <p>\u5e94\u7528\u5b9e\u4f8b:</p> <p>\u5468\u4e00:\u5b8c\u5168\u5907\u4efd</p> <pre><code>innobackupex --user root --password PASSWORD /allbak --no-timestamp  #\u5907\u4efd\u6240\u6709\u6570\u636e\ncat /allbak/xtrabackup_checkpoints \n#lsn:\u65e5\u5fd7\u5e8f\u5217\u53f7\nbackup_type = full-backuped\nfrom_lsn = 0        #\u5907\u4efd\u6570\u636e\u5f00\u59cb\u5e8f\u5217\u53f7\nto_lsn = 2880259      #\u5907\u4efd\u6570\u636e\u7ed3\u5c3e\u5e8f\u5217\u53f7\nlast_lsn = 2880268      #\u589e\u91cf\u5907\u4efd\u65f6,\u4f7f\u7528\u6b64\u5e8f\u5217\u53f7\u4e0e\u6570\u636e\u5e93\u76ee\u5f55\u4e0b\u7684ib_logfile\u8fdb\u884c\u6bd4\u5bf9,\u786e\u5b9a\u662f\u5426\u6709\u65b0\u6570\u636e\ncompact = 0\nrecover_binlog_info = 0\n</code></pre> <p>\u5468\u4e8c:\u589e\u91cf\u5907\u4efd</p> <pre><code>innobackupex --user root --password PASSWORD --incremental /new1dir --incremental-basedir=/allbak --no-timestamp\ncat /new1dir/xtrabackup_checkpoints \nbackup_type = incremental\nfrom_lsn = 2880259    #\u901a\u8fc7\u4e0a\u4e00\u6b21\u5907\u4efd\u7684\u7ed3\u5c3e\u786e\u5b9a\u8fd9\u4e00\u6b21\u5907\u4efd\u7684\u5f00\u59cb\nto_lsn = 2882360  \nlast_lsn = 2882369    #\u518d\u6b21\u8fdb\u884c\u589e\u91cf\u5907\u4efd\u65f6,\u540c\u6837\u8fdb\u884c\u6bd4\u5bf9\ncompact = 0\nrecover_binlog_info = 0\n</code></pre> <p>\u5468\u4e09:\u589e\u91cf\u5907\u4efd</p> <pre><code>innobackupex --user root --password PASSWORD --incremental /new2dir --incremental-basedir=/new1dir --no-timestamp\ncat /new2dir/xtrabackup_checkpoints \nbackup_type = incremental\nfrom_lsn = 2882360\nto_lsn = 2884453\nlast_lsn = 2884462\ncompact = 0\nrecover_binlog_info = 0\n</code></pre> <p>\u589e\u91cf\u6062\u590d:</p> <ol> <li>\u505c\u6b62\u6570\u636e\u5e93\u670d\u52a1</li> <li>\u6e05\u7a7a\u6570\u636e\u5e93\u76ee\u5f55\u4e0b\u5185\u5bb9</li> <li>\u51c6\u5907\u6062\u590d\u6570\u636e(\u5408\u5e76\u65e5\u5fd7)</li> <li>\u62f7\u8d1d\u6570\u636e\u5230\u6570\u636e\u5e93\u76ee\u5f55\u4e0b</li> <li>\u4fee\u6539\u6587\u4ef6\u6240\u6709\u8005/\u7ec4\u4e3amysql</li> <li>\u542f\u52a8\u6570\u636e\u5e93\u670d\u52a1</li> </ol> <pre><code>systemctl stop mysqld\nrm -rf /var/lib/mysql/*\ninnobackupex --apply-log --redo-only /allbak  #\u5408\u5e76\u65e5\u5fd7\ninnobackupex --apply-log --redo-only /allbak --incremental-dir=/new1dir  #\u5408\u5e76\u589e\u91cf\u65e5\u5fd7\ninnobackupex --apply-log --redo-only /allbak --incremental-dir=/new2dir  #\u5408\u5e76\u589e\u91cf\u65e5\u5fd7\ninnobackupex --copy-back /allbak  #\u62f7\u8d1d\u6587\u4ef6\nchown -R mysql:mysql /var/lib/mysql/*\nsystemctl start mysqld\n</code></pre>"},{"location":"kubernetes/k8s-applications/mysql/xtrabackup/#4","title":"4.\u6570\u636e\u8fc1\u79fb\u65b9\u6848","text":"<ol> <li>\u4ece\u670d\u52a1\u5668\u5b89\u88c5mysql,\u542f\u52a8\u670d\u52a1\u5b8c\u6210\u521d\u59cb\u5316\uff0c\u7136\u540estop\u670d\u52a1\uff0c\u5220\u9664/var/lib/mysql/\u4e0b\u7684\u6240\u6709\u6587\u4ef6\uff0c\u4e3a\u6062\u590d\u6570\u636e\u505a\u51c6\u5907</li> <li>\u4f7f\u7528innobackupex\u5de5\u5177\u5907\u4efd\u6240\u6709\u6570\u636e\uff0c\u5e76\u8bb0\u5f55\u5f53\u524d\u7684binlog\u65e5\u5fd7\u540d\u548c\u504f\u79fb\u91cf</li> </ol> <pre><code>innobackupex  --user root --password PASSWORD  --slave-info  /allbak --no-timestamp  #\u4f7f\u7528--slave-info\u53c2\u6570\uff0c\u5907\u4efd\u6240\u6709\u6570\u636e\uff0c\u5e76\u8bb0\u5f55\u5907\u4efd\u6570\u636e\u5bf9\u5e94\u7684binlog\u65e5\u5fd7\u540d\n</code></pre> <ol> <li>\u5c06\u5907\u4efd\u6587\u6863\u53d1\u9001\u5230\u4ece\u670d\u52a1\u5668</li> </ol> <pre><code>scp -r /allbak root@slave:\n</code></pre> <ol> <li>\u4ece\u670d\u52a1\u5668\u4f7f\u7528\u5907\u4efd\u6587\u4ef6\u6062\u590d\u6570\u636e</li> <li>\u542f\u52a8\u670d\u52a1</li> <li>\u67e5\u770b\u5907\u4efd\u6587\u4ef6\u4e2d\u8bb0\u5f55\u7684binlog\u65e5\u5fd7\u4fe1\u606f\uff0c\u914d\u7f6e\u4e3b\u4ece<code>change master to</code></li> </ol> <pre><code>] cat /root/allbak/xtrabackup_info  | grep master11   #master11\u4e3a\u5f53\u524d\u4e3b\u670d\u52a1\u5668\u7684binlog\u65e5\u5fd7\u524d\u7f00\nbinlog_pos = filename 'master11.000001', position '7700'\n</code></pre> <ol> <li>stop\u4ece\u670d\u52a1\u5668\u7684mysqld\u670d\u52a1\uff0c\u5378\u8f7d\uff0c\u5b89\u88c5pxc\uff0c\u542f\u52a8pxc\uff0c\u6b64\u65f6\u8be5\u670d\u52a1\u5668\u4f9d\u7136\u4e3a\u7ebf\u4e0a\u670d\u52a1\u5668\u7684\u4ece\u670d\u52a1\u5668\uff0c\u6570\u636e\u4fdd\u8bc1\u4e86\u540c\u6b65\uff0c\u7ee7\u7eed\u914d\u7f6e\u5176\u4f59pxc\u670d\u52a1\u5668\u5373\u53ef</li> </ol>"},{"location":"kubernetes/k8s-applications/oceanBase/readme/","title":"\u90e8\u7f72","text":""},{"location":"kubernetes/k8s-applications/oceanBase/readme/#k8s","title":"\u5728k8s\u4e2d\u9ad8\u53ef\u7528\u90e8\u7f72\uff08\u5931\u8d25\uff09","text":"<p>https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000218236</p> <pre><code>helm repo add ob-operator https://oceanbase.github.io/ob-operator/\nhelm install ob-operator ob-operator/ob-operator --namespace=oceanbase --create-namespace  --version=1.1.0\n</code></pre> <pre><code># \u8282\u70b9\u89c4\u5212\nkubectl label node k8s-node1 ob.zone=zone1\nkubectl label node k8s-node2 ob.zone=zone2\nkubectl label node k8s-node3 ob.zone=zone3\n</code></pre>"},{"location":"kubernetes/k8s-applications/oceanBase/readme/#_2","title":"\u5bb9\u5668\u76f4\u63a5\u8fd0\u884c","text":"<pre><code>docker run -itd -p 22881:2881 -e MODE=slim -v oceanbase:/root/ob -v oceanbase-metadata:/root/.obd -v oceanbase-agent:/root/obagent --name obstandalone oceanbase/oceanbase-ce\n</code></pre>"},{"location":"kubernetes/k8s-applications/oceanBase/readme/#k8s_1","title":"k8s\u4e2d\u5355\u673a\u90e8\u7f72","text":"<p>standalone.md</p>"},{"location":"kubernetes/k8s-applications/oceanBase/standalone/","title":"standalone","text":""},{"location":"kubernetes/k8s-applications/oceanBase/standalone/#_1","title":"\u90e8\u7f72","text":"<pre><code>helm template oceanbase-test ketanyun-stable/helper -n oceanbase-test \\\n--create-namespace \\\n--set image.repository='oceanbase/oceanbase-ce' \\\n--set env.MINI_MODE=1 \\\n--set updateStrategy.type='Recreate' \\\n--set containerPorts.http='2881' \\\n--set service.ports.http='2881' \\\n--set persistence.enabled=true \\\n--set persistence.mountPath='/root/ob' \\\n--set persistence.storageClass='local-path' \\\n--set persistence.accessModes[0]='ReadWriteOnce' \\\n--set persistence.size='40Gi' \\\n--set nodeSelector.'kubernetes\\.io/hostname'=k8s-node2 \\\n--set-string resources.limits.cpu='2' \\\n--set resources.limits.memory='4Gi' \\\n--set-string resources.requests.cpu='500m' \\\n--set resources.requests.memory='1Gi' \\\n--set service.type='NodePort' \n</code></pre> <pre><code>---\n# Source: helper/templates/pvc.yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: oceanbase-test-pvc\n  namespace: oceanbase-test\n  labels:\n    app.kubernetes.io/name: helper\n    helm.sh/chart: helper-1.0.5\n    app.kubernetes.io/instance: oceanbase-test\n    app.kubernetes.io/managed-by: Helm\n  annotations:\nspec:\n  accessModes:\n    - \"ReadWriteOnce\"\n  resources:\n    requests:\n      storage: 40Gi\n  storageClassName: local-path\n  volumeMode: Filesystem\n---\n# Source: helper/templates/pvc2.yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: oceanbase-test-metadata-pvc\n  namespace: oceanbase-test\n  labels:\n    app.kubernetes.io/name: helper\n    helm.sh/chart: helper-1.0.5\n    app.kubernetes.io/instance: oceanbase-test\n    app.kubernetes.io/managed-by: Helm\n  annotations:\nspec:\n  accessModes:\n    - \"ReadWriteOnce\"\n  resources:\n    requests:\n      storage: 10Gi\n  storageClassName: local-path\n  volumeMode: Filesystem\n---\n# Source: helper/templates/pvc3.yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: oceanbase-test-agent-pvc\n  namespace: oceanbase-test\n  labels:\n    app.kubernetes.io/name: helper\n    helm.sh/chart: helper-1.0.5\n    app.kubernetes.io/instance: oceanbase-test\n    app.kubernetes.io/managed-by: Helm\n  annotations:\nspec:\n  accessModes:\n    - \"ReadWriteOnce\"\n  resources:\n    requests:\n      storage: 20Gi\n  storageClassName: local-path\n  volumeMode: Filesystem\n---\n# Source: helper/templates/service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: oceanbase-test\n  namespace: oceanbase-test\n  labels:\n    helm.sh/chart: helper-1.0.5\n    app.kubernetes.io/name: helper\n    app.kubernetes.io/instance: oceanbase-test\n    app.kubernetes.io/version: \"0.1.0\"\n    app.kubernetes.io/managed-by: Helm\nspec:\n  ports:\n    - name: http\n      port: 2881\n      targetPort: http\n  selector:\n    app.kubernetes.io/name: helper\n    app.kubernetes.io/instance: oceanbase-test\n  sessionAffinity: None\n  type: NodePort\n---\n# Source: helper/templates/deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: oceanbase-test\n  namespace: oceanbase-test\n  labels:\n    helm.sh/chart: helper-1.0.5\n    app.kubernetes.io/name: helper\n    app.kubernetes.io/instance: oceanbase-test\n    app.kubernetes.io/version: \"0.1.0\"\n    app.kubernetes.io/managed-by: Helm\nspec:\n  minReadySeconds: 0\n  progressDeadlineSeconds: 600\n  revisionHistoryLimit: 10\n  strategy:\n    type: Recreate\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: helper\n      app.kubernetes.io/instance: oceanbase-test\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: helper\n        app.kubernetes.io/instance: oceanbase-test\n      annotations:\n    spec:\n\n      automountServiceAccountToken: false\n      affinity:\n        podAffinity:\n\n        podAntiAffinity:\n          preferredDuringSchedulingIgnoredDuringExecution:\n            - podAffinityTerm:\n                labelSelector:\n                  matchLabels:\n                    app.kubernetes.io/name: helper\n                    app.kubernetes.io/instance: oceanbase-test\n                namespaces:\n                  - \"oceanbase-test\"\n                topologyKey: kubernetes.io/hostname\n              weight: 1\n        nodeAffinity:\n\n      nodeSelector:\n        kubernetes.io/hostname: k8s-node2\n      containers:\n        - name: oceanbase-test\n          image: oceanbase/oceanbase-ce\n          imagePullPolicy: IfNotPresent\n          env:\n\n\n            - name: MODE\n              value: \"slim\"\n\n          envFrom:\n\n\n\n          ports:\n            - containerPort: 2881\n              name: http\n              protocol: TCP\n          resources: {}\n          volumeMounts:\n            - name: oceanbase-test-pvc\n              mountPath: /root/ob\n            - name: oceanbase-test-metadata-pvc\n              mountPath: /root/.obd\n            - name: oceanbase-test-agent-pvc\n              mountPath: /root/obagent\n      volumes:\n        - name: oceanbase-test-pvc\n          persistentVolumeClaim:\n            claimName: oceanbase-test-pvc\n        - name: oceanbase-test-metadata-pvc\n          persistentVolumeClaim:\n            claimName: oceanbase-test-metadata-pvc\n        - name: oceanbase-test-agent-pvc\n          persistentVolumeClaim:\n            claimName: oceanbase-test-agent-pvc\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 60\n      dnsPolicy: ClusterFirst\n</code></pre>"},{"location":"kubernetes/k8s-applications/openldap/Run%20openLDAP%20with%20helm%20on%20k8s/","title":"Run OpenLDAP created by official helm chart on k8s","text":"<p>values.yaml defaultuser.ldif</p>"},{"location":"kubernetes/k8s-applications/openldap/Run%20openLDAP%20with%20helm%20on%20k8s/#using-helm-3-installed-openldap","title":"Using Helm 3 installed OpenLDAP:","text":"<p><pre><code>helm install openldap apphub/openldap \\\n--set persistence.enabled=true \\\n--set persistence.storageClass=\"nfs-client\" \\\n--set persistence.size=\"20Gi\" \\\n-f values.yaml  \\\n-n qtgl\n</code></pre> Got this message: ```shell script [ymzhang@SaaS-Storage qtgl]$ helm install openldap apphub/openldap \\</p> <p>--set persistence.enabled=true \\ --set persistence.storageClass=\"nfs-storage\" \\ --set persistence.size=\"20Gi\" \\ -n qtgl NAME: openldap LAST DEPLOYED: Mon Jul  5 14:14:36 2021 NAMESPACE: qtgl STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: OpenLDAP has been installed. You can access the server from within the k8s cluster using:</p> <p>openldap.qtgl.svc.cluster.local:389</p> <p>You can access the LDAP adminPassword and configPassword using:</p> <p>kubectl get secret --namespace qtgl openldap -o jsonpath=\"{.data.LDAP_ADMIN_PASSWORD}\" | base64 --decode; echo   kubectl get secret --namespace qtgl openldap -o jsonpath=\"{.data.LDAP_CONFIG_PASSWORD}\" | base64 --decode; echo</p> <p>You can access the LDAP service, from within the cluster (or with kubectl port-forward) with a command like (replace password and domain):   ldapsearch -x -H ldap://openldap.qtgl.svc.cluster.local:389 -b dc=example,dc=org -D \"cn=admin,dc=example,dc=org\" -w $LDAP_ADMIN_PASSWORD</p> <p>Test server health using Helm test:   helm test openldap</p> <p>You can also consider installing the helm chart for phpldapadmin to manage this instance of OpenLDAP, or install Apache Directory Studio, and connect using kubectl port-forward. <pre><code>ldapsearch \u67e5\u8be2\n```shell script\nroot@openldap-69db79887d-5xvcf:/# ldapsearch -x -H ldap://openldap-nodeport:389 -b dc=example,dc=org -D \"cn=admin,dc=example,dc=org\" -w aFNhJnUmqiXm4pgB88HQEe2a6r3lkMeT\n# extended LDIF\n#\n# LDAPv3\n# base &lt;dc=example,dc=org&gt; with scope subtree\n# filter: (objectclass=*)\n# requesting: ALL\n#\n\n# example.org\ndn: dc=example,dc=org\nobjectClass: top\nobjectClass: dcObject\nobjectClass: organization\no: Example Inc.\ndc: example\n\n# admin, example.org\ndn: cn=admin,dc=example,dc=org\nobjectClass: simpleSecurityObject\nobjectClass: organizationalRole\ncn: admin\ndescription: LDAP administrator\nuserPassword:: e1NTSEF9ZjgwblRtK05MeVA2aXpNVXFRTXN5QktqdVJ2ZVdZcks=\n\n# search result\nsearch: 2\nresult: 0 Success\n\n# numResponses: 3\n# numEntries: 2\n</code></pre></p>"},{"location":"kubernetes/k8s-applications/openldap/Run%20openLDAP%20with%20helm%20on%20k8s/#references","title":"References","text":"<ul> <li>openladp</li> </ul>"},{"location":"kubernetes/k8s-applications/openldap/docker%E5%AE%89%E8%A3%85openldap/","title":"Docker\u5b89\u88c5openldap","text":"<p>bitnami\u955c\u50cf</p>"},{"location":"kubernetes/k8s-applications/postgresql/readme/","title":"pgsql","text":"<p>bitnami</p>","tags":["pgsql","postgre"]},{"location":"kubernetes/k8s-applications/postgresql/readme/#119","title":"\u90e8\u7f72\u652f\u63011.19\u96c6\u7fa4\u7684\u7248\u672c","text":"<pre><code>helm install pgsql oci://registry-1.docker.io/bitnamicharts/postgresql --version 12.12.10 \\\n--set global.storageClass=nfs-client \\\n--set global.postgresql.auth.postgresPassword='' \\\n--set architecture=standalone \\\n--set primary.resources.limits.memory=2048Mi \\\n--set primary.resources.limits.cpu=1000m \\\n--set primary.resources.requests.memory=256Mi \\\n--set primary.resources.requests.cpu=250m \\\n-n saas -f values.yaml\n</code></pre>","tags":["pgsql","postgre"]},{"location":"kubernetes/k8s-applications/ssh-tunnel/readme/","title":"k8s\u4e2d\u5b89\u88c5ssh-tunnel","text":"<p>ssh-tunnel.yaml</p> <pre><code>kubectl create secret generic ssh-tunnel-pk -n ketanyun --from-file=id_rsa\nkubectl -n ketanyun apply -f ssh-tunnel.yaml\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInVm/","title":"\u865a\u62df\u5316\u90e8\u7f72Tidb","text":"<p>\u8f6f\u4ef6\u548c\u786c\u4ef6\u73af\u5883\u5efa\u8bae\u914d\u7f6e</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInVm/#1","title":"1. \u670d\u52a1\u5668\u62d3\u6251\u89c4\u5212","text":"<p>\u9ad8\u53ef\u7528\u6700\u5c0f\u914d\u7f6e\uff1a\u4f7f\u75283\u4e2a\u8282\u70b9\uff0c\u6bcf\u4e2a\u8282\u70b9\u5747\u8d1f\u8d23\u8fd0\u884c\u6240\u6709\u7ec4\u4ef6\uff0c\u5404\u7ec4\u4ef6\u95f4\u5747\u5300\u5206\u5e03\u57283\u4e2a\u8282\u70b9\u4e0a\u7ec4\u6210\u9ad8\u53ef\u7528</p> <p>\u53c2\u8003config-templates/simple.yaml</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInVm/#2-tidb","title":"2. TiDB \u73af\u5883\u4e0e\u7cfb\u7edf\u914d\u7f6e\u68c0\u67e5","text":"<p>\u6309\u7167\u6807\u9898\u94fe\u63a5\u6587\u6863\u521d\u59cb\u5316\u670d\u52a1\u5668\u53cassh\u514d\u5bc6</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInVm/#3-tiup","title":"3. \u4f7f\u7528tiup\u90e8\u7f72","text":"<ul> <li>\u90e8\u7f72\u5e76\u542f\u52a8</li> </ul> <p>simple.yaml</p> <pre><code># \u5b89\u88c5tiup\ncurl --proto '=https' --tlsv1.2 -sSf https://tiup-mirrors.pingcap.com/install.sh | sh\n\nsource .bash_profile\nwhich tiup\n\n# \u5b89\u88c5 TiUP cluster \u7ec4\u4ef6\ntiup cluster\n\n# \u5b89\u88c5\u524d\u68c0\u67e5\ntiup cluster check config-templates/simple.yaml --user root \n# \u4fee\u590d\ntiup cluster check config-templates/simple.yaml --apply --user root \n# \u90e8\u7f72\u3002tidb-test\u4e3a\u96c6\u7fa4\u540d\u79f0\ntiup cluster deploy tidb-test v7.1.0 config-templates/simple.yaml --user root \n\n# \u5b89\u88c5\u5b8c\u6210\u4ee5\u540e\u9700\u8981\u542f\u52a8\u96c6\u7fa4\ntiup cluster start tidb-test --init\n</code></pre> <ul> <li>\u5e38\u7528\u547d\u4ee4</li> </ul> <pre><code># \u67e5\u770b\u96c6\u7fa4\u5217\u8868\ntiup cluster list\n\n# \u67e5\u770b\u96c6\u7fa4\ntiup cluster display tidb-test\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInVm/#4","title":"4. \u79bb\u7ebf\u90e8\u7f72","text":"<p>https://docs.pingcap.com/zh/tidb/stable/production-deployment-using-tiup#%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInVm/#5-dashboard","title":"5. dashboard","text":"<p>\u901a\u8fc7<code>{pd-ip}:{pd-port}/dashboard</code>\u767b\u5f55 TiDB Dashboard</p>"},{"location":"kubernetes/k8s-applications/tidb/readme/","title":"TiDB","text":"<p>tidb on kubernetes \u5b98\u65b9\u6587\u6863</p> <p>k8s\u4e2d\u90e8\u7f72tidb</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/readme/","title":"\u90e8\u7f72","text":"<p>https://docs.pingcap.com/zh/tidb-in-kubernetes/stable/prerequisites</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/readme/#1-storageclass","title":"1. \u914d\u7f6estorageclass","text":"<ul> <li> <p><code>local-path-provisioner</code>\u9ed8\u8ba4\u914d\u7f6e\u65f6\uff0c\u9700\u8981\u4fdd\u8bc1\u6240\u6709\u8282\u70b9\u7684\u5b58\u50a8\u4f9b\u5e94\u76ee\u5f55\u4e00\u81f4\uff0c\u5373\u6240\u6709\u8282\u70b9\u7684\u6570\u636e\u76d8\u90fd\u6302\u8f7d\u5230\u540c\u540d\u7684\u76ee\u5f55\u3002</p> </li> <li> <p>\u90e8\u7f72local-path-provisioner\uff0c\u63d0\u4f9b\u672c\u5730\u5b58\u50a8\u3002</p> </li> </ul> <p>local-path-storage.yaml</p> <ul> <li>\u6ce8\u610f\u4fee\u6539configmap\u4e2d\u7684\u5b58\u50a8\u8def\u5f84</li> </ul> <pre><code>kind: ConfigMap\napiVersion: v1\nmetadata:\n  name: local-path-config\n  namespace: local-path-storage\ndata:\n  config.json: |-\n    {\n            \"nodePathMap\":[\n            {\n                    \"node\":\"DEFAULT_PATH_FOR_NON_LISTED_NODES\",\n                    \"paths\":[\"/opt/local-path-provisioner\"]\n            }\n            ]\n    }\n</code></pre> <ul> <li>\u4fee\u6539reclaimPolicy</li> </ul> <pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: local-path\nprovisioner: rancher.io/local-path\nvolumeBindingMode: WaitForFirstConsumer\nreclaimPolicy: Retain\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/readme/#2-operator","title":"2. \u5b89\u88c5operator","text":"<ul> <li> <p>\u5b89\u88c5helm\u547d\u4ee4\u884c</p> </li> <li> <p>\u5b89\u88c5crd</p> </li> </ul> <p>crd.yaml</p> <pre><code>kubectl create -f https://raw.githubusercontent.com/pingcap/tidb-operator/v1.4.5/manifests/crd.yaml\n</code></pre> <ul> <li>\u5b89\u88c5operator</li> </ul> <pre><code>helm repo add pingcap https://charts.pingcap.org/\n\nhelm install tidb-operator pingcap/tidb-operator --namespace=tidb-admin --create-namespace \\\n--set scheduler.create='false' \\\n\n# \u4ee5\u4e0b\u8c03\u5ea6\u53c2\u6570\u53ef\u9009\uff0c\u5177\u4f53\u6839\u636e\u662f\u5426\u8981\u8ba9tidb-operator\u548ctidb\u8fd0\u884c\u5728\u4e00\u8d77\n--set controllerManager.nodeSelector.'app\\.kubernetes\\.io/component'=tidb \\\n--set controllerManager.tolerations[0].effect=NoSchedule \\\n--set-string controllerManager.tolerations[0].key=\"node-role.kubernetes.io/tidb\" \\\n--set controllerManager.tolerations[0].operator=\"Exists\" \n\n\nkubectl get po -n tidb-admin -l app.kubernetes.io/name=tidb-operator\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/readme/#3-tidbwoker","title":"3. \u89c4\u5212tidb\u4f7f\u7528\u7684woker\u8282\u70b9","text":"<p>\u53ef\u9009\u5355\u673a\u6a21\u5f0f\u6216\u8005\u9ad8\u53ef\u7528\uff0c\u5355\u673a\u6a21\u5f0f\u9700\u89811\u4e2a\u8282\u70b9\u3002\u9ad8\u53ef\u7528\u6a21\u5f0f\u9700\u8981\u81f3\u5c113\u4e2a\u8282\u70b9\u3002</p> <pre><code># tidb\u8282\u70b9\u6807\u8bb0taint\uff0c\u963b\u6b62tidb\u4e4b\u5916\u7684\u7a0b\u5e8f\u8c03\u5ea6\nkubectl taint nodes k8s-node1 node-role.kubernetes.io/tidb=:NoSchedule\nkubectl taint nodes k8s-node2 node-role.kubernetes.io/tidb=:NoSchedule\nkubectl taint nodes k8s-node3 node-role.kubernetes.io/tidb=:NoSchedule\n\n# tidb\u8282\u70b9\u6253\u6807\u7b7e\uff0c\u4f9b\u8c03\u5ea6\nkubectl label node k8s-node1 app.kubernetes.io/component=tidb\nkubectl label node k8s-node2 app.kubernetes.io/component=tidb\nkubectl label node k8s-node3 app.kubernetes.io/component=tidb\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/readme/#4-tidbtidb-clusteryaml","title":"4. \u4fee\u6539tidb\u96c6\u7fa4\u914d\u7f6e(\u4fee\u6539tidb-cluster.yaml)","text":"<p>pd\u662ftidb\u5143\u6570\u636e\u5b58\u50a8\u7ec4\u4ef6\uff0c\u5185\u7f6eetcd tidb\u662f\u8ba1\u7b97\u7ec4\u4ef6\uff0c\u672c\u8eab\u4e0d\u9700\u8981\u6570\u636e\u6301\u4e45\u5316 tikv\u662f\u5b58\u50a8\u7ec4\u4ef6\uff0c\u9700\u8981\u6570\u636e\u6301\u4e45\u5316\u4e14\u5bf9\u78c1\u76d8\u6027\u80fd\u6709\u8981\u6c42\uff0c\u6240\u4ee5\u5fc5\u987b\u4f7f\u7528k8s\u672c\u5730\u5b58\u50a8\u3002 pump\u662fbinlog\u76f8\u5173\u7ec4\u4ef6\uff0c\u5fc5\u987b\u5b89\u88c5pump\uff0c\u624d\u80fd\u5f00\u542fbinlog</p> <p>tidb-cluster.yaml</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/readme/#_2","title":"\u4fee\u6539\u5404\u7ec4\u4ef6\u526f\u672c\u6570\u91cf","text":"<ul> <li> <p>\u5355\u673a\u6a21\u5f0f\u4fee\u6539\u6240\u6709replicas=1</p> </li> <li> <p>\u9ad8\u53ef\u7528\u6a21\u5f0f\uff1a</p> </li> <li>pd = 3</li> <li>tikv = \u4e0a\u4e00\u6b65\u4e2d\u89c4\u5212\u7684\u8282\u70b9\u6570\u91cf</li> <li>tidb = \u4e0a\u4e00\u6b65\u4e2d\u89c4\u5212\u7684\u8282\u70b9\u6570\u91cf</li> </ul>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/readme/#storageclass","title":"\u4fee\u6539storageclass","text":"<p>\u5728\u6587\u4ef6\u4e2d\u641c\u7d22\u6240\u6709storageClassName\u4fee\u6539</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/readme/#_3","title":"\u5176\u4ed6\u53c2\u6570\u5f85\u8865\u5145","text":""},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/readme/#5-tidb","title":"5. \u90e8\u7f72tidb\u96c6\u7fa4","text":"<pre><code>kubectl create namespace tidb\n\nkubectl apply -f tidb-cluster.yaml -n tidb\n</code></pre> <ul> <li>\u5f85\u6240\u6709\u7ec4\u4ef6\u542f\u52a8\u5b8c\u6210\u4e4b\u540e\uff0c\u518d\u8fdb\u884c\u4e0b\u4e00\u6b65\u521d\u59cb\u5316</li> </ul> <pre><code>root@k8s-master1:~/books/k8s-applications/tidb# kubectl get po -n tidb \nNAME                                           READY   STATUS      RESTARTS   AGE\nadvanced-tidb-discovery-68f65f6fb-sls7t        1/1     Running     3          7d3h\nadvanced-tidb-pd-0                             1/1     Running     3          7d3h\nadvanced-tidb-pd-1                             1/1     Running     2          5d21h\nadvanced-tidb-pd-2                             1/1     Running     2          5d21h\nadvanced-tidb-pump-0                           1/1     Running     3          6d2h\nadvanced-tidb-pump-1                           1/1     Running     3          5d21h\nadvanced-tidb-pump-2                           1/1     Running     3          5d21h\nadvanced-tidb-ticdc-0                          1/1     Running     0          42m\nadvanced-tidb-ticdc-1                          1/1     Running     0          42m\nadvanced-tidb-ticdc-2                          1/1     Running     0          42m\nadvanced-tidb-tidb-0                           2/2     Running     5          6d2h\nadvanced-tidb-tidb-1                           2/2     Running     5          5d21h\nadvanced-tidb-tidb-2                           2/2     Running     0          29m\nadvanced-tidb-tikv-0                           1/1     Running     4          7d3h\nadvanced-tidb-tikv-1                           1/1     Running     1          44h\nadvanced-tidb-tikv-2                           1/1     Running     0          22m\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/readme/#6","title":"6. \u521d\u59cb\u5316","text":"<pre><code># \u521b\u5efaroot\u7528\u6237\u5bc6\u7801secret\nkubectl create secret generic tidb-secret --from-literal=root=\"123qqq...A\" --namespace=tidb\n</code></pre> <ul> <li>\u4fee\u6539tidb-init.yaml</li> </ul> <p>tidb-init.yaml</p> <pre><code>spec:\n  # \u4e0a\u4e00\u6b65\u5b89\u88c5\u7684tidb\u7684\u4fe1\u606f\n  cluster:\n    namespace: tidb\n    name: advanced-tidb\n  # \u914d\u7f6e\u7684sql\u4f1a\u88ab\u6267\u884c\uff0c\u53ef\u4ee5\u6267\u884c\u4f8b\u5982\u5efa\u5e93\u5efa\u7528\u6237sql\n  initSql: |\n    create database app;\n  # \u8fd9\u4e2asecret\u4e2d\u7684\u7528\u6237\u4f1a\u88ab\u521b\u5efa\u7528\u6237\u540d\u662fsecretKey\uff0c\u5bc6\u7801\u4e3aValue\n  passwordSecret: tidb-secret\n</code></pre> <ul> <li>\u6267\u884c\u521d\u59cb\u5316</li> </ul> <pre><code># \u4ea7\u751f\u4e00\u4e2ajob\uff0c\u9700\u7b49\u5f85\u8be5job\u6267\u884c\u5b8c\u6210\u5373\u521d\u59cb\u5316\u7ed3\u675f\nkubectl -n tidb create -f ./manifest/tidb-init.yaml\n\nroot@k8s-master1:~/books/k8s-applications/tidb# kubectl get po -n tidb -l app.kubernetes.io/component=initializer\nNAME                                   READY   STATUS      RESTARTS   AGE\nadvanced-tidb-tidb-initializer-c7jtq   0/1     Completed   0          7d3h\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/readme/#7-tidb-dashboard","title":"7. tidb dashboard","text":"<ul> <li>dashboarad\u96c6\u6210\u5728pd\u4e2d\uff0c\u53ef\u4fee\u6539pd\u7684svc\u4e3aNodePort\uff0c\u901a\u8fc7NodePort\u7aef\u53e3\u8bbf\u95ee</li> </ul> <pre><code>kubectl get svc -n tidb -l app.kubernetes.io/component=pd,app.kubernetes.io/used-by=end-user\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/tidb%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/","title":"Tidb\u6570\u636e\u540c\u6b65","text":""},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/tidb%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/#tidb","title":"\u4e3atidb\u914d\u7f6e\u4e0b\u6e38\u6570\u636e\u5e93\uff0c\u63a5\u6536\u6570\u636e\u540c\u6b65","text":"<p>https://docs.pingcap.com/zh/tidb/dev/replicate-between-primary-and-secondary-clusters</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/tidb%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/#_1","title":"\u6ce8\u610f\u4e8b\u9879","text":"<pre><code>TiCDC \u540c\u6b65\u7684\u8868\u9700\u8981\u81f3\u5c11\u5b58\u5728\u4e00\u4e2a\u6709\u6548\u7d22\u5f15\u7684\u8868\uff0c\u6709\u6548\u7d22\u5f15\u7684\u5b9a\u4e49\u5982\u4e0b\uff1a\n\n\u4e3b\u952e (PRIMARY KEY) \u4e3a\u6709\u6548\u7d22\u5f15\u3002\n\u552f\u4e00\u7d22\u5f15 (UNIQUE INDEX) \u4e2d\u6bcf\u4e00\u5217\u5728\u8868\u7ed3\u6784\u4e2d\u660e\u786e\u5b9a\u4e49\u975e\u7a7a (NOT NULL) \u4e14\u4e0d\u5b58\u5728\u865a\u62df\u751f\u6210\u5217 (VIRTUAL GENERATED COLUMNS)\u3002\n</code></pre> <ul> <li>\u5f00\u542f\u540c\u6b65\u6ca1\u6709\u6709\u6548\u7d22\u5f15\u7684\u8868</li> </ul>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/tidb%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/#tidbticdc","title":"\u4e0a\u6e38tidb\u90e8\u7f72ticdc","text":"<ul> <li> <ol> <li>\u4fee\u6539tidb-cluster.yaml\uff0cticdc\u90e8\u5206</li> </ol> </li> </ul> <pre><code>  ## TiCDC is a tool for replicating the incremental data of TiDB\n  ## Ref: https://docs.pingcap.com/tidb-in-kubernetes/stable/deploy-ticdc/\n  ticdc:\n    baseImage: pingcap/ticdc\n  #   version: \"v6.5.0\"\n    replicas: 3\n    storageClassName: local-path\n  #   requests:\n  #     cpu: 1000m\n  #     memory: 1Gi\n  #   limits:\n  #     cpu: 2000m\n  #     memory: 2Gi\n  #   imagePullPolicy: IfNotPresent\n  #   imagePullSecrets:\n  #   - name: secretName\n  #   hostNetwork: false\n  #   serviceAccount: advanced-tidb-ticdc\n  #   priorityClassName: system-cluster-critical\n  #   schedulerName: default-scheduler\n  #   nodeSelector:\n  #     app.kubernetes.io/component: ticdc\n  #   annotations:\n  #     node.kubernetes.io/instance-type: some-vm-type\n  #   tolerations: {}\n  #   configUpdateStrategy: RollingUpdate\n  #   statefulSetUpdateStrategy: RollingUpdate\n  #   podSecurityContext: {}\n  #   env: []\n  #   additionalContainers: []\n  #   storageVolumes: []\n  #   additionalVolumes: []\n  #   additionalVolumeMounts: []\n  #   terminationGracePeriodSeconds: 30\n  #   config: |\n  #     gc-ttl = 86400\n  #     log-level = \"info\"\n  #     log-file = \"\"\n  #   # TopologySpreadConstraints for pod scheduling, will overwrite cluster level spread constraints setting\n  #   # Ref: pkg/apis/pingcap/v1alpha1/types.go#TopologySpreadConstraint\n  #   topologySpreadConstraints:\n  #   - topologyKey: topology.kubernetes.io/zone\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/tidb%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/#tidb_1","title":"\u4e0b\u6e38tidb\u90e8\u7f72","text":"<p>\u6ce8\u610f\uff1a\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e0d\u5141\u8bb8\u4ecetidb\u548c\u4e3btidb\u5171\u7528k8s\u8282\u70b9(\u5982\u679c\u4e00\u5b9a\u8981\u5171\u7528\u9700\u8981\u540c\u65f6\u53bb\u6389\u4e3b\u4ecetidb\u7684podAntiAffinity\u76f8\u5173\u914d\u7f6e)</p> <p>\u4f7f\u7528tidb-cluster.yaml\uff0c\u4fee\u6539<code>name</code>\u548c<code>nodeSelector</code>\u6216\u5176\u4ed6\u914d\u7f6e\u540e<code>kubectl create -f</code>\u3002\u4e0d\u9700\u8981\u5f00\u542fticdc</p> <pre><code># \u793a\u4f8b\u4e2d\u4ecetidb\u4e3a\u5355\u673a\u6a21\u5f0f\uff0c\u989d\u5916\u4f7f\u7528\u4e86\u4e00\u4e2ak8s\u8282\u70b9\nkubectl create -f ./manifest/slave-tidb-cluster.yaml\nkubectl create secret generic slave-tidb-secret --from-literal=root=\"1qaz@WSX\" --namespace=tidb\nkubectl create -f ./manifest/slave-tidb-init.yaml\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/tidb%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/#brtidb","title":"\u4f7f\u7528BR\u8fc1\u79fb\u5168\u91cf\u6570\u636e(\u5982\u679c\u662f\u5168\u65b0\u7684tidb\uff0c\u5373\u4e0d\u9700\u8981\u8fc1\u79fb\u6570\u636e\uff0c\u5219\u8fd9\u4e00\u6b65\u8df3\u8fc7)","text":"<ul> <li>\u4e0a\u6e38\u6267\u884c</li> </ul> <pre><code>SET GLOBAL tidb_gc_enable=FALSE;\nSELECT @@global.tidb_gc_enable;\n-- BackupTS \u4f5c\u4e3a\u6570\u636e\u6821\u9a8c\u622a\u6b62\u65f6\u95f4\u548c TiCDC \u589e\u91cf\u626b\u63cf\u7684\u5f00\u59cb\u65f6\u95f4\nBACKUP DATABASE * TO 'local:///tmp/backup/' RATE_LIMIT = 120 MB/SECOND;\n+----------------------+----------+--------------------+---------------------+---------------------+\n| Destination          | Size     | BackupTS           | Queue Time          | Execution Time      |\n+----------------------+----------+--------------------+---------------------+---------------------+\n| local:///tmp/backup/ | 10315858 | 431434047157698561 | 2022-02-25 19:57:59 | 2022-02-25 19:57:59 |\n+----------------------+----------+--------------------+---------------------+---------------------+\n1 row in set (2.11 sec)\n</code></pre> <ul> <li>\u4e0b\u6e38\u6267\u884c</li> </ul> <pre><code>RESTORE DATABASE * FROM 'local:///tmp/backup/';\n+----------------------+----------+--------------------+---------------------+---------------------+\n| Destination          | Size     | BackupTS           | Queue Time          | Execution Time      |\n+----------------------+----------+--------------------+---------------------+---------------------+\n| local:///tmp/backup/ | 10315858 | 431434141450371074 | 2022-02-25 20:03:59 | 2022-02-25 20:03:59 |\n+----------------------+----------+--------------------+---------------------+---------------------+\n1 row in set (41.85 sec)\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/tidb%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/#_2","title":"\u521b\u5efa\u540c\u6b65\u4efb\u52a1","text":"<ul> <li>\u767b\u5f55\u4efb\u610fticdc\u7684pod\uff0c\u521b\u5efa\u540c\u6b65\u4efb\u52a1\u3002\u547d\u4ee4\u53c2\u6570\u53ef\u53c2\u8003\u4e0a\u9762\u94fe\u63a5\u6587\u6863</li> </ul> <p>\u5982\u679c\u6267\u884c\u4e86\u4e0a\u4e00\u6b65\u7684\u6570\u636e\u8fc1\u79fb\uff0c\u5219\u9700\u8981\u5728\u521b\u5efa\u540c\u6b65\u4efb\u52a1\u547d\u4ee4\u4e2d\u6dfb\u52a0\u53c2\u6570<code>--start-ts</code>\uff0c\u586b\u4e0a\u4e00\u6b65\u4e2d\u4e0a\u6e38\u96c6\u7fa4\u5907\u4efd\u6570\u636e\u65f6\u8f93\u51fa\u7684<code>BackupTS</code></p> <pre><code># \u521b\u5efa\u540c\u6b65\u4efb\u52a1\n/cdc cli changefeed create \\\n    --server=http://localhost:8301 \\\n    --sink-uri=\"mysql://root:MXFhekBXU1g=@slave-tidb-tidb:4000/\" \\\n    --changefeed-id=\"simple-replication-task\"\n\n# \u521b\u5efa\u540c\u6b65\u4efb\u52a1\u65e7\u7248\uff0c\u4e0a\u9762\u547d\u4ee4\u62a5\u9519pd\u94fe\u63a5\u9519\u8bef\u65f6\u53ef\u5c1d\u8bd5\n/cdc cli changefeed create \\\n    --pd=http://advanced-tidb-pd:2379 \\\n    --sink-uri=\"mysql://root:MXFhekBXU1g=@slave-tidb-tidb:4000/\" \\\n    --changefeed-id=\"simple-replication-task\"\n\n# \u6570\u636e\u8fc1\u79fb\u65f6\u6dfb\u52a0\u53c2\u6570--start-ts\n/cdc cli changefeed create \\\n    --start-ts=\"431434047157698561\" \\\n    --pd=http://advanced-tidb-pd:2379 \\\n    --sink-uri=\"mysql://root:MXFhekBXU1g=@slave-tidb-tidb:4000/\" \\\n    --changefeed-id=\"simple-replication-task\"\n</code></pre> <ul> <li>\u5e38\u7528\u64cd\u4f5c</li> </ul> <pre><code># \u67e5\u8be2\u540c\u6b65\u5217\u8868\n/cdc cli changefeed list --server=http://localhost:8301\n\n# \u5220\u9664\u540c\u6b65\u4efb\u52a1\n/cdc cli changefeed remove --server=http://localhost:8301 --changefeed-id simple-replication-task\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/tidb%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/#_3","title":"\u540c\u6b65\u6d4b\u8bd5\uff0c\u5728\u4e0a\u6e38\u505a\u5199\u64cd\u4f5c\uff0c\u89c2\u5bdf\u4e0b\u6e38\u662f\u5426\u540c\u6b65","text":""},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E5%90%AF%E7%94%A8binlog/","title":"\u542f\u7528binlog","text":""},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E5%90%AF%E7%94%A8binlog/#_1","title":"\u542f\u7528binlog","text":"<p>\u5982\u679c\u9700\u8981\u914d\u7f6etidb\u4e3b\u4ece\u540c\u6b65\uff0c\u79fb\u6b65tidb\u6570\u636e\u540c\u6b65</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E5%90%AF%E7%94%A8binlog/#tidb-clusteryamlpumpbinlog","title":"tidb-cluster.yaml\u4e2d\u6253\u5f00pump\u7ec4\u4ef6\u5373\u81ea\u52a8\u5f00\u542fbinlog\uff0c","text":"<pre><code>  ## Deploy TiDB Binlog of a TiDB cluster\n  ## Ref: https://docs.pingcap.com/tidb-in-kubernetes/stable/deploy-tidb-binlog/#deploy-pump\n  pump:\n  #   baseImage: pingcap/tidb-binlog\n  #   version: \"v6.5.0\"\n    replicas: 3\n    storageClassName: local-path\n    requests:\n  #     cpu: 1000m\n  #     memory: 1Gi\n      storage: 10Gi\n  #   limits:\n  #     cpu: 2000m\n  #     memory: 2Gi\n  #   imagePullPolicy: IfNotPresent\n  #   imagePullSecrets:\n  #   - name: secretName\n  #   hostNetwork: false\n  #   serviceAccount: advanced-tidb-pump\n  #   priorityClassName: system-cluster-critical\n  #   schedulerName: default-scheduler\n  #   nodeSelector:\n  #     app.kubernetes.io/component: pump\n  #   annotations:\n  #     node.kubernetes.io/instance-type: some-vm-type\n  #   tolerations: {}\n  #   configUpdateStrategy: RollingUpdate\n  #   statefulSetUpdateStrategy: RollingUpdate\n  #   podSecurityContext: {}\n  #   env: []\n  #   additionalContainers: []\n  #   additionalVolumes: []\n  #   additionalVolumeMounts: []\n  #   terminationGracePeriodSeconds: 30\n  #   # Ref: https://docs.pingcap.com/tidb/stable/tidb-binlog-configuration-file#pump\n  #   config: |\n  #     gc = 7\n  #   # TopologySpreadConstraints for pod scheduling, will overwrite cluster level spread constraints setting\n  #   # Ref: pkg/apis/pingcap/v1alpha1/types.go#TopologySpreadConstraint\n  #   topologySpreadConstraints:\n  #   - topologyKey: topology.kubernetes.io/zone\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/","title":"\u6570\u636e\u5907\u4efd\u4e0e\u6062\u590d","text":""},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/#_1","title":"\u6570\u636e\u5907\u4efd\u4e0e\u6062\u590d","text":"<p>https://docs.pingcap.com/zh/tidb-in-kubernetes/stable/backup-restore-overview</p> <p>\u6570\u636e\u91cf\u8f83\u5c11\uff0c\u53ef\u4f7f\u7528dumpling\u5bfc\u51fa \u6570\u636e\u91cf\u8f83\u5927\uff0c\u53ef\u4f7f\u7528BR \u9488\u5bf9\u6570\u636e\u91cf\u5c11\u7684\u90e8\u5206\u5e93\u5907\u4efd\uff0c\u53ef\u76f4\u63a5\u7528mysqldump(\u6216\u8005\u4f7f\u7528job)</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/#dumpling","title":"\u4e00\u3001\u4f7f\u7528dumpling\u547d\u4ee4\u884c","text":"<p>\u5907\u4efd\u548c\u6062\u590d\u53ef\u53c2\u8003\u8fc1\u79fb\u81f3Tidb.md\u7684\u5bfc\u51fasql\u6587\u4ef6\u90e8\u5206</p> <pre><code># \u4e0e\u5bfc\u51famysql\u6570\u636e\u76f8\u540c\uff0c\u53ea\u66ff\u6362\u6570\u636e\u5e93\u5730\u5740\u548c\u7aef\u53e3\u5373\u53ef\ntiup dumpling -u root -p '1qaz@WSX' -P 4000 -h 10.96.46.185 --filetype sql -t 8 -o /tmp/mariadb -r 200000 -F256MiB\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/#br","title":"\u4e8c\u3001\u4f7f\u7528BR","text":"<p>BR\u6709\u591a\u79cd\u4f7f\u7528\u65b9\u5f0f\uff0c\u5177\u4f53\u67e5\u770b</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/#1-sql","title":"1. sql\u65b9\u5f0f","text":"<pre><code>-- \u5907\u4efd\u5230\u6307\u5b9a\u76ee\u5f55\nBACKUP DATABASE `test` TO 'local:///mnt/backup/2020/04/';\n\n-- \u4ece\u5907\u4efd\u6570\u636e\u76ee\u5f55\u6062\u590d\nRESTORE DATABASE * FROM 'local:///mnt/backup/2020/04/';\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/#2-br","title":"2. BR\u547d\u4ee4\u884c","text":"<p>\u5f85\u8865\u5145</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/#3-crk8s","title":"3. \u4f7f\u7528cr\uff08\u4ec5k8s\u90e8\u7f72\uff09","text":"<p>\u5f85\u8865\u5145</p> <p><code>Backup</code>\u5907\u4efd\u4e00\u6b21 <code>BackupSchedule</code>\u5b9a\u671f\u5907\u4efd <code>Restore</code>\u6062\u590d\u4e00\u6b21</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D/","title":"\u707e\u96be\u6062\u590d","text":""},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D/#1-pd","title":"1. pd\u635f\u574f","text":"<p>pd\u5185\u7f6eetcd\uff0c\u5373\u5b9e\u9645\u6062\u590dpd\u5c31\u662f\u6062\u590detcd\u96c6\u7fa4\uff0c\u53ef\u53c2\u8003\u6807\u9898\u94fe\u63a5\u64cd\u4f5c</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D/#2-tikv","title":"2. tikv\u6709\u8282\u70b9\u6570\u636e\u635f\u574f","text":"<p>\u5982\u679c\u662f\u5728k8s\u4e2d\u90e8\u7f72\u7684tidb\uff0c\u5219</p> <ul> <li> <ol> <li>\u5907\u4efd\u635f\u574f\u8282\u70b9\u4e0a\u7684\u65e7tikv\u6570\u636e\uff0c\u5728local-path\u5b58\u50a8\u8def\u5f84\u4e2d</li> </ol> </li> </ul> <pre><code>mv /data/local-path/pvc-xxxxxxxxxxxxxxxx /data/backup/\n...\n</code></pre> <ul> <li> <ol> <li>\u5220\u9664\u8fd9\u4e2a\u635f\u574f\u8282\u70b9\u7ed1\u5b9a\u7684pv\u548cpvc\uff0c\u5177\u4f53\u8981\u5220\u9664\u54ea\u4e9b\uff0c\u53ef\u901a\u8fc7local-path\u5b58\u50a8\u8def\u5f84\u4e2d\u7684pvc\u540d\u79f0\u83b7\u53d6</li> </ol> </li> </ul> <pre><code>kubectl delete pvc ...\n</code></pre> <ul> <li> <ol> <li>\u624b\u5de5\u8c03\u6574tikv\u526f\u672c\u6570\uff0c\u4e0b\u7f29\u5bb9\u81f30\uff0c\u518d\u6269\u5bb9\u81f3\u539f\u6570\u91cf\uff0c\u4f7f\u5220\u9664\u7684pvc\u521b\u5efa\u51fa\u6765</li> </ol> </li> </ul> <pre><code>kubectl scale -n ketanyun sts tikv --replicas=0\n...\nkubectl scale -n ketanyun sts tikv --replicas=3\n</code></pre> <ul> <li> <ol> <li>tikv\u96c6\u7fa4\u81ea\u52a8\u6062\u590d\u6570\u636e\u5230\u8be5\u65b0tikv\u8282\u70b9\uff08\u5f85\u9a8c\u8bc1\uff09</li> </ol> </li> </ul>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E8%BF%81%E7%A7%BB%E8%87%B3Tidb/","title":"\u8fc1\u79fb\u81f3Tidb","text":"<p>\u6709\u4e24\u79cd\u65b9\u6848\uff1a</p> <ol> <li>\u4ecemysql/mariadb\u5bfc\u51fasql\u6587\u4ef6\uff0c\u518d\u5bfc\u5165tidb</li> <li>\u4f7f\u7528TiDB Data Migration\u8fc1\u79fb\u5de5\u5177\uff0c\u53ef\u5168\u91cf\u6216\u589e\u91cf\u8fc1\u79fb\u6570\u636e</li> </ol>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E8%BF%81%E7%A7%BB%E8%87%B3Tidb/#mairadbsqltidb","title":"\u4e00\u3001 \u4ecemairadb\u5bfc\u51fasql\u6587\u4ef6\uff0c\u518d\u5bfc\u5165tidb","text":"<p>\u4f7f\u7528dumpling\u5bfc\u51famariadb\u7684\u6570\u636e\uff0c\u4f7f\u7528lightning\u5c06\u6570\u636e\u5bfc\u5165tidb</p>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E8%BF%81%E7%A7%BB%E8%87%B3Tidb/#1-mysqlmariadb","title":"1. \u4ecemysql/mariadb\u5bfc\u51fa","text":"<ul> <li>\u5728\u7ebf\u5b89\u88c5dumpling</li> </ul> <pre><code># \u5b89\u88c5tiup\ncurl --proto '=https' --tlsv1.2 -sSf https://tiup-mirrors.pingcap.com/install.sh | sh\nsource $HOME/.bashrc\n\n# \u5b89\u88c5dumpling\ntiup install dumpling\n\n# \u5982\u679c\u4f7f\u7528tiup\u5b89\u88c5dumpling\uff0c\u5219\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5982\u679c\u76f4\u63a5\u5b89\u88c5\u7684dumpling\uff0c\u76f4\u63a5\u4f7f\u7528dumpling\ntiup dumpling -u root -p '1qaz@WSX' -P 3306 -h 10.96.46.185 --filetype sql -t 8 -o /tmp/mariadb -r 200000 -F256MiB\n</code></pre> <ul> <li>\u79bb\u7ebf\u5b89\u88c5</li> </ul> <p>\u4e0b\u8f7d\u5de5\u5177\u5305 </p> <ul> <li>\u5bfc\u51fa\u6570\u636e\u4e3asql\u6587\u4ef6</li> </ul> <pre><code># \u5ffd\u7565\u4e86\u7cfb\u7edf\u5e93\n$ tiup dumpling -u root -p '1qaz@WSX' -P 3306 -h 10.96.46.185 --filetype sql -t 8 -o /tmp/mariadb -r 200000 -F256MiB\n\n# \u67e5\u770b\u5bfc\u51fa\u7684\u6587\u4ef6\n$ ls /tmp/mariadb\nmaria1-mb4.r1.0000000000000.sql  maria1-mb4-schema-create.sql      maria2-utf8.r2-schema.sql      metadata                       test-schema-create.sql\nmaria1-mb4.r1-schema.sql         maria2-utf8.r2.0000000000000.sql  maria2-utf8-schema-create.sql  my_database-schema-create.sql\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E8%BF%81%E7%A7%BB%E8%87%B3Tidb/#2-tidb","title":"2. \u5bfc\u5165tidb","text":"<ul> <li>\u83b7\u53d6values\u6587\u4ef6</li> </ul> <pre><code># \u83b7\u53d6values\u6587\u4ef6\nhelm inspect values pingcap/tidb-lightning &gt; tidb-lightning-values.yaml\n</code></pre> <ul> <li>\u4fee\u6539values</li> </ul> <pre><code>dataSource:\n  # \u5c06dumpling\u5bfc\u51fa\u7684\u6570\u636e\u76ee\u5f55\u590d\u5236\u5230\u96c6\u7fa4\u7684\u4e00\u4e2awoker\u8282\u70b9\u7684/tmp/mariadb\u3002nodeName\u5e94\u8be5\u586b\u5199\u8be5node\u7684nodeName\u3002\n  # \u5982\u4e0b\u914d\u7f6e\u4f1a\u4f7flightning\u8fd0\u884c\u5728k8s-node1\u4e0a\uff0c\u5e76\u4e14\u5c06\u4e3b\u673a\u4e0a\u7684/tmp/mariadb\u6302\u8f7d\u8fdb\u5bb9\u5668\u4e2d\n  local: \n    nodeName: k8s-node1\n    hostPath: /tmp/mariadb\n\n\ntargetTidbCluster:\n  # tidb\u96c6\u7fa4\u540d\u79f0\uff0c\u586b\u5199tidb-cluster.yaml\u4e2d\u5b9a\u4e49\u7684metadata.name\n  name: advanced-tidb\n  # tidb\u96c6\u7fa4\u6240\u5728namespace\n  namespace: \"tidb\"\n  # \u94fe\u63a5tidb\u6240\u4f7f\u7528\u7684\u7528\u6237\n  user: root\n  # \u8fd9\u4e2a\u7528\u6237\u7684\u5bc6\u7801\u6765\u6e90\u4e8e\u54ea\u4e2asecret\n  secretName: tidb-secret\n  # secret\u4e2d\uff0c\u8be5\u7528\u6237\u5bc6\u7801\u7684key\n  secretPwdKey: root\n</code></pre> <ul> <li>k8s\u4e2d\u5b89\u88c5lightning</li> </ul> <p>lightning\u5b89\u88c5\u540e\u4f1a\u4ea7\u751f\u4e00\u4e2ajob\uff0c\u53ea\u8fd0\u884c\u4e00\u6b21</p> <pre><code># \u5b89\u88c5lightning\nhelm install advanced-tidb-lightning pingcap/tidb-lightning -n tidb --set failFast=true -f tidb-lightning-values.yaml \n\n# \u5b89\u88c5\u4ee5\u540e\u4ea7\u751flightning\u7684job\uff0c\u53ef\u67e5\u770bjob\u65e5\u5fd7\u786e\u8ba4\u5bfc\u5165\u8fdb\u5ea6\nkubectl get job -n tidb\n\n# \u6210\u529f\u7684\u65e5\u5fd7\n[2023/07/06 07:25:25.721 +00:00] [INFO] [import.go:1601] [\"restore all tables data completed\"] [takeTime=3.688287278s] []\n[2023/07/06 07:25:25.721 +00:00] [INFO] [import.go:1604] [\"cleanup task metas\"]\n[2023/07/06 07:25:25.723 +00:00] [INFO] [import.go:1221] [\"everything imported, stopping periodic actions\"]\n[2023/07/06 07:25:25.727 +00:00] [INFO] [import.go:1909] [\"skip full compaction\"]\n[2023/07/06 07:25:25.727 +00:00] [INFO] [import.go:2099] [\"clean checkpoints start\"] [keepAfterSuccess=remove] [taskID=1688628319580476994]\n[2023/07/06 07:25:25.727 +00:00] [INFO] [import.go:2107] [\"clean checkpoints completed\"] [keepAfterSuccess=remove] [taskID=1688628319580476994] [takeTime=33.199\u00b5s] []\n[2023/07/06 07:25:25.727 +00:00] [INFO] [import.go:514] [\"the whole procedure completed\"] [takeTime=5.806939726s] []\n[2023/07/06 07:25:25.727 +00:00] [WARN] [local.go:780] [\"remove local db file failed\"] [error=\"unlinkat /var/lib/sorted-kv: device or resource busy\"]\n[2023/07/06 07:25:25.730 +00:00] [INFO] [main.go:106] [\"tidb lightning exit\"] [finished=true]\ntidb lightning exit successfully\n\n# \u767b\u5f55tidb\uff0c\u786e\u8ba4\u5bfc\u5165\u7684\u6570\u636e\u5b58\u5728\n\n# lightning\u6210\u529f\u5bfc\u5165\u6570\u636e\u540e\uff0c\u5220\u9664lightning \nhelm uninstall advanced-tidb-lightning -n tidb\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E8%BF%81%E7%A7%BB%E8%87%B3Tidb/#tidb-data-migration","title":"\u4e8c\u3001 \u4f7f\u7528TiDB Data Migration\u8fc1\u79fb\u6570\u636e","text":""},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E8%BF%81%E7%A7%BB%E8%87%B3Tidb/#1-dm","title":"1. \u5b89\u88c5dm","text":"<pre><code>kubectl create -f ./manifests/dm-cluster.yaml\n</code></pre>"},{"location":"kubernetes/k8s-applications/tidb/TidbInK8s/%E8%BF%81%E7%A7%BB%E8%87%B3Tidb/#2-dm","title":"2. \u521b\u5efadm\u4efb\u52a1","text":"<p>\u5f85\u8865\u5145</p>"},{"location":"kubernetes/k8s-applications/walrus/readme/","title":"walrus","text":""},{"location":"kubernetes/k8s-applications/walrus/readme/#_1","title":"\u90e8\u7f72","text":"<p>https://seal-io.github.io/docs/zh/quickstart</p> <p>https://github.com/seal-io/walrus</p>"},{"location":"kubernetes/k8s-control-plane/apiserver/","title":"apiserver","text":"","tags":["apiserver","k8s"]},{"location":"kubernetes/k8s-control-plane/apiserver/#apiserver_1","title":"\u6269\u5c55apiserver","text":"","tags":["apiserver","k8s"]},{"location":"kubernetes/k8s-control-plane/apiserver/#crd","title":"\u4f7f\u7528crd","text":"","tags":["apiserver","k8s"]},{"location":"kubernetes/k8s-control-plane/apiserver/#aggregation-api","title":"\u914d\u7f6e\u805a\u5408\u5c42Aggregation API","text":"<p>\u4e0e\u81ea\u5b9a\u4e49\u8d44\u6e90\u5b9a\u4e49\uff08CRD\uff09\u4e0d\u540c\uff0c\u9664\u6807\u51c6\u7684 Kubernetes apiserver \u5916\uff0cAggregation API \u8fd8\u6d89\u53ca\u53e6\u4e00\u4e2a\u670d\u52a1\u5668</p>","tags":["apiserver","k8s"]},{"location":"kubernetes/k8s-control-plane/apiserver/#apiserver_2","title":"\u5b89\u88c5\u6269\u5c55\u7684apiserver","text":"","tags":["apiserver","k8s"]},{"location":"kubernetes/k8s-control-plane/kube-proxy/","title":"Kube proxy","text":""},{"location":"kubernetes/k8s-control-plane/kube-proxy/#kube-proxy","title":"\u4fee\u6539kube-proxy\u8fd0\u884c\u6a21\u5f0f","text":"<pre><code>kubectl edit cm -n kube-system kube-proxy\n</code></pre> <pre><code>## \u8fd0\u884c\u6a21\u5f0f\u3002ipvs\u6216\u8005iptables\uff0c\u9ed8\u8ba4\u4e3a\u7a7a\uff08iptables\uff09\nmode: \"\"\n</code></pre> <ul> <li>\u4fee\u6539\u540e\u9700\u8981\u91cd\u542fCNI\u63d2\u4ef6</li> </ul> <p>Calico \u81ea\u52a8\u68c0\u6d4b ipvs</p> <p>\u5f53 Calico \u68c0\u6d4b\u5230 kube-proxy \u5728 IPVS \u6a21\u5f0f\u4e0b\u8fd0\u884c\u65f6\uff08\u5b89\u88c5\u671f\u95f4\u6216\u5b89\u88c5\u540e\uff09\uff0c\u4f1a\u81ea\u52a8\u6fc0\u6d3b IPVS \u652f\u6301\u3002\u68c0\u6d4b\u53d1\u751f\u5728 calico-node \u542f\u52a8\u65f6\uff0c\u56e0\u6b64\u5982\u679c\u60a8\u5728\u6b63\u5728\u8fd0\u884c\u7684\u96c6\u7fa4\u4e2d\u66f4\u6539 kube-proxy \u7684\u6a21\u5f0f\uff0c\u5219\u9700\u8981\u91cd\u65b0\u542f\u52a8 calico-node \u5b9e\u4f8b\u3002</p> <pre><code>kubectl rollout restart ds calico-node\n</code></pre>"},{"location":"kubernetes/k8s-control-plane/schedule/","title":"schedule","text":"","tags":["schedule","k8s"]},{"location":"kubernetes/k8s-control-plane/schedule/#_1","title":"\u914d\u7f6e\u591a\u4e2a\u8c03\u5ea6\u5668","text":"","tags":["schedule","k8s"]},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/","title":"K8s\u96c6\u7fa4\u5b89\u88c5","text":""},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#masteranodeanodeb","title":"\u4e00\u3001\u8c03\u6574\u903b\u8f91\u5206\u533a(MasterA,NodeA,NodeB)","text":""},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#1","title":"1.\u8c03\u6574\u8bf4\u660e","text":"<p><code>shell script /dev/mapper/centos-root   50G  --&gt; 80G /dev/mapper/centos-home   42G  --&gt; 10G <pre><code>#### 2.\u64cd\u4f5c\u6b65\u9aa4\n- 2.1 \u53d6\u6d88\u6302\u8f7d\n```shell script\n[root@MasterA ~]# vi /etc/fstab\n#/dev/mapper/centos-home /home                   xfs     defaults        0 0\n[root@MasterA ~]# umount /home\n[root@MasterA ~]# df -h\n\u6587\u4ef6\u7cfb\u7edf                 \u5bb9\u91cf  \u5df2\u7528  \u53ef\u7528 \u5df2\u7528% \u6302\u8f7d\u70b9\ndevtmpfs                  16G     0   16G    0% /dev\ntmpfs                     16G     0   16G    0% /dev/shm\ntmpfs                     16G  8.9M   16G    1% /run\ntmpfs                     16G     0   16G    0% /sys/fs/cgroup\n/dev/mapper/centos-root   50G  1.4G   49G    3% /\n/dev/sda1               1014M  150M  865M   15% /boot\ntmpfs                    3.2G     0  3.2G    0% /run/user/0\n</code></pre> - 2.2 \u91cd\u65b0\u521b\u5efalv\uff1acentos-home,\u683c\u5f0f\u5316</code>shell script [root@MasterA ~]# lvremove /dev/mapper/centos-home  Do you really want to remove active logical volume centos/home? [y/n]: y   Logical volume \"home\" successfully removed [root@MasterA ~]# lvcreate -L 10G -n home centos WARNING: xfs signature detected on /dev/centos/home at offset 0. Wipe it? [y/n]: y   Wiping xfs signature on /dev/centos/home.   Logical volume \"home\" created. [root@MasterA ~]# lvs   LV   VG     Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert   home centos -wi-a----- 10.00g                                                     root centos -wi-ao---- 50.00g                                                     swap centos -wi-ao---- &lt;7.88g [root@MasterA ~]# mkfs.xfs /dev/mapper/centos-home  meta-data=/dev/mapper/centos-home isize=512    agcount=4, agsize=655360 blks          =                       sectsz=512   attr=2, projid32bit=1          =                       crc=1        finobt=0, sparse=0 data     =                       bsize=4096   blocks=2621440, imaxpct=25          =                       sunit=0      swidth=0 blks naming   =version 2              bsize=4096   ascii-ci=0 ftype=1 log      =internal log           bsize=4096   blocks=2560, version=2          =                       sectsz=512   sunit=0 blks, lazy-count=1 realtime =none                   extsz=4096   blocks=0, rtextents=0 [root@MasterA ~]# vi /etc/fstab /dev/mapper/centos-home /home                   xfs     defaults        0 0 [root@MasterA ~]# mount -a [root@MasterA ~]# df -h \u6587\u4ef6\u7cfb\u7edf                 \u5bb9\u91cf  \u5df2\u7528  \u53ef\u7528 \u5df2\u7528% \u6302\u8f7d\u70b9 devtmpfs                 3.9G     0  3.9G    0% /dev tmpfs                    3.9G     0  3.9G    0% /dev/shm tmpfs                    3.9G  8.9M  3.9G    1% /run tmpfs                    3.9G     0  3.9G    0% /sys/fs/cgroup /dev/mapper/centos-root   50G  1.4G   49G    3% / /dev/sda1               1014M  150M  865M   15% /boot tmpfs                    783M     0  783M    0% /run/user/0 /dev/mapper/centos-home   10G   33M   10G    1% /home - 2.3 \u6269\u5c55lv\uff1acentos-root,\u5237\u65b0\u6587\u4ef6\u7cfb\u7edf [root@MasterA ~]# lvextend -L 80G /dev/mapper/centos-root    Size of logical volume centos/root changed from 50.00 GiB (12800 extents) to 80.00 GiB (20480 extents).   Logical volume centos/root successfully resized. [root@MasterA ~]# xfs_growfs /dev/mapper/centos-root  meta-data=/dev/mapper/centos-root isize=512    agcount=4, agsize=3276800 blks          =                       sectsz=512   attr=2, projid32bit=1          =                       crc=1        finobt=0 spinodes=0 data     =                       bsize=4096   blocks=13107200, imaxpct=25          =                       sunit=0      swidth=0 blks naming   =version 2              bsize=4096   ascii-ci=0 ftype=1 log      =internal               bsize=4096   blocks=6400, version=2          =                       sectsz=512   sunit=0 blks, lazy-count=1 realtime =none                   extsz=4096   blocks=0, rtextents=0 data blocks changed from 13107200 to 20971520 [root@MasterA ~]# df -h \u6587\u4ef6\u7cfb\u7edf                 \u5bb9\u91cf  \u5df2\u7528  \u53ef\u7528 \u5df2\u7528% \u6302\u8f7d\u70b9 devtmpfs                 3.9G     0  3.9G    0% /dev tmpfs                    3.9G     0  3.9G    0% /dev/shm tmpfs                    3.9G  8.9M  3.9G    1% /run tmpfs                    3.9G     0  3.9G    0% /sys/fs/cgroup /dev/mapper/centos-root   80G  1.4G   79G    2% / /dev/sda1               1014M  150M  865M   15% /boot tmpfs                    783M     0  783M    0% /run/user/0 /dev/mapper/centos-home   10G   33M   10G    1% /home <pre><code>## \u4e8c\u3001\u90e8\u7f72k8s\uff08MasterA\uff09\n#### 1.\u5173\u95ed\u3001\u7981\u7528\u9632\u706b\u5899\uff1a\n```shell script\nsystemctl disable --now firewalld\n</code></pre></p>"},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#2selinux","title":"2.\u7981\u7528SELINUX\uff1a","text":"<p>```shell script sed  -i  '7s/enforcing/disabled/' /etc/selinux/config setenforce 0 getenforce <pre><code>##### 3.\u5173\u95ed\u4ea4\u6362\u5206\u533a\n```shell script\nsed -i '12s/^/#/' /etc/fstab\nswapoff -a\n</code></pre></p>"},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#4hosts","title":"4.\u6dfb\u52a0hosts","text":"<p>```shell script cat &gt;&gt; /etc/hosts &lt;&lt;- EOF 10.1.2.32 ExportAPI 10.1.2.27 MasterA 10.1.2.28 NodeA 10.1.2.31 NodeB 10.1.2.29 StorageA 10.1.2.30 StorageB EOF <pre><code>#### 5.\u521b\u5efa /etc/sysctl.d/k8s.conf \u6587\u4ef6\uff0c\u751f\u6548\u914d\u7f6e\n```shell script\ncat &lt;&lt; EOF &gt; /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_forward = 1\nEOF\n\nmodprobe br_netfilter \nsysctl -p /etc/sysctl.d/k8s.conf\n</code></pre></p>"},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#6yum","title":"6.\u914d\u7f6e\u963f\u91cc\u4e91yum\u6e90","text":"<p>```shell script curl -o /etc/yum.repos.d/Centos-7.repo http://mirrors.aliyun.com/repo/Centos-7.repo curl -o /etc/yum.repos.d/docker-ce.repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</p> <p>cat &lt; /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=0 repo_gpgcheck=0 gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg         http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg EOF <p>yum clean all &amp;&amp; yum makecache <pre><code>#### 7.\u5b89\u88c5 Docker\n```shell script\nyum -y install docker-ce\nsystemctl enable --now docker\n</code></pre></p>"},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#8-kubelet-kubeadm-kubectl","title":"8.\u5b89\u88c5 kubelet kubeadm kubectl","text":"<p>```shell script yum install -y kubectl-1.18.4 kubeadm-1.18.4 kubelet-1.18.4 <pre><code>#### 9.\u8bbe\u7f6ekubectl\u3001kubeadm\u7684Tab\u8865\u9f50\n```shell script\nkubectl completion bash &gt;/etc/bash_completion.d/kubectl\nkubeadm completion bash &gt;/etc/bash_completion.d/kubeadm\nexit\n</code></pre></p>"},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#10masteripvsadm-ipset","title":"10.master\u5b89\u88c5ipvsadm ipset","text":"<p>```shell script yum -y install ipvsadm ipset <pre><code>#### 11.\u914d\u7f6e\u963f\u91cc\u4e91\u955c\u50cf\u52a0\u901f\u5668\uff0c\u5e76\u6307\u5411\u955c\u50cf\u4ed3\u5e93\n```shell script\nmkdir -p /etc/docker\ntee /etc/docker/daemon.json &lt;&lt;-'EOF'\n{\n    \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n    \"registry-mirrors\": [\n    \"https://obww7jh1.mirror.aliyuncs.com\",\n    \"https://8xpk5wnt.mirror.aliyuncs.com\",\n    \"https://dockerhub.azk8s.cn\",\n    \"https://registry.docker-cn.com\",\n    \"https://ot2k4d59.mirror.aliyuncs.com/\"\n]\n}\nEOF\n\nsystemctl daemon-reload &amp;&amp; systemctl restart docker\n</code></pre></p>"},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#12","title":"12.\u955c\u50cf\u4e0a\u4f20","text":"<ul> <li>12.1 \u67e5\u770b\u9700\u8981\u955c\u50cf ```shell script [root@k8s-master ~]# kubeadm  config images list k8s.gcr.io/kube-apiserver:v1.18.4 k8s.gcr.io/kube-controller-manager:v1.18.4 k8s.gcr.io/kube-scheduler:v1.18.4     \u00b7 k8s.gcr.io/kube-proxy:v1.18.4 k8s.gcr.io/pause:3.2 k8s.gcr.io/etcd:3.4.3-0 k8s.gcr.io/coredns:1.6.7 <pre><code>- 12.2 \u62c9\u53d6gotok8s\u7684\u955c\u50cf\n```shell script\nexport image=kube-apiserver:v1.18.4\ndocker pull gotok8s/${image}\ndocker tag gotok8s/${image} k8s.gcr.io/${image}\ndocker rmi gotok8s/${image}\n\nexport image=kube-controller-manager:v1.18.4\ndocker pull gotok8s/${image}\ndocker tag gotok8s/${image} k8s.gcr.io/${image}\ndocker rmi gotok8s/${image}\n\nexport image=kube-scheduler:v1.18.4\ndocker pull gotok8s/${image}\ndocker tag gotok8s/${image} k8s.gcr.io/${image}\ndocker rmi gotok8s/${image}\n\nexport image=kkube-proxy:v1.18.4\ndocker pull gotok8s/${image}\ndocker tag gotok8s/${image} k8s.gcr.io/${image}\ndocker rmi gotok8s/${image}\n\nexport image=pause:3.2\ndocker pull gotok8s/${image}\ndocker tag gotok8s/${image} k8s.gcr.io/${image}\ndocker rmi gotok8s/${image}\n\nexport image=etcd:3.4.3-0\ndocker pull gotok8s/${image}\ndocker tag gotok8s/${image} k8s.gcr.io/${image}\ndocker rmi gotok8s/${image}\n\nexport image=coredns:1.6.7\ndocker pull gotok8s/${image}\ndocker tag gotok8s/${image} k8s.gcr.io/${image}\ndocker rmi gotok8s/${image}\n</code></pre></li> </ul>"},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#13","title":"13.\u521d\u59cb\u5316\u96c6\u7fa4","text":"<ul> <li>13.1 \u6d4b\u8bd5\u521d\u59cb\u5316 ```shell script kubeadm init --dry-run <pre><code>- 13.2 \u5bfc\u51fa\u914d\u7f6e\u6587\u4ef6\n```shell script\nkubeadm config print init-defaults &gt;kubeadm-init.yaml\n</code></pre></li> <li>13.3 \u4fee\u6539\u914d\u7f6e\u6587\u4ef6 ```shell script [root@MasterA ~]# vi kubeadm-init.yaml    token: abcdef.0123456789abcdef   ttl: 24h0m0s      #token\u5468\u671f   usages:</li> <li>signing</li> <li>authentication kind: InitConfiguration localAPIEndpoint:   advertiseAddress: 10.1.2.27       #apiserver\u5730\u5740   bindPort: 6443 nodeRegistration:   criSocket: /var/run/dockershim.sock   name: mastera   taints:</li> <li>effect: NoSchedule     key: node-role.kubernetes.io/master</li> </ul> <p>apiServer:   timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta2 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controllerManager: {} dns:   type: CoreDNS etcd:   local:     dataDir: /var/lib/etcd imageRepository: k8s.gcr.io     #\u955c\u50cf\u4ed3\u5e93\u5730\u5740 kind: ClusterConfiguration kubernetesVersion: v1.18.4      #k8s\u7248\u672c networking:   dnsDomain: cluster.local   podSubnet: 192.168.0.0/16     #\u5bb9\u5668\u5730\u5740cidr   serviceSubnet: 10.101.0.0/16  #\u670d\u52a1\u5730\u5740cidr scheduler: {} <pre><code>- 13.4 \u521d\u59cb\u5316\u96c6\u7fa4\n```shell script\n[root@MasterA ~]# kubeadm init --config=kubeadm-init.yaml | tee master-init.log\n\u00b7\u00b7\u00b7 \u00b7\u00b7\u00b7\u00b7\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 10.1.2.27:6443 --token abcdef.0123456789abcdef \\\n    --discovery-token-ca-cert-hash sha256:402a5cb9c1c301b27cf0fb7fd747a9d62cdfb6cff1db7a7c3536a623a5e3817f\n</code></pre>  - 13.5 \u6839\u636e\u521d\u59cb\u5316\u63d0\u793a  <code>shell script [root@MasterA ~]# mkdir -p $HOME/.kube [root@MasterA ~]# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config [root@MasterA ~]# sudo chown $(id -u):$(id -g) $HOME/.kube/config</code>  - 13.5 \u67e5\u770bmaster\u72b6\u6001 ```shell script [root@MasterA ~]# kubectl  get nodes NAME      STATUS     ROLES    AGE     VERSION mastera   NotReady   master   2m23s   v1.18.4 <pre><code>#### 14.\u4f01\u4e1a\u7ea7\u7f51\u7edc\n```shell script\ncurl https://docs.projectcalico.org/manifests/calico.yaml -O\nkubectl apply -f calico.yaml\n</code></pre></p>"},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#nodenodeanodebstorageastoragebexportapi","title":"\u4e09\u3001\u6dfb\u52a0Node\u8282\u70b9(NodeA,NodeB,StorageA,StorageB,ExportAPI)","text":""},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#node","title":"Node\u811a\u672c","text":"<pre><code>##/bin/bash\nsystemctl disable --now   firewalld\n\nsed  -i  '7s/enforcing/disabled/' /etc/selinux/config\nsetenforce 0\n\nsed -i '12s/^/#/' /etc/fstab\nswapoff -a\n\ncat &gt;&gt; /etc/hosts &lt;&lt;- EOF\n10.1.2.32 ExportAPI\n10.1.2.27 MasterA\n10.1.2.28 NodeA\n10.1.2.31 NodeB\n10.1.2.29 StorageA\n10.1.2.30 StorageB\nEOF\n\ncat &lt;&lt; EOF &gt; /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_forward = 1\nEOF\n\nmodprobe br_netfilter \nsysctl -p /etc/sysctl.d/k8s.conf\n\ncurl -o /etc/yum.repos.d/Centos-7.repo http://mirrors.aliyun.com/repo/Centos-7.repo\ncurl -o /etc/yum.repos.d/docker-ce.repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n\ncat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg\n        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\nyum clean all &amp;&amp; yum makecache\n\nyum -y install docker-ce\nsystemctl enable --now docker\n\nyum install -y kubectl-1.18.4 kubeadm-1.18.4 kubelet-1.18.4\n\nkubectl completion bash &gt;/etc/bash_completion.d/kubectl\nkubeadm completion bash &gt;/etc/bash_completion.d/kubeadm\n\nyum -y install ipvsadm ipset\n\nmkdir -p /etc/docker\ntee /etc/docker/daemon.json &lt;&lt;-'EOF'\n{\n    \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n    \"registry-mirrors\": [\n    \"https://obww7jh1.mirror.aliyuncs.com\",\n    \"https://8xpk5wnt.mirror.aliyuncs.com\",\n    \"https://dockerhub.azk8s.cn\",\n    \"https://registry.docker-cn.com\",\n    \"https://ot2k4d59.mirror.aliyuncs.com/\"\n]\n}\nEOF\nsystemctl daemon-reload &amp;&amp; systemctl restart docker\n\nexport image=pause:3.2\ndocker pull gotok8s/${image}\ndocker tag gotok8s/${image} k8s.gcr.io/${image}\ndocker rmi gotok8s/${image}\n\nexport image=kube-proxy:v1.18.4\ndocker pull gotok8s/${image}\ndocker tag gotok8s/${image} k8s.gcr.io/${image}\ndocker rmi gotok8s/${image}\n\nexport image=coredns:1.6.7\ndocker pull gotok8s/${image}\ndocker tag gotok8s/${image} k8s.gcr.io/${image}\ndocker rmi gotok8s/${image}\n\nkubeadm join 10.1.2.27:6443 --token abcdef.0123456789abcdef \\\n    --discovery-token-ca-cert-hash sha256:402a5cb9c1c301b27cf0fb7fd747a9d62cdfb6cff1db7a7c3536a623a5e3817f\n</code></pre>"},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#masterahelm","title":"\u56db\u3001MasterA\u5b89\u88c5Helm","text":""},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#1helm","title":"1.Helm\u8f6f\u4ef6\u5305\u4e0b\u8f7d","text":"<p><code>shell script $cd /tmp wget https://get.helm.sh/helm-v3.3.1-linux-amd64.tar.gz</code></p>"},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#2","title":"2.\u89e3\u538b\u8f6f\u4ef6\u5305","text":"<p><code>shell script tar -zxvf helm-v3.3.1-linux-amd64.tar.gz cd linux-amd64/</code></p>"},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#3","title":"3.\u66f4\u6362\u8def\u5f84","text":"<p><code>shell script mv helm  /usr/local/bin/helm</code></p>"},{"location":"kubernetes/k8s-deploy/K8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/#_1","title":"\u6dfb\u52a0\u4ed3\u5e93","text":"<p><code>shell script helm repo add bitnami https://charts.bitnami.com/bitnami helm repo add stable https://kubernetes-charts.storage.googleapis.com</code> </p>"},{"location":"kubernetes/k8s-deploy/Kubernetesv1.19.9%E5%AE%B9%E5%99%A8%E5%8C%96%E5%B9%B3%E5%8F%B0%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%8C%87%E5%AF%BC%E6%89%8B%E5%86%8C/","title":"Kubernetesv1.19.9\u5bb9\u5668\u5316\u5e73\u53f0\u73af\u5883\u90e8\u7f72\u6307\u5bfc\u624b\u518c","text":""},{"location":"kubernetes/k8s-deploy/Kubernetesv1.19.9%E5%AE%B9%E5%99%A8%E5%8C%96%E5%B9%B3%E5%8F%B0%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%8C%87%E5%AF%BC%E6%89%8B%E5%86%8C/#kubernetesv1199","title":"Kubernetesv1.19.9\u5bb9\u5668\u5316\u5e73\u53f0\u73af\u5883\u90e8\u7f72\u6307\u5bfc\u624b\u518c","text":"<p>https://git.ketanyun.cn/operation/docs/wikis/Kubernetesv1.19.9\u5bb9\u5668\u5316\u5e73\u53f0\u73af\u5883\u90e8\u7f72\u6307\u5bfc\u624b\u518c</p>"},{"location":"kubernetes/k8s-deploy/Kubernetesv1.19.9%E5%AE%B9%E5%99%A8%E5%8C%96%E5%B9%B3%E5%8F%B0%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%8C%87%E5%AF%BC%E6%89%8B%E5%86%8C/#_1","title":"\u90e8\u7f72\u65f6\u6ce8\u610f\u6574\u6539\u7684\u5185\u5bb9\uff1a","text":"<ol> <li>master\u9ad8\u53ef\u7528\u6539\u4e3akeepalived+api server\uff0c\u53ef\u4ee5\u53bb\u6389nginx\uff0ckeepalived\u68c0\u6d4b6443\u7aef\u53e3</li> <li>calico\u9ed8\u8ba4\u91c7\u7528vxlan\u6a21\u5f0f</li> <li>\u4ee5DS\u65b9\u5f0f\u8d77ingress controller</li> </ol>"},{"location":"kubernetes/k8s-deploy/Kubernetesv1.19.9%E5%AE%B9%E5%99%A8%E5%8C%96%E5%B9%B3%E5%8F%B0%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%8C%87%E5%AF%BC%E6%89%8B%E5%86%8C/#_2","title":"\u90e8\u7f72\u67b6\u6784\u6839\u636e\u5b66\u6821\u60c5\u51b5\u8c03\u6574","text":"<ul> <li>\u60c5\u51b5\u4e00\uff1a\u57df\u540d\u6307\u5411\u6211\u4eecingress;</li> <li> <p>\u60c5\u51b5\u4e8c\uff1a\u57df\u540d\u4e0d\u6307\u5411\u6211\u4eec\u7684ingress. \u9488\u5bf9\u60c5\u51b5\u4e8c\uff0c\u4e0d\u6307\u5411\u6211\u4eecingress\u60c5\u51b5\uff0c\u6211\u4eec\u63d0\u4f9b\u591a\u4e2aingress ,\u8ba9\u4e0a\u6e38\u8981\u505a\u8d1f\u8f7d\u5747\u8861\u548c\u5065\u5eb7\u68c0\u67e5\u3002\u4f46\u662f\u5f88\u591a\u60c5\u51b5\uff0c\u5b66\u6821\u53ea\u7ed9\u4e00\u4e2anode\u6307\u5411\u3002</p> </li> <li> <p>\u3010\u65b9\u68481\uff1a\u6709\u707e\u5907\uff0c\u65e0\u8d1f\u8f7d\u5747\u8861\u3011node\u670d\u52a1\u5668\u9700\u8981\u505aVIP\uff081\u4e2aVIP\uff09\uff0c\u628aVIP\uff08\u8bbf\u95ee\u5730\u5740\uff09\u63d0\u4f9b\u7ed9\u5b66\u6821\uff0c\u8ba9\u5b66\u6821\u505aDNS\u6307\u5411\u62167\u5c42\u4ee3\u7406\u6307\u5411\u3002</p> </li> <li>\u3010\u65b9\u68482\uff1a\u4ee3\u7406\u6a21\u5f0f\u4e0b\u7684\u8d1f\u8f7d\u5747\u8861\u3011\u5982\u679c\u5b66\u6821\u80fd\u505a\u5230\u5065\u5eb7\u68c0\u67e5\u548c\u8d1f\u8f7d\u5747\u8861\uff0c\u6211\u4eec\u53ef\u4ee5\u4e0d\u7528VIP,\u76f4\u63a5\u5c06node ip\uff08\u8bbf\u95ee\u5730\u5740\uff09\u63d0\u4f9b\u5b66\u6821\u3002</li> <li>\u3010\u65b9\u68483\uff1aDNS\u6a21\u5f0f\u4e0b\u7684\u8d1f\u8f7d\u5747\u8861\u3011\u5f53\u5b66\u6821\u7528\u201c\u65b9\u68481\u201d\u65b9\u6cd5\u65e0\u6cd5\u6ee1\u8db3\u541e\u5410\u91cf\u7684\u65f6\u5019\uff0c\u9700\u8981\u63d0\u4f9b\u591a\u7ec4VIP\uff082\u53f0node1\u4e2avip\uff0c\u9700\u89814\u53f0\u53ca\u4ee5\u4e0anode\u670d\u52a1\u5668\u6570\u91cf\uff09\u3002</li> </ul> <p>\u7f16\u5199\u624b\u518c\u65f6\uff0c\u6ce8\u610f\u5c06\u4e0a\u8ff0\u65b9\u6cd5\u505a\u533a\u5206\u3002</p> <p>\u672c\u6587\u6863\u5220\u9664\u4e86\u4f20\u7edf\u90e8\u7f72\u7684\u591a\u6d3bmaster\u7684HA\u914d\u7f6e\uff0c\u4f7f\u7528VIP\u505a\u6545\u969c\u5207\u6362</p> <p>\u9879\u76ee\u4e3b\u673a\u89c4\u5212 \u4e3b\u673a\u540d_\u7279\u6b8a\u4e8b\u9879_\u4e3b\u673a\u5730\u5740_pod\u7f51\u7edc_service\u7f51\u7edc</p> <p>0\u3001\u4e3b\u673a\u540d\u89c4\u5212</p> <pre><code>10.15.6.66 MasterA\n10.15.6.75 MasterB\n10.15.6.74 MasterC\n10.15.6.76 NodeA\n10.15.6.77 NodeB\n10.15.6.78 NodeC\n</code></pre> <p>1\u3001\u66f4\u6539\u4e3b\u673a\u540d</p> <pre><code>hostnamectl set-hostname MasterA\nhostnamectl set-hostname MasterB\nhostnamectl set-hostname MasterC\nhostnamectl set-hostname NodeA\nhostnamectl set-hostname NodeB\nhostnamectl set-hostname NodeC\n</code></pre> <p>2\u3001\u6267\u884c\u521d\u59cb\u5316</p> <pre><code>yum install wget -y\n\ncd /root &amp;&amp; mkdir /root/shell &amp;&amp; wget http://taskcenter.net/1a2699623e1b8b111676fe63de6551e5 -O /root/shell/init-server.sh\n\nsh /root/shell/init-server.sh\n\ntimedatectl set-timezone Asia/Shanghai\n\nyum update -y\n\n\u5347\u7ea7\u5185\u6838\uff0c\u53c2\u8003https://linux.cn/article-8310-1.html  *\u5347\u7ea7\u5185\u6838\u4f1a\u5bfc\u81f4NFS\u6302\u8f7d\u5931\u8d25\uff0c\u6b63\u5f0f\u73af\u5883\u5347\u7ea7\u5185\u6838\u9700\u8981\u6ce8\u610f*\n</code></pre> <p>3\u3001\u5b89\u88c5keepalived</p> <pre><code>yum install keepalived -y\n</code></pre> <p>4\u3001\u5b89\u88c5docker</p> <pre><code>yum install -y yum-utils device-mapper-persistent-data lvm2\nyum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\nyum makecache fast\n\nyum install -y docker-ce-18.09.9-3.el7\n\nmkdir -p /etc/docker\n\ncat &gt; /etc/docker/daemon.json &lt;&lt;EOF\n{\n             \"registry-mirrors\": [\"https://q2uvt0x7.mirror.aliyuncs.com\"],\n             \"data-root\": \"/data/docker\",\n             \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n             \"storage-driver\": \"overlay2\", \n             \"storage-opts\":[\"overlay2.override_kernel_check=true\"],\n             \"log-driver\": \"json-file\", \n             \"log-opts\": { \n               \"max-size\": \"100m\", \n               \"max-file\": \"10\" \n              }\n}\nEOF\n\nsystemctl enable docker &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl start docker\n</code></pre>"},{"location":"kubernetes/k8s-deploy/Kubernetesv1.19.9%E5%AE%B9%E5%99%A8%E5%8C%96%E5%B9%B3%E5%8F%B0%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%8C%87%E5%AF%BC%E6%89%8B%E5%86%8C/#5","title":"5\u670d\u52a1\u5668\u8bbe\u7f6e\u767d\u540d\u5355","text":"<pre><code>\u5047\u5982\u91c7\u7528\u4f20\u7edf\u8bf7\u6267\u884c\u4e00\u4e0b\u547d\u4ee4\uff1a\n\nsystemctl stop firewalld\nsystemctl mask firewalld\n\n\u5e76\u4e14\u5b89\u88c5iptables-services\uff1a\nyum install iptables-services\n\n\u8bbe\u7f6e\u5f00\u673a\u542f\u52a8\uff1a\nsystemctl enable iptables\n\niptables\u542f\u52a8\u3001\u5173\u95ed\u3001\u4fdd\u5b58\uff1a\n\nsystemctl [stop|start|restart] iptables\n#or\nservice iptables [stop|start|restart]\n\n\nservice iptables save\n#or\n/usr/libexec/iptables/iptables.init save\n</code></pre>"},{"location":"kubernetes/k8s-deploy/Kubernetesv1.19.9%E5%AE%B9%E5%99%A8%E5%8C%96%E5%B9%B3%E5%8F%B0%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%8C%87%E5%AF%BC%E6%89%8B%E5%86%8C/#51-mastera","title":"5.1 MasterA \u4e3e\u4f8b","text":"<pre><code>vim /etc/sysconfig/iptables\n\n\n*filter\n:INPUT ACCEPT [0:0]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [0:0]\n#\u8fd9\u91cc\u5f00\u59cb\u589e\u52a0\u767d\u540d\u5355\u670d\u52a1\u5668ip(\u8bf7\u5220\u9664\u5f53\u524d\u670d\u52a1\u5668\u7684ip\u5730\u5740)\n-N whitelist\n#-A whitelist -s 10.15.6.66 -j ACCEPT\n-A whitelist -s 10.15.6.75 -j ACCEPT\n-A whitelist -s 10.15.6.74 -j ACCEPT\n-A whitelist -s 10.15.6.76 -j ACCEPT\n-A whitelist -s 10.15.6.77 -j ACCEPT\n-A whitelist -s 10.15.6.78 -j ACCEPT\n#\u8fd9\u91cc\u7ed3\u675f\u767d\u540d\u5355\u670d\u52a1\u5668ip\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 30771 -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT  \n-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT \n#\u4e0a\u9762\u8fd9\u4e9b ACCEPT \u7aef\u53e3\u53f7\uff0c\u516c\u7f51\u5185\u7f51\u90fd\u53ef\u4ee5\u8bbf\u95ee\n\n#\u4e0b\u9762\u8fd9\u4e9b whitelist \u7aef\u53e3\u53f7\uff0c\u4ec5\u9650\u670d\u52a1\u5668\u4e4b\u95f4\u901a\u8fc7\u5185\u7f51\u8bbf\u95ee\n#\u8fd9\u91cc\u6dfb\u52a0\u4e3a\u767d\u540d\u5355ip\u5f00\u653e\u7684\u7aef\u53e3\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 30771 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 6443 -j whitelist\n#\u8fd9\u7ed3\u675f\u4e3a\u767d\u540d\u5355ip\u5f00\u653e\u7684\u7aef\u53e3\n-A INPUT -j REJECT --reject-with icmp-host-prohibited\n-A FORWARD -j REJECT --reject-with icmp-host-prohibited\n\nCOMMIT\nservice iptables restart\n</code></pre>"},{"location":"kubernetes/k8s-deploy/Kubernetesv1.19.9%E5%AE%B9%E5%99%A8%E5%8C%96%E5%B9%B3%E5%8F%B0%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%8C%87%E5%AF%BC%E6%89%8B%E5%86%8C/#52-masterb","title":"5.2 MasterB \u4e3e\u4f8b","text":"<pre><code>vim /etc/sysconfig/iptables\n\n\n*filter\n:INPUT ACCEPT [0:0]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [0:0]\n#\u8fd9\u91cc\u5f00\u59cb\u589e\u52a0\u767d\u540d\u5355\u670d\u52a1\u5668ip(\u8bf7\u5220\u9664\u5f53\u524d\u670d\u52a1\u5668\u7684ip\u5730\u5740)\n-N whitelist\n-A whitelist -s 10.15.6.66 -j ACCEPT\n-A whitelist -s 10.15.6.75 -j ACCEPT\n#-A whitelist -s 10.15.6.74 -j ACCEPT\n-A whitelist -s 10.15.6.76 -j ACCEPT\n-A whitelist -s 10.15.6.77 -j ACCEPT\n-A whitelist -s 10.15.6.78 -j ACCEPT\n#\u8fd9\u91cc\u7ed3\u675f\u767d\u540d\u5355\u670d\u52a1\u5668ip\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 30771 -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT  \n-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT \n#\u4e0a\u9762\u8fd9\u4e9b ACCEPT \u7aef\u53e3\u53f7\uff0c\u516c\u7f51\u5185\u7f51\u90fd\u53ef\u4ee5\u8bbf\u95ee\n\n#\u4e0b\u9762\u8fd9\u4e9b whitelist \u7aef\u53e3\u53f7\uff0c\u4ec5\u9650\u670d\u52a1\u5668\u4e4b\u95f4\u901a\u8fc7\u5185\u7f51\u8bbf\u95ee\n#\u8fd9\u91cc\u6dfb\u52a0\u4e3a\u767d\u540d\u5355ip\u5f00\u653e\u7684\u7aef\u53e3\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 30771 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 6443 -j whitelist\n#\u8fd9\u7ed3\u675f\u4e3a\u767d\u540d\u5355ip\u5f00\u653e\u7684\u7aef\u53e3\n-A INPUT -j REJECT --reject-with icmp-host-prohibited\n-A FORWARD -j REJECT --reject-with icmp-host-prohibited\n\nCOMMIT\nservice iptables restart\n</code></pre>"},{"location":"kubernetes/k8s-deploy/Kubernetesv1.19.9%E5%AE%B9%E5%99%A8%E5%8C%96%E5%B9%B3%E5%8F%B0%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%8C%87%E5%AF%BC%E6%89%8B%E5%86%8C/#53-nodea","title":"5.3 NodeA \u4e3e\u4f8b","text":"<pre><code>vim /etc/sysconfig/iptables\n\n\n*filter\n:INPUT ACCEPT [0:0]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [0:0]\n#\u8fd9\u91cc\u5f00\u59cb\u589e\u52a0\u767d\u540d\u5355\u670d\u52a1\u5668ip(\u8bf7\u5220\u9664\u5f53\u524d\u670d\u52a1\u5668\u7684ip\u5730\u5740)\n-N whitelist\n-A whitelist -s 10.15.6.66 -j ACCEPT\n-A whitelist -s 10.15.6.75 -j ACCEPT\n-A whitelist -s 10.15.6.74 -j ACCEPT\n#-A whitelist -s 10.15.6.76 -j ACCEPT\n-A whitelist -s 10.15.6.77 -j ACCEPT\n-A whitelist -s 10.15.6.78 -j ACCEPT\n#\u8fd9\u91cc\u7ed3\u675f\u767d\u540d\u5355\u670d\u52a1\u5668ip\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 30771 -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT  \n-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT \n#\u4e0a\u9762\u8fd9\u4e9b ACCEPT \u7aef\u53e3\u53f7\uff0c\u516c\u7f51\u5185\u7f51\u90fd\u53ef\u4ee5\u8bbf\u95ee\n\n#\u4e0b\u9762\u8fd9\u4e9b whitelist \u7aef\u53e3\u53f7\uff0c\u4ec5\u9650\u670d\u52a1\u5668\u4e4b\u95f4\u901a\u8fc7\u5185\u7f51\u8bbf\u95ee\n#\u8fd9\u91cc\u6dfb\u52a0\u4e3a\u767d\u540d\u5355ip\u5f00\u653e\u7684\u7aef\u53e3\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 30771 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 6443 -j whitelist\n#\u8fd9\u7ed3\u675f\u4e3a\u767d\u540d\u5355ip\u5f00\u653e\u7684\u7aef\u53e3\n-A INPUT -j REJECT --reject-with icmp-host-prohibited\n-A FORWARD -j REJECT --reject-with icmp-host-prohibited\n\nCOMMIT\nservice iptables restart\n</code></pre>"},{"location":"kubernetes/k8s-deploy/Kubernetesv1.19.9%E5%AE%B9%E5%99%A8%E5%8C%96%E5%B9%B3%E5%8F%B0%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%8C%87%E5%AF%BC%E6%89%8B%E5%86%8C/#54-nodeb","title":"5.4 NodeB \u4e3e\u4f8b","text":"<pre><code>vim /etc/sysconfig/iptables\n\n*filter\n:INPUT ACCEPT [0:0]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [0:0]\n#\u8fd9\u91cc\u5f00\u59cb\u589e\u52a0\u767d\u540d\u5355\u670d\u52a1\u5668ip(\u8bf7\u5220\u9664\u5f53\u524d\u670d\u52a1\u5668\u7684ip\u5730\u5740)\n-N whitelist\n-A whitelist -s 10.15.6.66 -j ACCEPT\n# -A whitelist -s 10.15.6.75 -j ACCEPT\n-A whitelist -s 10.15.6.74 -j ACCEPT\n-A whitelist -s 10.15.6.76 -j ACCEPT\n-A whitelist -s 10.15.6.77 -j ACCEPT\n-A whitelist -s 10.15.6.78 -j ACCEPT\n#\u8fd9\u91cc\u7ed3\u675f\u767d\u540d\u5355\u670d\u52a1\u5668ip\n-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n-A INPUT -p icmp -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 30771 -j ACCEPT\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT  \n-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT \n#\u4e0a\u9762\u8fd9\u4e9b ACCEPT \u7aef\u53e3\u53f7\uff0c\u516c\u7f51\u5185\u7f51\u90fd\u53ef\u4ee5\u8bbf\u95ee\n\n#\u4e0b\u9762\u8fd9\u4e9b whitelist \u7aef\u53e3\u53f7\uff0c\u4ec5\u9650\u670d\u52a1\u5668\u4e4b\u95f4\u901a\u8fc7\u5185\u7f51\u8bbf\u95ee\n#\u8fd9\u91cc\u6dfb\u52a0\u4e3a\u767d\u540d\u5355ip\u5f00\u653e\u7684\u7aef\u53e3\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 30771 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -j whitelist\n-A INPUT -m state --state NEW -m tcp -p tcp --dport 6443 -j whitelist\n#\u8fd9\u7ed3\u675f\u4e3a\u767d\u540d\u5355ip\u5f00\u653e\u7684\u7aef\u53e3\n-A INPUT -j REJECT --reject-with icmp-host-prohibited\n-A FORWARD -j REJECT --reject-with icmp-host-prohibited\n\nCOMMIT\nservice iptables restart\n</code></pre> <p>6\u3001\u4e0b\u8f7d\u9700\u8981\u7684k8s\u8f6f\u4ef6\uff0c\u672c\u6587\u6863\u91c7\u75281.19.9</p> <pre><code>yum install -y kubelet-1.19.9 kubeadm-1.19.9 kubectl-1.19.9\n</code></pre> <p>7\u3001\u5728master\u4e0a\u4e0b\u8f7d\u7f16\u8bd1\u597d\u7684kubeadm\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u6682\u65f6\u5728\u8fd0\u7ef4\u7684\u7fa4\u5171\u4eab\u91cc https://taskcenter.net/kubeadm</p> <p>8\u3001\u914d\u7f6eVIP</p> <p>\u4f7f\u7528\u975e\u62a2\u5360\u6a21\u5f0f\uff0c\u9632\u6b62\u67d0\u4e2a\u8282\u70b9\u7684apiserver\u91cd\u542f\u5bfc\u81f4\u9891\u7e41\u6545\u969c\u5207\u6362 \u7531\u4e8ek8s\u672c\u8eab\u5bf9apiserver\u5b58\u5728\u5065\u5eb7\u68c0\u67e5\u673a\u5236\uff0ckeepalived\u672c\u8eab\u65e0\u9700\u914d\u7f6e\u5065\u5eb7\u68c0\u67e5\uff0c\u4f46\u9700\u8981\u5728\u8ba1\u5212\u4efb\u52a1\u914d\u7f6e\u811a\u672c\u68c0\u6d4bkeepalived\u672c\u8eab</p> <pre><code>vi /etc/keepalived/keepalived.conf\n\n! Configuration File for keepalived\n\nglobal_defs {\n   router_id LVS_DEVEL\n}\n\nvrrp_instance VI_1 {\n    state BACKUP   \n    interface eth0  # \u7f51\u5361\u540d\u79f0\uff0cCentOS 7 \u4e3a\u7cfb\u7edf\u8bc6\u522b\u603b\u7ebf\u81ea\u751f\u6210\uff0c\u4ee5\u5b9e\u9645\u7f51\u5361\u540d\u4e3a\u51c6\n    nopreempt\nvirtual_router_id 51\n    priority 100   # \u5176\u4ed6\u4e3b\u673a\u4fee\u6539\u4e3a100\u4ee5\u4e0b\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass HPMOHhWlki  # \u8ba4\u8bc1\u5bc6\u7801\uff0c\u591a\u4e2avrrp\u7ec4\u8bf7\u4fee\u6539\u6b64\u5bc6\u7801\n    }\n    virtual_ipaddress {\n        10.15.6.92/32  # VIP\u5730\u5740\n    }\n}\n</code></pre> <p>9\u3001\u521b\u5efakubeadm\u914d\u7f6e\u6587\u4ef6</p> <pre><code>vim kubeadm-config.yaml\n\napiServer:\n  certSANs:\n  - 10.15.6.66\n  - 10.15.6.75\n  - 10.15.6.74\n  - 10.15.6.92\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta2\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrolPlaneEndpoint: \"10.15.6.92:6443\"   # \u4fee\u6539\u4e3aVIP\u5730\u5740\ncontrollerManager: {}\ndns:\n  type: CoreDNS\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: oci.ketanyun.cn/hxzhou/kubenetes\nkind: ClusterConfiguration\nkubernetesVersion: v1.19.9\nnetworking:\n  dnsDomain: cluster.local\n  serviceSubnet: 172.31.2.0/24  # \u6309\u5b9e\u9645\u9700\u8981\u4fee\u6539service\u7f51\u7edc\n  podSubnet: \"172.31.1.0/24\"  # \u6309\u5b9e\u9645\u9700\u8981\u4fee\u6539pod\u7f51\u7edc\nscheduler: {}\n</code></pre> <p>10\u3001\u521d\u59cb\u5316master\uff08\u4f7f\u7528\u65b0\u4e0a\u4f20\u7684kubeadm\uff0c\u89e3\u51b3\u8bc1\u4e661\u5e74\u540e\u8fc7\u671f\u95ee\u9898\uff09</p> <pre><code>./kubeadm init --config kubeadm-config.yaml --upload-certs\n</code></pre> <p>11\u3001\u521d\u59cb\u5316\u5176\u4ed6master\uff08\u4f7f\u7528\u65b0\u4e0a\u4f20\u7684kubeadm\uff0c\u89e3\u51b3\u8bc1\u4e661\u5e74\u540e\u8fc7\u671f\u95ee\u9898\uff09</p> <pre><code>./kubeadm join 10.15.6.92:6443 --token 1q3wpz.u1damy0rh12u0l5h \\\n    --discovery-token-ca-cert-hash sha256:9ceb1590eded8d2ad4404505c4be4d79cc64d4e79a0351aed5bddb938708d40c \\\n    --control-plane --certificate-key 73bff999c21a8d469e071f146ff0fb283f3d23f72295d00b130abdc12293efe6\n</code></pre> <p>12\u3001\u5de5\u4f5c\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\uff08\u4f7f\u7528\u65b0\u4e0a\u4f20\u7684kubeadm\uff0c\u89e3\u51b3\u8bc1\u4e661\u5e74\u540e\u8fc7\u671f\u95ee\u9898\uff09</p> <pre><code>./kubeadm join 10.15.6.92:6443 --token 1q3wpz.u1damy0rh12u0l5h \\\n    --discovery-token-ca-cert-hash sha256:9ceb1590eded8d2ad4404505c4be4d79cc64d4e79a0351aed5bddb938708d40c\n</code></pre> <p>13\u3001\u90e8\u7f72calico\u7f51\u7edc\u63d2\u4ef6\uff08\u4e0a\u4f20\u6587\u4ef6\u505a\u94fe\u63a5\uff09</p> <p>\u4e0a\u4f20calico\u5b9a\u4e49\u6587\u4ef6\uff0c\u7136\u540ekubectl apply -f \u5e94\u7528</p> <p>\u6587\u4ef6\u4f4d\u7f6e\uff1ahttps://git.ketanyun.cn/hxzhou/kubenetes/blob/master/calico-vxlan.yaml</p> <p>14\u3001\u5b8c\u6210\u5176\u4ed6\u90e8\u7f72\uff08rancher\u3001ingress\uff09</p> <p>\uff081\uff09ingress-controller</p> <p>\u4e0a\u4f20ingress\u5b9a\u4e49\u6587\u4ef6\uff0c\u7136\u540ekubectl apply -f \u5e94\u7528</p> <p>\u6587\u4ef6\u4f4d\u7f6e\uff1ahttps://git.ketanyun.cn/hxzhou/kubenetes/blob/master/ingress-controller.yaml</p> <p>\uff082\uff09rancher</p> <pre><code>wget https://get.helm.sh/helm-v3.2.0-linux-amd64.tar.gz\ntar zxvf helm-v3.2.0-linux-amd64.tar.gz &amp;&amp; mv linux-amd64/helm /usr/bin/helm\n\n\nhelm repo add rancher-stable http://rancher-mirror.oss-cn-beijing.aliyuncs.com/server-charts/stable\n\nkubectl create namespace cattle-system\n\nhelm install rancher rancher-stable/rancher \\\n --namespace cattle-system \\\n --set hostname=10.15.6.93.nip.io  \\\n --set ingress.tls.source=secret \\\n --set rancherImageTag=v2.5.6\n\n\u53ef\u5728\u9879\u76ee\u7684windows\u670d\u52a1\u5668\u4e0a\u8bbf\u95eehttps://10.15.6.93.nip.io \n\nRancher\u4f7f\u7528\u65b9\u6cd5\u53c2\u89c1\uff1a\nhttps://git.ketanyun.cn/operation/docs/wikis/Rancher%E9%83%A8%E7%BD%B2K8s%E6%8C%87%E5%AF%BC\n</code></pre>"},{"location":"kubernetes/k8s-deploy/Ubuntu20.04/","title":"Ubuntu20.04","text":"<pre><code>#!/bin/bash\n\n# \u914d\u7f6e\u65f6\u533a\ntimedatectl set-timezone Asia/Shanghai\n\n# \u5173\u95ed\u81ea\u52a8\u66f4\u65b0\nsed -i s/1/0/g /etc/apt/apt.conf.d/10periodic\n\n# \u66ff\u6362\u955c\u50cf\u6e90\ncat &gt; /etc/apt/sources.list &lt;&lt; EOF\ndeb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse\n\ndeb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse\n\ndeb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse\n\ndeb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse\n\ndeb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse\ndeb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse\nEOF\n\napt-get update -y\n\n# \u4fee\u6539limit\u53c2\u6570\necho \"* soft nofile 655360\" &gt;&gt; /etc/security/limits.conf\necho \"* hard nofile 655360\" &gt;&gt; /etc/security/limits.conf\necho \"root soft nofile 655360\" &gt;&gt; /etc/security/limits.conf\necho \"root hard nofile 655360\" &gt;&gt; /etc/security/limits.conf\necho \"* soft nproc 655360\"  &gt;&gt; /etc/security/limits.conf\necho \"* hard nproc 655360\"  &gt;&gt; /etc/security/limits.conf\necho \"* soft  memlock  unlimited\"  &gt;&gt; /etc/security/limits.conf\necho \"* hard memlock  unlimited\"  &gt;&gt; /etc/security/limits.conf\necho \"DefaultLimitNOFILE=1024000\"  &gt;&gt; /etc/systemd/system.conf\necho \"DefaultLimitNPROC=1024000\"  &gt;&gt; /etc/systemd/system.conf\n\n# \u7981\u7528swap\u5206\u533a\nswapoff -a &amp;&amp; echo \"vm.swappiness = 0\"&gt;&gt; /etc/sysctl.conf\n\nmv /etc/fstab /etc/fstab_bak\ncat /etc/fstab_bak |grep -v swap &gt; /etc/fstab\n\n\n# \u4fee\u6539\u5185\u6838\u53c2\u6570\necho 'net.bridge.bridge-nf-call-ip6tables = 1' &gt;&gt;  /etc/sysctl.d/k8s.conf\necho 'net.bridge.bridge-nf-call-iptables = 1' &gt;&gt; /etc/sysctl.d/k8s.conf\necho 'net.ipv4.ip_forward = 1' &gt;&gt; /etc/sysctl.d/k8s.conf\nmodprobe br_netfilter\nsysctl -p /etc/sysctl.d/k8s.conf\n\n# \u5f00\u542fIPVS\nfor i in $(ls /lib/modules/$(uname -r)/kernel/net/netfilter/ipvs|grep -o \"^[^.]*\");do echo $i; sudo /sbin/modinfo -F filename $i &gt;/dev/null 2&gt;&amp;1 &amp;&amp; /sbin/modprobe $i; done\nls /lib/modules/$(uname -r)/kernel/net/netfilter/ipvs|grep -o \"^[^.]*\" &gt;&gt; /etc/modules\n\n# \u5b89\u88c5\u5fc5\u8981\u8f6f\u4ef6\napt-get install -y lrzsz wget curl net-tools vim ipset ipvsadm lvm2 telnet keepalived nfs-kernel-server\n\n# \u5b89\u88c5docker\napt-get update\napt-get install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common\ncurl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -\nadd-apt-repository \\\n         \"deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu \\\n              $(lsb_release -cs) \\\n               stable\"\n\napt-get install -y docker-ce=5:19.03.15~3-0~ubuntu-focal docker-ce-cli=5:19.03.15~3-0~ubuntu-focal containerd.io\n\nmkdir -p /etc/docker\n\ncat &gt; /etc/docker/daemon.json &lt;&lt;EOF\n{\n             \"registry-mirrors\": [\"https://3muer6q5.mirror.aliyuncs.com\"],\n             \"data-root\": \"/data/docker\",\n             \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n             \"storage-driver\": \"overlay2\",\n             \"storage-opts\":[\"overlay2.override_kernel_check=true\"],\n             \"log-driver\": \"json-file\",\n             \"log-opts\": {\n               \"max-size\": \"100m\",\n               \"max-file\": \"10\"\n              }\n\n}\nEOF\n\nsystemctl enable docker &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl restart docker\n\n# \u5b89\u88c5kubernetes\ncurl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -\n\ncat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list\ndeb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\nEOF\napt-get update -y\napt-get install -y kubelet=1.19.9-00 kubeadm=1.19.9-00 kubectl=1.19.9-00\n</code></pre>"},{"location":"kubernetes/k8s-deploy/Ubuntu%E7%B3%BB%E7%BB%9F%E9%83%A8%E7%BD%B2k8s/","title":"Ubuntu\u7cfb\u7edf\u90e8\u7f72k8s","text":"<p>1\u3001\u4e3b\u673a\u540d\u89c4\u5212 10.15.6.66 MasterA 10.15.6.75 MasterB 10.15.6.74 MasterC 10.15.6.76 NodeA 10.15.6.77 NodeB 10.15.6.78 NodeC 2\u3001\u66f4\u6539\u4e3b\u673a\u540d hostnamectl set-hostname MasterA hostnamectl set-hostname MasterB hostnamectl set-hostname MasterC hostnamectl set-hostname NodeA hostnamectl set-hostname NodeB hostnamectl set-hostname NodeC 3\u3001\u6267\u884c\u521d\u59cb\u5316 sudo su - root cd /root &amp;&amp; mkdir /root/shell &amp;&amp; wget https://taskcenter.net/f27b84ee7e0620b39d03cbfb6a530413 -O /root/shell/init-server.sh sh /root/shell/init-server.sh 4\u3001\u5728master\u4e0a\u4e0b\u8f7d\u7f16\u8bd1\u597d\u7684kubeadm\u4e8c\u8fdb\u5236\u6587\u4ef6 wget https://taskcenter.net/fb620d15e174ca5cb4388b5a75d1ee18 -O ./kubeadm 5\u3001\u914d\u7f6eVIP \u4f7f\u7528\u975e\u62a2\u5360\u6a21\u5f0f\uff0c\u9632\u6b62\u67d0\u4e2a\u8282\u70b9\u7684apiserver\u91cd\u542f\u5bfc\u81f4\u9891\u7e41\u6545\u969c\u5207\u6362 \u7531\u4e8ek8s\u672c\u8eab\u5bf9apiserver\u5b58\u5728\u5065\u5eb7\u68c0\u67e5\u673a\u5236\uff0ckeepalived\u672c\u8eab\u65e0\u9700\u914d\u7f6e\u5065\u5eb7\u68c0\u67e5\uff0c\u4f46\u9700\u8981\u5728\u8ba1\u5212\u4efb\u52a1\u914d\u7f6e\u811a\u672c\u68c0\u6d4bkeepalived\u672c\u8eab vi /etc/keepalived/keepalived.conf</p> <p>! Configuration File for keepalived</p> <p>global_defs {    router_id LVS_DEVEL }</p> <p>vrrp_instance VI_1 {     state BACKUP      interface eth0  # \u7f51\u5361\u540d\u79f0\uff0cCentOS 7 \u4e3a\u7cfb\u7edf\u8bc6\u522b\u603b\u7ebf\u81ea\u751f\u6210\uff0c\u4ee5\u5b9e\u9645\u7f51\u5361\u540d\u4e3a\u51c6     nopreempt virtual_router_id 51     priority 100   # \u5176\u4ed6\u4e3b\u673a\u4fee\u6539\u4e3a100\u4ee5\u4e0b     advert_int 1     authentication {         auth_type PASS         auth_pass HPMOHhWlki  # \u8ba4\u8bc1\u5bc6\u7801\uff0c\u591a\u4e2avrrp\u7ec4\u8bf7\u4fee\u6539\u6b64\u5bc6\u7801     }     virtual_ipaddress {         10.15.6.92/32  # VIP\u5730\u5740     } } 6\u3001\u521b\u5efakubeadm\u914d\u7f6e\u6587\u4ef6 vim kubeadm-config.yaml</p> <p>apiVersion: kubeadm.k8s.io/v1beta2 kind: ClusterConfiguration kubernetesVersion: v1.19.9 controlPlaneEndpoint: \"10.15.6.92:6443\" imageRepository: oci.ketanyun.cn/hxzhou/kubenetes networking:   dnsDomain: cluster.local   serviceSubnet: \"172.31.2.0/24\"   podSubnet: \"172.31.1.0/24\" apiServer:   certSANs:   - 10.15.6.66   - 10.15.6.75   - 10.15.6.74   - 10.15.6.92   timeoutForControlPlane: 4m0s   extraVolumes:   - name: localtime     hostPath: /etc/localtime     mountPath: /etc/localtime     readOnly: true     pathType: File certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controllerManager:    extraVolumes:   - hostPath: /etc/localtime     mountPath: /etc/localtime     name: localtime     readOnly: true     pathType: File dns:   type: CoreDNS etcd:   local:     dataDir: /var/lib/etcd scheduler:    extraVolumes:   - hostPath: /etc/localtime     mountPath: /etc/localtime     name: localtime     readOnly: true     pathType: File</p> <p>apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration mode: \"ipvs\" 7\u3001\u521d\u59cb\u5316master\uff08\u4f7f\u7528\u65b0\u4e0a\u4f20\u7684kubeadm\uff0c\u89e3\u51b3\u8bc1\u4e661\u5e74\u540e\u8fc7\u671f\u95ee\u9898\uff09 ./kubeadm init --config kubeadm-config.yaml --upload-certs 8\u3001\u521d\u59cb\u5316\u5176\u4ed6master\uff08\u4f7f\u7528\u65b0\u4e0a\u4f20\u7684kubeadm\uff0c\u89e3\u51b3\u8bc1\u4e661\u5e74\u540e\u8fc7\u671f\u95ee\u9898\uff09 ./kubeadm join 10.15.6.92:6443 --token 1q3wpz.u1damy0rh12u0l5h \\     --discovery-token-ca-cert-hash sha256:9ceb1590eded8d2ad4404505c4be4d79cc64d4e79a0351aed5bddb938708d40c \\     --control-plane --certificate-key 73bff999c21a8d469e071f146ff0fb283f3d23f72295d00b130abdc12293efe6 9\u3001\u5de5\u4f5c\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\uff08\u4f7f\u7528\u65b0\u4e0a\u4f20\u7684kubeadm\uff0c\u89e3\u51b3\u8bc1\u4e661\u5e74\u540e\u8fc7\u671f\u95ee\u9898\uff09 ./kubeadm join 10.15.6.92:6443 --token 1q3wpz.u1damy0rh12u0l5h \\     --discovery-token-ca-cert-hash sha256:9ceb1590eded8d2ad4404505c4be4d79cc64d4e79a0351aed5bddb938708d40c 10\u3001\u90e8\u7f72calico\u7f51\u7edc\u63d2\u4ef6\uff08\u4e0a\u4f20\u6587\u4ef6\u505a\u94fe\u63a5\uff09 \u4e0a\u4f20calico\u5b9a\u4e49\u6587\u4ef6\uff0c\u7136\u540ekubectl apply -f \u5e94\u7528 \u6587\u4ef6\u4f4d\u7f6e\uff1ahttps://git.ketanyun.cn/hxzhou/kubenetes/blob/master/calico-vxlan.yaml 11\u3001\u5b8c\u6210\u5176\u4ed6\u90e8\u7f72\uff08rancher\u3001ingress\uff09 \uff081\uff09ingress-controller \u4e0a\u4f20ingress\u5b9a\u4e49\u6587\u4ef6\uff0c\u7136\u540ekubectl apply -f \u5e94\u7528 \u6587\u4ef6\u4f4d\u7f6e\uff1ahttps://git.ketanyun.cn/hxzhou/kubenetes/blob/master/ingress-controller.yaml \uff082\uff09rancher wget https://get.helm.sh/helm-v3.2.0-linux-amd64.tar.gz tar zxvf helm-v3.2.0-linux-amd64.tar.gz &amp;&amp; mv linux-amd64/helm /usr/bin/helm</p> <p>helm repo add rancher-stable http://rancher-mirror.oss-cn-beijing.aliyuncs.com/server-charts/stable</p> <p>kubectl create namespace cattle-system</p> <p>helm install rancher rancher-stable/rancher \\  --namespace cattle-system \\  --set hostname=10.15.6.93.nip.io  \\  --set ingress.tls.source=secret \\  --set rancherImageTag=v2.5.6</p> <p>\u53ef\u5728\u9879\u76ee\u7684windows\u670d\u52a1\u5668\u4e0a\u8bbf\u95eehttps://10.15.6.93.nip.io </p> <p>Rancher\u4f7f\u7528\u65b9\u6cd5\u53c2\u89c1\uff1a https://git.ketanyun.cn/operation/docs/wikis/Rancher%E9%83%A8%E7%BD%B2K8s%E6%8C%87%E5%AF%BC</p>"},{"location":"kubernetes/k8s-deploy/centos-init/","title":"Centos init","text":"<pre><code>## all vm\n\nvim /etc/hosts\nmkdir .ssh\nmv rsa.pem .ssh/id_rsa\nmv authorized_keys .ssh/\nchmod 0400 .ssh/*\nsed -ri \"59i StrictHostKeyChecking no\" /etc/ssh/ssh_config || true\nsed -ri \"59i UserKnownHostsFile /dev/null\" /etc/ssh/ssh_config || true\necho \"Host *\n  StrictHostKeyChecking no\n  UserKnownHostsFile /dev/null\" &gt; /etc/ssh/ssh_config.d/my.conf || true\nsystemctl restart sshd\n\n# \u5173\u95edSELINUX\nsed -i \"s/SELINUX=enforcing/SELINUX=disabled/g\" /etc/selinux/config\nsetenforce 0\n\n# \u4fee\u6539limit\u53c2\u6570\necho \"* soft nofile 655360\" &gt;&gt; /etc/security/limits.conf\necho \"* hard nofile 655360\" &gt;&gt; /etc/security/limits.conf\necho \"* soft nproc 655360\"  &gt;&gt; /etc/security/limits.conf\necho \"* hard nproc 655360\"  &gt;&gt; /etc/security/limits.conf\necho \"* soft  memlock  unlimited\"  &gt;&gt; /etc/security/limits.conf\necho \"* hard memlock  unlimited\"  &gt;&gt; /etc/security/limits.conf\necho \"DefaultLimitNOFILE=1024000\"  &gt;&gt; /etc/systemd/system.conf\necho \"DefaultLimitNPROC=1024000\"  &gt;&gt; /etc/systemd/system.conf\n\n# \u5173\u95ed\u9632\u706b\u5899\nsystemctl stop firewalld &amp;&amp; systemctl disable firewalld\n\n# \u7981\u7528swap\u5206\u533a\nswapoff -a &amp;&amp; echo \"vm.swappiness = 0\"&gt;&gt; /etc/sysctl.conf\nvim /etc/fstab\n\n# \u4fee\u6539\u5185\u6838\u53c2\u6570\ncat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_forward = 1\nEOF\nmodprobe br_netfilter\nsysctl -p /etc/sysctl.d/k8s.conf\n\n# \u5f00\u542fIPVS\ncat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF\n#!/bin/bash\nmodprobe -- ip_vs\nmodprobe -- ip_vs_rr\nmodprobe -- ip_vs_wrr\nmodprobe -- ip_vs_sh\nmodprobe -- nf_conntrack_ipv4\nEOF\n\nchmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4\n\n# \u5b89\u88c5\u5fc5\u8981\u7684\u8f6f\u4ef6\nyum repolist\nyum install -y git lrzsz wget curl net-tools vim ipset ipvsadm yum-utils device-mapper-persistent-data lvm2 telnet nfs-utils\n\n# \u914d\u7f6e\u955c\u50cf\u6e90\ncat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\ntimedatectl set-timezone Asia/Shanghai\nyum update -y\nmkdir /data\n\n#\u5b89\u88c5docker\nyum install -y yum-utils device-mapper-persistent-data lvm2\nyum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\nyum makecache fast\n\nyum install -y docker-ce-18.09.9-3.el7\nmkdir -p /etc/docker\ncat &gt; /etc/docker/daemon.json &lt;&lt;EOF\n{\n  \"registry-mirrors\": [\"https://3muer6q5.mirror.aliyuncs.com\"],\n  \"exec-opts\": [\"native.cgroupdriver=cgroupfs\"],\n#  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"data-root\": \"/data/docker\",\n  \"storage-driver\": \"overlay2\", \n  \"storage-opts\":[\"overlay2.override_kernel_check=true\"],\n  \"log-driver\": \"json-file\", \n  \"log-opts\": { \n      \"max-size\": \"100m\", \n      \"max-file\": \"10\" \n  }\n}\nEOF\n\nsystemctl enable docker &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl start docker\n\n#\u5b89\u88c5kube\nyum install -y kubelet-1.19.9 kubeadm-1.19.9 kubectl-1.19.9 &amp;&amp; systemctl enable kubelet\n\n\n## \u4e0d\u540c\u673a\u5668\u53c2\u6570\u4e0d\u540c\nnmtui\nhostnamectl set-hostname master|node\n\n\n# master\nvim kubeadm-config.yaml\n\napiServer:\n  certSANs:\n  - 192.168.0.11\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta2\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrolPlaneEndpoint: \"192.168.0.11:6443\"   # \u5982\u679c\u4f7f\u7528keepalived\u505a\u9ad8\u53ef\u7528\uff0c\u5219\u4fee\u6539\u4e3aVIP\u5730\u5740\ncontrollerManager: {}\ndns:\n  type: CoreDNS\netcd:\n  local:\n    dataDir: /data/etcd\nimageRepository: oci.ketanyun.cn/zhdong/k8s\nkind: ClusterConfiguration\nkubernetesVersion: v1.19.9\nnetwo\nrking:\n  dnsDomain: cluster.local\n  serviceSubnet: 172.31.2.0/24  # \u6309\u5b9e\u9645\u9700\u8981\u4fee\u6539service\u7f51\u7edc\n  podSubnet: \"172.31.1.0/24\"  # \u6309\u5b9e\u9645\u9700\u8981\u4fee\u6539pod\u7f51\u7edc\nscheduler: {}\n\n#\u521d\u59cb\u5316\u96c6\u7fa4\ndocker pull oci.ketanyun.cn/zhdong/k8s/pause:3.2\ndocker pull oci.ketanyun.cn/zhdong/k8s/coredns:1.7.0\ndocker pull oci.ketanyun.cn/zhdong/k8s/etcd:3.4.13-0\ndocker pull oci.ketanyun.cn/zhdong/k8s/kube-apiserver:v1.19.9\ndocker pull oci.ketanyun.cn/zhdong/k8s/kube-scheduler:v1.19.9\ndocker pull oci.ketanyun.cn/zhdong/k8s/kube-controller-manager:v1.19.9\ndocker pull oci.ketanyun.cn/zhdong/k8s/kube-proxy:v1.19.9\ndocker pull oci.ketanyun.cn/zhdong/k8s/kube-controllers:v3.19.1\ndocker pull oci.ketanyun.cn/zhdong/k8s/cni:v3.19.1\ndocker pull oci.ketanyun.cn/zhdong/k8s/pod2daemon-flexvol:v3.19.1\ndocker pull oci.ketanyun.cn/zhdong/k8s/node:v3.19.1\n\n./kubeadm init --config kubeadm-config.yaml --upload-certs\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nYou can now join any number of the control-plane node running the following command on each as root:\n\n  kubeadm join 192.168.0.11:6443 --token 39fnj7.wppktox08qk4799t \\\n    --discovery-token-ca-cert-hash sha256:7e75028528c15e2d62dc3c8a729b04808f086ed3fbea096539a0ea629f3c2ced \\\n    --control-plane --certificate-key 8f63d58ab0c42ce0424ba25b6e319e87f55752f2f284217809a7f060f3ef8cd2\n\nPlease note that the certificate-key gives access to cluster sensitive data, keep it secret!\nAs a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use\n\"kubeadm init phase upload-certs --upload-certs\" to reload certs afterward.\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 192.168.0.11:6443 --token mkfx10.hjw8sa2xf59bgs24 \\\n    --discovery-token-ca-cert-hash sha256:7e75028528c15e2d62dc3c8a729b04808f086ed3fbea096539a0ea629f3c2ced\n\n#\u914d\u7f6ekubectl\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\n#\u90e8\u7f72\u63d2\u4ef6\nkubectl apply -f calico-vxlan.yaml  \nkubectl apply -f ingress-controller.yaml \n\n#kubectl\u8865\u5168\nsource &lt;(kubectl completion bash)\necho \"source &lt;(kubectl completion bash)\" &gt;&gt; ~/.bashrc\nsource &lt;(kubeadm completion bash)\necho \"source &lt;(kubeadm completion bash)\" &gt;&gt; ~/.bashrc\n\n#helm\nwget https://get.helm.sh/helm-v3.2.0-linux-amd64.tar.gz\ntar -xf helm-v3.2.0-linux-amd64.tar.gz\ncp -p linux-amd64/helm /usr/bin/\nsource &lt;(helm completion bash)\necho \"source &lt;(helm completion bash)\" &gt;&gt; ~/.bashrc\n</code></pre>"},{"location":"kubernetes/k8s-deploy/1.24/k8s-containerd/","title":"1.24\u7248\u672c\u5b89\u88c5\u8bb0\u5f55","text":"<pre><code>hostnamectl set-hostname  k8s-master1\ncat &gt;&gt; /etc/hosts&lt;&lt;EOF\n192.168.2.11 k8s-master1\nEOF\ntimedatectl set-timezone Asia/Shanghai\n\n#ssh-keygen\n#ssh-copy-id -i ~/.ssh/id_rsa.pub root@k8s-master-168-0-113\n#ssh-copy-id -i ~/.ssh/id_rsa.pub root@k8s-node1-168-0-114\n#ssh-copy-id -i ~/.ssh/id_rsa.pub root@k8s-node2-168-0-115\n\n# ubuntu\ncat &gt; /etc/apt/sources.list&lt;&lt;EOF\ndeb https://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse\ndeb-src https://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse\n\ndeb https://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse\ndeb-src https://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse\n\ndeb https://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse\ndeb-src https://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse\n\n# deb https://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse\n# deb-src https://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse\n\ndeb https://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse\ndeb-src https://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse\nEOF\napt update\n\nyum install chrony -y || apt -y install chrony\nsystemctl start chronyd\nsystemctl enable chronyd\nchronyc sources\n\nsystemctl stop firewalld &amp;&amp; systemctl disable firewalld || ufw disable\n\nswapoff -a\nsed -ri 's/.*swap.*/#&amp;/' /etc/fstab\n\n# centos\n# \u4e34\u65f6\u5173\u95ed\nsetenforce 0\n# \u6c38\u4e45\u7981\u7528\nsed -i 's/^SELINUX=enforcing$/SELINUX=disabled/' /etc/selinux/config\n\n# ipvs\nmodprobe -- ip_vs\nmodprobe -- ip_vs_sh\nmodprobe -- ip_vs_rr\nmodprobe -- ip_vs_wrr\nlsmod |grep ip_vs\nyum install ipset ipvsadm -y || apt -y install ipset ipvsadm\n\n# \u5141\u8bb8 iptables \u68c0\u67e5\u6865\u63a5\u6d41\u91cf(\u53ef\u9009\uff0c\u6240\u6709\u8282\u70b9)\ncat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf\nbr_netfilter\nEOF\nsudo modprobe br_netfilter\nlsmod | grep br_netfilter\n# \u8bbe\u7f6e\u6240\u9700\u7684 sysctl \u53c2\u6570\uff0c\u53c2\u6570\u5728\u91cd\u65b0\u542f\u52a8\u540e\u4fdd\u6301\u4e0d\u53d8\ncat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables  = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.ipv4.ip_forward                 = 1\nEOF\n# \u5e94\u7528 sysctl \u53c2\u6570\u800c\u4e0d\u91cd\u65b0\u542f\u52a8\nsudo sysctl --system\n\n# \u6dfb\u52a0docker\u548ck8s\u8f6f\u4ef6\u6e90\nbash add_source.sh\napt update\n\n# \u5b89\u88c5docker-ce\u7248\u672c\nyum install -y docker-ce || apt -y install docker-ce\n# \u542f\u52a8\nsystemctl start docker\n# \u5f00\u673a\u81ea\u542f\nsystemctl enable docker\n# \u67e5\u770b\u7248\u672c\u53f7\ndocker --version\n# \u67e5\u770b\u7248\u672c\u5177\u4f53\u4fe1\u606f\ndocker version\n\n# Docker\u955c\u50cf\u6e90\u8bbe\u7f6e\n# \u4fee\u6539\u6587\u4ef6 /etc/docker/daemon.json\uff0c\u6ca1\u6709\u8fd9\u4e2a\u6587\u4ef6\u5c31\u521b\u5efa\n# \u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\u540e\uff0c\u91cd\u542fdocker\u670d\u52a1\uff1a\ncat &gt;/etc/docker/daemon.json&lt;&lt;EOF\n{\n  \"registry-mirrors\": [\"https://3muer6q5.mirror.aliyuncs.com\"],\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"data-root\": \"/data/docker\",\n  \"storage-driver\": \"overlay2\",\n  \"storage-opts\":[\"overlay2.override_kernel_check=true\"],\n  \"log-driver\": \"json-file\",\n  \"log-opts\": {\n      \"max-size\": \"100m\",\n      \"max-file\": \"10\"\n  }\n}\nEOF\n# \u52a0\u8f7d\nsystemctl reload docker\n\n# \u67e5\u770b\nsystemctl status docker containerd\n\n# \u5bfc\u51fa\u9ed8\u8ba4\u914d\u7f6e\uff0cconfig.toml\u8fd9\u4e2a\u6587\u4ef6\u9ed8\u8ba4\u662f\u4e0d\u5b58\u5728\u7684\ncontainerd config default &gt; /etc/containerd/config.toml\ngrep sandbox_image  /etc/containerd/config.toml\nsed -i \"s#k8s.gcr.io/pause#registry.aliyuncs.com/google_containers/pause#g\" /etc/containerd/config.toml\ngrep sandbox_image  /etc/containerd/config.toml\n\nsed -i 's#SystemdCgroup = false#SystemdCgroup = true#g' /etc/containerd/config.toml\n# \u5e94\u7528\u6240\u6709\u66f4\u6539\u540e,\u91cd\u65b0\u542f\u52a8containerd\nsystemctl restart containerd\n\n\ncat &lt;&lt;EOF&gt; /etc/crictl.yaml\nruntime-endpoint: unix:///run/containerd/containerd.sock\nimage-endpoint: unix:///run/containerd/containerd.sock\ntimeout: 10\ndebug: false\nEOF\n\n\n#yum install -y kubelet-1.24.4  kubeadm-1.24.4  kubectl-1.24.4 --disableexcludes=kubernetes\napt -y install kubelet=1.24.4-00  kubeadm=1.24.4-00  kubectl=1.24.4-00\n\n# \u8bbe\u7f6e\u4e3a\u5f00\u673a\u81ea\u542f\u5e76\u73b0\u5728\u7acb\u523b\u542f\u52a8\u670d\u52a1 --now\uff1a\u7acb\u523b\u542f\u52a8\u670d\u52a1\nsystemctl enable --now kubelet\n\n\n# \u6253\u5370\u914d\u7f6e\u6587\u4ef6\n# kubeadm config print init-defaults --component-configs KubeProxyConfiguration,KubeletConfiguration &gt; kube-config.yaml\nkubeadm init --config kube-config.yaml --upload-certs\n# \u6216\u8005\nkubeadm init \\\n--apiserver-advertise-address=192.168.2.11 \\\n--image-repository registry.aliyuncs.com/google_containers \\\n--control-plane-endpoint=cluster-endpoint \\\n--kubernetes-version v1.24.4 \\\n--service-cidr=172.19.0.0/16 \\\n--pod-network-cidr=172.18.0.0/16 \\\n--v=5 --upload-certs\n# \u2013image-repository string\uff1a    \u8fd9\u4e2a\u7528\u4e8e\u6307\u5b9a\u4ece\u4ec0\u4e48\u4f4d\u7f6e\u6765\u62c9\u53d6\u955c\u50cf\uff081.13\u7248\u672c\u624d\u6709\u7684\uff09\uff0c\u9ed8\u8ba4\u503c\u662fk8s.gcr.io\uff0c\u6211\u4eec\u5c06\u5176\u6307\u5b9a\u4e3a\u56fd\u5185\u955c\u50cf\u5730\u5740\uff1aregistry.aliyuncs.com/google_containers\n# \u2013kubernetes-version string\uff1a  \u6307\u5b9akubenets\u7248\u672c\u53f7\uff0c\u9ed8\u8ba4\u503c\u662fstable-1\uff0c\u4f1a\u5bfc\u81f4\u4ecehttps://dl.k8s.io/release/stable-1.txt\u4e0b\u8f7d\u6700\u65b0\u7684\u7248\u672c\u53f7\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5176\u6307\u5b9a\u4e3a\u56fa\u5b9a\u7248\u672c\uff08v1.22.1\uff09\u6765\u8df3\u8fc7\u7f51\u7edc\u8bf7\u6c42\u3002\n# \u2013apiserver-advertise-address  \u6307\u660e\u7528 Master \u7684\u54ea\u4e2a interface \u4e0e Cluster \u7684\u5176\u4ed6\u8282\u70b9\u901a\u4fe1\u3002\u5982\u679c Master \u6709\u591a\u4e2a interface\uff0c\u5efa\u8bae\u660e\u786e\u6307\u5b9a\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\uff0ckubeadm \u4f1a\u81ea\u52a8\u9009\u62e9\u6709\u9ed8\u8ba4\u7f51\u5173\u7684 interface\u3002\u8fd9\u91cc\u7684ip\u4e3amaster\u8282\u70b9ip\uff0c\u8bb0\u5f97\u66f4\u6362\u3002\n# \u2013pod-network-cidr             \u6307\u5b9a Pod \u7f51\u7edc\u7684\u8303\u56f4\u3002Kubernetes \u652f\u6301\u591a\u79cd\u7f51\u7edc\u65b9\u6848\uff0c\u800c\u4e14\u4e0d\u540c\u7f51\u7edc\u65b9\u6848\u5bf9  \u2013pod-network-cidr\u6709\u81ea\u5df1\u7684\u8981\u6c42\uff0c\u8fd9\u91cc\u8bbe\u7f6e\u4e3a10.244.0.0/16 \u662f\u56e0\u4e3a\u6211\u4eec\u5c06\u4f7f\u7528 flannel \u7f51\u7edc\u65b9\u6848\uff0c\u5fc5\u987b\u8bbe\u7f6e\u6210\u8fd9\u4e2a CIDR\u3002\n# --control-plane-endpoint     cluster-endpoint \u662f\u6620\u5c04\u5230\u8be5 IP \u7684\u81ea\u5b9a\u4e49 DNS \u540d\u79f0\uff0c\u8fd9\u91cc\u914d\u7f6ehosts\u6620\u5c04\uff1a192.168.0.113   cluster-endpoint\u3002 \u8fd9\u5c06\u5141\u8bb8\u4f60\u5c06 --control-plane-endpoint=cluster-endpoint \u4f20\u9012\u7ed9 kubeadm init\uff0c\u5e76\u5c06\u76f8\u540c\u7684 DNS \u540d\u79f0\u4f20\u9012\u7ed9 kubeadm join\u3002 \u7a0d\u540e\u4f60\u53ef\u4ee5\u4fee\u6539 cluster-endpoint \u4ee5\u6307\u5411\u9ad8\u53ef\u7528\u6027\u65b9\u6848\u4e2d\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u5730\u5740\u3002\n\n\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n\n# \u4e34\u65f6\u751f\u6548\uff08\u9000\u51fa\u5f53\u524d\u7a97\u53e3\u91cd\u8fde\u73af\u5883\u53d8\u91cf\u5931\u6548\uff09\nexport KUBECONFIG=/etc/kubernetes/admin.conf\n# \u6c38\u4e45\u751f\u6548\uff08\u63a8\u8350\uff09\necho \"export KUBECONFIG=/etc/kubernetes/admin.conf\" &gt;&gt; ~/.bash_profile\nsource  ~/.bash_profile\n\nkubectl get po -A\n\n\nkubectl edit  configmap -n kube-system  kube-proxy\n     mode: \"ipvs\"\n\n# \u91cd\u542fkube-proxy\nkubectl get pod -n kube-system | grep kube-proxy\n# \u518ddelete\u8ba9\u5b83\u81ea\u62c9\u8d77\nkubectl get pod -n kube-system | grep kube-proxy |awk '{system(\"kubectl delete pod \"$1\" -n kube-system\")}'\n# \u518d\u67e5\u770b\nkubectl get pod -n kube-system | grep kube-proxy\n\n\nipvsadm -Ln\niptables -nvL\n</code></pre> <p>kube-config.yaml</p>"},{"location":"kubernetes/k8s-deploy/kind/readme/","title":"kind \u642d\u5efa\u6d4b\u8bd5\u73af\u5883","text":"<p>config-with-port-mapping.yaml</p> <pre><code>kind create cluster --config=config-with-port-mapping.yaml --image=kindest/node:v1.19.16\nkind create cluster --config=config-with-port-mapping.yaml --image=kindest/node:v1.24.15\nkind create cluster --config=config-with-port-mapping.yaml --image=kindest/node:v1.29.0\n</code></pre>"},{"location":"kubernetes/k8s-network/coredns/","title":"coredns","text":""},{"location":"kubernetes/k8s-network/coredns/#corednshosts","title":"coredns\u914d\u7f6e\u6cdb\u57df\u540dhosts","text":"<pre><code>apiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health {\n           lameduck 5s\n        }\n        ready\n        hosts {\n           192.168.0.204 kas.site.domain minio.site.domain registry.site.domain gitlab.site.domain harbor.site.domain\n           fallthrough\n        }\n        template IN A dzh.com {\n          match .*\\.dzh\\.com\n          answer \"{{ .Name }} 60 IN A 192.168.1.1\"\n          fallthrough\n        }\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n           pods insecure\n           fallthrough in-addr.arpa ip6.arpa\n           ttl 30\n        }\n        prometheus :9153\n        forward . /etc/resolv.conf {\n           max_concurrent 1000\n        }\n        cache 30\n        loop\n        reload\n        loadbalance\n    }\nkind: ConfigMap\nmetadata:\n  name: coredns\n  namespace: kube-system\n</code></pre>"},{"location":"kubernetes/k8s-network/coredns/#coredns-dns","title":"coredns \u914d\u7f6edns","text":"<pre><code>apiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health {\n           lameduck 5s\n        }\n        ready\n        hosts {\n           192.168.110.183 my-sso.saif.sjtu.edu.cn\n           fallthrough\n        }\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n           pods insecure\n           fallthrough in-addr.arpa ip6.arpa\n           ttl 30\n        }\n        prometheus :9153\n        forward . /etc/resolv.conf {\n           max_concurrent 1000\n        }\n        cache 30\n        loop\n        reload\n        loadbalance\n    }\n    saifdc1.saif.com:53 {\n      errors\n      cache 30\n      forward . 172.16.110.11\n      reload\n    }\n    saifdc2.saif.com:53 {\n      errors\n      cache 30\n      forward . 172.16.110.12\n      reload\n    }\nkind: ConfigMap\nmetadata:\n  name: coredns\n  namespace: kube-system\n</code></pre>"},{"location":"kubernetes/k8s-network/endpointslice/","title":"EndpointSlice","text":"<p>https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#endpointslices</p> <p>https://blog.csdn.net/junbaozi/article/details/127857965</p> <p>Kubernetes v1.21 [stable]</p> <ul> <li>\u65e7\u7248endpoints api\u6700\u591a\u53ea\u80fd\u5c06\u6d41\u91cf\u53d1\u9001\u5230 1000 \u4e2a\u53ef\u7528\u7684\u652f\u6491\u7aef\u70b9\u3002</li> <li>\u4ece1.19\u7248\u672c\u5f00\u59cb\uff0ckube-proxy\u9ed8\u8ba4\u5df2\u7ecf\u4f7f\u7528endpointslice\u3002</li> <li>\u5b9a\u5236\u521b\u5efa\u7684endpoint\uff0c\u9ed8\u8ba4\u4f1a\u955c\u50cf\u5230endpointslice</li> </ul>","tags":["network","k8s"]},{"location":"kubernetes/k8s-network/ingress/","title":"ingress-nginx","text":""},{"location":"kubernetes/k8s-network/ingress/#ingress-nginxserviceingressservicenamepod","title":"ingress-nginx\u4e0d\u901a\u8fc7service\u8f6c\u53d1\u6d41\u91cf\uff0cingress\u4e2d\u914d\u7f6e\u7684serviceName\u4ec5\u7528\u4e8e\u5339\u914dpod","text":"<p><code>Internet</code> -&gt; <code>ingress-nginx-controller</code> -&gt; <code>pod</code></p> <p>\u9a8c\u8bc1\uff1a</p> <ol> <li>\u542f\u52a8\u4e00\u4e2a\u5177\u59073\u4e2apod\u7684\u5de5\u4f5c\u8d1f\u8f7d</li> <li>\u8bbe\u7f6e\u8be5\u5de5\u4f5c\u8d1f\u8f7d\u7684service\u7684<code>sessionAffinity: ClientIP</code>\uff0c\u5373\u5982\u679cingress-nginx\u8f6c\u53d1\u65f6\u4f7f\u7528service\uff0c\u90a3\u4e48\u6d41\u91cf\u7ecf\u8fc7service\u65f6\u603b\u662f\u547d\u4e2d\u540c\u4e00\u4e2apod</li> <li>\u76f4\u63a5\u8bbf\u95eeservice\uff0c\u9a8c\u8bc1<code>sessionAffinity: ClientIP</code>\u6709\u6548\u3002</li> <li>\u901a\u8fc7ingress\u8bbf\u95ee\uff0c\u9a8c\u8bc1<code>sessionAffinity: ClientIP</code>\u65e0\u6548\u3002\u5373ingress\u76f4\u63a5\u8f6c\u5230pod</li> <li><code>nginx.ingress.kubernetes.io/affinity: cookie</code>\u914d\u7f6e\u540e\uff0cingress-nginx\u4f1a\u8fd4\u56de\u7ed9\u6d4f\u89c8\u5668\u4e00\u4e2acookie\uff0c\u5f62\u5982<code>INGRESSCOOKIE=1704864597.384.165.82687|ee780868b2b0b107ed5d4ffd0fd10be9</code>\u3002ingress-nginx\u901a\u8fc7\u8be5cookie\u8fdb\u884c\u4f1a\u8bdd\u4fdd\u6301</li> </ol>"},{"location":"kubernetes/k8s-network/ingress/#ingress-nginx_1","title":"ingress-nginx \u4ee3\u7406\u5916\u90e8\u57df\u540d","text":"<pre><code>---\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n#    nginx.ingress.kubernetes.io/backend-protocol: HTTPS\n    nginx.ingress.kubernetes.io/rewrite-target: /$2\n    nginx.ingress.kubernetes.io/upstream-vhost: prometheus.site.domain\n    nginx.ingress.kubernetes.io/use-regex: \"true\"\n  name: test\n  namespace: dev\nspec:\n  ingressClassName: nginx\n  rules:\n  - host: test.site.domain\n    http:\n      paths:\n      - backend:\n          service:\n            name: test\n            port:\n              number: 80\n        path: /test(/|$)(.*)\n        pathType: ImplementationSpecific\n#  tls:\n#  - hosts:\n#    - 'test.site.domain'\n#    secretName: domain-tls\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: test\n  namespace: dev\nspec:\n  externalName: prometheus.site.domain\n  sessionAffinity: None\n  type: ExternalName\n</code></pre>"},{"location":"kubernetes/k8s-network/ingress/#ingress","title":"ingress\u6dfb\u52a0\u8bf7\u6c42\u5934","text":"<pre><code>      set $X-Forwarded-Proto https;\n      set $X-Forwarded-Port 443;\n      set $http_x_forwarded_proto https;\n      set $http_x_forwarded_port 443;\n\n\n\n      add_header \"X-XSS-Protection\" \"1; mode=block\";\n      add_header Cache-Control no-cache;\n      add_header X-Frame-Options SAMEORIGIN;\n      add_header Set-Cookie \"HttpOnly\";\n      add_header Set-Cookie \"Secure\";\n      if ($request_method !~ ^(GET|POST|PUT|OPTIONS|DELETE)$) {\n            return 403;\n      }\n\n\n      add_header Content-Security-Policy \"default-src 'self' localhost:8080 'unsafe-inline' 'unsafe-eval' blob: data: ;\";\n      add_header X-Content-Type-Options nosniff;\n</code></pre>"},{"location":"kubernetes/k8s-network/networkpolicy/","title":"\u7f51\u7edc\u7b56\u7565networkPolicy","text":"","tags":["network","k8s"]},{"location":"kubernetes/k8s-network/networkpolicy/#example","title":"example","text":"<pre><code>apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: test-network-policy\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      role: db\n  policyTypes:\n    - Ingress\n    - Egress\n  ingress:\n    - from:\n        - ipBlock:\n            cidr: 172.17.0.0/16\n            except:\n              - 172.17.1.0/24\n        - namespaceSelector:\n            matchLabels:\n              project: myproject\n        - podSelector:\n            matchLabels:\n              role: frontend\n      ports:\n        - protocol: TCP\n          port: 6379\n  egress:\n    - to:\n        - ipBlock:\n            cidr: 10.0.0.0/24\n      ports:\n        - protocol: TCP\n          port: 5978\n</code></pre>","tags":["network","k8s"]},{"location":"kubernetes/k8s-network/networkpolicy/#deny-all","title":"deny all","text":"<pre><code>---\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: default-deny-all\nspec:\n  podSelector: {}\n  policyTypes:\n  - Ingress\n  - Egress\n</code></pre>","tags":["network","k8s"]},{"location":"kubernetes/k8s-network/note/","title":"Note","text":""},{"location":"kubernetes/k8s-network/note/#pod","title":"pod\u7f51\u7edc\u95ee\u9898\u6392\u67e5","text":"<ul> <li> <p>\u7f51\u7edc\u914d\u7f6e\u68c0\u67e5\uff1a\u786e\u4fdd Pod \u548c\u670d\u52a1\u7684\u7f51\u7edc\u914d\u7f6e\u6b63\u786e\uff0c\u5305\u62ec Pod \u7f51\u7edc\u7b56\u7565\u3001\u670d\u52a1\u9009\u62e9\u5668\u548c\u7f51\u7edc\u63d2\u4ef6\u7b49\u3002</p> </li> <li> <p>\u7f51\u7edc\u6d41\u91cf\u76d1\u63a7\uff1a\u4f7f\u7528\u5de5\u5177\u5982 tcpdump\u3001Wireshark \u6216 Kubernetes \u81ea\u5e26\u7684 kubectl \u547d\u4ee4\u6765\u76d1\u63a7\u7f51\u7edc\u6d41\u91cf\uff0c\u67e5\u770b\u662f\u5426\u6709\u5f02\u5e38\u3002</p> </li> <li> <p>\u7f51\u7edc\u5ef6\u8fdf\u548c\u4e22\u5305\u7387\uff1a\u4f7f\u7528 ping \u6216 traceroute \u547d\u4ee4\u68c0\u6d4b\u7f51\u7edc\u5ef6\u8fdf\u548c\u4e22\u5305\u7387\uff0c\u627e\u51fa\u7f51\u7edc\u74f6\u9888\u3002</p> </li> <li> <p>\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff1a\u68c0\u67e5\u8282\u70b9\u548c Pod \u7684 CPU \u548c\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\uff0c\u786e\u4fdd\u6ca1\u6709\u8d44\u6e90\u4e0d\u8db3\u5bfc\u81f4\u7684\u7f51\u7edc\u62e5\u5835\u3002</p> </li> <li> <p>\u7f51\u7edc\u63d2\u4ef6\u95ee\u9898\uff1a\u5982\u679c\u4f7f\u7528\u7684\u662f\u7b2c\u4e09\u65b9\u7f51\u7edc\u63d2\u4ef6\uff08\u5982 Calico\u3001Flannel \u7b49\uff09\uff0c\u68c0\u67e5\u63d2\u4ef6\u914d\u7f6e\u548c\u65e5\u5fd7\uff0c\u6392\u67e5\u53ef\u80fd\u7684\u95ee\u9898\u3002</p> </li> <li> <p>DNS \u89e3\u6790\u95ee\u9898\uff1a\u68c0\u67e5 DNS \u89e3\u6790\u662f\u5426\u6b63\u5e38\uff0cDNS \u670d\u52a1\u662f\u5426\u6709\u95ee\u9898\u3002</p> </li> </ul>"},{"location":"kubernetes/k8s-network/service/","title":"Service","text":"","tags":["network","k8s"]},{"location":"kubernetes/k8s-network/service/#service","title":"service\u6d41\u91cf\u7b56\u7565","text":"<p>\u4f60\u53ef\u4ee5\u8bbe\u7f6e .spec.internalTrafficPolicy \u548c .spec.externalTrafficPolicy \u5b57\u6bb5\u6765\u63a7\u5236 Kubernetes \u5982\u4f55\u5c06\u6d41\u91cf\u8def\u7531\u5230\u5065\u5eb7\uff08\u201c\u5c31\u7eea\u201d\uff09\u7684\u540e\u7aef\u3002</p>","tags":["network","k8s"]},{"location":"kubernetes/k8s-network/service/#_1","title":"\u5185\u90e8\u6d41\u91cf\u7b56\u7565","text":"<p>\u7279\u6027\u72b6\u6001\uff1a Kubernetes v1.26 [stable]</p> <p>\u4f60\u53ef\u4ee5\u8bbe\u7f6e .spec.internalTrafficPolicy \u5b57\u6bb5\u6765\u63a7\u5236\u6765\u81ea\u5185\u90e8\u6e90\u7684\u6d41\u91cf\u5982\u4f55\u88ab\u8def\u7531\u3002 \u6709\u6548\u503c\u4e3a Cluster \u548c Local\u3002 \u5c06\u5b57\u6bb5\u8bbe\u7f6e\u4e3a Cluster \u4f1a\u5c06\u5185\u90e8\u6d41\u91cf\u8def\u7531\u5230\u6240\u6709\u51c6\u5907\u5c31\u7eea\u7684\u7aef\u70b9\uff0c \u5c06\u5b57\u6bb5\u8bbe\u7f6e\u4e3a Local \u4ec5\u4f1a\u5c06\u6d41\u91cf\u8def\u7531\u5230\u672c\u5730\u8282\u70b9\u51c6\u5907\u5c31\u7eea\u7684\u7aef\u70b9\u3002 \u5982\u679c\u6d41\u91cf\u7b56\u7565\u4e3a Local \u4f46\u6ca1\u6709\u672c\u5730\u8282\u70b9\u7aef\u70b9\uff0c\u90a3\u4e48 kube-proxy \u4f1a\u4e22\u5f03\u8be5\u6d41\u91cf\u3002</p>","tags":["network","k8s"]},{"location":"kubernetes/k8s-network/service/#_2","title":"\u5916\u90e8\u6d41\u91cf\u7b56\u7565","text":"<p>\u4f60\u53ef\u4ee5\u8bbe\u7f6e .spec.externalTrafficPolicy \u5b57\u6bb5\u6765\u63a7\u5236\u4ece\u5916\u90e8\u6e90\u8def\u7531\u7684\u6d41\u91cf\u3002 \u6709\u6548\u503c\u4e3a Cluster \u548c Local\u3002 \u5c06\u5b57\u6bb5\u8bbe\u7f6e\u4e3a Cluster \u4f1a\u5c06\u5916\u90e8\u6d41\u91cf\u8def\u7531\u5230\u6240\u6709\u51c6\u5907\u5c31\u7eea\u7684\u7aef\u70b9\uff0c \u5c06\u5b57\u6bb5\u8bbe\u7f6e\u4e3a Local \u4ec5\u4f1a\u5c06\u6d41\u91cf\u8def\u7531\u5230\u672c\u5730\u8282\u70b9\u4e0a\u51c6\u5907\u5c31\u7eea\u7684\u7aef\u70b9\u3002 \u5982\u679c\u6d41\u91cf\u7b56\u7565\u4e3a Local \u5e76\u4e14\u6ca1\u6709\u672c\u5730\u8282\u70b9\u7aef\u70b9\uff0c \u90a3\u4e48 kube-proxy \u4e0d\u4f1a\u8f6c\u53d1\u4e0e\u76f8\u5173 Service \u76f8\u5173\u7684\u4efb\u4f55\u6d41\u91cf\u3002</p>","tags":["network","k8s"]},{"location":"kubernetes/k8s-network/service/#_3","title":"\u6d41\u5411\u6b63\u7ec8\u6b62\u7684\u7aef\u70b9\u7684\u6d41\u91cf","text":"<p>\u7279\u6027\u72b6\u6001\uff1a Kubernetes v1.28 [stable]</p> <p>\u5982\u679c\u4e3a kube-proxy \u542f\u7528\u4e86 ProxyTerminatingEndpoints \u7279\u6027\u95e8\u63a7\u4e14\u6d41\u91cf\u7b56\u7565\u4e3a Local\uff0c \u5219\u8282\u70b9\u7684 kube-proxy \u5c06\u4f7f\u7528\u66f4\u590d\u6742\u7684\u7b97\u6cd5\u4e3a Service \u9009\u62e9\u7aef\u70b9\u3002 \u542f\u7528\u6b64\u7279\u6027\u65f6\uff0ckube-proxy \u4f1a\u68c0\u67e5\u8282\u70b9\u662f\u5426\u5177\u6709\u672c\u5730\u7aef\u70b9\u4ee5\u53ca\u662f\u5426\u6240\u6709\u672c\u5730\u7aef\u70b9\u90fd\u6807\u8bb0\u4e3a\u6b63\u5728\u7ec8\u6b62\u8fc7\u7a0b\u4e2d\u3002 \u5982\u679c\u6709\u672c\u5730\u7aef\u70b9\u5e76\u4e14\u6240\u6709\u672c\u5730\u7aef\u70b9\u90fd\u88ab\u6807\u8bb0\u4e3a\u5904\u4e8e\u7ec8\u6b62\u8fc7\u7a0b\u4e2d\uff0c \u5219 kube-proxy \u4f1a\u5c06\u8f6c\u53d1\u6d41\u91cf\u5230\u8fd9\u4e9b\u6b63\u5728\u7ec8\u6b62\u8fc7\u7a0b\u4e2d\u7684\u7aef\u70b9\u3002 \u5426\u5219\uff0ckube-proxy \u4f1a\u59cb\u7ec8\u9009\u62e9\u5c06\u6d41\u91cf\u8f6c\u53d1\u5230\u5e76\u672a\u5904\u4e8e\u7ec8\u6b62\u8fc7\u7a0b\u4e2d\u7684\u7aef\u70b9\u3002</p> <p>\u8fd9\u79cd\u5bf9\u5904\u4e8e\u7ec8\u6b62\u8fc7\u7a0b\u4e2d\u7684\u7aef\u70b9\u7684\u8f6c\u53d1\u884c\u4e3a\u4f7f\u5f97 NodePort \u548c LoadBalancer Service \u80fd\u6709\u6761\u4e0d\u7d0a\u5730\u817e\u7a7a\u8bbe\u7f6e\u4e86 externalTrafficPolicy: Local \u65f6\u7684\u8fde\u63a5\u3002</p> <p>\u5f53\u4e00\u4e2a Deployment \u88ab\u6eda\u52a8\u66f4\u65b0\u65f6\uff0c\u5904\u4e8e\u8d1f\u8f7d\u5747\u8861\u5668\u540e\u7aef\u7684\u8282\u70b9\u53ef\u80fd\u4f1a\u5c06\u8be5 Deployment \u7684 N \u4e2a\u526f\u672c\u7f29\u51cf\u5230 0 \u4e2a\u526f\u672c\u3002\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u5916\u90e8\u8d1f\u8f7d\u5747\u8861\u5668\u53ef\u80fd\u5728\u4e24\u6b21\u6267\u884c\u5065\u5eb7\u68c0\u67e5\u63a2\u9488\u4e4b\u95f4\u5c06\u6d41\u91cf\u53d1\u9001\u5230\u5177\u6709 0 \u4e2a\u526f\u672c\u7684\u8282\u70b9\u3002 \u5c06\u6d41\u91cf\u8def\u7531\u5230\u5904\u4e8e\u7ec8\u6b62\u8fc7\u7a0b\u4e2d\u7684\u7aef\u70b9\u53ef\u786e\u4fdd\u6b63\u5728\u7f29\u51cf Pod \u7684\u8282\u70b9\u80fd\u591f\u6b63\u5e38\u63a5\u6536\u6d41\u91cf\uff0c \u5e76\u9010\u6e10\u964d\u4f4e\u6307\u5411\u90a3\u4e9b\u5904\u4e8e\u7ec8\u6b62\u8fc7\u7a0b\u4e2d\u7684 Pod \u7684\u6d41\u91cf\u3002 \u5230 Pod \u5b8c\u6210\u7ec8\u6b62\u65f6\uff0c\u5916\u90e8\u8d1f\u8f7d\u5747\u8861\u5668\u5e94\u8be5\u5df2\u7ecf\u53d1\u73b0\u8282\u70b9\u7684\u5065\u5eb7\u68c0\u67e5\u5931\u8d25\u5e76\u4ece\u540e\u7aef\u6c60\u4e2d\u5b8c\u5168\u79fb\u9664\u8be5\u8282\u70b9\u3002</p>","tags":["network","k8s"]},{"location":"kubernetes/k8s-network/service/#netbridgebridge-nf-call-iptables-1","title":"\u5185\u6838\u53c2\u6570 net.bridge.bridge-nf-call-iptables = 1 \u7684\u4f5c\u7528","text":"<p>\u9996\u5148 Kubernetes \u7684 Service \u672c\u8d28\u662f\u4e2a\u53cd\u5411\u4ee3\u7406\uff0c\u8bbf\u95ee Service \u65f6\u4f1a\u8fdb\u884c DNAT\uff0c\u5c06\u539f\u672c\u8bbf\u95ee ClusterIP:Port \u7684\u6570\u636e\u5305 NAT \u6210 Service \u7684\u67d0\u4e2a Endpoint (PodIP:Port)\uff0c \u7136\u540e\u5185\u6838\u5c06\u8fde\u63a5\u4fe1\u606f\u63d2\u5165 conntrack \u8868\u4ee5\u8bb0\u5f55\u8fde\u63a5\u3002 \u76ee\u7684\u7aef\u56de\u5305\u7684\u65f6\u5019\u5185\u6838\u4ece conntrack \u8868\u5339\u914d\u8fde\u63a5\u5e76\u53cd\u5411 NAT\uff0c\u8fd9\u6837\u539f\u8def\u8fd4\u56de\u5f62\u6210\u4e00\u4e2a\u5b8c\u6574\u7684\u8fde\u63a5\u94fe\u8def\u3002</p> <p>\u4f46\u662f Linux Bridge\uff08Linux \u7f51\u6865\uff09\u662f\u4e00\u4e2a\u865a\u62df\u7684\u4e8c\u5c42\u8f6c\u53d1\u8bbe\u5907\uff0c\u800c iptables conntrack \u5de5\u4f5c\u5728\u4e09\u5c42\u3002 \u6240\u4ee5\u95ee\u9898\u6765\u4e86\uff0c\u5982\u679c\u76f4\u63a5\u8bbf\u95ee\u540c\u4e00\u7f51\u6865\u5185\u7684\u5730\u5740\uff0c\u4f1a\u8d70\u4e8c\u5c42\u8f6c\u53d1\uff0c\u4e0d\u7ecf\u8fc7 conntrack\uff0c\u7531\u4e8e\u6ca1\u6709\u539f\u8def\u8fd4\u56de\uff0c\u5ba2\u6237\u7aef\u4e0e\u670d\u52a1\u7aef\u7684\u901a\u4fe1\u5c31\u4e0d\u5728\u4e00\u4e2a \u300c\u9891\u9053\u300d \u4e0a\uff0c\u4e0d\u8ba4\u4e3a\u5904\u5728\u540c\u4e00\u4e2a\u8fde\u63a5\uff0c\u4e5f\u5c31\u65e0\u6cd5\u6b63\u5e38\u901a\u4fe1\u3002</p> <p>\u8bbe\u7f6e bridge-nf-call-iptables \u8fd9\u4e2a\u5185\u6838\u53c2\u6570 (\u8bbe\u7f6e\u4e3a 1)\uff0c\u8868\u793a bridge \u8bbe\u5907\u5728\u4e8c\u5c42\u8f6c\u53d1\u65f6\u4e5f\u53bb\u8c03\u7528 iptables \u914d\u7f6e\u7684\u4e09\u5c42\u89c4\u5219 (\u5305\u542b conntrack)\uff0c \u6240\u4ee5\u5f00\u542f\u8fd9\u4e2a\u53c2\u6570\u5c31\u80fd\u591f\u89e3\u51b3\u4e0a\u8ff0 Service \u540c\u8282\u70b9\u901a\u4fe1\u95ee\u9898\u3002</p>","tags":["network","k8s"]},{"location":"kubernetes/k8s-network/%E4%B8%BA%E5%8D%95%E4%B8%AApod%E9%85%8D%E7%BD%AEdns/","title":"\u4e3a\u5355\u4e2apod\u914d\u7f6edns","text":""},{"location":"kubernetes/k8s-network/%E4%B8%BA%E5%8D%95%E4%B8%AApod%E9%85%8D%E7%BD%AEdns/#pod-dns","title":"Pod \u7684 DNS \u914d\u7f6e","text":"<p>\u7279\u6027\u72b6\u6001\uff1a Kubernetes v1.14 [stable]</p> <p>Pod \u7684 DNS \u914d\u7f6e\u53ef\u8ba9\u7528\u6237\u5bf9 Pod \u7684 DNS \u8bbe\u7f6e\u8fdb\u884c\u66f4\u591a\u63a7\u5236\u3002</p> <p>Note</p> <p>dnsConfig \u5b57\u6bb5\u662f\u53ef\u9009\u7684\uff0c\u5b83\u53ef\u4ee5\u4e0e\u4efb\u4f55 dnsPolicy \u8bbe\u7f6e\u4e00\u8d77\u4f7f\u7528\u3002 \u4f46\u662f\uff0c\u5f53 Pod \u7684 dnsPolicy \u8bbe\u7f6e\u4e3a \"None\" \u65f6\uff0c\u5fc5\u987b\u6307\u5b9a dnsConfig \u5b57\u6bb5\u3002</p> <p>\u7528\u6237\u53ef\u4ee5\u5728 dnsConfig \u5b57\u6bb5\u4e2d\u6307\u5b9a\u4ee5\u4e0b\u5c5e\u6027\uff1a</p> <ul> <li> <p>nameservers\uff1a\u5c06\u7528\u4f5c\u4e8e Pod \u7684 DNS \u670d\u52a1\u5668\u7684 IP \u5730\u5740\u5217\u8868\u3002 \u6700\u591a\u53ef\u4ee5\u6307\u5b9a 3 \u4e2a IP \u5730\u5740\u3002\u5f53 Pod \u7684 dnsPolicy \u8bbe\u7f6e\u4e3a \"None\" \u65f6\uff0c \u5217\u8868\u5fc5\u987b\u81f3\u5c11\u5305\u542b\u4e00\u4e2a IP \u5730\u5740\uff0c\u5426\u5219\u6b64\u5c5e\u6027\u662f\u53ef\u9009\u7684\u3002 \u6240\u5217\u51fa\u7684\u670d\u52a1\u5668\u5c06\u5408\u5e76\u5230\u4ece\u6307\u5b9a\u7684 DNS \u7b56\u7565\u751f\u6210\u7684\u57fa\u672c\u540d\u79f0\u670d\u52a1\u5668\uff0c\u5e76\u5220\u9664\u91cd\u590d\u7684\u5730\u5740\u3002</p> </li> <li> <p>searches\uff1a\u7528\u4e8e\u5728 Pod \u4e2d\u67e5\u627e\u4e3b\u673a\u540d\u7684 DNS \u641c\u7d22\u57df\u7684\u5217\u8868\u3002\u6b64\u5c5e\u6027\u662f\u53ef\u9009\u7684\u3002 \u6307\u5b9a\u6b64\u5c5e\u6027\u65f6\uff0c\u6240\u63d0\u4f9b\u7684\u5217\u8868\u5c06\u5408\u5e76\u5230\u6839\u636e\u6240\u9009 DNS \u7b56\u7565\u751f\u6210\u7684\u57fa\u672c\u641c\u7d22\u57df\u540d\u4e2d\u3002 \u91cd\u590d\u7684\u57df\u540d\u5c06\u88ab\u5220\u9664\u3002Kubernetes \u6700\u591a\u5141\u8bb8 32 \u4e2a\u641c\u7d22\u57df\u3002</p> </li> <li> <p>options\uff1a\u53ef\u9009\u7684\u5bf9\u8c61\u5217\u8868\uff0c\u5176\u4e2d\u6bcf\u4e2a\u5bf9\u8c61\u53ef\u80fd\u5177\u6709 name \u5c5e\u6027\uff08\u5fc5\u9700\uff09\u548c value \u5c5e\u6027\uff08\u53ef\u9009\uff09\u3002 \u6b64\u5c5e\u6027\u4e2d\u7684\u5185\u5bb9\u5c06\u5408\u5e76\u5230\u4ece\u6307\u5b9a\u7684 DNS \u7b56\u7565\u751f\u6210\u7684\u9009\u9879\u3002 \u91cd\u590d\u7684\u6761\u76ee\u5c06\u88ab\u5220\u9664\u3002</p> </li> </ul> <p>\u4ee5\u4e0b\u662f\u5177\u6709\u81ea\u5b9a\u4e49 DNS \u8bbe\u7f6e\u7684 Pod \u793a\u4f8b\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  namespace: default\n  name: dns-example\nspec:\n  containers:\n    - name: test\n      image: nginx\n  dnsPolicy: \"None\"\n  dnsConfig:\n    nameservers:\n      - 192.0.2.1 # \u8fd9\u662f\u4e00\u4e2a\u793a\u4f8b\n    searches:\n      - ns1.svc.cluster-domain.example\n      - my.dns.search.suffix\n    options:\n      - name: ndots\n        value: \"2\"\n      - name: edns0\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/crd/","title":"Crd","text":""},{"location":"kubernetes/k8s-notebooks/crd/#cel-crd","title":"\u57fa\u4e8e CEL \u7684 CRD \u89c4\u5219\u6821\u9a8c","text":"<p>\u53c2\u8003</p> <p>\u5728 Kubernetes v1.29 \u7248\u672c\u4e2d\u57fa\u4e8e CEL \u7684 CRD \u6821\u9a8c\u80fd\u529b\u8fbe\u5230 GA\uff0c\u53ea\u9700\u8981\u4f7f\u7528 x-kubernetes-validations \u5b9a\u4e49\u6821\u9a8c\u89c4\u5219\u5373\u53ef</p> <pre><code>---\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  annotations:\n    controller-gen.kubebuilder.io/version: v0.13.0\n  name: kongplugins.configuration.konghq.com\nspec:\n  group: configuration.konghq.com\n  scope: Namespaced\n  versions:\n    name: v1\n    schema:\n      openAPIV3Schema:\n        description: KongPlugin is the Schema for the kongplugins API.\n        properties:\n          plugin:\n        ...\n        x-kubernetes-validations:\n        - message: Using both config and configFrom fields is not allowed.\n          rule: '!(has(self.config) &amp;&amp; has(self.configFrom))'\n        - message: The plugin field is immutable\n          rule: self.plugin == oldSelf.plugin\n</code></pre> <p>\u4f8b\u5982\u5176\u4e2d\u7684\u8fd9\u53e5 self.plugin == oldSelf.plugin\uff0cself \u548c oldSelf \u4ee3\u8868\u4e86\u53d8\u5316\u524d\u540e\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c \u4e00\u65e6\u5b9a\u4e49\u4e86 plugin \u5b57\u6bb5\u7684\u5185\u5bb9\uff0c\u5219\u4e0d\u5141\u8bb8\u4fee\u6539\u5b83\u3002</p> <p>\u6b64\u5916\uff0cCEL \u8fd8\u6709\u975e\u5e38\u4e30\u5bcc\u7684\u7279\u6027\uff0c\u53ef\u4ee5\u901a\u8fc7\u5728\u7ebf\u7684 Playground \u6765\u4f53\u9a8c\u5b83 https://playcel.undistro.io/</p>"},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/","title":"Note","text":"","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#_1","title":"\u955c\u50cf\u4ed3\u5e93\u51ed\u8bc1","text":"<p>\u521b\u5efaimagePullSecret\uff0c\u5e76**\u8986\u76d6\u65e7\u7684**</p> <pre><code>kubectl create secret docker-registry registry -n ketanyun \\\n--docker-server=docker.qtgl.com.cn \\\n--docker-username=xx \\\n--docker-password=xx \\\n--dry-run=client -o yaml | kubectl apply -f -\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#kubectl-token","title":"kubectl \u4f7f\u7528token\u7684\u65b9\u5f0f\u8fde\u63a5\u5230\u96c6\u7fa4","text":"<p>\u9996\u5148\u5f97\u6709\u4e00\u4e2a\u8d26\u6237</p> <pre><code>kubectl create serviceaccount dashboard-admin -n kube-system #\u521b\u5efa\u4e00\u4e2a\u540d\u53ebdashboard-admin \u547d\u540d\u7a7a\u95f4\u5728kube-system \u4e0b\u7684\u670d\u52a1\u8d26\u6237\nkubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin #dashboard-admin \u7ed1\u5b9a\u4e3a\u96c6\u7fa4\u8d26\u6237\nkubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}') #\u663e\u793a\u51fa\u540d\u5b57\u4e3adashboard-admin-*\u7684\u7b2c\u4e00\u4e2a\u5339\u914d\u8d26\u6237\u7684\u8be6\u7ec6\u4fe1\u606f\n</code></pre> <p>\u8fd9\u91cc\u521b\u5efa\u4e00\u4e2a\u7528\u6765\u767b\u5f55kubernetes\u7684\u8d26\u6237 </p> <p>\u5982\u679c\u6709\u76f4\u63a5\u6267\u884c\u7b2c\u4e09\u6761\u547d\u4ee4\u53d6\u51fatoken</p> <pre><code> kubectl config set-credentials tf-admin --token={\u4e0a\u6587\u7684Token} #\u914d\u7f6e\u767b\u5f55\u65b9\u5f0f \u8fd9\u91cc\u6211\u4f7f\u7528\u7684\u662ftoken\u767b\u5f55 \u901a\u8fc7kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}') \u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u4e00\u6761\n kubectl config set-cluster tf-cluster --insecure-skip-tls-verify=true --server={\u96c6\u7fa4\u7684\u8fde\u63a5\u5730\u5740https://xx.xx.xx.xx:xx} #\u914d\u7f6e\u8fde\u63a5\u5730\u5740\n kubectl config set-context tf-system --cluster=tf-cluster --user=tf-admin \n kubectl config use-context tf-system  \n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#k8s","title":"k8s\u96c6\u7fa4\u6dfb\u52a0\u65b0\u8282\u70b9","text":"<pre><code># \u6dfb\u52a0node\n#\u521b\u5efa\u65b0token\uff0c24h\u8fc7\u671f\nkubeadm token create --print-join-command\n\n#\u67e5\u770bKubernetes\u8ba4\u8bc1\u7684SHA256\u52a0\u5bc6\u5b57\u7b26\u4e32\n#openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'\n\n#\u5728\u65b0node\u4e0a\u6267\u884c\u547d\u4ee4\u52a0\u5165\u96c6\u7fa4\nkubeadm join 192.168.0.11:6443 --token mkfx10.hjw8sa2xf59bgs24 \\\n    --discovery-token-ca-cert-hash sha256:7e75028528c15e2d62dc3c8a729b04808f086ed3fbea096539a0ea629f3c2ced\n</code></pre> <pre><code>#\u6dfb\u52a0master\u8282\u70b9\nkubeadm token create --print-join-command\n\n#\u67e5\u770bcertificate-key\nkubeadm init phase upload-certs --upload-certs\n\nkubeadm join 192.168.0.11:6443 --token mkfx10.hjw8sa2xf59bgs24 \\\n    --discovery-token-ca-cert-hash sha256:7e75028528c15e2d62dc3c8a729b04808f086ed3fbea096539a0ea629f3c2ced \\\n    --control-plane --certificate-key 8d2709697403b74e35d05a420bd2c19fd8c11914eb45f2ff22937b245bed5b68\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#unable-to-connect-to-the-server-x509-certificate-is-valid-for-ingresslocal","title":"Unable to connect to the server: x509: certificate is valid for ingress.local","text":"<pre><code>kubectl ... --insecure-skip-tls-verify\n\n  or\n\nclusters:\n- cluster:\n    server: https://cluster.mysite.com\n    insecure-skip-tls-verify: true\n  name: default\n- \n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#_2","title":"\u91cd\u7f6e\u8282\u70b9\u540e\u7684\u64cd\u4f5c","text":"<p>rm -rf /etc/kubernetes/* &amp;&amp; rm -rf ~/.kube/* &amp;&amp; rm -rf /var/lib/etcd/*</p>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#taint","title":"taint","text":"<pre><code># \u67e5\u770bnode\u7684taints\nkubectl get node k8s-masterc -o yaml\n  taints:\n  - effect: NoSchedule\n    key: node-role.kubernetes.io/master\n# \u914d\u7f6e\u8c03\u5ea6\u5230\u8fd9\u53f0\u673a\u5668\u7684\u5e94\u7528\nkubectl edit -n ns deploy rancher\n      containers:\n        \u00b7\u00b7\u00b7\n      tolerations:\n      - key: node-role.kubernetes.io/master\n        operator: \"Exists\"   \n        value: \"v1\"  #\u5f53op=Exists\u53ef\u4e3a\u7a7a\n        effect: NoSchedule  #\u53ef\u4ee5\u4e3a\u7a7a\uff0c\u5339\u914d\u6240\u6709\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#kubeletetcd","title":"\u4fee\u6539kubelet\u548cetcd\u7684\u5b58\u50a8\u76ee\u5f55","text":"<p>https://blog.csdn.net/qq_39826987/article/details/126473129</p>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#linuxkubectl-convert","title":"linux\u5b89\u88c5kubectl-convert","text":"<pre><code>curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl-convert\"\nsudo install -o root -g root -m 0755 kubectl-convert /usr/local/bin/kubectl-convert\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#docker-composek8syaml","title":"\u5c06docker-compose\u8f6c\u6210k8s\u7684yaml\u683c\u5f0f\u914d\u7f6e","text":"<pre><code># \u4e0b\u8f7d\u4e8c\u8fdb\u5236\u5305\n# https://github.com/kubernetes/kompose/releases\n\n# \u5f00\u59cb\u8f6c\u53d1yaml\u914d\u7f6e\n./kompose-linux-amd64 -f docker-compose.yml convert\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#master","title":"\u66f4\u6362master\u8282\u70b9","text":"<pre><code>## \u80cc\u666f\uff0c\u539fmaster\u8282\u70b9\u6545\u969c\uff0c\u5df2\u8e22\u51fa\u96c6\u7fa4\uff0c\u63d0\u4f9b\u65b0\u670d\u52a1\u5668\uff0cip\u7b49\u914d\u7f6e\u4e0d\u53d8\uff0c\u91cd\u65b0\u52a0\u5165\n\n- \u53ef\u4f7f\u7528\u90e8\u7f72k8s\u96c6\u7fa4\u811a\u672c\uff0c\u5c06\u5176\u4ed6\u4e3b\u673a\u5728hosts\u4e2d\u6ce8\u91ca\uff0c\u53ea\u7559\u4e0b\u9700\u8981\u7684\u4e3b\u673a\uff0c\u53ea\u8fd0\u884c\u811a\u672c\u7b2c\u4e00\u6bb5\u521d\u59cb\u5316\n\nansible-playbook  deploy.yml --tags common\n\n\n## \u5728\u5176\u4ed6master\u4e2d\u83b7\u53d6\u52a0\u5165\u96c6\u7fa4\u547d\u4ee4 \uff08\u9700\u5148\u505a\u4e0b\u4e00\u6b65\u518d\u6267\u884c\u52a0\u5165\u8282\u70b9\u64cd\u4f5c\uff09\n\n# \u6dfb\u52a0node\n#\u521b\u5efa\u65b0token\uff0c24h\u8fc7\u671f\nkubeadm token create --print-join-command\n\n#\u67e5\u770bKubernetes\u8ba4\u8bc1\u7684SHA256\u52a0\u5bc6\u5b57\u7b26\u4e32\n#openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'\n\n#\u5728\u65b0node\u4e0a\u6267\u884c\u547d\u4ee4\u52a0\u5165\u96c6\u7fa4\nkubeadm join 192.168.0.11:6443 --token mkfx10.hjw8sa2xf59bgs24 \\\n    --discovery-token-ca-cert-hash sha256:7e75028528c15e2d62dc3c8a729b04808f086ed3fbea096539a0ea629f3c2ced\n\n\n#\u6dfb\u52a0master\u8282\u70b9\nkubeadm token create --print-join-command\n\n#\u67e5\u770bcertificate-key\nkubeadm init phase upload-certs --upload-certs\n\nkubeadm join 172.17.0.1:6443 --token mkfx10.hjw8sa2xf59bgs24 \\\n    --discovery-token-ca-cert-hash sha256:7e75028528c15e2d62dc3c8a729b04808f086ed3fbea096539a0ea629f3c2ced \\\n    --control-plane --certificate-key 8d2709697403b74e35d05a420bd2c19fd8c11914eb45f2ff22937b245bed5b68\n\n\n## \u5728\u73b0\u6709etcd\u4e2d\u53bb\u9664\u539f\u6709\u8282\u70b9\u4fe1\u606f\n\n## \u5220\u9664cm\u4e2d\u4fe1\u606f\nkubectl edit configmaps -n kube-system kubeadm-config\n\nClusterStatus: |\n    apiEndpoints:\n      node130:\n        advertiseAddress: 192.168.3.130\n        bindPort: 6443\n#      node131:\n#        advertiseAddress: 192.168.3.131\n#        bindPort: 6443\n      node132:\n        advertiseAddress: 192.168.3.132\n        bindPort: 6443\n\n## \u5220\u9664etcdpod\u4e2d\u4fe1\u606f\nkubectl exec -it etcd-node130 sh -n kube-system\n\nexport ETCDCTL_API=3\n\nalias etcdctl='etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key'\n\n## \u83b7\u53d6\u8282\u70b9\u5217\u8868\netcdctl member list\nca953a0d64b48849, started, node132, https://192.168.3.132:2380, https://192.168.3.132:2379\ndf8b283813118626, started, node130, https://192.168.3.130:2380, https://192.168.3.130:2379\nea4c8cb8cc15f00b, started, node131, https://192.168.3.131:2380, https://192.168.3.131:2379\n## \u5220\u9664\u5bf9\u5e94\u8282\u70b9\netcdctl member remove 4dc1b8e05e1da44d\nMember ea4c8cb8cc15f00b removed from cluster 884edae04b421411\n## \u518d\u6b21\u67e5\u770b\u5217\u8868\netcdctl member list\nca953a0d64b48849, started, node132, https://192.168.3.132:2380, https://192.168.3.132:2379\ndf8b283813118626, started, node130, https://192.168.3.130:2380, https://192.168.3.130:2379\n\n\n## \u6267\u884c\u52a0\u5165\u8282\u70b9\u64cd\u4f5c\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#k8s_1","title":"k8s\u4e2d\u7684\u4f1a\u8bdd\u4fdd\u6301","text":"<ul> <li>\u4f7f\u7528ingress-nginx</li> </ul> <p>\u4f1a\u8bdd\u4fdd\u6301\u7531ingress-nginx-controller\u63d0\u4f9b\uff0c\u8bf7\u6c42\u8def\u5f84\uff1a</p> <p>\u5ba2\u6237\u7aef -&gt; ingress-nginx -&gt; pod </p> <p>ingress\u914d\u7f6e\u4e2d\u7684service\u4ec5\u7528\u4e8e\u670d\u52a1\u53d1\u73b0pod\uff0c\u6d41\u91cf\u6ca1\u6709\u7ecf\u8fc7service</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/affinity: cookie\n</code></pre> <ul> <li>\u76f4\u63a5\u8bbf\u95eeservice</li> </ul> <p>\u4f1a\u8bdd\u4fdd\u6301\u7531service\u63d0\u4f9b\uff0c\u8bf7\u6c42\u8def\u5f84\uff1a</p> <p>\u5ba2\u6237\u7aef -&gt; service -&gt; pod</p> <p>service\u53ef\u914d\u7f6e\u6839\u636eClientIP\u8fdb\u884c\u4f1a\u8bdd\u4fdd\u6301</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: demo\nspec:\n  ports:\n  - name: http\n    port: 80\n    protocol: TCP\n    targetPort: http\n  selector:\n    app.kubernetes.io/instance: demo\n    app.kubernetes.io/name: demo\n  sessionAffinity: ClientIP\n  sessionAffinityConfig:\n    clientIP:\n      timeoutSeconds: 10800\n  type: ClusterIP\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#error-metrics-api-not-available","title":"error: Metrics API not available","text":"<pre><code>[zhdong@k8s-master ~]$ kubectl top no \nerror: Metrics API not available\n</code></pre> <pre><code>cat &lt;&lt; EOF | kubectl create -f -\napiVersion: apiregistration.k8s.io/v1\nkind: APIService\nmetadata:\n  labels:\n    k8s-app: metrics-server\n  name: v1beta1.metrics.k8s.io\nspec:\n  group: metrics.k8s.io\n  groupPriorityMinimum: 100\n  insecureSkipTLSVerify: true\n  service:\n    name: metrics-server\n    namespace: kube-system\n  version: v1beta1\n  versionPriority: 100\nEOF\n\n\n[zhdong@k8s-master ~]$ kubectl api-resources | grep metri\nmonitormetrics                                          management.cattle.io/v3           true         MonitorMetric\nnodes                                                   metrics.k8s.io/v1beta1            false        NodeMetrics\npods                                                    metrics.k8s.io/v1beta1            true         PodMetrics\nmetricsinstances                                        monitoring.grafana.com/v1alpha1   true         MetricsInstance\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#non-graceful-node-shutdown","title":"Non-Graceful Node Shutdown\u8282\u70b9\u975e\u6b63\u5e38\u5173\u95ed","text":"<p>Kubernetes v1.24 introduced an alpha quality implementation of improvements for handling a non-graceful node shutdown Kubernetes 1.26: Non-Graceful Node Shutdown Moves to Beta and enabled by default.</p> <ul> <li>\u8be5\u529f\u80fd\u4e3b\u8981\u89e3\u51b3sts\u7684pod\u5728\u8282\u70b9\u975e\u6b63\u5e38\u5173\u95ed\u65f6\u4f1a\u5361\u6b7b\uff0c\u4e0d\u4f1a\u81ea\u52a8\u5728\u5176\u4ed6\u8282\u70b9\u542f\u52a8</li> </ul> <pre><code># \u5728\u786e\u8ba4\u975e\u6b63\u5e38\u5173\u95ed\u7684\u8282\u70b9\u4e0a\u6253out-of-service\u6c61\u70b9\uff0c\u5219\u89e6\u53d1\u8282\u70b9\u4e0a\u7684 Pod \u88ab\u5f3a\u5236\u5220\u9664\u3002\u5728\u8be5\u8282\u70b9\u6062\u590d\u540e\uff0c\u5e94\u8be5\u53bb\u9664\u8be5\u6c61\u70b9\nkubectl taint nodes &lt;node-name&gt; node.kubernetes.io/out-of-service=nodeshutdown:NoExecute\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#poddisruptionbudget","title":"PodDisruptionBudget","text":"<p>\u9996\u5148\u4e86\u89e3\u5e72\u6270Disruptions</p> <pre><code>apiVersion: policy/v1\nkind: PodDisruptionBudget\nmetadata:\n  name: zk-pdb\nspec:\n  # \u8981\u6c42\u6700\u5c11\u67092\u4e2apod\u53ef\u7528\n  minAvailable: 2\n  selector:\n    matchLabels:\n      app: zookeeper\n</code></pre> <pre><code>apiVersion: policy/v1\nkind: PodDisruptionBudget\nmetadata:\n  name: zk-pdb\nspec:\n  # \u6700\u591a\u5141\u8bb81\u4e2apod\u4e0d\u53ef\u7528\n  maxUnavailable: 1\n  selector:\n    matchLabels:\n      app: zookeeper\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#kubernetes-sli","title":"Kubernetes \u7ec4\u4ef6\u8fd0\u884c\u72b6\u51b5 SLI","text":"<p>Kubernetes v1.29 [stable] \u4ecev1.27\u5f00\u59cb\u9ed8\u8ba4\u542f\u7528</p> <pre><code>~# kubectl get --raw \"/metrics/slis\"\n# HELP kubernetes_healthcheck [STABLE] This metric records the result of a single healthcheck.\n# TYPE kubernetes_healthcheck gauge\nkubernetes_healthcheck{name=\"etcd\",type=\"healthz\"} 1\nkubernetes_healthcheck{name=\"etcd\",type=\"livez\"} 1\nkubernetes_healthcheck{name=\"etcd\",type=\"readyz\"} 1\nkubernetes_healthcheck{name=\"etcd-readiness\",type=\"readyz\"} 1\nkubernetes_healthcheck{name=\"informer-sync\",type=\"readyz\"} 1\nkubernetes_healthcheck{name=\"ping\",type=\"healthz\"} 1\nkubernetes_healthcheck{name=\"ping\",type=\"livez\"} 1\nkubernetes_healthcheck{name=\"ping\",type=\"readyz\"} 1\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#_3","title":"\u5b9a\u4e49\u76f8\u4e92\u4f9d\u8d56\u7684\u73af\u5883\u53d8\u91cf","text":"<pre><code>          env:\n            - name: DB_DRIVER\n              valueFrom:\n                secretKeyRef:\n                  name: walrus\n                  key: db_driver\n            - name: DB_USER\n              valueFrom:\n                secretKeyRef:\n                  name: walrus\n                  key: db_user\n            - name: DB_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  name: walrus\n                  key: db_password\n            - name: DB_NAME\n              valueFrom:\n                secretKeyRef:\n                  name: walrus\n                  key: db_name\n            - name: SERVER_DATA_SOURCE_ADDRESS\n              value: $(DB_DRIVER)://$(DB_USER):$(DB_PASSWORD)@database:5432/$(DB_NAME)?sslmode=disable\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#pidpod","title":"\u6839\u636e\u8fdb\u7a0bPID\u627e\u5230\u5bf9\u5e94pod","text":"<pre><code># containerd\nroot@tracy:~# crictl ps -q | xargs crictl inspect -o go-template --template '{{ .info.pid }}    {{ index .info.config.labels \"io.kubernetes.pod.namespace\" }}         {{  index .info.config.labels \"io.kubernetes.pod.name\" }}' \n21358    ingress-nginx         ingress-nginx-controller-r6hsw\n20924    kube-system         kube-scheduler-tracy\n20917    kube-system         kube-controller-manager-tracy\n20592    kube-system         kube-apiserver-tracy\n20557    kube-system         etcd-tracy\n18969    captain-system         captain-controller-manager-5b86cdf675-j6txr\n18664    captain-system         captain-chartmuseum-79d6bb79d7-fh8l4\n18352    loki         grafana-7cd485b99b-4ck87\n17615    loki         promtail-9hwxb\n16152    loki         loki-0\n15406    loki         loki-minio-647c455b5b-m9jzf\n14710    loki         loki-gateway-d96bbd6bb-rpks6\n14510    kube-system         metrics-server-5868f67966-72qjb\n13318    nfs-client-provisioner         nfs-client-nfs-subdir-external-provisioner-fc58df597-7bmmf\n12934    local-path-storage         local-path-provisioner-bf6cc89c4-6b9gb\n12763    kube-system         calico-kube-controllers-7768b8dd4-jvjlv\n12209    kube-system         coredns-75b8b5b69d-g842s\n11954    kube-system         coredns-75b8b5b69d-fzsk5\n11261    kube-system         calico-node-66tqz\n8847    kube-system         kube-proxy-v8kh6\n\n\n# docker\ndocker ps -q | xargs docker inspect -f '{{.State.Pid}}    {{ index .Config.Labels \"io.kubernetes.pod.namespace\" }}    {{ index .Config.Labels \"io.kubernetes.pod.name\" }}'\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/k8s-notebooks/#nsenter","title":"nsenter\u547d\u4ee4\u89e3\u51b3\u5bb9\u5668\u5185\u90e8\u547d\u4ee4\u4e0d\u8db3\u7684\u95ee\u9898","text":"<ul> <li> <p>\u7f51\u7edc\u6587\u4ef6\u53c2\u8003</p> </li> <li> <p>\u8bf4\u660e</p> </li> </ul> <pre><code>root@tracy:~# crictl ps -q | xargs crictl inspect -o go-template --template '{{ .info.pid }}    {{ index .info.config.labels \"io.kubernetes.pod.namespace\" }}         {{  index .info.config.labels \"io.kubernetes.pod.name\" }}'\n16152    loki         loki-0\n\nroot@tracy:~# nsenter -n -t 16152\n\nroot@tracy:~# ip a \n1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n3: eth0@if17: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default qlen 1000\n    link/ether f2:eb:85:40:94:0b brd ff:ff:ff:ff:ff:ff link-netnsid 0\n    inet 10.95.175.75/32 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::f0eb:85ff:fe40:940b/64 scope link \n       valid_lft forever preferred_lft forever\n\nroot@tracy:~# kubectl get po -o wide -n loki   loki-0\nNAME     READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES\nloki-0   1/1     Running   0          58m   10.95.175.75   tracy   &lt;none&gt;           &lt;none&gt;\n\nroot@tracy:~# exit\nlogout\n\nroot@tracy:~# ip a \n1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 1000\n    link/ether 00:0c:29:ff:26:91 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.182.15/24 brd 192.168.182.255 scope global ens33\n       valid_lft forever preferred_lft forever\n    inet6 fe80::20c:29ff:feff:2691/64 scope link \n       valid_lft forever preferred_lft forever\n</code></pre> <pre><code># \u8fdb\u5165\u7279\u5b9a\u8fdb\u7a0b\u7684\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\nnsenter --net -t [PID] -- ip a\n\n# \u540c\u65f6\u8fdb\u5165\u591a\u4e2a\u547d\u540d\u7a7a\u95f4\nnsenter --net --pid -t [PID] -- bash\n\n# \u8bbf\u95ee\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7edf\nnsenter --mount -t [PID] -- bash\n\n# --preserve-credentials\u9009\u9879\u5141\u8bb8\u5728\u6267\u884c\u547d\u4ee4\u65f6\u4fdd\u7559\u7528\u6237\u7684UID\u548cGID\nnsenter --preserve-credentials -n -t [PID] -- id\nuid=0(root) gid=0(root) groups=0(root)\n\n# \u68c0\u67e5\u5bb9\u5668\u4e2d\u7684\u7f51\u7edc\u8fde\u63a5\nnsenter --target [PID] --net -- ss -lntup\n</code></pre>","tags":["k8s"]},{"location":"kubernetes/k8s-notebooks/kubectl/","title":"kubectl\u5e38\u7528\u547d\u4ee4","text":""},{"location":"kubernetes/k8s-notebooks/kubectl/#kubectl-applykubectl-createkubectl-replace","title":"kubectl apply\u53ef\u80fd\u4f1a\u8d85\u51fa\u8bf7\u6c42\u9650\u5236\u3002\u4f7f\u7528kubectl create\u6216kubectl replace","text":"<p>apply\u4f1a\u5c06\u5305\u542b\u7528\u4e8e\u521b\u5efa\u5bf9\u8c61\u7684\u5bf9\u8c61\u914d\u7f6e\u6587\u4ef6\u7684\u5185\u5bb9\u8bb0\u5f55\u5728<code>annotations</code>\u7684<code>kubectl.kubernetes.io/last-applied-configuration</code>\u4e2d</p> <pre><code>https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/#how-to-create-objects\nThis sets the kubectl.kubernetes.io/last-applied-configuration: '{...}' annotation on each object. \nThe annotation contains the contents of the object configuration file that was used to create the object.\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#kubectl_1","title":"\u914d\u7f6ekubectl\u547d\u4ee4\u884c\u8865\u5168","text":"<pre><code>source &lt;(kubectl completion bash)\necho \"source &lt;(kubectl completion bash)\" &gt;&gt; ~/.bashrc\n# windows\nPS C:\\Users\\Tracy&gt; helm completion powershell | Out-String | Invoke-Expression\nPS C:\\Users\\Tracy&gt; kubectl completion powershell | Out-String | Invoke-Expression\n\n# linux\nsource &lt;(helm completion bash)\nhelm completion bash &gt; /etc/bash_completion.d/helm\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#_1","title":"\u56de\u6eda\u5de5\u4f5c\u8d1f\u8f7d","text":"<pre><code># \u67e5\u770b\u4e00\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u7684history\uff0c\u4fdd\u7559\u6570\u91cf\u7531revisionHistoryLimit\u5b57\u6bb5\u51b3\u5b9a\uff0c\u9ed8\u8ba4\u662f10\nkubectl -n devel rollout history sts infoplus \n\n# describe version\nkubectl -n devel rollout history sts infoplus --revision 96\n\n# \u67e5\u770b\u6307\u5b9aversion\u7684yaml\nkubectl -n devel rollout history sts infoplus --revision 96 -o yaml\n\n# \u56de\u6eda\u5230\u4e0a\u4e2a\u7248\u672c\nkubectl -n devel rollout undo sts infoplus\n\n# \u56de\u6eda\u5230\u6307\u5b9a\u7248\u672c\nkubectl -n devel rollout undo sts infoplus --revision 96\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#secretkey","title":"\u6279\u91cf\u89e3\u5bc6secret\u7684\u6240\u6709key","text":"<pre><code>kubectl -o go-template='{{range $k,$v := .data}}{{printf \"%s: \" $k}}{{if not $v}}{{$v}}{{else}}{{$v | base64decode}}{{end}}{{\"\\n\"}}{{end}}' \\\nget secret -n default xxx\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#podnameimage","title":"\u83b7\u53d6podname\u548cimage","text":"<pre><code>kubectl -o custom-columns=NAME:.metadata.name,IMAGE:.spec.containers[*].image \\\n-n devel get pods\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#workloadimage","title":"\u83b7\u53d6workload\u548cimage","text":"<pre><code>kubectl -o custom-columns=TYPE:.kind,NAME:.metadata.name,IMAGE:.spec.template.spec.containers[*].image \\\nget deploy,sts -n ketanyun\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#apply","title":"apply\u76ee\u5f55","text":"<pre><code>kubectl apply -R -f ./directory\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#nodename","title":"\u83b7\u53d6nodeName\u5b57\u6bb5","text":"<pre><code>kubectl -o custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,NODENAME:.spec.template.spec.nodeName \\\nget deploy,sts -A\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#workloadresources","title":"\u83b7\u53d6workload\u7684resources","text":"<pre><code>kubectl -o custom-columns=NAME:.metadata.name,CPUREQ:.spec.template.spec.containers[0].resources.requests.cpu,CPULIMITS:.spec.template.spec.containers[0].resources.limits.cpu,MEMREQ:.spec.template.spec.containers[0].resources.requests.memory,MEMLIMITS:.spec.template.spec.containers[0].resources.limits.memory \n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#explain","title":"explain \u663e\u793a\u8d44\u6e90\u6240\u6709\u5b57\u6bb5","text":"<pre><code>kubectl explain deploy --recursive\n\nkubectl explain deploy.spec.replicas\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#kubectl-events","title":"kubectl events","text":"<p>\u662f<code>kubectl get events</code>\u7684\u589e\u5f3a\uff0cGA in v1.26.0</p> <pre><code>kubectl events -A\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#socks5","title":"\u4f7f\u7528socks5\u4ee3\u7406\u8bbf\u95ee\u96c6\u7fa4","text":""},{"location":"kubernetes/k8s-notebooks/kubectl/#kubectl-auth","title":"kubectl auth","text":"<pre><code>root@tracy:~# kubectl auth \nInspect authorization.\n\nAvailable Commands:\n  can-i         Check whether an action is allowed\n  reconcile     Reconciles rules for RBAC role, role binding, cluster role, and cluster role binding objects\n  whoami        Experimental: Check self subject attributes\n\nUsage:\n  kubectl auth [flags] [options]\n\nUse \"kubectl auth &lt;command&gt; --help\" for more information about a given command.\nUse \"kubectl options\" for a list of global command-line options (applies to all commands).\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#kubectl-debug","title":"kubectl debug","text":"<p>Kubernetes v1.25 [stable]</p> <p>\u96c6\u7fa4\u4f4e\u7248\u672c\u9700\u8981\u4fee\u6539kube-apiserver\u3001kube-scheduler\u3001kubelet\u542f\u52a8\u914d\u7f6e\u53c2\u6570\uff0c\u6dfb\u52a0--feature-gates=EphemeralContainers=true</p> <p>\u4e0d\u6ee1\u8db3\u8981\u6c42\u65f6\u53ef\u4ee5\u4f7f\u7528nsenter</p> <pre><code>kubectl debug $(kubectl get pod -l app=sleep -n ambient-demo -o jsonpath='{.items[0].metadata.name}') -it -n ambient-demo  --image nicolaka/netshoot  -- ss -ntlp\n\nkubectl debug $(kubectl get pod -l app=sleep -n ambient-demo -o jsonpath='{.items[0].metadata.name}') -it --image gcr.io/istio-release/base --profile=netadmin -n ambient-demo -- iptables-save\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/kubectl/#kubectl-logs","title":"kubectl logs","text":"<pre><code># \u67e5\u770bpod\u65e5\u5fd7\nkubectl logs ${POD_NAME}\n# \u67e5\u770bworkload\u65e5\u5fd7\nkubectl logs deploy/${DEPLOYMENT_NAME}\n# \u83b7\u53d6\u6709\u6307\u5b9alabels\u7684pods\u7684\u65e5\u5fd7\nkubectl logs -l ${LABELS}\n\n-f [mum] # tail\n-p  # \u83b7\u53d6pod\u7684\u524d\u4e00\u4e2a\u5bb9\u5668\u7684\u65e5\u5fd7\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/%E4%BF%AE%E6%94%B9%E5%AE%B9%E5%99%A8%E5%86%85%E6%97%B6%E5%8C%BA/","title":"\u914d\u7f6e\u5bb9\u5668\u5185\u65f6\u533a","text":"<pre><code># \u53d8\u91cf\u4f20\u9012TZ\n      containers:\n      - env:\n        - name: TZ\n          value: Asia/Shanghai\n---     \n# \u5c06\u5bbf\u4e3b\u673a\u7684/etc/localtime\u6302\u8f7d\u8fdb\u5bb9\u5668\n        volumeMounts:\n        - mountPath: /etc/localtime\n          name: localtime\n      volumes:\n      - hostPath:\n          path: /etc/localtime\n          type: \"\"\n        name: localtime\n---\n# \u5982\u679c\u6302\u8f7d/etc/localtime\u6ca1\u6709\u4f5c\u7528\uff1a\n        lifecycle:\n          postStart:\n            exec:\n              command:\n              - /bin/sh\n              - -c\n              - ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\n\n        volumeMounts:\n        - mountPath: /usr/share/zoneinfo/Asia/Shanghai\n          name: localtime\n      volumes:\n      - hostPath:\n          path: /usr/share/zoneinfo/Asia/Shanghai\n          type: \"\"\n        name: localtime\n</code></pre>"},{"location":"kubernetes/k8s-notebooks/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/","title":"\u95ee\u9898\u8bb0\u5f55","text":""},{"location":"kubernetes/k8s-notebooks/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/#podetcresolvconf","title":"pod\u7684/etc/resolv.conf\u6587\u4ef6\u914d\u7f6e\u4e0d\u6b63\u786e","text":"<p>\u96c6\u7fa4\u5b89\u88c5\u540e\uff0cpod\u65e0\u6cd5\u89e3\u6790\u96c6\u7fa4\u5185\u5730\u5740\uff0c\u767b\u5f55\u4efb\u610f\u5bb9\u5668\u67e5\u770b/etc/resolv.conf \uff0c\u663e\u793a\u5f62\u5982\uff1a <pre><code>[root@demo-59fc87bd89-lghrt html]# cat /etc/resolv.conf\nnameserver 192.168.74.2\nnameserver 223.5.5.5\nnameserver 8.8.8.8\nsearch localdomain\n</code></pre> \u6b63\u5e38\u7684\u5e94\u4e3a\uff1a <pre><code>nameserver 10.32.0.10\nsearch &lt;namespace&gt;.svc.cluster.local svc.cluster.local cluster.local\noptions ndots:5\n</code></pre></p> <p>\u95ee\u9898\u539f\u56e0\uff1akubelet\u672a\u6b63\u786e\u914d\u7f6eclusterDNS <pre><code># \u6b63\u786e\u914d\u7f6e\u53c2\u8003\napiVersion: kubelet.config.k8s.io/v1beta1\nauthentication:\n  anonymous:\n    enabled: false\n  webhook:\n    cacheTTL: 0s\n    enabled: true\n  x509:\n    clientCAFile: /etc/kubernetes/pki/ca.crt\nauthorization:\n  mode: Webhook\n  webhook:\n    cacheAuthorizedTTL: 0s\n    cacheUnauthorizedTTL: 0s\ncgroupDriver: systemd\n# \u914d\u7f6ekube-dns.kube-system.svc\u7684ip\nclusterDNS:\n- 172.19.0.10\nclusterDomain: cluster.local\ncpuManagerReconcilePeriod: 0s\nevictionPressureTransitionPeriod: 0s\nfileCheckFrequency: 0s\nhealthzBindAddress: 127.0.0.1\nhealthzPort: 10248\nhttpCheckFrequency: 0s\nimageMinimumGCAge: 0s\nkind: KubeletConfiguration\nlogging: {}\nmemorySwap: {}\nnodeStatusReportFrequency: 0s\nnodeStatusUpdateFrequency: 0s\n# \u5f53clusterDNS\u672a\u914d\u7f6e\uff0c\u5219\u9ed8\u8ba4\u4f7f\u7528\u8be5\u6587\u4ef6\u7684dns\u914d\u7f6e\nresolvConf: /run/systemd/resolve/resolv.conf\nrotateCertificates: true\nruntimeRequestTimeout: 0s\nshutdownGracePeriod: 0s\nshutdownGracePeriodCriticalPods: 0s\nstaticPodPath: /etc/kubernetes/manifests\nstreamingConnectionIdleTimeout: 0s\nsyncFrequency: 0s\nvolumeStatsAggPeriod: 0s\n</code></pre></p>"},{"location":"kubernetes/k8s-platform/docker/","title":"Note","text":""},{"location":"kubernetes/k8s-platform/docker/#daemonjson","title":"daemon.json","text":"<pre><code>{\n    \"debug\": false,\n    \"insecure-registries\": [\n      \"0.0.0.0/0\"\n    ],\n    \"ip-forward\": true,\n    \"ipv6\": false,\n    \"live-restore\": true,\n    \"log-driver\": \"json-file\",\n    \"log-level\": \"warn\",\n    \"log-opts\": {\n      \"max-size\": \"100m\",\n      \"max-file\": \"2\"\n    },\n    \"selinux-enabled\": false,\n    \"metrics-addr\" : \"0.0.0.0:9323\",\n    \"experimental\" : true,\n    \"storage-driver\": \"overlay2\"\n  }\n</code></pre>"},{"location":"kubernetes/k8s-platform/k8s-dashboard/","title":"Kubernetes \u4eea\u8868\u677f\uff08Dashboard\uff09","text":"<p>\u53c2\u8003\u6587\u6863: https://kubernetes.io/zh/docs/tasks/access-application-cluster/web-ui-dashboard/</p> <p>github: https://github.com/kubernetes/dashboard/</p>"},{"location":"kubernetes/k8s-platform/k8s-dashboard/#_1","title":"\u90e8\u7f72","text":"<p>version: 7.5.0</p> <p>kubeVersion: \"&gt;=1.21.0-0\"</p> <pre><code># \u6dfb\u52a0 kubernetes-dashboard \u4ed3\u5e93\nhelm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/\n# \u4f7f\u7528 kubernetes-dashboard Chart \u90e8\u7f72\u540d\u4e3a `kubernetes-dashboard` \u7684 Helm Release\nhelm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard \\\n--create-namespace --namespace kubernetes-dashboard \\\n--set app.ingress.enabled=true \\\n--set app.ingress.hosts[0]=k8s-dashboard.local.domain \\\n--set app.ingress.ingressClassName=nginx\n</code></pre>"},{"location":"kubernetes/k8s-platform/k8s-dashboard/#_2","title":"\u4f7f\u7528","text":"<ul> <li>Creating sample user</li> </ul> <pre><code>#dashboard\u521b\u5efa\u7528\u6237\uff0c\u751f\u6210token\nkubectl create sa admin-user -n kubernetes-dashboard\n\n#\u7ed9\u7528\u6237\u7ed1\u5b9a\u89d2\u8272\nkubectl create clusterrolebinding admin-user --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:admin-user\n\n#\u67e5\u770b\u7528\u6237\u7684token\uff1a\nkubectl -n kubernetes-dashboard create token admin-user\n</code></pre>"},{"location":"kubernetes/k8s-platform/kube-capacity/","title":"Kube capacity","text":"<pre><code>source &lt;(kube-capacity completion bash)\necho \"source &lt;(kube-capacity completion bash)\" &gt;&gt; ~/.bashrc\n</code></pre>"},{"location":"kubernetes/k8s-platform/kube-capacity/#kube-capacity","title":"kube-capacity","text":"<p>This is a simple CLI that provides an overview of the resource requests, limits, and utilization in a Kubernetes cluster. It attempts to combine the best parts of the output from <code>kubectl top</code> and <code>kubectl describe</code> into an easy to use CLI focused on cluster resources.</p>"},{"location":"kubernetes/k8s-platform/kube-capacity/#installation","title":"Installation","text":"<p>Go binaries are automatically built with each release by GoReleaser. These can be accessed on the GitHub releases page for this project.</p>"},{"location":"kubernetes/k8s-platform/kube-capacity/#homebrew","title":"Homebrew","text":"<p>This project can be installed with Homebrew: <pre><code>brew tap robscott/tap\nbrew install robscott/tap/kube-capacity\n</code></pre></p>"},{"location":"kubernetes/k8s-platform/kube-capacity/#krew","title":"Krew","text":"<p>This project can be installed with Krew: <pre><code>kubectl krew install resource-capacity\n</code></pre></p>"},{"location":"kubernetes/k8s-platform/kube-capacity/#usage","title":"Usage","text":"<p>By default, kube-capacity will output a list of nodes with the total CPU and Memory resource requests and limits for all the pods running on them. For clusters with more than one node, the first line will also include cluster wide totals. That output will look something like this:</p> <pre><code>kube-capacity\n\nNODE              CPU REQUESTS    CPU LIMITS    MEMORY REQUESTS    MEMORY LIMITS\n*                 560m (28%)      130m (7%)     572Mi (9%)         770Mi (13%)\nexample-node-1    220m (22%)      10m (1%)      192Mi (6%)         360Mi (12%)\nexample-node-2    340m (34%)      120m (12%)    380Mi (13%)        410Mi (14%)\n</code></pre>"},{"location":"kubernetes/k8s-platform/kube-capacity/#including-pods","title":"Including Pods","text":"<p>For more detailed output, kube-capacity can include pods in the output. When <code>-p</code> or <code>--pods</code> are passed to kube-capacity, it will include pod specific output that looks like this:</p> <pre><code>kube-capacity --pods\n\nNODE              NAMESPACE     POD                   CPU REQUESTS    CPU LIMITS    MEMORY REQUESTS    MEMORY LIMITS\n*                 *             *                     560m (28%)      780m (38%)    572Mi (9%)         770Mi (13%)\n\nexample-node-1    *             *                     220m (22%)      320m (32%)    192Mi (6%)         360Mi (12%)\nexample-node-1    kube-system   metrics-server-lwc6z  100m (10%)      200m (20%)    100Mi (3%)         200Mi (7%)\nexample-node-1    kube-system   coredns-7b5bcb98f8    120m (12%)      120m (12%)    92Mi (3%)          160Mi (5%)\n\nexample-node-2    *             *                     340m (34%)      460m (46%)    380Mi (13%)        410Mi (14%)\nexample-node-2    kube-system   kube-proxy-3ki7       200m (20%)      280m (28%)    210Mi (7%)         210Mi (7%)\nexample-node-2    tiller        tiller-deploy         140m (14%)      180m (18%)    170Mi (5%)         200Mi (7%)\n</code></pre>"},{"location":"kubernetes/k8s-platform/kube-capacity/#including-utilization","title":"Including Utilization","text":"<p>To help understand how resource utilization compares to configured requests and limits, kube-capacity can include utilization metrics in the output. It's important to note that this output relies on metrics-server functioning correctly in your cluster. When <code>-u</code> or <code>--util</code> are passed to kube-capacity, it will include resource utilization information that looks like this:</p> <pre><code>kube-capacity --util\n\nNODE              CPU REQUESTS    CPU LIMITS    CPU UTIL    MEMORY REQUESTS    MEMORY LIMITS   MEMORY UTIL\n*                 560m (28%)      130m (7%)     40m (2%)    572Mi (9%)         770Mi (13%)     470Mi (8%)\nexample-node-1    220m (22%)      10m (1%)      10m (1%)    192Mi (6%)         360Mi (12%)     210Mi (7%)\nexample-node-2    340m (34%)      120m (12%)    30m (3%)    380Mi (13%)        410Mi (14%)     260Mi (9%)\n</code></pre>"},{"location":"kubernetes/k8s-platform/kube-capacity/#displaying-available-resources","title":"Displaying Available Resources","text":"<p>To more clearly see the total available resources on the node it is possible to pass the <code>--available</code> option to kube-capacity, which will give output in the following format</p> <pre><code>kube-capacity --available\n\nNODE              CPU REQUESTS    CPU LIMITS    MEMORY REQUESTS    MEMORY LIMITS\n*                 560/2000m       130/2000m     572/5923Mi         770/5923Mi \nexample-node-1    220/1000m       10/1000m      192/3200Mi         360/3200Mi \nexample-node-2    340/1000m       120/1000m     380/2923Mi         410/2923Mi\n</code></pre>"},{"location":"kubernetes/k8s-platform/kube-capacity/#including-pods-and-utilization","title":"Including Pods and Utilization","text":"<p>For more detailed output, kube-capacity can include both pods and resource utilization in the output. When <code>--util</code> and <code>--pods</code> are passed to kube-capacity, it will result in a wide output that looks like this:</p> <pre><code>kube-capacity --pods --util\n\nNODE              NAMESPACE     POD                   CPU REQUESTS    CPU LIMITS   CPU UTIL     MEMORY REQUESTS    MEMORY LIMITS   MEMORY UTIL\n*                 *             *                     560m (28%)      780m (38%)   340m (17%)   572Mi (9%)         770Mi (13%)     470Mi (8%)\n\nexample-node-1    *             *                     220m (22%)      320m (32%)   160m (16%)   192Mi (6%)         360Mi (12%)     210Mi (7%)\nexample-node-1    kube-system   metrics-server-lwc6z  100m (10%)      200m (20%)   70m (7%)     100Mi (3%)         200Mi (7%)      120Mi (4%)\nexample-node-1    kube-system   coredns-7b5bcb98f8    120m (12%)      120m (12%)   90m (9%)     92Mi (3%)          160Mi (5%)      90Mi (3%)\n\nexample-node-2    *             *                     340m (34%)      460m (46%)   180m (18%)   380Mi (13%)        410Mi (14%)     260Mi (9%)\nexample-node-2    kube-system   kube-proxy-3ki7       200m (20%)      280m (28%)   110m (11%)   210Mi (7%)         210Mi (7%)      120Mi (4%)\nexample-node-2    tiller        tiller-deploy         140m (14%)      180m (18%)   70m (7%)     170Mi (6%)         200Mi (7%)      140Mi (5%)\n</code></pre> <p>It's worth noting that utilization numbers from pods will likely not add up to the total node utilization numbers. Unlike request and limit numbers where node and cluster level numbers represent a sum of pod values, node metrics come directly from metrics-server and will likely include other forms of resource utilization.</p>"},{"location":"kubernetes/k8s-platform/kube-capacity/#sorting","title":"Sorting","text":"<p>To highlight the nodes, pods, and containers with the highest metrics, you can sort by a variety of columns:</p> <pre><code>kube-capacity --util --sort cpu.util\n\nNODE              CPU REQUESTS    CPU LIMITS    CPU UTIL    MEMORY REQUESTS    MEMORY LIMITS   MEMORY UTIL\n*                 560m (28%)      130m (7%)     40m (2%)    572Mi (9%)         770Mi (13%)     470Mi (8%)\nexample-node-2    340m (34%)      120m (12%)    30m (3%)    380Mi (13%)        410Mi (14%)     260Mi (9%)\nexample-node-1    220m (22%)      10m (1%)      10m (1%)    192Mi (6%)         360Mi (12%)     210Mi (7%)\n</code></pre>"},{"location":"kubernetes/k8s-platform/kube-capacity/#displaying-pod-count","title":"Displaying Pod Count","text":"<p>To display the pod count of each node and the whole cluster, you can pass --pod-count argument: <pre><code>$ kube-capacity --pod-count\n\nNODE           CPU REQUESTS   CPU LIMITS   MEMORY REQUESTS   MEMORY LIMITS   POD COUNT\n*              950m (2%)      200m (0%)    284Mi (0%)        284Mi (0%)      10/220\nminikube       850m (5%)      100m (0%)    231Mi (1%)        231Mi (1%)      8/110\nminikube-m02   100m (0%)      100m (0%)    53Mi (0%)         53Mi (0%)       2/110\n</code></pre></p>"},{"location":"kubernetes/k8s-platform/kube-capacity/#filtering-by-labels","title":"Filtering By Labels","text":"<p>For more advanced usage, kube-capacity also supports filtering by pod, namespace, and/or node labels. The following examples show how to use these filters:</p> <pre><code>kube-capacity --pod-labels app=nginx\nkube-capacity --namespace default\nkube-capacity --namespace-labels team=api\nkube-capacity --node-labels kubernetes.io/role=node\n</code></pre>"},{"location":"kubernetes/k8s-platform/kube-capacity/#json-and-yaml-output","title":"JSON and YAML Output","text":"<p>By default, kube-capacity will provide output in a table format. To view this data in JSON or YAML format, the output flag can be used. Here are some sample commands: <pre><code>kube-capacity --pods --output json\nkube-capacity --pods --containers --util --output yaml\n</code></pre></p>"},{"location":"kubernetes/k8s-platform/kube-capacity/#flags-supported","title":"Flags Supported","text":"<pre><code>  -c, --containers                includes containers in output\n      --context string            context to use for Kubernetes config\n  -h, --help                      help for kube-capacity\n  -n, --namespace string          only include pods from this namespace\n      --namespace-labels string   labels to filter namespaces with\n      --node-labels string        labels to filter nodes with\n  -o, --output string             output format for information\n                                    (supports: [table json yaml])\n                                    (default \"table\")\n  -a, --available                 includes quantity available instead of percentage used\n  -l, --pod-labels string         labels to filter pods with\n  -p, --pods                      includes pods in output\n      --sort string               attribute to sort results be (supports:\n                                    [cpu.util cpu.request cpu.limit mem.util mem.request mem.limit name])\n                                    (default \"name\")\n  -u, --util                      includes resource utilization in output\n      --pod-count                 includes pod counts for each of the nodes and the whole cluster\n</code></pre>"},{"location":"kubernetes/k8s-platform/kube-capacity/#prerequisites","title":"Prerequisites","text":"<p>Any commands requesting cluster utilization are dependent on metrics-server running on your cluster. If it's not already installed, you can install it with the official helm chart.</p>"},{"location":"kubernetes/k8s-platform/kube-capacity/#similar-projects","title":"Similar Projects","text":"<p>There are already some great projects out there that have similar goals.</p> <ul> <li>kube-resource-report: generates HTML/CSS report for resource requests and limits across multiple clusters.</li> <li>kubetop: a CLI similar to top for Kubernetes, focused on resource utilization (not requests and limits).</li> </ul>"},{"location":"kubernetes/k8s-platform/kube-capacity/#contributors","title":"Contributors","text":"<p>Although this project was originally developed by robscott, there have been some great contributions from others:</p> <ul> <li>endzyme</li> <li>justinbarrick</li> <li>Padarn</li> <li>nickatsegment</li> </ul>"},{"location":"kubernetes/k8s-platform/kube-capacity/#license","title":"License","text":"<p>Apache License 2.0</p>"},{"location":"kubernetes/k8s-platform/local-static-provisioner/","title":"Local static provisioner","text":"<p>examples\uff1ahttps://github.com/kubernetes-sigs/sig-storage-local-static-provisioner/tree/master/examples</p> <p>\u7f51\u7edc\u6587\u6863\uff1ahttps://blog.csdn.net/weixin_41831919/article/details/118058876</p>"},{"location":"kubernetes/k8s-platform/metalLB/","title":"metalLB","text":""},{"location":"kubernetes/k8s-platform/metalLB/#k8slb","title":"k8s\u88f8\u673aLB\u670d\u52a1","text":"<pre><code>\u53ef\u9009L2\u6a21\u5f0f\u548cBGP\u6a21\u5f0f\uff0cL2\u6700\u7b80\u5355\uff0c\u517c\u5bb9\u6027\u597d\uff0c\u53ef\u4ee5\u5728\u51e0\u4e4e\u6240\u6709\u7f51\u7edc\u4e0a\u5de5\u4f5c\uff0c\u4f46\u539f\u7406\u662f\u7c7b\u4f3ckeepalived\uff0c\u62e5\u6709IP\u7684\u8282\u70b9\u5c06\u6210\u4e3a\u74f6\u9888\u5e76\u9650\u5236\u6027\u80fd\uff1b\n\u5176\u6b21\uff0c\u5728\u8282\u70b9\u6d88\u5931\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u6545\u969c\u8f6c\u79fb\u7684\u65f6\u95f4\u53ef\u80fd\u4f1a\u5f88\u6162\uff1b\n\u7b2c\u4e09\uff0c\u5730\u5740\u5206\u914d\u7a7a\u95f4\u5fc5\u987b\u662f\u96c6\u7fa4\u8282\u70b9\u7f51\u7edc\u7684\u4e00\u90e8\u5206\u3002\nBGP\u76f8\u8f83L2\u6027\u80fd\u66f4\u597d\uff0c\u9700\u8981\u914d\u7f6eBGP\u8def\u7531\u5668\u7684IP\u5730\u5740\u548cASN\u4fe1\u606f\u6765\u548c\u8def\u7531\u5668\u8fdb\u884cBGP\u5bf9\u7b49\u8fde\u63a5\uff0c\u8fd9\u5728\u865a\u62df\u7f51\u7edc\u4e2d\u53ef\u80fd\u65e0\u6cd5\u914d\u7f6e\uff08\u5f85\u786e\u8ba4\uff09\u3002\n</code></pre>"},{"location":"kubernetes/k8s-platform/metalLB/#install","title":"install","text":"<pre><code>helm repo add metallb https://metallb.github.io/metallb\nhelm install metallb metallb/metallb -n metallb-system --create-namespace\n</code></pre>"},{"location":"kubernetes/k8s-platform/metalLB/#configuration","title":"configuration","text":""},{"location":"kubernetes/k8s-platform/metalLB/#1-l2","title":"1. L2","text":"<p>\u521b\u5efa\u5730\u5740\u6c60\uff1a <pre><code>apiVersion: metallb.io/v1beta1\nkind: IPAddressPool\nmetadata:\n  name: first-pool\n  namespace: metallb-system\nspec:\n  addresses:\n#  - 192.168.10.0/24\n  - 192.168.17.200-192.168.17.210\n#  - fc00:f853:0ccd:e799::/124\n</code></pre></p> <p>\u521b\u5efaL2Advertisement\uff1a <pre><code>apiVersion: metallb.io/v1beta1\nkind: L2Advertisement\nmetadata:\n  name: example\n  namespace: metallb-system\nspec:\n  ipAddressPools:\n  - first-pool\n</code></pre></p>"},{"location":"kubernetes/k8s-platform/metalLB/#2-bgp","title":"2. BGP","text":"<p>\u521b\u5efaBGP\u5bf9\u7b49\u8fde\u63a5 <pre><code>apiVersion: metallb.io/v1beta2\nkind: BGPPeer\nmetadata:\n  name: sample\n  namespace: metallb-system\nspec:\n  myASN: 64500\n  peerASN: 64501\n  peerAddress: 192.168.17.2\n</code></pre></p> <p>\u68c0\u67e5BGP\u5bf9\u7b49\u8fde\u63a5\u72b6\u6001 <pre><code># \u5982\u679c\u8fde\u63a5\u5931\u8d25\uff0c\u5219\u5728metallb-speaker\u65e5\u5fd7\u4e2d\u770b\u5230\u7c7b\u4f3c\u4ee5\u4e0b\u5185\u5bb9\uff08179\u4e3aBGP\u8def\u7531\u5668\u5bf9\u7b49\u8fde\u63a5\u7aef\u53e3\uff09\n{\"caller\":\"native.go:90\",\"error\":\"dial \\\"192.168.17.2:179\\\": getsockopt: connection refused\",\"level\":\"error\",\"localASN\":64500,\"msg\":\"failed to connect to peer\",\"op\":\"connect\",\"peer\":\"192.168.17.2:179\",\"peerASN\":64501,\"ts\":\"2023-03-04T09:45:56Z\"}\n</code></pre></p> <p>\u521b\u5efa\u5730\u5740\u6c60\uff1a <pre><code>apiVersion: metallb.io/v1beta1\nkind: IPAddressPool\nmetadata:\n  name: first-pool\n  namespace: metallb-system\nspec:\n  addresses:\n#  - 192.168.10.0/24\n  - 192.168.17.200-192.168.17.210\n#  - fc00:f853:0ccd:e799::/124\n</code></pre></p> <p>\u521b\u5efaBGPAdvertisement\uff1a <pre><code>apiVersion: metallb.io/v1beta1\nkind: BGPAdvertisement\nmetadata:\n  name: example\n  namespace: metallb-system\nspec:\n  ipAddressPools:\n  - first-pool\n</code></pre></p>"},{"location":"kubernetes/k8s-platform/metalLB/#_1","title":"\u5b9e\u9645\u5e94\u7528","text":"<ul> <li>\u642d\u914dingress-nginx</li> </ul> <pre><code>apiVersion: metallb.io/v1beta1\nkind: IPAddressPool\nmetadata:\n  name: ippool-ingress-nginx\n  namespace: metallb-system\nspec:\n  addresses:\n    - 192.168.17.199/32\n  avoidBuggyIPs: true\n  serviceAllocation:\n    priority: 50\n    namespaces:\n      - ingress-nginx\n#    namespaceSelectors:\n#      - matchLabels:\n#          foo: bar\n    serviceSelectors:\n      - matchExpressions:\n          - key: app.kubernetes.io/instance \n            operator: In\n            values: \n              - nginx-ingress-controller\n\n--- \napiVersion: metallb.io/v1beta1\nkind: L2Advertisement\nmetadata:\n  name: l2-ingress-nginx\n  namespace: metallb-system\nspec:\n  ipAddressPools:\n  - ippool-ingress-nginx\n</code></pre> <pre><code># \u521b\u5efa\u4e0a\u9762\u7684metal\u914d\u7f6e\nkubectl create -f -\n\n# \u5b89\u88c5ingress-nginx\nhelm upgrade --install nginx-ingress-controller bitnami/nginx-ingress-controller --version=9.3.24 -f values.yaml \\\n-n ingress-nginx --create-namespace \\\n--set ingressClassResource.default=true \\\n--set defaultBackend.enabled=false\n\n# EXTERNAL-IP\u53ef\u770b\u5230\u5206\u914d\u7684IP\nroot@k8s-master1:~/operations/k8s/kube-system/ingress-nginx-controller/bitnami-nginx-ingress-controller-9.3.24# kubectl get svc -A\nNAMESPACE        NAME                                       TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                         AGE\ndefault          kubernetes                                 ClusterIP      10.96.0.1       &lt;none&gt;           443/TCP                         83m\ningress-nginx    nginx-ingress-controller                   LoadBalancer   10.96.18.243    192.168.17.199   80:30015/TCP,443:30893/TCP      4s\n\n# \u6d4b\u8bd5\u8bbf\u95ee\n</code></pre>"},{"location":"kubernetes/k8s-platform/neuvector/","title":"neuvector","text":""},{"location":"kubernetes/k8s-platform/neuvector/#charts","title":"charts","text":"<pre><code>helm repo add neuvector https://neuvector.github.io/neuvector-helm/\n\nhelm search repo neuvector/core\nNAME            CHART VERSION   APP VERSION     DESCRIPTION                             \nneuvector/core  2.4.2           5.1.1           Helm chart for NeuVector's core services\n</code></pre> <pre><code>helm upgrade --install neuvector -n neuvector neuvector/core --create-namespace \\\n--set controller.replicas=1 \\\n--set cve.scanner.replicas=1 \\\n--set manager.ingress.enabled=true \\\n--set manager.ingress.host='manage-neuvector.local.domain' \n\n\n# \u6570\u636e\u6301\u4e45\u5316\n--set controller.pvc.enabled=true \\\n--set controller.pvc.storageClass='standard' \\\n--set controller.pvc.capacity='1Gi' \\\n\n\n# \u81ea\u5b9a\u4e49NeuVector configuration\n--set controller.configmap.enabled=true \\\n--set controller.configmap.data={} \\\n\n\n# 0\u4e3a\u7981\u7528\uff0c\u5efa\u8bae\u8bbe\u7f6e2\n--set controller.disruptionbudget=2 \\\n\n\n# \u63a7\u5236\u5668 REST API \u670d\u52a1\u7c7b\u578b\n--set controller.apisvc.type='ClusterIP' \\\n--set controller.ingress.enabled=true \\\n--set controller.ingress.host='neuvector.local.domain' \\\n# \u591a\u96c6\u7fa4\u6258\u7ba1\u96c6\u7fa4\u670d\u52a1\u7c7b\u578b\n--set controller.federation.managedsvc.type='ClusterIP' \\\n--set controller.federation.managedsvc.ingress.enabled=true \\\n--set controller.federation.managedsvc.ingress.host='manage-federation.local.domain' \\\n# \u591a\u96c6\u7fa4\u4e3b\u96c6\u7fa4\u670d\u52a1\u7c7b\u578b\n--set controller.federation.mastersvc.type='ClusterIP' \\\n--set controller.federation.mastersvc.ingress.enabled=true \\\n--set controller.federation.mastersvc.ingress.host='master-federation.local.domain' \\\n</code></pre>"},{"location":"kubernetes/k8s-platform/nfs-client-provisioner/","title":"Nfs client provisioner","text":""},{"location":"kubernetes/k8s-platform/nfs-client-provisioner/#1-nfs","title":"1. \u5b89\u88c5nfs\u670d\u52a1\u7aef\uff08\u5728\u5b58\u50a8\u670d\u52a1\u5668\u6267\u884c\uff09","text":"<pre><code>#\u5b58\u50a8\u670d\u52a1\u5668\u5b89\u88c5nfs\u670d\u52a1\nyum -y install nfs-utils\napt-get install nfs-kernel-server\n\n#\u5728\u5b58\u50a8\u670d\u52a1\u5668\u4e2d\uff0c\u521b\u5efa\u6302\u8f7d\u76ee\u5f55\nmkdir -p /data/nfs_data\n\n#\u7f16\u8f91nfs\u914d\u7f6e\u6587\u4ef6\uff0c\u6307\u5b9a\u7684\u76ee\u5f55\u5141\u8bb8\u6307\u5b9a\u7684\u6765\u6e90IP\u6216\u8005\u7f51\u6bb5\u8bbf\u95ee\nvim /etc/exports\n/data/nfs_data 192.168.1.0/24(rw,async,no_root_squash)\n\n#\u91cd\u542fnfs\nsystemctl stop nfs-server\nsystemctl stop rpcbind\nsystemctl start rpcbind\nsystemctl start nfs-server\nsystemctl enable nfs-server\nsystemctl enable rpcbind\n\n#\u67e5\u770b\u662f\u5426\u6b63\u786e\u914d\u7f6e\u670d\u52a1\nexportfs -arv &amp;&amp; showmount -e \n</code></pre>"},{"location":"kubernetes/k8s-platform/nfs-client-provisioner/#2-nfsk8shelm","title":"2. \u90e8\u7f72nfs\u5b58\u50a8\u7c7b\uff08\u5728k8s\u63a7\u5236\u7aef\u6267\u884c\uff0c\u9700\u8981\u5148\u5b89\u88c5helm\uff09","text":"<pre><code># https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/tree/master/charts/nfs-subdir-external-provisioner\nhelm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/\nhelm repo update\nhelm install nfs-client nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \\\n-n nfs-client-provisioner --create-namespace \\\n--set image.repository=willdockerhub/nfs-subdir-external-provisioner \\\n--set image.tag=v4.0.2 \\\n--set nfs.server=192.168.0.205 \\\n--set nfs.path=/data/nfs_data \\\n--set storageClass.name=nfs-client \\\n--set storageClass.defaultClass=true \n\n\n\n#helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts\n</code></pre>"},{"location":"kubernetes/k8s-platform/nfs-client-provisioner/#3","title":"3. \u5176\u4ed6","text":"<ul> <li> <p>\u8bbe\u7f6e\u4e3a\u9ed8\u8ba4\u5b58\u50a8\u7c7b <pre><code>kubectl patch storageclass nfs-client -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}'\n</code></pre></p> </li> <li> <p>\u5982\u679c\u6709\u9632\u706b\u5899\uff0c\u5219\u9700\u8981\u653e\u901a111 2049 \u548c\u53e6\u5916\u4e09\u4e2a\u670d\u52a1\u7684\u7aef\u53e3\uff0c\u8fd9\u4e09\u4e2a\u670d\u52a1\u7aef\u53e3\u968f\u673a\uff0c\u9700\u8981\u914d\u7f6e\u56fa\u5b9ahttps://blog.csdn.net/weixin_39840153/article/details/116624759</p> </li> </ul>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/old/","title":"old","text":""},{"location":"kubernetes/k8s-platform/ROOK-ceph/old/#rook","title":"rook\u5b89\u88c5\u6d4b\u8bd5","text":"<ul> <li>\u5b98\u65b9\u5b89\u88c5\u624b\u518c</li> <li>\u4ee3\u7801\u5730\u5740</li> <li>\u64cd\u4f5c\u53c2\u8003</li> <li>\u91cd\u7f6e\u73af\u5883</li> <li>\u5e38\u89c1\u95ee\u9898</li> </ul>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/old/#minimum-version","title":"Minimum Version","text":"<p>Kubernetes v1.17 or higher is supported by Rook.</p>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/old/#prerequisites","title":"Prerequisites","text":"<p>To make sure you have a Kubernetes cluster that is ready for Rook, you can follow these instructions.</p> <p>In order to configure the Ceph storage cluster, at least one of these local storage options are required:</p> <p>Raw devices (no partitions or formatted filesystems) This requires lvm2 to be installed on the host. To avoid this dependency, you can create a single full-disk partition on the disk (see below) Raw partitions (no formatted filesystem) Persistent Volumes available from a storage class in block mode</p>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/old/#_1","title":"\u5b89\u88c5","text":"<pre><code># \u62c9\u53d6\u4ee3\u7801\ngit clone --single-branch --branch v1.9.13 https://github.com/rook/rook.git\n# \u5b89\u88c5operator\ncd rook/deploy/examples\nkubectl create -f crds.yaml -f common.yaml -f operator.yaml\n# \u9700\u8981\u7b49\u5f85operator\u8fd0\u884c\nkubectl get pod -n rook-ceph\n\n#\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5b98\u65b9\u7684\u90e8\u7f72\u955c\u50cf\u9ed8\u8ba4\u90fd\u662f\u4ecek8s.gcr.io\u6216\u8005quay.io\u62c9\u53d6\uff0c\u8fd9\u91cc\u5efa\u8bae\u4fee\u6539\u4e0boperator.yaml\u7684\u955c\u50cf\u540d\u79f0\uff0c\u4ecedockerhub\u62c9\u53d6\uff0coperator.yaml\u7684\u955c\u50cf\u5b57\u6bb5\u914d\u7f6e\u9ed8\u8ba4\u90fd\u662f\u6ce8\u91ca\u7684\uff0c\u9700\u8981\u4fee\u6539yaml\u6587\u4ef6\u53bb\u6389\u6ce8\u91ca\uff0c\u7136\u540e\u914d\u7f6e\u4e0bdockerhub\u4e0a\u7684\u955c\u50cf\uff0c\u4fee\u6539\u540e\u5982\u4e0b\u3002\n[root@VM-0-4-centos examples]# cat operator.yaml | grep -i image:\n  ROOK_CSI_CEPH_IMAGE: \"cnplat/cephcsi:v3.5.1\"\n  ROOK_CSI_REGISTRAR_IMAGE: \"opsdockerimage/sig-storage-csi-node-driver-registrar:v2.5.0\"\n  ROOK_CSI_RESIZER_IMAGE: \"opsdockerimage/sig-storage-csi-resizer:v1.4.0\"\n  ROOK_CSI_PROVISIONER_IMAGE: \"opsdockerimage/sig-storage-csi-provisioner:v3.1.0\"\n  ROOK_CSI_SNAPSHOTTER_IMAGE: \"opsdockerimage/sig-storage-csi-snapshotter:v5.0.1\"\n  ROOK_CSI_ATTACHER_IMAGE: \"opsdockerimage/sig-storage-csi-attacher:v3.4.0\"\n  # ROOK_CSI_NFS_IMAGE: \"k8s.gcr.io/sig-storage/nfsplugin:v3.1.0\"\n  # CSI_VOLUME_REPLICATION_IMAGE: \"quay.io/csiaddons/volumereplication-operator:v0.3.0\"\n  ROOK_CSIADDONS_IMAGE: \"willdockerhub/k8s-sidecar:v0.2.1\"\n          image: rook/ceph:v1.9.2\n\n\n\nvim cluster.yaml\n    spec:\n      dashboard:\n        urlPrefix: /ceph-dashboard\n        port: 80\n        ssl: false\n\n# \u521b\u5efaceph\u96c6\u7fa4\nkubectl create -f cluster.yaml\n\nkubectl get po -n rook-ceph \n\n    NAME                                                    READY   STATUS      RESTARTS   AGE\n    csi-cephfsplugin-db874                                  2/2     Running     0          44m\n    csi-cephfsplugin-gx494                                  2/2     Running     0          44m\n    csi-cephfsplugin-j4crv                                  2/2     Running     0          44m\n    csi-cephfsplugin-provisioner-69db968597-7gd9z           5/5     Running     0          44m\n    csi-cephfsplugin-provisioner-69db968597-wmd2j           5/5     Running     0          44m\n    csi-rbdplugin-2678w                                     2/2     Running     0          44m\n    csi-rbdplugin-88zp6                                     2/2     Running     0          44m\n    csi-rbdplugin-pd6ph                                     2/2     Running     0          44m\n    csi-rbdplugin-provisioner-8f4c9744d-gxfdx               5/5     Running     0          44m\n    csi-rbdplugin-provisioner-8f4c9744d-zfl4d               5/5     Running     0          44m\n    rook-ceph-crashcollector-k8s-master1-6475bddb6c-br8mp   1/1     Running     0          29m\n    rook-ceph-crashcollector-k8s-node1-685449647f-xx6nt     1/1     Running     0          40m\n    rook-ceph-crashcollector-k8s-node2-8ddf7c7bd-22ktp      1/1     Running     0          29m\n    rook-ceph-mds-myfs-a-76ff75746d-cdh84                   1/1     Running     0          29m\n    rook-ceph-mds-myfs-b-f57ccb9b8-mrpt7                    1/1     Running     0          29m\n    rook-ceph-mgr-a-844b5c6785-shpbw                        2/2     Running     0          42m\n    rook-ceph-mgr-b-7cf45b98f9-2mphj                        2/2     Running     0          42m\n    rook-ceph-mon-a-ff6f44777-dnsr2                         1/1     Running     0          44m\n    rook-ceph-mon-b-6986d5c8d-lqnbt                         1/1     Running     0          43m\n    rook-ceph-mon-c-554b78677f-7lccm                        1/1     Running     0          43m\n    rook-ceph-operator-b45b4db68-bs69t                      1/1     Running     0          74m\n    rook-ceph-osd-0-7d85c984fb-knkrx                        1/1     Running     0          40m\n    rook-ceph-osd-1-864757ff78-ckx75                        1/1     Running     0          40m\n    rook-ceph-osd-2-6f76c78ff5-6hwl8                        1/1     Running     0          40m\n    rook-ceph-osd-prepare-k8s-master1-4fsjd                 0/1     Completed   0          40m\n    rook-ceph-osd-prepare-k8s-node1-f6sct                   0/1     Completed   0          40m\n    rook-ceph-osd-prepare-k8s-node2-pwmp9                   0/1     Completed   0          40m\n    rook-ceph-tools-697bd5f4f7-2zlgz                        1/1     Running     0          39m\n\n\n# \u5b89\u88c5ceph-tools\u7684\u5ba2\u6237\u7aef\u5de5\u5177\nkubectl create -f deploy/examples/toolbox.yaml\nkubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- bash\n\nceph status\n\n     cluster:\n       id:     a0452c76-30d9-4c1a-a948-5d8405f19a7c\n       health: HEALTH_OK\n\n     services:\n       mon: 3 daemons, quorum a,b,c (age 3m)\n       mgr: a(active, since 2m)\n       osd: 3 osds: 3 up (since 1m), 3 in (since 1m)\n    ...\n</code></pre> <ul> <li>\u521b\u5efaingress\uff0c\u4ee5\u4fbf\u4f7f\u7528\u57df\u540d\u8bbf\u95eedashboard</li> </ul> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: ceph-ingress\n  namespace: rook-ceph\nspec:\n  ingressClassName: nginx\n  rules:\n  - host: ceph.local.domain\n    http:\n      paths:\n      - backend:\n          service:\n            name: rook-ceph-mgr-dashboard\n            port:\n              number: 80\n        path: /\n        pathType: ImplementationSpecific  \n</code></pre> <ul> <li>\u83b7\u53d6\u7ba1\u7406\u5458\u5bc6\u7801 <pre><code>kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath=\"{['data']['password']}\" | base64 --decode &amp;&amp; echo\n</code></pre></li> </ul>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/old/#cephfilesystem","title":"cephFileSystem\u6d4b\u8bd5","text":"<pre><code># \u521b\u5efaCephFilesystem\nkubectl apply -f examples/filesystem.yaml\n\n# \u67e5\u770b\nkubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- bash\nceph fs ls\nname: myfs, metadata pool: myfs-metadata, data pools: [myfs-replicated ]\n\n# \u521b\u5efasc\nkubectl apply -f deploy/examples/csi/cephfs/storageclass.yaml\n\n# \u521b\u5efapvc\u6d4b\u8bd5\uff0c\u663e\u793abound\uff0c\u5219\u8bf4\u660e\u521b\u5efa\u6210\u529f\nkubectl apply -f deploy/examples/csi/cephfs/pvc.yam\n</code></pre>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/old/#rbd","title":"rbd\u6d4b\u8bd5","text":"<pre><code># \u521b\u5efa\u4e00\u4e2arbdsc\uff0c\u540c\u65f6\u4e5f\u4f1a\u521b\u5efa\u4e00\u4e2arbd\u7684pool\nkubectl create -f deploy/examples/csi/rbd/storageclass.yaml\n\n# \u521b\u5efapvc\u6d4b\u8bd5\uff0c\u663e\u793abound\uff0c\u5219\u8bf4\u660e\u521b\u5efa\u6210\u529f\nkubectl create -f deploy/examples/csi/rbd/pvc.yaml\n</code></pre>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/old/#_2","title":"\u4f7f\u7528\u6d4b\u8bd5","text":"<pre><code>kubectl create -f deploy/examples/mysql.yaml\nkubectl create -f deploy/examples/wordpress.yaml\n\n\n# charts\u6d4b\u8bd5\nhelm upgrade --install demo . \\\n--set persistence.enabled='true' \\\n--set persistence.storageClass='rook-ceph-block' \\\n--set persistence.mountPath='/var/log/nginx' \\\n--set persistence.size='1Gi' \\\n--set persistence.accessModes[0]='ReadWriteOnce'\n</code></pre>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/readme/","title":"ROOK","text":"<p>v1.14</p>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/readme/#_1","title":"\u5b89\u88c5","text":""},{"location":"kubernetes/k8s-platform/ROOK-ceph/readme/#ceph-operator","title":"Ceph Operator","text":""},{"location":"kubernetes/k8s-platform/ROOK-ceph/readme/#prerequisites","title":"Prerequisites","text":"<ul> <li>Kubernetes 1.22+</li> <li>Helm 3.x</li> </ul>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/readme/#install","title":"Install","text":"<ul> <li>v1.14-origin-values.yaml</li> </ul> <pre><code>helm repo add rook-release https://charts.rook.io/release\nhelm install rook-ceph rook-release/rook-ceph -f values.yaml \\\n--create-namespace --namespace rook-ceph \n</code></pre>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/readme/#ceph-cluster","title":"Ceph Cluster","text":"<p>\u4f7f\u7528<code>helm chart</code>\u5b89\u88c5\u96c6\u7fa4\uff0c\u6216\u8005\u53c2\u8003<code>manifests</code>\u4e2d\u7684\u6e05\u5355\u624b\u5de5\u914d\u7f6e</p>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/readme/#ceph-cluster-chart","title":"Ceph Cluster Chart","text":"<p>TODO</p>"},{"location":"kubernetes/k8s-platform/ROOK-ceph/readme/#ceph-cluster-manifests","title":"Ceph Cluster manifests","text":"<p>\u6240\u6709\u793a\u4f8b\u6e05\u5355example-manifests</p> <p>\u5982\u4e0b\u4e3a\u6d4b\u8bd5\u7528\u4f8b</p> <ul> <li>\u521b\u5efaceph\u96c6\u7fa4cluster-test.yaml</li> </ul> <pre><code>kubectl create -f cluster-test.yaml\n</code></pre> <ul> <li> <p>\u5757\u5b58\u50a8\uff0c\u521b\u5efa\u5b58\u50a8\u7c7bstorageclass-test.yaml</p> </li> <li> <p>\u5757\u5b58\u50a8\u4f7f\u7528\u793a\u4f8b</p> </li> <li> <p>\u521b\u5efa\u6587\u4ef6\u7cfb\u7edf\u5b58\u50a8filesystem-test.yaml</p> </li> <li> <p>\u521b\u5efa\u6587\u4ef6\u7cfb\u7edf\u5b58\u50a8\u7c7bstorageclass.yaml</p> </li> <li> <p>\u6587\u4ef6\u7cfb\u7edf\u5b58\u50a8\u4f7f\u7528\u793a\u4f8b</p> </li> </ul>"},{"location":"kubernetes/k8s-platform/calico/","title":"calico","text":"<p>Update:2024/1/9</p>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#architecture","title":"architecture","text":"","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#_1","title":"\u4e00\u4e9b\u6280\u672f\u7ec6\u8282","text":"","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#networkpolicy","title":"NetworkPolicy","text":"<p>Kubernetes \u7f51\u7edc\u7b56\u7565\u662f\u901a\u8fc7\u7f51\u7edc\u63d2\u4ef6\u800c\u4e0d\u662f Kubernetes \u672c\u8eab\u6765\u5b9e\u73b0\u7684\u3002\u7b80\u5355\u5730\u521b\u5efa\u7f51\u7edc\u7b56\u7565\u8d44\u6e90\u800c\u4e0d\u4f7f\u7528\u7f51\u7edc\u63d2\u4ef6\u6765\u5b9e\u73b0\u5b83\uff0c\u4e0d\u4f1a\u5bf9\u7f51\u7edc\u6d41\u91cf\u4ea7\u751f\u5f71\u54cd\u3002</p> <p>Calico\u63d2\u4ef6\u5b9e\u73b0\u4e86\u5168\u5957 Kubernetes \u7f51\u7edc\u7b56\u7565\u529f\u80fd\u3002\u6b64\u5916\uff0cCalico \u652f\u6301Calico\u7f51\u7edc\u7b56\u7565\uff0c\u63d0\u4f9b Kubernetes \u7f51\u7edc\u7b56\u7565\u4e4b\u5916\u7684\u9644\u52a0\u7279\u6027\u548c\u529f\u80fd\u3002Kubernetes \u548cCalico\u7f51\u7edc\u7b56\u7565\u65e0\u7f1d\u534f\u4f5c\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u9009\u62e9\u6700\u9002\u5408\u60a8\u7684\u7b56\u7565\uff0c\u5e76\u6839\u636e\u9700\u8981\u8fdb\u884c\u6df7\u5408\u548c\u5339\u914d\u3002</p>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#ipam","title":"IPAM","text":"<p>Kubernetes \u5982\u4f55\u4e3a Pod \u5206\u914d IP \u5730\u5740\u7531\u6240\u4f7f\u7528\u7684 IPAM\uff08IP \u5730\u5740\u7ba1\u7406\uff09\u63d2\u4ef6\u51b3\u5b9a\u3002</p> <p>Calico IPAM\u63d2\u4ef6\u6839\u636e\u9700\u8981\u52a8\u6001\u5730\u5c06\u5c0f\u5757 IP \u5730\u5740\u5206\u914d\u7ed9\u8282\u70b9\uff0c\u4ee5\u6709\u6548\u5730\u6574\u4f53\u5229\u7528\u53ef\u7528\u7684 IP \u5730\u5740\u7a7a\u95f4\u3002\u6b64\u5916\uff0cCalico IPAM \u652f\u6301\u9ad8\u7ea7\u529f\u80fd\uff0c\u4f8b\u5982\u591a\u4e2a IP \u6c60\u3001\u6307\u5b9a\u547d\u540d\u7a7a\u95f4\u6216 Pod \u5e94\u4f7f\u7528\u7684\u7279\u5b9a IP \u5730\u5740\u8303\u56f4\u7684\u80fd\u529b\uff0c\u751a\u81f3\u662f Pod \u5e94\u4f7f\u7528\u7684\u7279\u5b9a IP \u5730\u5740\u3002</p>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#cni","title":"CNI","text":"<p>Kubernetes \u4f7f\u7528\u7684 CNI\uff08\u5bb9\u5668\u7f51\u7edc\u63a5\u53e3\uff09\u63d2\u4ef6\u51b3\u5b9a\u4e86 Pod \u5982\u4f55\u8fde\u63a5\u5230\u5e95\u5c42\u7f51\u7edc\u7684\u8be6\u7ec6\u4fe1\u606f\u3002</p> <p>Calico CNI \u63d2\u4ef6\u4f7f\u7528 L3 \u8def\u7531\u5c06Pod \u8fde\u63a5\u5230\u4e3b\u673a\u7f51\u7edc\uff0c\u800c\u4e0d\u9700\u8981 L2 \u6865\u63a5\u5668\u3002\u8fd9\u7b80\u5355\u6613\u61c2\uff0c\u5e76\u4e14\u6bd4 kubenet \u6216 flannel \u7b49\u5176\u4ed6\u5e38\u89c1\u66ff\u4ee3\u65b9\u6848\u66f4\u9ad8\u6548\u3002</p>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#overlay-vxlan","title":"Overlay VXLAN","text":"<p>\u8986\u76d6\u7f51\u7edc\u5141\u8bb8 Pod \u5728\u8282\u70b9\u4e4b\u95f4\u8fdb\u884c\u901a\u4fe1\uff0c\u800c\u5e95\u5c42\u7f51\u7edc\u4e0d\u77e5\u9053 Pod \u6216 Pod IP \u5730\u5740\u3002</p> <p>\u4e0d\u540c\u8282\u70b9\u4e0a\u7684 Pod \u4e4b\u95f4\u7684\u6570\u636e\u5305\u4f7f\u7528 VXLAN \u8fdb\u884c\u5c01\u88c5\uff0c\u5c06\u6bcf\u4e2a\u539f\u59cb\u6570\u636e\u5305\u5305\u88c5\u5728\u4f7f\u7528\u8282\u70b9 IP \u7684\u5916\u90e8\u6570\u636e\u5305\u4e2d\uff0c\u5e76\u9690\u85cf\u5185\u90e8\u6570\u636e\u5305\u7684 Pod IP\u3002Linux \u5185\u6838\u53ef\u4ee5\u975e\u5e38\u6709\u6548\u5730\u5b8c\u6210\u6b64\u64cd\u4f5c\uff0c\u4f46\u5b83\u4ecd\u7136\u4f1a\u4ea7\u751f\u5f88\u5c0f\u7684\u5f00\u9500\uff0c\u5982\u679c\u8fd0\u884c\u7279\u522b\u7f51\u7edc\u5bc6\u96c6\u578b\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u60a8\u53ef\u80fd\u5e0c\u671b\u907f\u514d\u8fd9\u79cd\u60c5\u51b5\u3002</p> <p>\u76f8\u53cd\uff0c\u4e3a\u4e86\u5b8c\u6574\u6027\uff0c\u4e0d\u4f7f\u7528\u8986\u76d6\u7684\u64cd\u4f5c\u53ef\u63d0\u4f9b\u6700\u9ad8\u6027\u80fd\u7684\u7f51\u7edc\u3002\u79bb\u5f00 Pod \u7684\u6570\u636e\u5305\u662f\u901a\u8fc7\u7f51\u7edc\u4f20\u8f93\u7684\u6570\u636e\u5305\u3002</p>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#routing","title":"Routing","text":"<p>Calico\u8def\u7531\u4f7f\u7528\u5176\u6570\u636e\u5b58\u50a8\u6765\u5206\u914d\u548c\u7f16\u7a0b\u8282\u70b9\u4e4b\u95f4 pod \u6d41\u91cf\u7684\u8def\u7531\uff0c\u800c\u65e0\u9700 BGP\u3002Calico\u8def\u7531\u652f\u6301\u5355\u4e2a\u5b50\u7f51\u5185\u7684\u672a\u5c01\u88c5\u6d41\u91cf\uff0c\u4ee5\u53ca\u8de8\u591a\u4e2a\u5b50\u7f51\u7684\u96c6\u7fa4\u7684\u9009\u62e9\u6027 VXLAN \u5c01\u88c5\u3002</p>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#datastore","title":"Datastore","text":"<p>Calico\u5c06\u96c6\u7fa4\u7684\u64cd\u4f5c\u548c\u914d\u7f6e\u72b6\u6001\u5b58\u50a8\u5728\u4e2d\u592e\u6570\u636e\u5b58\u50a8\u4e2d\u3002\u5982\u679c\u6570\u636e\u5b58\u50a8\u4e0d\u53ef\u7528\uff0c\u60a8\u7684Calico\u7f51\u7edc\u5c06\u7ee7\u7eed\u8fd0\u884c\uff0c\u4f46\u65e0\u6cd5\u66f4\u65b0\uff08\u65b0 Pod \u65e0\u6cd5\u8054\u7f51\u3001\u65e0\u6cd5\u5e94\u7528\u7b56\u7565\u66f4\u6539\u7b49\uff09\u3002</p> <p>Calico\u6709\u4e24\u4e2a\u6570\u636e\u5b58\u50a8\u9a71\u52a8\u7a0b\u5e8f\u53ef\u4f9b\u9009\u62e9   - etcd - \u7528\u4e8e\u76f4\u63a5\u8fde\u63a5\u5230 etcd \u96c6\u7fa4   - Kubernetes - \u7528\u4e8e\u8fde\u63a5\u5230 Kubernetes API \u670d\u52a1\u5668</p> <p>\u4f7f\u7528 Kubernetes \u4f5c\u4e3a\u6570\u636e\u5b58\u50a8\u7684\u4f18\u70b9\u662f\uff1a   - \u5b83\u4e0d\u9700\u8981\u989d\u5916\u7684\u6570\u636e\u5b58\u50a8\uff0c\u56e0\u6b64\u5b89\u88c5\u548c\u7ba1\u7406\u66f4\u7b80\u5355   - \u60a8\u53ef\u4ee5\u4f7f\u7528 Kubernetes RBAC \u6765\u63a7\u5236\u5bf9Calico\u8d44\u6e90\u7684\u8bbf\u95ee   - \u60a8\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u5ba1\u6838\u65e5\u5fd7\u8bb0\u5f55\u6765\u751f\u6210Calico\u8d44\u6e90\u66f4\u6539\u7684\u5ba1\u6838\u65e5\u5fd7</p> <p>\u4e3a\u4e86\u5b8c\u6574\u8d77\u89c1\uff0c\u4f7f\u7528 etcd \u4f5c\u4e3a\u6570\u636e\u5b58\u50a8\u7684\u4f18\u70b9\u662f\uff1a   - \u5141\u8bb8\u60a8\u5728\u975e Kubernetes \u5e73\u53f0\uff08\u4f8b\u5982 OpenStack\uff09\u4e0a\u8fd0\u884cCalico   - \u5141\u8bb8\u5206\u79bb Kubernetes \u548cCalico\u8d44\u6e90\u4e4b\u95f4\u7684\u5173\u6ce8\u70b9\uff0c\u4f8b\u5982\u5141\u8bb8\u60a8\u72ec\u7acb\u6269\u5c55\u6570\u636e\u5b58\u50a8   - \u5141\u8bb8\u60a8\u8fd0\u884c\u5305\u542b\u591a\u4e2a Kubernetes \u96c6\u7fa4\u7684Calico\u96c6\u7fa4\uff0c\u4f8b\u5982\uff0c\u5177\u6709Calico\u4e3b\u673a\u4fdd\u62a4\u7684\u88f8\u673a\u670d\u52a1\u5668\u4e0e Kubernetes \u96c6\u7fa4\u6216\u591a\u4e2a Kubernetes \u96c6\u7fa4\u8054\u52a8\u3002</p>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#network-configuration","title":"Network Configuration","text":"<ul> <li>\u64cd\u4f5c\u524d\u9605\u8bfb\u786e\u5b9a\u6700\u4f73\u7f51\u7edc\u9009\u9879</li> </ul> <p>Note</p> <p>\u4e00\u822c\u96c6\u7fa4\u5efa\u8bae\uff1a 1. \u4f7f\u7528overlay\u7f51\u7edc\u7684ipip\u6a21\u5f0f\uff08vxlan\u6027\u80fd\u7a0d\u5dee\u4e00\u70b9\uff09\uff0c\u8bbe\u7f6e\u4e3a\u4ec5\u8de8\u5b50\u7f51\u65f6\u8fdb\u884c\u5c01\u88c5\u3002\u4f46\u8fd8\u9700\u5b9e\u9645\u6d4b\u8bd5\u73af\u5883\u7f51\u7edc\u662f\u5426\u6709\u62e6\u622aipip\u6d41\u91cf\uff0c\u5426\u5219\u4e5f\u53ef\u4ee5\u4f7f\u7528vxlan 2. xvlan\u6a21\u5f0f\u51e0\u4e4e\u53ef\u4ee5\u5728\u4efb\u4f55\u73af\u5883\u4e2d\u8fd0\u884c\uff0c\u53ef\u4ee5\u5c06\u8be5\u6a21\u5f0f\u4f5c\u4e3a\u4fdd\u5e95\u65b9\u6848\uff08<code>IPPool</code>\u8bbe\u7f6e<code>vxlanMode: Always</code>\uff09</p>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#calicobgp","title":"\u914d\u7f6ecalico\u4e0e\u5e95\u5c42\u7f51\u7edc\u7684BGP\u5bf9\u7b49\u8fde\u63a5","text":"<p>Note</p> <p>calico\u4e0e\u5e95\u5c42\u7f51\u7edc\u7684BGP\u5bf9\u7b49\u8fde\u63a5\u9700\u8981\u5bf9\u5e95\u5c42\u7f51\u7edc\u6709\u4e00\u5b9a\u7684\u914d\u7f6e\u64cd\u4f5c\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u4f7f\u7528overlay\u8986\u76d6\u96c6\u7fa4\u6240\u6709\u5de5\u4f5c\u8d1f\u8f7d\u5373\u53ef\uff0c\u4ec5\u6709\u516c\u5e03podip\u7b49\u7c7b\u4f3c\u9700\u6c42\u662f\u8003\u8651BGP</p> <p>BGP\u662f\u7528\u4e8e\u5728\u7f51\u7edc\u4e2d\u7684\u8def\u7531\u5668\u4e4b\u95f4\u4ea4\u6362\u8def\u7531\u4fe1\u606f\u7684\u6807\u51c6\u534f\u8bae\u3002\u6bcf\u53f0\u8fd0\u884c BGP \u7684\u8def\u7531\u5668\u90fd\u6709\u4e00\u4e2a\u6216\u591a\u4e2aBGP \u5bf9\u7b49\u4f53- \u5b83\u4eec\u901a\u8fc7 BGP \u4e0e\u5176\u4ed6\u8def\u7531\u5668\u8fdb\u884c\u901a\u4fe1\u3002\u60a8\u53ef\u4ee5\u5c06 Calico \u7f51\u7edc\u89c6\u4e3a\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u63d0\u4f9b\u4e00\u4e2a\u865a\u62df\u8def\u7531\u5668\u3002</p>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#overlay-networking","title":"overlay networking","text":"<p>Warning</p> <ul> <li>IP in IP supports only IPv4 addresses</li> <li>VXLAN in IPv6 is only supported for kernel versions \u2265 4.19.1 or redhat kernel version \u2265 4.18.0</li> </ul> <p>Calico \u652f\u6301\u4e24\u79cd\u7c7b\u578b\u7684\u5c01\u88c5\uff1aVXLAN \u548c IP in IP\u3002\u5728\u67d0\u4e9b\u4e0d\u652f\u6301 IP in IP \u7684\u73af\u5883\u4e2d\uff08\u4f8b\u5982 Azure\uff09\u652f\u6301 VXLAN\u3002 VXLAN \u7684\u6bcf\u4e2a\u6570\u636e\u5305\u5f00\u9500\u7a0d\u9ad8\uff0c\u56e0\u4e3a\u6807\u5934\u8f83\u5927\uff0c\u4f46\u9664\u975e\u60a8\u8fd0\u884c\u7f51\u7edc\u5bc6\u96c6\u578b\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5426\u5219\u60a8\u901a\u5e38\u4e0d\u4f1a\u6ce8\u610f\u5230\u5dee\u5f02\u3002\u4e24\u79cd\u5c01\u88c5\u7c7b\u578b\u4e4b\u95f4\u7684\u53e6\u4e00\u4e2a\u5c0f\u533a\u522b\u662f Calico \u7684 VXLAN \u5b9e\u73b0\u4e0d\u4f7f\u7528 BGP\uff0c\u800c Calico \u7684 IP in IP \u5b9e\u73b0\u5728 Calico \u8282\u70b9\u4e4b\u95f4\u4f7f\u7528 BGP\u3002</p> <p>Note</p> <ul> <li>\u4f7f\u7528tigera-operator\u5b89\u88c5\uff0c\u4e14\u672a\u660e\u786e\u914d\u7f6e\u65f6\uff0c\u9ed8\u8ba4\u4f7f\u7528ipip Always\u7684overlay\u7f51\u7edc</li> <li>\u90e8\u5206\u4e91\u5e73\u53f0\u4f1a\u62e6\u622aipip\u6d41\u91cf\uff0c\u4f7f\u7528\u65f6\u53ef\u4e24\u79cd\u7c7b\u578b\u90fd\u8bd5\u8bd5</li> </ul> <p>Calico \u53ef\u4ee5\u9009\u62e9\u9009\u62e9\u6027\u5730\u4ec5\u5c01\u88c5\u8de8\u8d8a\u5b50\u7f51\u8fb9\u754c\u7684\u6d41\u91cf\u3002\u5efa\u8bae\u4f7f\u7528IP in IP \u6216 VXLAN \u7684\u8de8\u5b50\u7f51\u9009\u9879\uff08\u5373\u5b50\u7f51\u5185\u90e8\u4e0d\u4f7f\u7528\u5c01\u88c5\uff0c\u4ec5\u8de8\u5b50\u7f51\u65f6\u4f7f\u7528\uff09\uff0c\u4ee5\u6700\u5927\u9650\u5ea6\u5730\u51cf\u5c11\u5c01\u88c5\u5f00\u9500\u3002</p> <ul> <li> <p><code>kubectl edit ippools default-ipv4-ippool</code></p> <pre><code>apiVersion: projectcalico.org/v3\nkind: IPPool\nmetadata:\n  creationTimestamp: \"2024-01-09T02:54:32Z\"\n  name: default-ipv4-ippool\n  resourceVersion: \"30050\"\n  uid: cc893d43-213c-4c1d-8f58-8de477cae79c\nspec:\n  allowedUses:\n  - Workload\n  - Tunnel\n  blockSize: 26\n  cidr: 10.95.0.0/16\n  ipipMode: CrossSubnet\n  natOutgoing: true\n  nodeSelector: all()\n  vxlanMode: Never\n</code></pre> </li> </ul>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#mtu","title":"\u914d\u7f6eMTU","text":"<p>IP\u3001VXLAN \u548c WireGuard \u534f\u8bae\u4e2d\u7684 IP \u4e2d\u4f7f\u7528\u7684\u989d\u5916\u8986\u76d6\u6807\u5934\u4f1a\u6309\u6807\u5934\u5927\u5c0f\u51cf\u5c11\u6700\u5c0f MTU\u3002\uff08IP in IP \u4f7f\u7528 20 \u5b57\u8282\u6807\u5934\uff0cIPv4 VXLAN \u4f7f\u7528 50 \u5b57\u8282\u6807\u5934\uff0cIPv6 VXLAN \u4f7f\u7528 70 \u5b57\u8282\u6807\u5934\uff0cIPv4 WireGuard \u4f7f\u7528 60 \u5b57\u8282\u6807\u5934\uff0cIPv6 WireGuard \u4f7f\u7528 80 \u5b57\u8282\u6807\u5934\uff09\u3002</p> <p>Note</p> <p>\u5982\u679c\u670d\u52a1\u5668\u7f51\u5361MTU\u6709\u8c03\u6574\uff0c\u6bd4\u5982\u51cf\u5c11\uff0c\u5219calico\u4e5f\u5e94\u8be5\u76f8\u5e94\u7684\u8c03\u6574</p>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#_2","title":"\u6545\u969c\u6392\u9664\u548c\u8bca\u65ad","text":"","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/#ipip-vs-vxlan","title":"ipip vs vxlan","text":"<ul> <li> <p>ipip</p> <ul> <li>\u6027\u80fd\u66f4\u597d\uff0c\u8d44\u6e90\u5360\u7528\u5c11</li> <li>\u662f\u5c06ip\u5305\u5c01\u88c5\u5728\u53e6\u4e00\u4e2aip\u5305\uff0c\u6240\u4ee5\u53ea\u80fd\u4f20\u8f93ip\u5305\uff0c\u5176\u4ed6\u975eip\u5305\u5c06\u88ab\u4e22\u5f03\uff0c\u5728\u8bbe\u8ba1\u4e0a\u65e0\u6cd5\u5c06\u975e IP \u6570\u636e\u5305\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u6807\u5934\u8fdb\u884c\u4f20\u8f93(IPIP \u7684\u8303\u56f4\u4ec5\u9650\u4e8e\u4e24\u4e2a Intranet \u4e4b\u95f4\u5355\u64ad IP \u6570\u636e\u5305\u7684\u96a7\u9053\u4f20\u8f93\u3002\u6240\u6709\u5e7f\u64ad\u548c\u591a\u64ad\u90fd\u5728\u95e8\u53e3\u4e22\u5f03\u3002\u6b64\u5916\uff0c\u5b83\u4e25\u683c\u6765\u8bf4\u662fOSI \u7b2c 3 \u5c42\u2014 IPV4 \u548c/\u6216 IPV6 \u534f\u8bae\u3002\u5b83\u7684\u4e3b\u8981\u4f18\u70b9\u662f\u8d44\u6e90\u5360\u7528\u975e\u5e38\u5c11\u3002)</li> <li>\u4ec5\u652f\u6301ipv4</li> </ul> </li> <li> <p>vxlan</p> <ul> <li>VxLAN \u662fOSI \u7b2c 2 \u5c42\u96a7\u9053\u534f\u8bae\u3002\u8be5\u534f\u8bae\u7684\u529f\u80fd\u7c7b\u4f3c\u4e8e\u6865\u63a5\u5668/\u4ea4\u6362\u673a\u3002\u5b83\u901a\u8fc7\u96a7\u9053\u4f20\u8f93\u6240\u6709\u4ee5\u592a\u7f51\u6d41\u91cf\uff0c\u5305\u62ec\u90a3\u4e9b\u4e0d\u53ef\u8def\u7531\u7684\u6570\u636e\u5305\u3002</li> <li>\u652f\u6301ipv4\u548cipv6\uff0c\u5982\u679c\u96c6\u7fa4\u4f7f\u7528\u4e86ipv6\u5219\u53ea\u80fd\u4f7f\u7528vxlan</li> <li>\u76f8\u8f83ipip\u529f\u80fd\u6027\u66f4\u5f3a\uff0c\u4f8b\u5982\u79df\u6237\u9694\u79bb\uff0c\u652f\u6301\u975eip\u6570\u636e\u5305\u3002\u4f46\u5f00\u9500\u66f4\u5927\uff0cIP in IP uses a 20-byte header, IPv4 VXLAN uses a 50-byte header, IPv6 VXLAN uses a 70-byte header</li> </ul> </li> </ul>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/install/","title":"calico\u90e8\u7f72","text":"","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/install/#_1","title":"\u90e8\u7f72","text":"","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/install/#_2","title":"\u7cfb\u7edf\u8981\u6c42","text":"<ul> <li> <p>x86-64, arm64, ppc64le, or s390x processor</p> </li> <li> <p>Calico must be able to manage <code>cali*</code> interfaces on the host. When IPIP is enabled (the default), Calico also needs to be able to manage <code>tunl*</code> interfaces. When VXLAN is enabled, Calico also needs to be able to manage the <code>vxlan.calico</code> interface.</p> </li> <li> <p>\u5982\u679c\u60a8\u7684 Linux \u53d1\u884c\u7248\u9644\u5e26\u5b89\u88c5\u7684 Firewalld \u6216\u5176\u4ed6 iptables \u7ba1\u7406\u5668\uff0c\u5219\u5e94\u5c06\u5176\u7981\u7528\u3002\u8fd9\u4e9b\u53ef\u80fd\u4f1a\u5e72\u6270 Calico \u6dfb\u52a0\u7684\u89c4\u5219\u5e76\u5bfc\u81f4\u610f\u5916\u884c\u4e3a\u3002</p> </li> <li> <p>\u7aef\u53e3\u8981\u6c42</p> </li> </ul> \u914d\u7f6e \u4e3b\u673a \u8fde\u63a5\u7c7b\u578b \u7aef\u53e3/\u534f\u8bae Calico\u7f51\u7edc (BGP) \u5168\u90e8 \u53cc\u5411 TCP 179 \u542f\u7528 IP-in-IP \u7684Calico\u7f51\u7edc\uff08\u9ed8\u8ba4\uff09 \u5168\u90e8 \u53cc\u5411 IP-in-IP\uff0c\u901a\u5e38\u7531\u5176\u534f\u8bae\u53f7\u8868\u793a4 \u542f\u7528 VXLAN \u7684Calico\u7f51\u7edc \u5168\u90e8 \u53cc\u5411 UDP 4789 \u542f\u7528 Typha \u7684Calico\u7f51\u7edc Typha agent hosts \u4f20\u5165 TCP 5473\uff08\u9ed8\u8ba4\uff09 \u542f\u7528 IPv4 Wireguard \u7684Calico\u7f51\u7edc \u5168\u90e8 \u53cc\u5411 UDP 51820\uff08\u9ed8\u8ba4\uff09 \u542f\u7528 IPv6 Wireguard \u7684Calico\u7f51\u7edc \u5168\u90e8 \u53cc\u5411 UDP 51821\uff08\u9ed8\u8ba4\uff09 Flannel (VXLAN) \u5168\u90e8 \u53cc\u5411 UDP 4789 \u5168\u90e8 kube-apiserver \u4e3b\u673a \u4f20\u5165 \u901a\u5e38\u662f TCP 443 \u6216 6443 etcd \u6570\u636e\u5b58\u50a8 etcd \u4e3b\u673a \u4f20\u5165 TCP 2379 \u4f46\u53ef\u80fd\u6709\u6240\u4e0d\u540c","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/install/#tigera-operator","title":"\u4f7f\u7528tigera operator","text":"<ul> <li> <p>\u5b89\u88c5operator     <pre><code>kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml\n</code></pre></p> </li> <li> <p>\u90e8\u7f72\uff0c\u81ea\u5b9a\u4e49\u914d\u7f6e\u53c2\u8003 <pre><code>kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml\n</code></pre></p> </li> </ul> <p>\u5b8c\u6574\u53c2\u8003</p>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/install/#helm","title":"\u4f7f\u7528helm\u90e8\u7f72","text":"<p>\u5b98\u65b9\u6587\u6863\uff1ahttps://projectcalico.docs.tigera.io/getting-started/kubernetes/helm</p> <pre><code>helm repo add projectcalico https://docs.tigera.io/calico/charts\nhelm repo update\n\nhelm show values projectcalico/tigera-operator --version v3.26.4\n\nkubectl create namespace tigera-operator\nhelm install calico projectcalico/tigera-operator --version v3.26.4 --namespace tigera-operator\n\nwatch kubectl get pods -n calico-system\n</code></pre>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/install/#yaml-manifestskubernetescnicalico","title":"\u4f7f\u7528yaml manifests\u90e8\u7f72(\u4ec5\u5efa\u8bae\u5bf9\u5e95\u5c42Kubernetes\u8d44\u6e90\u8fdb\u884c\u9ad8\u5ea6\u7279\u5b9a\u4fee\u6539\u65f6\uff0c\u6216\u8005\u53ea\u4f5c\u4e3acni\u63d2\u4ef6\uff0c\u4e0d\u4f7f\u7528\u5176\u4ed6calico\u529f\u80fd\u65f6\u4f7f\u7528)","text":"<p>Note</p> <p>\u4ee5\u4e0b\u5b98\u65b9\u63d0\u4f9b\u7684manifests\uff0ccalico-vxlan.yaml\u5747\u4e3a<code>vxlanMode: CrossSubnet</code>\uff0ccalico.yaml\u5747\u4e3a<code>ipipMode: Always</code>.</p> <pre><code># \u6700\u65b0\u7248\n#vxlan\nwget https://github.com/projectcalico/calico/blob/master/manifests/calico-vxlan.yaml\n#ipip\nwget https://github.com/projectcalico/calico/blob/master/manifests/calico.yaml\n</code></pre>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/install/#_3","title":"\u5386\u53f2\u7248\u672c","text":"<p>\u4e0d\u540c\u7248\u672c\u94fe\u63a5\uff0c\u9700\u8981\u5176\u4ed6\u7248\u672c\uff0c\u5219\u4fee\u6539url\u4e2d\u7684\u7248\u672c\u548c\u7ed3\u5c3e\u6587\u4ef6\u540d\u3002\u6d4f\u89c8\u5668\u8bbf\u95ee\u6216\u4e0b\u8f7d\u6216<code>kubectl create -f</code></p> <p>Note</p> <p>\u90e8\u5206\u8001\u7248\u672c\u9700\u8981\u4fee\u6539<code>pod cidr</code>\uff0c\u5177\u4f53\u770byaml\u4e2d\u8fd9\u4e2a\u73af\u5883\u53d8\u91cf\u9ed8\u8ba4\u662f\u5426\u6ce8\u91ca\uff0c\u9ed8\u8ba4\u6ce8\u91ca\u5219\u4e0d\u9700\u8981\u914d\u7f6e\uff0c\u9ed8\u8ba4\u6ca1\u6ce8\u91ca\u5219\u9700\u8981\u4fee\u6539\u4e3a\u5b9e\u9645\u73af\u5883\u7684         <pre><code>- name: CALICO_IPV4POOL_CIDR\n  value: \"172.18.0.0/16\"\n</code></pre></p> <ul> <li> <p><code>&lt;=v3.21</code></p> <ul> <li> <p><code>https://docs.projectcalico.org/archive/v3.15/manifests/calico-vxlan.yaml</code></p> </li> <li> <p><code>https://docs.projectcalico.org/archive/v3.15/manifests/calico.yaml</code></p> </li> </ul> </li> <li> <p><code>v3.22 &lt;= version &lt;= v3.25</code></p> <ul> <li><code>https://docs.tigera.io/archive/v3.22/manifests/calico.yaml</code></li> </ul> </li> <li> <p><code>&gt;= v3.26</code></p> <ul> <li><code>https://github.com/projectcalico/calico/blob/v3.24.4/manifests/calico.yaml</code></li> </ul> </li> </ul>","tags":["k8s","calico","network"]},{"location":"kubernetes/k8s-platform/calico/other/","title":"Other","text":""},{"location":"kubernetes/k8s-platform/calico/other/#_1","title":"\u4e3b\u673a\u7f51\u7edc\u7b56\u7565","text":"<p>\u5982\u679c\u9700\u8981\u4e3b\u673a\u9632\u706b\u5899\uff0c\u53ef\u4ee5\u901a\u8fc7Calico HostEndpoint \u548c GlobalNetworkPolicy \u8fdb\u884c\u914d\u7f6e\u3002</p>"},{"location":"kubernetes/k8s-platform/cert-manager/","title":"\u4f7f\u7528helm\u90e8\u7f72","text":"<p>helm\u5b89\u88c5cert-manager\u5b98\u65b9\u6587\u6863  \\ \u5176\u4ed6\u53c2\u8003</p> <ul> <li>\u5b89\u88c5</li> </ul> <pre><code>helm repo add jetstack https://charts.jetstack.io\nhelm repo update\n\nhelm install \\\n  cert-manager jetstack/cert-manager \\\n  --namespace cert-manager \\\n  --create-namespace \\\n  --version v1.9.2 \\\n  --set installCRDs=true \\\n  --set prometheus.enabled=false \\\n  --set webhook.timeoutSeconds=10 \\\n  --set ingressShim.defaultIssuerName=letsencrypt-prod \\\n  --set ingressShim.defaultIssuerKind=ClusterIssuer \\\n  --set ingressShim.defaultIssuerGroup=cert-manager.io\n\n# \u521b\u5efaclusterissuer\ncat &lt;&lt; EOF| kubectl create  -f -\napiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-prod\nspec:\n  acme:\n    email: 13835518617@163.com\n    privateKeySecretRef:\n      name: letsencrypt-prod\n    server: https://acme-v02.api.letsencrypt.org/directory\n    solvers:\n    - http01:\n        ingress:\n          class: nginx\nEOF\n</code></pre> <ul> <li>\u4f7f\u7528 <pre><code>#1. \u624b\u52a8\u521b\u5efa\u8bc1\u4e66\ncat &lt;&lt;EOF &gt;  rancher.site.domain.yaml\napiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: rancher.site.domain-tls\n  namespace: cattle-system\nspec:\n  secretName: rancher.site.domain-tls\n  issuerRef:\n    name: letsencrypt-prod\n    kind: ClusterIssuer\n  dnsNames:\n  - rancher.site.domain\nEOF\n\n#2. \u914d\u7f6eingress\u81ea\u52a8\u83b7\u53d6\u8bc1\u4e66\n    cert-manager.io/cluster-issuer: letsencrypt-prod\n    kubernetes.io/tls-acme: \"true\"\n\n  ingressClassName: nginx\n\n\ntls:\n - hosts:\n   - rancher.site.domain\n   secretName: rancher.site.domain-tls\n\n\n#\u8bc1\u4e66\u8fc7\u671f\u5904\u7406\n\u5c06ingress\u5bf9\u5e94\u7684cert\u548csecret\u5220\u9664\n</code></pre></li> </ul>"},{"location":"kubernetes/k8s-platform/cert-manager/#charts","title":"\u5176\u4ed6charts","text":"<pre><code>helm repo add bitnami https://charts.bitnami.com/bitnami\nhelm install my-release bitnami/cert-manager\n</code></pre>"},{"location":"kubernetes/k8s-platform/cert-manager/old/","title":"old","text":""},{"location":"kubernetes/k8s-platform/cert-manager/old/#install-cert-manager","title":"Install cert-manager","text":"<p>Note: cert-manager is only required for certificates issued by Rancher\u2019s generated CA (ingress.tls.source=rancher) and Let\u2019s Encrypt issued certificates (ingress.tls.source=letsEncrypt). You should skip this step if you are using your own certificate files (option ingress.tls.source=secret) or if you use TLS termination on an External Load Balancer.</p> <p>Install the CustomResourceDefinition resources separately <pre><code>kubectl apply -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.9/deploy/manifests/00-crds.yaml\n</code></pre> Create the namespace for cert-manager <pre><code>kubectl create namespace cert-manager\n</code></pre> Label the cert-manager namespace to disable resource validation <pre><code>kubectl label namespace cert-manager certmanager.k8s.io/disable-validation=true\n</code></pre> Add the Jetstack Helm repository <pre><code>helm repo add jetstack https://charts.jetstack.io\n</code></pre> Update your local Helm chart repository cache <pre><code>helm repo update\n</code></pre> Install the cert-manager Helm chart <pre><code>helm install cert-manager \\\n  --namespace cert-manager \\\n  --version v0.14.2 \\\n  jetstack/cert-manager\n</code></pre></p> <p>Upgrade the cert-manager <pre><code>kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.5.1/cert-manager.crds.yaml\n\nhelm upgrade \\\n  --install \\\n  --create-namespace \\\n  --namespace cert-manager \\\n  --version v1.5.1 \\\n  cert-manager \\\n  jetstack/cert-manager \\\n   --set ingressShim.defaultIssuerName=letsencrypt-prod \\\n   --set ingressShim.defaultIssuerKind=ClusterIssuer \\\n   --set ingressShim.defaultIssuerGroup=cert-manager.io\n\n\ncat &lt;&lt; EOF| kubectl create  -f -\napiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-prod\nspec:\n  acme:\n    server: https://acme-v02.api.letsencrypt.org/directory\n    email: ymzhang@quantangle.com.cn\n    privateKeySecretRef:\n      name: letsencrypt-prod\n    solvers:\n    - http01:\n       ingress:\n         class: nginx\nEOF\n</code></pre></p> <p>Creating the <code>rancher</code> issuer <pre><code>cat &lt;&lt; EOF| kubectl create -n cattle-system -f -\n   apiVersion: cert-manager.io/v1\n   kind: Issuer\n   metadata:\n     name: rancher\n   spec:\n     acme:\n       # The ACME server URL\n       server: https://acme-v02.api.letsencrypt.org/directory\n       # Email address used for ACME registration\n       email: ymzhang@quantangle.com.cn\n       # Name of a secret used to store the ACME account private key\n       privateKeySecretRef:\n         name: rancher\n       # Enable the HTTP-01 challenge provider\n       solvers:\n       - http01:\n           ingress:\n             class: nginx\nEOF\n</code></pre></p> <p>3, Rancher Generated Certificates</p> <pre><code>Note:\nYou need to have cert-manager installed before proceeding.\n</code></pre> <p>The default is for Rancher to generate a CA and uses cert-manager to issue the certificate for access to the Rancher server interface. Because rancher is the default option for ingress.tls.source, we are not specifying ingress.tls.source when running the helm install command.</p> <pre><code>Set the hostname to the DNS name you pointed at your load balancer.\nIf you are installing an alpha version, Helm requires adding the --devel option to the command.\n</code></pre> <p>```shell script kubectl -n kube-system edit cm coredns</p> <pre><code>\u6dfb\u52a0\n```shell script\n        ready\n        hosts {\n            10.0.2.17  rancher.qtgl.com.cn\n            fallthrough\n        }\n</code></pre> <p>\u672c\u673a\u7535\u8111\u6dfb\u52a0hosts: <pre><code>121.5.129.198  rancher.qtgl.com.cn\n</code></pre></p> <pre><code>helm install rancher rancher-stable/rancher   \\\n  --namespace cattle-system \\\n  --set hostname=rancher.qtgl.com.cn \n</code></pre> <p>To get just the bootstrap password on its own, run:</p> <pre><code>kubectl get secret --namespace cattle-system bootstrap-secret -o go-template='{{.data.bootstrapPassword|base64decode}}{{ \"\\n\" }}'\n</code></pre>"},{"location":"kubernetes/k8s-platform/docker-registry/","title":"registry","text":"<p>https://docs.docker.com/registry/</p> <p>\u90e8\u7f72\u6587\u6863\uff1a https://distribution.github.io/distribution/about/deploying/</p>"},{"location":"kubernetes/k8s-platform/docker-registry/#1","title":"1. \u81ea\u7b7e\u540d\u8bc1\u4e66","text":"<pre><code>mkdir certs &amp;&amp; cd certs/\n# \u6267\u884c\u5b8c\u4ee5\u4e0b3\u6761\u547d\u4ee4\u540e\uff0c\u5f53\u524d\u76ee\u5f55\u4e0b\u5e94\u8be5\u67094\u4e2a\u6587\u4ef6\n'*.dachui.com.crt'  '*.dachui.com.csr'  '*.dachui.com.key'  '*.dachui.com.srl'\n\n#\u7b7e\u53d1\u8bc1\u4e66\uff0c10\u5e74\u6709\u6548\u671f\nopenssl req -nodes -subj \"/C=CN/ST=Beijing/L=Beijing/CN=*.dachui.com\" -newkey rsa:2048 -keyout *.dachui.com.key -out *.dachui.com.csr\nopenssl x509 -req -days 3650 -in *.dachui.com.csr -signkey *.dachui.com.key -out *.dachui.com.crt\nopenssl x509 -req -in *.dachui.com.csr -CA *.dachui.com.crt -CAkey *.dachui.com.key -CAcreateserial -out *.dachui.com.crt -days 3650 \n\n\n# \u5c06\u8bc1\u4e66\u6dfb\u52a0\u5230\u53ef\u4fe1\u8303\u56f4\uff0c\u96c6\u7fa4\u91cc\u7684\u6240\u6709\u673a\u5668\u90fd\u914d\u7f6e\n# centos\u914d\u7f6e\u65b9\u6cd5\nyum install -y ca-certificates\nupdate-ca-trust enable\ncp *.dachui.com.crt /etc/pki/ca-trust/source/anchors/\nupdate-ca-trust extract\n# ubuntu\u914d\u7f6e\u65b9\u6cd5\ncp *.dachui.com.crt /usr/local/share/ca-certificates\nupdate-ca-certificates\n</code></pre>"},{"location":"kubernetes/k8s-platform/docker-registry/#2registry","title":"2.\u5b89\u88c5registry","text":"<pre><code>mkdir -p /data/registry &amp;&amp; cd ..\n\ndocker run -d \\\n  -p 5000:5000 \\\n  --restart=always \\\n  --name registry \\\n  -v /data/registry:/var/lib/registry \\\n  registry:2\n\ndocker run -d \\\n  -p 443:443 \\\n  --restart=always \\\n  --name registry \\\n  -v /data/registry:/var/lib/registry \\\n  -v \"$(pwd)\"/certs:/certs \\\n  -e REGISTRY_HTTP_ADDR=0.0.0.0:443 \\\n  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/'*.dachui.com.crt' \\\n  -e REGISTRY_HTTP_TLS_KEY=/certs/'*.dachui.com.key' \\\n  registry:2\n\n#\u9650\u5236cpu\u548c\u5185\u5b58  --cpus 2  -m 4096m \\\n</code></pre>"},{"location":"kubernetes/k8s-platform/docker-registry/#3","title":"3.\u9a8c\u8bc1","text":"<pre><code>#\u914d\u7f6ehosts\u89e3\u6790\nvim /etc/hosts \n192.168.1.11 reg.dachui.com\n\n#\u63a8\u9001\u955c\u50cf\ndocker tag xxx reg.dachui.com/test/pause:3.5\ndocker push reg.dachui.com/test/pause:3.5\n# \u95ee\u9898\u8bb0\u5f55\n# 1.Get https://reg.dachui.com/v2/: x509: certificate signed by unknown authority\n# 2.Error response from daemon: Missing client certificate *.dachui.com.cert for key *.dachui.com.key\n# \u89e3\u51b3\u65b9\u6848:\nmkdir -p /etc/docker/certs.d/reg.dachui.com/\ncp ./certs/reg.dachui.com.crt /etc/docker/certs.d/reg.dachui.com/reg.dachui.com.cert\nsystemctl daemon-reload\nsystemctl restart docker\n\n\n#\u67e5\u770b\u4ed3\u5e93\u91cc\u5df2\u6709\u7684\u955c\u50cf\ncurl https://reg.dachui.com/v2/_catalog\n{\"repositories\":[\"test/pause\"]}\n\n#\u67e5\u770b\u955c\u50cftag  e.g: curl https://reg.dachui.com/v2/{\u955c\u50cf\u540d\u79f0}/tags/list\ncurl https://reg.dachui.com/v2/test/pause/tags/list\n{\"name\":\"test/pause\",\"tags\":[\"3.5\"]}\n</code></pre>"},{"location":"kubernetes/k8s-platform/docker-registry/#4","title":"4.\u542f\u7528\u8eab\u4efd\u8ba4\u8bc1","text":"<p>Warning: You cannot use authentication with authentication schemes that send credentials as clear text. You must configure TLS first for authentication to work.</p> <p>Create a password file with one entry for the user testuser, with password testpassword: <pre><code>mkdir auth\ndocker run \\\n --entrypoint htpasswd \\\n httpd:2 -Bbn testuser testpassword &gt; auth/htpasswd\n</code></pre></p> <p>Restart the registry with basic authentication. <pre><code>docker run -d \\\n  -p 443:443 \\\n  --restart=always \\\n  --name registry \\\n  -v /data/registry:/var/lib/registry \\\n  -v \"$(pwd)\"/certs:/certs \\\n  -e REGISTRY_HTTP_ADDR=0.0.0.0:443 \\\n  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/'*.dachui.com.crt' \\\n  -e REGISTRY_HTTP_TLS_KEY=/certs/'*.dachui.com.key' \\\n  -v \"$(pwd)\"/auth:/auth \\\n  -e \"REGISTRY_AUTH=htpasswd\" \\\n  -e \"REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm\" \\\n  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \\\n  registry:2\n</code></pre> Try to pull an image from the registry, or push an image to the registry. These commands fail.</p> <p>Log in to the registry. <pre><code> docker login reg.dachui.com\n</code></pre></p> <p>Provide the username and password from the first step.</p> <p>Test that you can now pull an image from the registry or push an image to the registry.</p>"},{"location":"kubernetes/k8s-platform/docker-registry/#5-systemd-registry","title":"5. \u4f7f\u7528systemd \u7ba1\u7406registry","text":"<p><code>vim /lib/systemd/system/registry.socket</code></p> <pre><code>[Unit]\nDescription=Distribution registry\n\n[Socket]\nListenStream=5000\n\n[Install]\nWantedBy=sockets.target\n</code></pre> <p><code>vim /lib/systemd/system/registry.service</code></p> <pre><code>[Unit]\nDescription=Distribution registry\nAfter=docker.service\nRequires=docker.service\n\n[Service]\n#TimeoutStartSec=0\nRestart=always\nExecStartPre=-/usr/bin/docker stop %N\nExecStartPre=-/usr/bin/docker rm %N\nExecStart=/usr/bin/docker run --name %N \\\n    -v /data/registry:/var/lib/registry \\\n    -p 5000:5000 \\\n    registry:2\n\n[Install]\nWantedBy=multi-user.target\n</code></pre>"},{"location":"kubernetes/k8s-platform/docker-registry/#6","title":"6. \u5e38\u7528\u547d\u4ee4","text":"<pre><code># \u5217\u51fa\u6240\u6709\u955c\u50cf\ncurl -qsS localhost:5000/v2/_catalog | python3 -m json.tool\n\n# \u5217\u51fa\u955c\u50cf\u7684\u6240\u6709tag\ncurl -qsS localhost:5000/v2/kubernetes/pause/tags/list | python3 -m json.tool\n\n# docker registry cli \u5217\u51fa\u6240\u6709\u955c\u50cf\u548ctag\ndocker run --rm anoxis/registry-cli -r http://192.168.182.21:5000\n\n# \u5f53registry\u4e5f\u5728\u672c\u5730docker\u65f6\uff0c\u53ef\u4ee5\u76f4\u63a5\u94fe\u63a5\u5230registry\u5bb9\u5668\ndocker run --rm --link registry anoxis/registry-cli -r http://registry:5000\n</code></pre>"},{"location":"kubernetes/k8s-platform/docker-registry/#7-docker-registry-ui","title":"7. docker registry ui","text":"<p>https://github.com/Joxit/docker-registry-ui</p> <pre><code>mkdir docker-registry-ui\ncd docker-registry-ui\nvim docker-compose.yml\ndocker compose up -d\n</code></pre> <pre><code>version: '3.8'\n\nservices:\n  registry-ui:\n    image: joxit/docker-registry-ui:main\n    restart: always\n    ports:\n      - 80:80\n    environment:\n      - SINGLE_REGISTRY=true\n      - REGISTRY_TITLE=Docker Registry UI\n      - DELETE_IMAGES=true\n      - SHOW_CONTENT_DIGEST=true\n      - NGINX_PROXY_PASS_URL=http://registry-server:5000\n      - SHOW_CATALOG_NB_TAGS=true\n      - CATALOG_MIN_BRANCHES=1\n      - CATALOG_MAX_BRANCHES=1\n      - TAGLIST_PAGE_SIZE=100\n      - REGISTRY_SECURED=false\n      - CATALOG_ELEMENTS_LIMIT=1000\n    container_name: registry-ui\n</code></pre>"},{"location":"kubernetes/k8s-platform/docker-registry/README-k8s/","title":"registry in k8s","text":"<p>https://docs.docker.com/registry/</p> <p>\u90e8\u7f72\u6587\u6863\uff1a https://distribution.github.io/distribution/about/deploying/</p>"},{"location":"kubernetes/k8s-platform/docker-registry/README-k8s/#1","title":"1. \u81ea\u7b7e\u540d\u8bc1\u4e66","text":"<pre><code>mkdir -p certs\n\nopenssl req \\\n  -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key \\\n  -addext \"subjectAltName = DNS:myregistry.domain.com\" \\\n  -x509 -days 36500 -out certs/domain.crt\n</code></pre>"},{"location":"kubernetes/k8s-platform/docker-registry/README-k8s/#2","title":"2. \u521b\u5efa\u5bc6\u7801\u6587\u4ef6","text":"<pre><code>mkdir -p auth\n\ndocker run \\\n  --entrypoint htpasswd \\\n  httpd:2 -Bbn testuser testpassword &gt; auth/htpasswd\n</code></pre>"},{"location":"kubernetes/k8s-platform/docker-registry/README-k8s/#3registry","title":"3.\u5b89\u88c5registry","text":"<pre><code>kubectl create ns docker-registry\n\nkubectl create secret tls docker-registry-tls -n docker-registry \\\n--cert certs/domain.crt \\\n--key certs/domain.key\n\nkubectl create secret generic docker-registry-auth -n docker-registry \\\n--from-file=auth/htpasswd\n\nkubectl apply -n docker-registry -f docker-registry.yaml\n</code></pre>"},{"location":"kubernetes/k8s-platform/docker-registry/README-k8s/#4","title":"4. \u6d4b\u8bd5","text":"<pre><code>curl -qsS https://myregistry.domain.com/v2/_catalog -k --user testuser:testpassword\n</code></pre>"},{"location":"kubernetes/k8s-platform/docker-registry/README-k8s/#5-containerd","title":"5. containerd\u914d\u7f6e","text":"<pre><code>        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"myregistry.domain.com\"]\n          endpoint = [\"https://myregistry.domain.com\"]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"myregistry.domain.com\".tls]\n          insecure_skip_verify = true\n</code></pre>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaDocker/","title":"docker\u5b89\u88c5harbor","text":""},{"location":"kubernetes/k8s-platform/harbor/installHarborViaDocker/#harbor","title":"harbor","text":"<p>\u66f4\u65b0\u65e5\u671f\uff1a20230904 \\ \u7248\u672c\uff1av2.7.2 \u6587\u6863\u6765\u6e90\uff1ahttps://goharbor.io/docs/2.7.0/install-config/</p>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaDocker/#1","title":"1.\u73af\u5883\u51c6\u5907","text":"<p>https://goharbor.io/docs/2.7.0/install-config/installation-prereqs/</p> <p>\u9700\u63d0\u524d\u5b89\u88c5\u597ddocker\uff0c\u79bb\u7ebf\u5b89\u88c5\u53ef\u53c2\u8003docker-ce-offline</p>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaDocker/#2","title":"2.\u4e0b\u8f7d\u5b89\u88c5\u5305\uff0c\u53ef\u9009\u79bb\u7ebf\u6216\u5728\u7ebf","text":"<p>https://github.com/goharbor/harbor/releases/download/v2.7.2/harbor-offline-installer-v2.7.2.tgz</p> <pre><code># \u89e3\u538b\ntar xzvf harbor-offline-installer-v2.7.2.tgz\n</code></pre> <ul> <li>\u751f\u6210\u8bc1\u4e66\uff0c\u5982\u679c\u4e0d\u9700\u8981https\u5219\u8df3\u8fc7</li> </ul> <pre><code>mkdir -p /data/certs &amp;&amp; cd /data/certs\n\nopenssl genrsa -out ca.key 4096\n\nopenssl req -x509 -new -nodes -sha512 -days 3650 \\\n -subj \"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.local.domain\" \\\n -key ca.key \\\n -out ca.crt\n\nopenssl genrsa -out harbor.local.domain.key 4096\n\nopenssl req -sha512 -new \\\n    -subj \"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.local.domain\" \\\n    -key harbor.local.domain.key \\\n    -out harbor.local.domain.csr\n\ncat &gt; v3.ext &lt;&lt;-EOF\nauthorityKeyIdentifier=keyid,issuer\nbasicConstraints=CA:FALSE\nkeyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = @alt_names\n\n[alt_names]\nDNS.1=harbor.local.domain\nDNS.2=yourdomain\nDNS.3=hostname\nEOF\n\nopenssl x509 -req -sha512 -days 3650 \\\n    -extfile v3.ext \\\n    -CA ca.crt -CAkey ca.key -CAcreateserial \\\n    -in harbor.local.domain.csr \\\n    -out harbor.local.domain.crt\n\n# \u8bc1\u4e66docker\u914d\u7f6e\uff0c\u96c6\u7fa4\u91cc\u7684\u6240\u6709\u673a\u5668\u90fd\u914d\u7f6e\n#cp harbor.local.domain.crt /data/certs/\n#cp harbor.local.domain.key /data/certs/\nopenssl x509 -inform PEM -in harbor.local.domain.crt -out harbor.local.domain.cert\nmkdir -p /etc/docker/certs.d/harbor.local.domain/\ncp harbor.local.domain.cert /etc/docker/certs.d/harbor.local.domain/\ncp harbor.local.domain.key /etc/docker/certs.d/harbor.local.domain/\ncp ca.crt /etc/docker/certs.d/harbor.local.domain/\n\nsystemctl daemon-reload\nsystemctl restart docker\n\n# \u5c06\u8bc1\u4e66\u6dfb\u52a0\u5230\u53ef\u4fe1\u8303\u56f4\uff0c\u96c6\u7fa4\u91cc\u7684\u6240\u6709\u673a\u5668\u90fd\u914d\u7f6e\n# centos\u914d\u7f6e\u65b9\u6cd5\nyum install -y ca-certificates\nupdate-ca-trust enable\ncp harbor.local.domain.crt /etc/pki/ca-trust/source/anchors/\nupdate-ca-trust extract\n# ubuntu\u914d\u7f6e\u65b9\u6cd5\ncp harbor.local.domain.crt /usr/local/share/ca-certificates\nupdate-ca-certificates\n</code></pre>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaDocker/#2install","title":"2.install","text":"<p>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6harbor.yml</p> <ul> <li>\u8bbe\u7f6ehostname</li> <li>\u6839\u636e\u5b9e\u9645\u9700\u8981\u5220\u9664<code>https</code>\u6bb5</li> <li>\u4fee\u6539\u5e73\u53f0\u7ba1\u7406\u5458\u5bc6\u7801<code>harbor_admin_password</code>\uff0c\u4fee\u6539db\u5bc6\u7801<code>database.password</code></li> <li>\u4fee\u6539\u6570\u636e\u5b58\u50a8\u76ee\u5f55<code>data_volume</code></li> </ul> <pre><code>cd harbor/ &amp;&amp; cp harbor.yml.tmpl harbor.yml\nvim harbor.yml\n</code></pre> <p>\u5b89\u88c5</p> <pre><code>./install.sh --with-chartmuseum\n\n# \u53ef\u9009\u7ec4\u4ef6 \n./install.sh --with-notary --with-trivy --with-chartmuseum\n</code></pre> <ul> <li>\u751f\u547d\u5468\u671f\u7ba1\u7406</li> </ul>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaDocker/#3","title":"3.\u4f7f\u7528","text":""},{"location":"kubernetes/k8s-platform/harbor/installHarborViaDocker/#todo","title":"TODO::\u5f85\u8865\u5145","text":"<pre><code>#\u8bbf\u95eehttps://harbor.local.domain ,\u521b\u5efa\u9879\u76eebaiyuani\uff0c\u624b\u52a8\u63a8\u9001\u955c\u50cfharbor.local.domain/baiyuani/demo:0.1.4\n#\u521b\u5efa\u5bc6\u94a5\nkubectl create secret docker-registry harbor-registry -n default \\\n--docker-username=admin \\\n--docker-password=qweasd123 \\\n--docker-server=harbor.local.domain  \\\n--dry-run=client -o yaml | kubectl apply -f -\n#\u6d4b\u8bd5\u5b89\u88c5\u670d\u52a1\nhelm upgrade --install demo ./demo -n default \\\n--set image.repository='harbor.local.domain/baiyuani/demo' \\\n--set image.imagePullSecrets[0]='harbor-registry'\n</code></pre>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaDocker/#4-containerd","title":"4. \u8865\u5145\uff1acontainerd\u914d\u7f6e","text":"<pre><code>#\u4ee5\u524d\u4f7f\u7528 docker-engine \u7684\u65f6\u5019\uff0c\u53ea\u9700\u8981\u4fee\u6539/etc/docker/daemon.json \u5c31\u884c\uff0c\u4f46\u662f\u65b0\u7248\u7684 k8s \u5df2\u7ecf\u4f7f\u7528 containerd \u4e86\uff0c\u6240\u4ee5\u8fd9\u91cc\u9700\u8981\u505a\u76f8\u5173\u914d\u7f6e\uff0c\u8981\u4e0d\u7136 containerd \u4f1a\u5931\u8d25\u3002\u8bc1\u4e66\uff08ca.crt\uff09\u53ef\u4ee5\u5728\u9875\u9762\u4e0a\u4e0b\u8f7d\uff1a\n\nmkdir /etc/containerd/harbor.local.domain\ncp ca.crt /etc/containerd/harbor.local.domain/\n\n\nvim /etc/containerd/config.toml\n[plugins.\"io.containerd.grpc.v1.cri\".registry]\n      config_path = \"\"\n\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.auths]\n\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.configs]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"harbor.local.domain\".tls]\n          ca_file = \"/etc/containerd/harbor.local.domain/ca.crt\"\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"harbor.local.domain\".auth]\n          username = \"admin\"\n          password = \"Harbor12345\"\n\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.headers]\n\n      [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors]\n        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"harbor.local.domain\"]\n          endpoint = [\"https://harbor.local.domain\"]\n\n\n#\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\nsystemctl daemon-reload\n#\u91cd\u542fcontainerd\nsystemctl restart containerd\n\ncat &lt;&lt;EOF &gt; /etc/crictl.yaml\nruntime-endpoint: unix:///run/containerd/containerd.sock\nimage-endpoint: unix:///run/containerd/containerd.sock\ntimeout: 10\ndebug: false\nEOF\n\n\ncrictl pull harbor.local.domain/bigdata/mysql:5.7.38\n</code></pre>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaHelm%28Bitnami%29/","title":"helm\u5b89\u88c5(bitnami)","text":"<p>\u8be5\u6587\u6863\u5185\u7684\u57df\u540dlocal.domain\u53ef\u4ee5\u66ff\u6362</p>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaHelm%28Bitnami%29/#1","title":"1. \u751f\u6210\u8bc1\u4e66","text":"<pre><code>mkdir certs &amp;&amp; cd certs/\n# \u6267\u884c\u5b8c\u4ee5\u4e0b3\u6761\u547d\u4ee4\u540e\uff0c\u5f53\u524d\u76ee\u5f55\u4e0b\u5e94\u8be5\u67094\u4e2a\u6587\u4ef6\n'*.local.domain.crt'  '*.local.domain.csr'  '*.local.domain.key'  '*.local.domain.srl'\n\n#\u7b7e\u53d1\u8bc1\u4e66\uff0c10\u5e74\u6709\u6548\u671f\nopenssl req -nodes -subj \"/C=CN/ST=Beijing/L=Beijing/CN=*.local.domain\" -newkey rsa:2048 -keyout *.local.domain.key -out *.local.domain.csr\nopenssl x509 -req -days 3650 -in *.local.domain.csr -signkey *.local.domain.key -out *.local.domain.crt\nopenssl x509 -req -in *.local.domain.csr -CA *.local.domain.crt -CAkey *.local.domain.key -CAcreateserial -out *.local.domain.crt -days 3650 \n\n\n# \u5c06\u8bc1\u4e66\u914d\u7f6edocker\u4fe1\u4efb\uff0c\u96c6\u7fa4\u91cc\u7684\u6240\u6709\u673a\u5668\u90fd\u914d\u7f6e\n# The Docker daemon interprets .crt files as CA certificates and .cert files as client certificates.\nopenssl x509 -inform PEM -in *.local.domain.crt -out *.local.domain.cert\nmkdir -p /etc/docker/certs.d/*.local.domain/\ncp *.local.domain.cert /etc/docker/certs.d/*.local.domain/\ncp *.local.domain.key /etc/docker/certs.d/*.local.domain/\ncp *.local.domain.crt /etc/docker/certs.d/*.local.domain/\nsystemctl daemon-reload\nsystemctl restart docker\n\n\n# \u5c06\u8bc1\u4e66\u6dfb\u52a0\u5230\u53ef\u4fe1\u8303\u56f4\uff0c\u96c6\u7fa4\u91cc\u7684\u6240\u6709\u673a\u5668\u90fd\u914d\u7f6e\n# centos\u914d\u7f6e\u65b9\u6cd5\nyum install -y ca-certificates\nupdate-ca-trust enable\ncp *.local.domain.crt /etc/pki/ca-trust/source/anchors/\nupdate-ca-trust extract\n# ubuntu\u914d\u7f6e\u65b9\u6cd5\ncp *.local.domain.crt /usr/local/share/ca-certificates\nupdate-ca-certificates\n</code></pre>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaHelm%28Bitnami%29/#2-host","title":"2. \u914d\u7f6e\u96c6\u7fa4host\u89e3\u6790","text":"<pre><code>kubectl -n kube-system edit cm coredns\n\n#\u5728data\u90e8\u5206\uff0c\u6dfb\u52a0hosts\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health {\n           lameduck 5s\n        }\n        ready\n        hosts {\n           192.168.1.11 harbor.local.domain notary.local.domain\n           fallthrough\n        }\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n           pods insecure\n           fallthrough in-addr.arpa ip6.arpa\n           ttl 30\n        }\n        prometheus :9153\n        forward . /etc/resolv.conf {\n           max_concurrent 1000\n        }\n        cache 30\n        loop\n        reload\n        loadbalance\n    }\nkind: ConfigMap\nmetadata:\n  name: coredns\n  namespace: kube-system\n\n\n\nvim /etc/hosts  #\u6bcf\u53f0\u673a\u5668\u90fd\u914d\u7f6e\n\n192.168.1.11 harbor.local.domain notary.local.domain\n</code></pre>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaHelm%28Bitnami%29/#3-harbor","title":"3. \u5b89\u88c5harbor","text":"<p>Charts\u53c2\u6570README</p> <pre><code>#\u6dfb\u52a0helm repo\uff0c\u521b\u5efaharbor\u547d\u540d\u7a7a\u95f4\nhelm repo add bitnami https://charts.bitnami.com/bitnami\nkubectl create ns harbor\n\n#\u521b\u5efa\u8bc1\u4e66secret\uff0c\u4f7f\u7528\u7b2c\u4e00\u6b65\u4e2d\u81ea\u7b7e\u7684\u8bc1\u4e66\nkubectl create secret tls -n harbor local.domain-tls --cert \\*.local.domain.crt --key \\*.local.domain.key\n\n\n#\u90e8\u7f72harbor\nhelm upgrade --install harbor bitnami/harbor -n harbor  \\\n--version=11.2.1  \\\n--set global.storageClass=nfs-client  \\\n--set harborAdminPassword=1qaz@WSX  \\\n--set service.type=ingress \\\n--set ingress.enabled=true \\\n--set ingress.hosts.core=harbor.local.domain  \\\n--set externalURL=harbor.local.domain  \\\n--set service.tls.existingSecret=local.domain-tls  \\\n--set chartmuseum.enabled=false  \\\n--set clair.enabled=false  \\\n--set notary.enabled=false  \\\n--set trivy.enabled=false  \\\n--dry-run --debug\n#helm upgrade --install harbor bitnami/harbor -n harbor  \\\n#--version=15.0.0  \\\n#--set global.storageClass='nfs-client'  \\\n#--set adminPassword='1qaz@WSX'  \\\n#--set externalURL='https://harbor.local.domain' \\\n#--set exposureType='ingress' \\\n#--set ingress.core.hostname='harbor.local.domain'  \\\n#--set ingress.notary.hostname='notary.local.domain'  \\\n#--set persistence.resourcePolicy='' \\\n#--set persistence.persistentVolumeClaim.registry.size='5Gi' \\\n#--set persistence.persistentVolumeClaim.jobservice.size='1Gi' \\\n#--set persistence.persistentVolumeClaim.chartmuseum.size='5Gi' \\\n#--set persistence.persistentVolumeClaim.trivy.size='5Gi' \\\n#--set ingress.core.extraTls[0].secretName='local.domain-tls'   \\\n#--set ingress.core.extraTls[0].hosts[0]='harbor.local.domain'   \\\n#--set ingress.notary.extraTls[0].secretName='local.domain-tls'   \\\n#--set ingress.notary.extraTls[0].hosts[0]='notary.local.domain'   \\\n#--set chartmuseum.enabled='true'  \\\n#--set notary.enabled='true'  \\\n#--set trivy.enabled='true'  \\\n#--dry-run --debug\n</code></pre>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaHelm%28Bitnami%29/#4","title":"4. \u4f7f\u7528","text":"<p>\u8df3\u677f\u673a\u914d\u7f6ehost\uff1a192.168.1.11 harbor.local.domain \uff0c\u6d4f\u89c8\u5668\u8bbf\u95eehttps://harbor.local.domain \uff0c\u4f7f\u7528admin/1qaz@WSX\u767b\u5f55harbor</p>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaHelm%28Official%29/","title":"helm\u5b89\u88c5","text":"<p>https://github.com/goharbor/harbor-helm</p>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaHelm%28Official%29/#1","title":"1.\u751f\u6210\u8bc1\u4e66","text":"<pre><code>mkdir certs &amp;&amp; cd certs/\n# \u6267\u884c\u5b8c\u4ee5\u4e0b3\u6761\u547d\u4ee4\u540e\uff0c\u5f53\u524d\u76ee\u5f55\u4e0b\u5e94\u8be5\u67094\u4e2a\u6587\u4ef6\n'*.local.domain.crt'  '*.local.domain.csr'  '*.local.domain.key'  '*.local.domain.srl'\n\n#\u7b7e\u53d1\u8bc1\u4e66\uff0c10\u5e74\u6709\u6548\u671f\nopenssl req -nodes -subj \"/C=CN/ST=Beijing/L=Beijing/CN=*.local.domain\" -newkey rsa:2048 -keyout *.local.domain.key -out *.local.domain.csr\nopenssl x509 -req -days 3650 -in *.local.domain.csr -signkey *.local.domain.key -out *.local.domain.crt\nopenssl x509 -req -in *.local.domain.csr -CA *.local.domain.crt -CAkey *.local.domain.key -CAcreateserial -out *.local.domain.crt -days 3650 \n\n\n# \u5c06\u8bc1\u4e66\u914d\u7f6edocker\u4fe1\u4efb\uff0c\u96c6\u7fa4\u91cc\u7684\u6240\u6709\u673a\u5668\u90fd\u914d\u7f6e\n# The Docker daemon interprets .crt files as CA certificates and .cert files as client certificates.\nopenssl x509 -inform PEM -in *.local.domain.crt -out *.local.domain.cert\nmkdir -p /etc/docker/certs.d/*.local.domain/\ncp *.local.domain.cert /etc/docker/certs.d/*.local.domain/\ncp *.local.domain.key /etc/docker/certs.d/*.local.domain/\ncp *.local.domain.crt /etc/docker/certs.d/*.local.domain/\nsystemctl daemon-reload\nsystemctl restart docker\n\n\n# \u5c06\u8bc1\u4e66\u6dfb\u52a0\u5230\u53ef\u4fe1\u8303\u56f4\uff0c\u96c6\u7fa4\u91cc\u7684\u6240\u6709\u673a\u5668\u90fd\u914d\u7f6e\n# centos\u914d\u7f6e\u65b9\u6cd5\nyum install -y ca-certificates\nupdate-ca-trust enable\ncp *.local.domain.crt /etc/pki/ca-trust/source/anchors/\nupdate-ca-trust extract\n# ubuntu\u914d\u7f6e\u65b9\u6cd5\ncp *.local.domain.crt /usr/local/share/ca-certificates\nupdate-ca-certificates\n</code></pre>"},{"location":"kubernetes/k8s-platform/harbor/installHarborViaHelm%28Official%29/#2-host","title":"2. \u914d\u7f6e\u96c6\u7fa4host\u89e3\u6790","text":"<pre><code>kubectl -n kube-system edit cm coredns\n\n#\u5728data\u90e8\u5206\uff0c\u6dfb\u52a0hosts\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health {\n           lameduck 5s\n        }\n        ready\n        hosts {\n           192.168.1.11 harbor.local.domain notary.local.domain\n           fallthrough\n        }\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n           pods insecure\n           fallthrough in-addr.arpa ip6.arpa\n           ttl 30\n        }\n        prometheus :9153\n        forward . /etc/resolv.conf {\n           max_concurrent 1000\n        }\n        cache 30\n        loop\n        reload\n        loadbalance\n    }\nkind: ConfigMap\nmetadata:\n  name: coredns\n  namespace: kube-system\n\n\n\nvim /etc/hosts  #\u6bcf\u53f0\u673a\u5668\u90fd\u914d\u7f6e\n\n192.168.1.11 harbor.local.domain notary.local.domain\n</code></pre> <ul> <li>\u5b89\u88c5 <pre><code>helm repo add harbor https://helm.goharbor.io\nhelm fetch harbor/harbor --untar\nkubectl create ns harbor\n\nkubectl create secret tls -n harbor local.domain-tls --cert \\*.local.domain.crt --key \\*.local.domain.key\n\nhelm upgrade --install harbor --namespace harbor harbor/harbor \\\n  --version=1.10.1 \\\n  --set expose.tls.certSource='secret' \\\n  --set expose.tls.secret.secretName='local.domain-tls' \\\n  --set expose.tls.secret.notarySecretName='local.domain-tls' \\\n  --set expose.ingress.hosts.core='harbor.local.domain' \\\n  --set expose.ingress.hosts.notary='notary.local.domain' \\\n  --set-string expose.ingress.annotations.'nginx\\.org/client-max-body-size'=\"1024m\" \\\n  --set persistence.persistentVolumeClaim.registry.storageClass=nfs-client \\\n  --set persistence.persistentVolumeClaim.registry.size='500G' \\\n  --set persistence.persistentVolumeClaim.registry.accessMode='ReadWriteMany' \\\n  --set persistence.persistentVolumeClaim.chartmuseum.storageClass=nfs-client \\\n  --set persistence.persistentVolumeClaim.chartmuseum.size='100G' \\\n  --set persistence.persistentVolumeClaim.chartmuseum.accessMode='ReadWriteMany' \\\n  --set persistence.persistentVolumeClaim.jobservice.jobLog.storageClass=nfs-client \\\n  --set persistence.persistentVolumeClaim.jobservice.jobLog.size='20G' \\\n  --set persistence.persistentVolumeClaim.jobservice.jobLog.accessMode='ReadWriteMany' \\\n  --set persistence.persistentVolumeClaim.jobservice.scanDataExports.storageClass=nfs-client \\\n  --set persistence.persistentVolumeClaim.jobservice.scanDataExports.size='20G' \\\n  --set persistence.persistentVolumeClaim.jobservice.scanDataExports.accessMode='ReadWriteMany' \\\n  --set persistence.persistentVolumeClaim.database.storageClass=nfs-client \\\n  --set persistence.persistentVolumeClaim.database.size='500G' \\\n  --set persistence.persistentVolumeClaim.redis.storageClass=nfs-client \\\n  --set persistence.persistentVolumeClaim.redis.size='20G' \\\n  --set persistence.persistentVolumeClaim.trivy.storageClass=nfs-client \\\n  --set persistence.persistentVolumeClaim.trivy.size='500G' \\\n  --set externalURL=https://harbor.local.domain \\\n  --set harborAdminPassword='Harbor12345'\n\n\n# \u5176\u4ed6\n  --set-string expose.ingress.harbor.annotations.'cert-manager\\.io/cluster-issuer'='cluster-issuer' \\\n  --set-string expose.ingress.harbor.annotations.'kubernetes\\.io/tls-acme'=\"true\" \\\n  --set-string expose.ingress.notary.annotations.'cert-manager\\.io/cluster-issuer'='cluster-issuer' \\\n  --set-string expose.ingress.notary.annotations.'kubernetes\\.io/tls-acme'=\"true\" \\\n</code></pre></li> </ul>"},{"location":"kubernetes/k8s-platform/harbor/docker-ce-offline/readme/","title":"\u79bb\u7ebf\u5b89\u88c5docker-ce","text":""},{"location":"kubernetes/k8s-platform/harbor/docker-ce-offline/readme/#_1","title":"\u6b65\u9aa4","text":"<ul> <li>\u5728\u4e0e\u79bb\u7ebf\u670d\u52a1\u5668\u76f8\u540c\u53d1\u884c\u7248\u7684\u5728\u7ebf\u673a\u5668\u4e0a\u6267\u884cprepare.sh</li> <li>\u5c06\u76ee\u5f55\u6253\u5305\uff0c\u4f20\u8f93\u5230\u79bb\u7ebf\u673a\u5668\u4e0a\uff0c\u6267\u884cinstall.sh</li> </ul>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/","title":"ingress-nginx-controller","text":"<ol> <li> <p>official-ingress-nginx-4.7.5</p> <p>ingress-nginx \u5b98\u65b9charts\uff0c\u9700\u8981\u96c6\u7fa4\u7248\u672cv1.20+</p> </li> <li> <p>official-ingress-nginx-3.41.0</p> <p>ingress-nginx \u5b98\u65b9charts\uff0c\u9700\u8981\u96c6\u7fa4\u7248\u672cv1.16+</p> </li> <li> <p>bitnami-nginx-ingress-controller-9.2.6</p> <p>\u9700\u8981\u96c6\u7fa4v1.19+</p> </li> <li> <p>bitnami-nginx-ingress-controller-9.3.24</p> <p>\u9700\u8981\u96c6\u7fa4\u7248\u672cv1.20+</p> </li> </ol>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/bitnami-nginx-ingress-controller-9.2.6/","title":"bitnami 9.2.6","text":""},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/bitnami-nginx-ingress-controller-9.2.6/#nginx-ingress-controllerdockerio","title":"nginx-ingress-controller\uff08\u955c\u50cf\u6e90\u662fdocker.io\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\uff09","text":"<p>chart: https://github.com/bitnami/charts/tree/master/bitnami/nginx-ingress-controller   \\ 9.2.6\u7248\u672c\uff1ahttps://github.com/bitnami/charts/tree/ff3cf617a1680509b0f3855d17c4ccff7b29a0ff/bitnami/nginx-ingress-controller</p>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/bitnami-nginx-ingress-controller-9.2.6/#prerequisites","title":"Prerequisites","text":"<p>Kubernetes 1.19+ Helm 3.2.0+</p> <p>values.yaml nginx-ingress-controller-9.2.6.tgz</p> <pre><code># \u5728values.yaml config \u6dfb\u52a0\u81ea\u5b9a\u4e49\u914d\u7f6e\nhelm upgrade --install nginx-ingress-controller ./nginx-ingress-controller-9.2.6.tgz -f values.yaml \\\n-n ingress-nginx --create-namespace \\\n--set ingressClassResource.default=true \\\n--set kind=DaemonSet \\\n--set daemonset.useHostPort=true \\\n--set hostNetwork=true \\\n--set dnsPolicy=ClusterFirstWithHostNet  \\\n--set service.type=ClusterIP \\\n--set defaultBackend.enabled=false\n\n\n# \u5f00\u542fprometheus metrics\n--set metrics.enabled=true \\\n--set metrics.serviceMonitor.enabled=true \\\n\n# \u5728\u539f\u57fa\u7840\u4e0a\u5347\u7ea7\u547d\u4ee4\u683c\u5f0f\u53c2\u8003\nhelm get values -n ingress-nginx nginx-ingress-controller | helm upgrade \\\n-n ingress-nginx nginx-ingress-controller ./nginx-ingress-controller-9.2.6.tgz \\\n--set defaultBackend.enabled=true \\\n-f -\n</code></pre>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/bitnami-nginx-ingress-controller-9.3.24/","title":"bitnami 9.3.24","text":""},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/bitnami-nginx-ingress-controller-9.3.24/#1-bitnamidockerio","title":"1. bitnami\uff08\u955c\u50cf\u6e90\u662fdocker.io\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\uff09","text":"<p>chart: https://github.com/bitnami/charts/tree/master/bitnami/nginx-ingress-controller   \\ 9.3.24\u7248\u672c\uff1ahttps://github.com/bitnami/charts/tree/19e4632397176172c143a226ec0e30e0a1bcb86c/bitnami/nginx-ingress-controller</p>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/bitnami-nginx-ingress-controller-9.3.24/#prerequisites","title":"Prerequisites","text":"<p>Kubernetes 1.20+ Helm 3.2.0+</p> <p>values.yaml</p> <pre><code># \u5728values.yaml config \u6dfb\u52a0\u81ea\u5b9a\u4e49\u914d\u7f6e\nhelm repo add bitnami https://charts.bitnami.com/bitnami\nhelm repo update\nhelm upgrade --install nginx-ingress-controller bitnami/nginx-ingress-controller --version=9.3.24 -f values.yaml \\\n-n ingress-nginx --create-namespace \\\n--set ingressClassResource.default=true \\\n--set kind=DaemonSet \\\n--set daemonset.useHostPort=true \\\n--set hostNetwork=true \\\n--set dnsPolicy=ClusterFirstWithHostNet  \\\n--set service.type=ClusterIP \\\n--set defaultBackend.enabled=false\n\n\n# \u5f00\u542fprometheus metrics\n--set metrics.enabled=true \\\n--set metrics.serviceMonitor.enabled=true \\\n\n# \u5728\u539f\u57fa\u7840\u4e0a\u5347\u7ea7\nhelm get values -n ingress-nginx nginx-ingress-controller | helm upgrade \\\n-n ingress-nginx nginx-ingress-controller bitnami/nginx-ingress-controller \\\n--set defaultBackend.enabled=true \\\n--version=9.3.24 \\\n-f -\n</code></pre>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/ingress-errors/","title":"Index","text":""},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/ingress-errors/#_1","title":"\u4fee\u6539\u62a5\u9519\u9875\u9762\uff0c\u9632\u6b62\u6cc4\u9732\u670d\u52a1\u5668\u4fe1\u606f","text":"<p>\u53ef\u4ee5\u53c2\u7167\u5b98\u65b9\u7684\u6587\u6863\u8bf4\u660e\uff0c\u914d\u7f6e\u6d41\u7a0b\u5982\u4e0b\u3002</p> <p>custom-default-backend.yaml</p>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/ingress-errors/#1","title":"1. \u90e8\u7f72\u9ed8\u8ba4\u540e\u7aef","text":"<pre><code>kubectl -n ingress-nginx create -f custom-default-backend.yaml\n\n\nkubectl get deploy,svc -n ingress-nginx\nNAME                           DESIRED   CURRENT   READY     AGE\ndeployment.apps/nginx-errors   1         1         1         10s\n\nNAME                   TYPE        CLUSTER-IP  EXTERNAL-IP   PORT(S)   AGE\nservice/nginx-errors   ClusterIP   10.0.0.12   &lt;none&gt;        80/TCP    10s\n</code></pre>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/ingress-errors/#2","title":"2. \u914d\u7f6e\u542f\u52a8\u53c2\u6570","text":"<p>\u4fee\u6539Ingress controller\u63a7\u5236\u5668\u7684\u542f\u52a8\u53c2\u6570\uff0c\u52a0\u5165\u4ee5\u4e0b\u914d\u7f6e\uff0c\u901a\u8fc7--default-backend\u6807\u5fd7\u7684\u503c\u8bbe\u7f6e\u4e3a\u65b0\u521b\u5efa\u7684\u9519\u8bef\u540e\u7aef\u7684\u540d\u79f0\uff0c\u6ce8\u610f\u5c06\u91cd\u542fingress controller</p> <pre><code>kubectl -n ingress-nginx edit ds nginx-ingress-controller\n    spec:\n      containers:\n      - args:\n        - /nginx-ingress-controller\n        - --configmap=$(POD_NAMESPACE)/nginx-configuration\n        - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services\n        - --udp-services-configmap=$(POD_NAMESPACE)/udp-services\n        - --publish-service=$(POD_NAMESPACE)/ingress-nginx\n        - --annotations-prefix=nginx.ingress.kubernetes.io\n        - --default-backend-service=ingress-nginx/nginx-errors  # \u6dfb\u52a0\u6b64\u884c\n</code></pre>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/ingress-errors/#3-configmap","title":"3. \u4fee\u6539configmap","text":"<p>\u4fee\u6539\u5bf9\u5e94\u7684configmap\u6307\u5b9a\u8981\u5173\u8054\u5230\u9ed8\u8ba4\u540e\u7aef\u670d\u52a1\u7684\u670d\u52a1\u72b6\u6001\u7801\uff0c\u610f\u5473\u7740\u5982\u679c\u72b6\u6001\u7801\u662f\u914d\u7f6e\u9879\u4e2d\u7684\u503c\uff0c\u90a3\u4e48\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u6d4f\u89c8\u5668\u7684\u5c31\u662f\u9ed8\u8ba4\u540e\u7aef\u670d\u52a1</p> <pre><code>kubectl -n ingress-nginx edit configmap nginx-configuration\ndata:\n  custom-http-errors: 403,404,500,502,503,504 # \u6dfb\u52a0\u6b64\u884c\n</code></pre>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/ingress-errors/#4","title":"4. \u6d4b\u8bd5","text":"<p>\u901a\u8fc7\u7ec8\u7aef\u547d\u4ee4\u8bbf\u95ee\u4e0a\u9762404\u548c503\u9875\u9762\u7684\u4e24\u4e2a\u57df\u540d <pre><code>curl example.bar.com/asdasdasd                         \n5xx html                                                                                                                                                                        #  ingress-nginx curl example.foo.com                              \n&lt;span&gt;The page you're looking for could not be found.&lt;/span&gt;\n#  \u81ea\u5b9a\u4e49Accept\u6807\u5934\n#  ingress-nginx curl -H 'Accept: application/json' example.foo.com\n{ \"message\": \"The page you're looking for could not be found\" }\n\u53ef\u4ee5\u770b\u5230\u9ed8\u8ba4\u540e\u7aef\u5c06404\u72b6\u6001\u7801\u8fd4\u56de\u4e86\u5b57\u7b26\u4e32\uff0c503\u8fd4\u56de\u4e865xx html\u7684\u5b57\u7b26\u4e32\u3002\u7f3a\u70b9\u5728\u4e8e\u8fd9\u6837\u7684\u60c5\u51b5\u5982\u679c\u7528\u6d4f\u89c8\u5668\u8fdb\u884c\u8bbf\u95ee\uff0c\u4ec5\u4ec5\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32\u6587\u672c\u751a\u81f3\u65e0\u6cd5\u6b63\u5e38\u663e\u793a\uff0c\u56e0\u6b64\u9700\u8981\u91cd\u65b0\u5b9a\u4e49\u8fd9\u4e2a\u9ed8\u8ba4\u540e\u7aef\u670d\u52a1\uff0c\u63d0\u4f9b\u53cb\u597d\u7684\u754c\u9762\u8fd4\u56de\u3002\n</code></pre></p>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/ingress-errors/#5-kubernetes-nginx-ingress","title":"5. \u6df1\u5ea6\u5b9a\u5236 Kubernetes Nginx Ingress \u9519\u8bef\u63d0\u793a\u9875\u9762","text":""},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/log/","title":"\u65e5\u5fd7\u6302\u8f7d","text":"<p>ingress-log-pvc.yaml ingress-log-pv.yaml</p>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/log/#1ingresspvcingress","title":"1.ingress\u6dfb\u52a0PVC\u7528\u4e8eingress\u65e5\u5fd7\u5b58\u50a8","text":"<pre><code>kubectl apply -f ingress-log-pvc.yaml\n#kubectl apply -f ingress-log-pv.yaml\n</code></pre>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/log/#2ingress","title":"2.ingress\u4fee\u6539\u65e5\u5fd7\u683c\u5f0f\u548c\u5b58\u50a8\u4f4d\u7f6e","text":"<pre><code>kubectl -n ingress-nginx edit cm ingress-nginx-controller \n</code></pre> <pre><code>data: \n  access-log-path: /var/log/ingress/access.log      \n  error-log-path: /var/log/ingress/error.log    \n#  log-format-upstream: '{\"x-forward-for\": \"$proxy_add_x_forwarded_for\",\"remote_addr\": \"$remote_addr\",\"@timestamp\": \"$time_iso8601\",\"remote_user\": \"$remote_user\",\"bytes_sent\": \"$bytes_sent\",\"status\": \"$status\",\"vhost\": \"$host\",\"request_proto\": \"$server_protocol\",\"method\": \"$request_method\",\"path\": \"$uri\",\"request_query\": \"$args\",\"request_length\": \"$request_length\",\"http_referrer\": \"$http_referer\",\"http_user_agent\": \"$http_user_agent\",\"upstream_response_length\": \"$upstream_response_length\",\"upstream_response_time\": \"$upstream_response_time\",\"upstream_status\": \"$upstream_status\",\"request_time\": \"$request_time\"}'\n  log-format-upstream: '{\"@timestamp\": \"$time_iso8601\",\"remote_addr\": \"$remote_addr\",\"x-forward-for\": \"$proxy_add_x_forwarded_for\",\"request_id\": \"$req_id\",\"remote_user\": \"$remote_user\",\"bytes_sent\": $bytes_sent,\"request_time\": $request_time,\"status\": $status,\"vhost\": \"$host\",\"request_proto\": \"$server_protocol\",\"path\": \"$uri\",\"request_query\": \"$args\",\"request_length\": $request_length,\"duration\": $request_time,\"method\": \"$request_method\",\"http_referrer\": \"$http_referer\",\"http_user_agent\": \"$http_user_agent\",\"upstream-sever\":\"$proxy_upstream_name\",\"proxy_alternative_upstream_name\":\"$proxy_alternative_upstream_name\",\"upstream_addr\":\"$upstream_addr\",\"upstream_response_length\":$upstream_response_length,\"upstream_response_time\":$upstream_response_time,\"upstream_status\":$upstream_status}'\n  use-forwarded-headers: \"true\"\n  enable-underscores-in-headers: 'true' # \u652f\u6301\u4e0b\u5212\u7ebf\n  http-redirect-code: '301'             #301\u8f6c\u53d1\u517c\u5bb9\u4f4e\u7248\u672c\u5185\u6838\u6d4f\u89c8\u5668\u914d\u7f6e\n  max-worker-connections: '65531'       #\u66f4\u6539\u8fde\u63a5\u6570\n  proxy-body-size: 100m                  #\u5305\u5934\u5927\u5c0f\n  proxy-read-timeout: '720'             #\u6570\u636e\u8bfb\u53d6\u65f6\u95f4\u8bbe\u7f6e\n  server-tokens: 'false'                #\u5173\u95ednginx\u7248\u672c\u53f7\n#  ssl-ciphers: \"ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA\"\n#  ssl-ciphers: \"ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA256:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA\"\n  ssl-protocols: \"TLSv1 TLSv1.1 TLSv1.2 TLSv1.3\"  #\u517c\u5bb9TLSv1.3\n</code></pre>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/log/#3ingresstzasiashanghai","title":"3.ingress\u6dfb\u52a0\u6302\u8f7d(\u8bb0\u5f97\u589e\u52a0TZ/AsiaShanghai\u73af\u5883\u53d8\u91cf)","text":"<pre><code>kubectl -n ingress-nginx edit daemonsets.apps ingress-nginx-controller\n        - name: TZ\n          value: \"Asia/Shanghai\"\n ......      \n        volumeMounts:      \n        - mountPath: /var/log/ingress      \n          name: ingress-log\n          readOnly: false\n      ......      \n      volumes:      \n      - name: ingress-log    \n        persistentVolumeClaim:      \n          claimName: ingress-log\n</code></pre>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/log/#4","title":"4.\u914d\u7f6e\u6e05\u7406\u811a\u672c","text":"<pre><code>chmod +x log_auto_handle.sh\n(crontab -l; echo '0 3 * * * log_auto_handle.sh &amp;&gt; /dev/null') | crontab\n</code></pre>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/official-ingress-nginx-3.41.0/","title":"\u5b98\u65b9 3.41.0","text":"<p>github\uff1a https://github.com/kubernetes/ingress-nginx     \\ \u90e8\u7f72\u6587\u6863\uff1a https://kubernetes.github.io/ingress-nginx/deploy/    \\ charts:  https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx  \\</p>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/official-ingress-nginx-3.41.0/#prerequisites","title":"Prerequisites","text":"<p>Chart version 3.x.x: Kubernetes v1.16+</p>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/official-ingress-nginx-3.41.0/#_1","title":"\u5b89\u88c5","text":"<pre><code># yaml\u65b9\u5f0f\u90e8\u7f72\nkubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.51.0/deploy/static/provider/cloud/deploy.yaml\n</code></pre> <pre><code># helm\u65b9\u5f0f\u90e8\u7f72\nhelm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx\nhelm repo update\nhelm upgrade --install ingress-nginx ingress-nginx/ingress-nginx --timeout 20m0s \\\n--version 3.41.0 \\\n--namespace ingress-nginx --create-namespace  \\\n--set controller.image.image='nginx-ingress-controller' \\\n--set controller.image.registry='registry.aliyuncs.com/google_containers' \\\n--set controller.admissionWebhooks.patch.image.image='kube-webhook-certgen' \\\n--set controller.admissionWebhooks.patch.image.registry='registry.aliyuncs.com/google_containers' \\\n--set controller.kind=DaemonSet  \\\n--set controller.dnsPolicy=ClusterFirstWithHostNet  \\\n--set controller.hostNetwork=true  \\\n--set controller.ingressClassResource.enabled=true  \\\n--set controller.ingressClassResource.default=true  \\\n--set controller.config.log-format-upstream='$remote_addr - $remote_user [$time_local] \"$request\" $status $body_bytes_sent \"$http_referer\" \"$http_user_agent\" $request_length $request_time [$proxy_upstream_name] [$proxy_alternative_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id $http_x_correlation_id' \\\n--set controller.config.enable-underscores-in-headers='true' \\\n--set controller.config.max-worker-connections='65531' \\\n--set controller.config.server-tokens='false'  \\\n--set controller.config.use-gzip=\"true\" \\\n--set controller.config.ssl-redirect=\"false\"\n\n\n# \u5f00\u542fprometheus metrics\n--set controller.metrics.enabled=true \\\n--set controller.metrics.serviceMonitor.enabled=true \\\n\n# configmap\u53c2\u6570\n--set controller.config.access-log-path='/var/log/ingress/access.log'  \\\n--set controller.config.error-log-path='/var/log/ingress/error.log'  \\\n--set controller.config.log-format-upstream='{\"@timestamp\": \"$time_iso8601\",\"remote_addr\": \"$remote_addr\",\"x-forward-for\": \"$proxy_add_x_forwarded_for\",\"request_id\": \"$req_id\",\"remote_user\": \"$remote_user\",\"bytes_sent\": $bytes_sent,\"request_time\": $request_time,\"status\": $status,\"vhost\": \"$host\",\"request_proto\": \"$server_protocol\",\"path\": \"$uri\",\"request_query\": \"$args\",\"request_length\": $request_length,\"duration\": $request_time,\"method\": \"$request_method\",\"http_referrer\": \"$http_referer\",\"http_user_agent\": \"$http_user_agent\",\"upstream-sever\":\"$proxy_upstream_name\",\"proxy_alternative_upstream_name\":\"$proxy_alternative_upstream_name\",\"upstream_addr\":\"$upstream_addr\",\"upstream_response_length\":$upstream_response_length,\"upstream_response_time\":$upstream_response_time,\"upstream_status\":$upstream_status}'  \\\n--set controller.config.use-forwarded-headers=\"true\"  \\\n--set controller.config.enable-underscores-in-headers='true' \\\n--set controller.config.http-redirect-code='301'   \\\n--set controller.config.max-worker-connections='65531' \\\n--set controller.config.proxy-body-size=100m  \\\n--set controller.config.proxy-read-timeout='720'   \\\n--set controller.config.server-tokens='false'  \\\n--set controller.config.ssl-protocols=\"TLSv1 TLSv1.1 TLSv1.2 TLSv1.3\"  \\\n--set controller.config.use-gzip=\"true\" \n</code></pre>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/official-ingress-nginx-4.7.5/","title":"\u5b98\u65b9 4.7.5","text":"<p>github\uff1a https://github.com/kubernetes/ingress-nginx    \u90e8\u7f72\u6587\u6863\uff1a https://kubernetes.github.io/ingress-nginx/deploy/   charts:  https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx  </p>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/official-ingress-nginx-4.7.5/#prerequisites","title":"Prerequisites","text":"<p>Chart version 4.x.x and above: Kubernetes v1.20+</p>"},{"location":"kubernetes/k8s-platform/ingress-nginx-controller/official-ingress-nginx-4.7.5/#_1","title":"\u5b89\u88c5","text":"<pre><code># yaml\u65b9\u5f0f\u90e8\u7f72\nkubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml\n</code></pre> <pre><code># helm\u65b9\u5f0f\u90e8\u7f72\nhelm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx\nhelm repo update\nhelm upgrade --install ingress-nginx ingress-nginx/ingress-nginx --timeout 20m0s \\\n--version 4.7.5 \\\n--namespace ingress-nginx --create-namespace  \\\n--set controller.image.image='nginx-ingress-controller' \\\n--set controller.image.registry='registry.aliyuncs.com/google_containers' \\\n--set controller.admissionWebhooks.patch.image.image='kube-webhook-certgen' \\\n--set controller.admissionWebhooks.patch.image.registry='registry.aliyuncs.com/google_containers' \\\n--set controller.kind=DaemonSet  \\\n--set controller.dnsPolicy=ClusterFirstWithHostNet  \\\n--set controller.hostNetwork=true  \\\n--set controller.ingressClassResource.default=true  \\\n--set controller.priorityClassName='system-cluster-critical' \\\n--set controller.config.log-format-upstream='$remote_addr - $remote_user [$time_local] \"$request\" $status $body_bytes_sent \"$http_referer\" \"$http_user_agent\" $request_length $request_time [$proxy_upstream_name] [$proxy_alternative_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id $http_x_correlation_id' \\\n--set controller.config.enable-underscores-in-headers='true' \\\n--set controller.config.max-worker-connections='65531' \\\n--set controller.config.server-tokens='false'  \\\n--set controller.config.use-gzip=\"true\" \\\n--set controller.config.ssl-redirect=\"false\" \\\n--set controller.config.allow-snippet-annotations=true\n\n# \u5f00\u542fprometheus metrics\n--set controller.metrics.enabled=true \\\n--set controller.metrics.serviceMonitor.enabled=true \\\n\n# configmap\u53c2\u6570\n--set controller.config.access-log-path='/var/log/ingress/access.log'  \\\n--set controller.config.error-log-path='/var/log/ingress/error.log'  \\\n--set controller.config.use-forwarded-headers=\"true\"  \\\n--set controller.config.enable-underscores-in-headers='true' \\\n--set controller.config.http-redirect-code='301'   \\\n--set controller.config.max-worker-connections='65531' \\\n--set controller.config.proxy-body-size=100m  \\\n--set controller.config.proxy-read-timeout='720'   \\\n--set controller.config.server-tokens='false'  \\\n--set controller.config.ssl-protocols=\"TLSv1 TLSv1.1 TLSv1.2 TLSv1.3\"  \\\n--set controller.config.use-gzip=\"true\" \n</code></pre>"},{"location":"kubernetes/k8s-platform/lb/official/readme/","title":"Readme","text":""},{"location":"kubernetes/k8s-platform/lb/official/readme/#k8s","title":"k8s\u5b98\u65b9\u6587\u6863","text":"<p>https://github.com/kubernetes/kubeadm/blob/main/docs/ha-considerations.md</p> <p>keepalived.yaml</p> <p>haproxy.yaml</p>"},{"location":"kubernetes/k8s-platform/local-path-provisioner/readme/","title":"local-path-provisioner","text":""},{"location":"kubernetes/k8s-platform/local-path-provisioner/readme/#_1","title":"\u5b89\u88c5","text":"<p>https://github.com/rancher/local-path-provisioner</p>"},{"location":"kubernetes/k8s-platform/local-path-provisioner/readme/#_2","title":"\u5b89\u88c5\u8981\u6c42","text":"<p>k8s &gt; 1.12</p>"},{"location":"kubernetes/k8s-platform/local-path-provisioner/readme/#_3","title":"\u5b89\u88c5\u6b65\u9aa4","text":"<p>\u5982\u679c\u73af\u5883\u4e2d\u5df2\u7ecf\u4f7f\u7528k8s-playbook\u81ea\u52a8\u5b89\u88c5\u4e86local-path-provisioner\uff0c\u4e5f\u53ef\u4ee5\u6309\u4e0b\u9762\u6b65\u9aa4\u518d\u6b21\u5b89\u88c5\uff0c\u6ca1\u6709\u5f71\u54cd</p>"},{"location":"kubernetes/k8s-platform/local-path-provisioner/readme/#1-local-path-storageyamlpodlocal-path","title":"1. \u4fee\u6539local-path-storage.yaml\u4e2d\u7684\u5b58\u50a8\u8def\u5f84\u914d\u7f6e\uff08\u4f1a\u5c06\u8be5\u8282\u70b9\u4e0apod\u4f7f\u7528local-path\u65f6\u7684\u6570\u636e\u5b58\u653e\u5728\u8be5\u76ee\u5f55\uff09\uff0c\u4ee5\u4e0b\u4e3a\u51e0\u79cd\u914d\u7f6e\u793a\u4f8b","text":"<ul> <li>\u9ed8\u8ba4\u8def\u5f84\uff08\u5373\u6ca1\u6709\u4e3a\u8282\u70b9\u660e\u786e\u5b58\u50a8\u8def\u5f84\u65f6\uff0c\u6240\u6709\u8282\u70b9\u90fd\u4f7f\u7528\u8be5\u914d\u7f6e\uff09</li> </ul> <pre><code>data:\n  config.json: |-\n    {\n            \"nodePathMap\":[\n            {\n                    \"node\":\"DEFAULT_PATH_FOR_NON_LISTED_NODES\",\n                    \"paths\":[\"/opt/local-path-provisioner\"]\n            }\n            ]\n    }\n</code></pre> <ul> <li>\u4e3a<code>k8s-node1</code>\u5355\u72ec\u8bbe\u7f6e\u5b58\u50a8\u8def\u5f84\uff08\u5373<code>k8s-node1</code>\u4e0a\u7684pod\u4f7f\u7528local-path\u65f6\uff0c\u5c06\u6570\u636e\u5b58\u50a8\u5728<code>/data/local-path-provisioner</code>\u76ee\u5f55\uff0c\u5176\u4ed6\u8282\u70b9\u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\uff09</li> </ul> <pre><code>data:\n  config.json: |-\n    {\n            \"nodePathMap\":[\n            {\n                    \"node\":\"DEFAULT_PATH_FOR_NON_LISTED_NODES\",\n                    \"paths\":[\"/opt/local-path-provisioner\"]\n            },\n            {\n                    \"node\":\"k8s-node1\",\n                    \"paths\":[\"/data/local-path-provisioner\"]\n            }\n            ]\n    }\n</code></pre> <ul> <li>\u96c6\u7fa4\u4e2d\u6709\u4e24\u53f0\u8fd0\u884c\u6570\u636e\u5e93\u7684\u8282\u70b9\uff0c\u8282\u70b9\u540d\u79f0\u4e3a<code>mariadb-primary</code>\u548c<code>mariadb-secondary</code>\uff0c\u5176\u4ed6\u8282\u70b9\u4e0d\u63d0\u4f9blocal-path</li> </ul> <pre><code>data:\n  config.json: |-\n    {\n            \"nodePathMap\":[\n            {\n                    \"node\":\"mariadb-primary\",\n                    \"paths\":[\"/data/local-path-provisioner\"]\n            },\n            {\n                    \"node\":\"mariadb-secondary\",\n                    \"paths\":[\"/data/local-path-provisioner\"]\n            }\n            ]\n    }\n</code></pre>"},{"location":"kubernetes/k8s-platform/local-path-provisioner/readme/#2","title":"2. \u6267\u884c\u5b89\u88c5","text":"<pre><code>kubectl apply -f ./local-path-storage.yaml\n</code></pre> <p>\u6ce8\u610f\uff1a</p> <ul> <li>\u4f7f\u7528\u4e86\u8be5\u5b58\u50a8\u7684pod\u5c3d\u91cf\u907f\u514d\u968f\u610f\u8c03\u5ea6\uff0c\u9664\u975e\u5728\u90e8\u7f72\u8be5\u5b58\u50a8\u65f6\u9488\u5bf9\u6bcf\u4e2anode\u7684\u5b58\u50a8\u505a\u4e86\u914d\u7f6e\u3002\uff08\u5373\u5b8c\u5168\u6e05\u695a\u6570\u636e\u5c06\u5b58\u50a8\u5728\u54ea\u91cc\uff0c\u907f\u514d\u610f\u5916\u7684\u7a0b\u5e8f\u5c06\u78c1\u76d8\u5199\u6ee1\u5bfc\u81f4\u6545\u969c\uff09</li> <li>pvc\u521b\u5efa\u540e\uff0c\u4e0d\u4f1a\u7acb\u5373\u7ed1\u5b9a\uff0c\u4ec5\u5f53\u4f7f\u7528\u8be5pvc\u7684pod\u88ab\u8c03\u5ea6\u540e\uff0c\u518d\u4ece\u8c03\u5ea6\u8282\u70b9\u521b\u5efa<code>local</code>\u7c7b\u578b\u7684pv\u3002\u8fd9\u662f\u7531storageClass\u7684<code>volumeBindingMode: WaitForFirstConsumer</code>\u51b3\u5b9a\uff0c\u4e0d\u53ef\u4fee\u6539</li> <li>local\u7c7b\u578b\u7684pv\u4f1a\u8bbe\u7f6e<code>nodeAffinity</code>\u5b57\u6bb5\uff0c\u8fd9\u8981\u6c42\u4f7f\u7528\u8be5pv\u7684pod\u5fc5\u987b\u8c03\u5ea6\u5230\u7b26\u5408\u89c4\u5219\u7684\u8282\u70b9\u3002\uff08\u5373\u4e00\u5b9a\u5728pv\u88ab\u521b\u5efa\u65f6pod\u6240\u5728\u8282\u70b9\uff0c\u800c\u4e0d\u9700\u8981\u989d\u5916\u7684\u914d\u7f6e\u6765\u4fdd\u8bc1pod\u540e\u7eed\u6bcf\u6b21\u91cd\u542f\u7684\u8c03\u5ea6\uff09</li> </ul>"},{"location":"kubernetes/k8s-platform/log/efk/","title":"\u4f7f\u7528helm\u90e8\u7f72","text":"<ul> <li> <p>es\u5b98\u65b9charts </p> </li> <li> <p>filebeat\u5b98\u65b9charts </p> </li> <li> <p>kibana\u5b98\u65b9charts</p> </li> </ul> <p>filebeat-sidecar.yaml</p> <p>values.yaml</p> <pre><code># \u524d\u63d0\u6761\u4ef6\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u5c06\u60f3\u8981\u4f7f\u7528\u7684\u5b58\u50a8\u7c7b\u8bbe\u7f6e\u4e3a\u9ed8\u8ba4\uff0c\u6ce8\u610f\u66ff\u6362nfs-client\nkubectl patch storageclass nfs-client -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}'\n# \u955c\u50cf\u5728\u5916\u7f51\uff0c\u62c9\u4e0d\u4e0b\u6765\u7684\u8bdd\u8981\u624b\u52a8\u4e0a\u4f20\n\n# https://github.com/elastic/helm-charts/tree/7.17/elasticsearch\n#\u6ce8\uff1a\u4ee5\u4e0b\u4ec5\u9ed8\u8ba4\u914d\u7f6e\uff0c\u751f\u4ea7\u4f7f\u7528\u9700\u989d\u5916\u4fee\u6539resource\uff0cstorageSize\uff0ces\u5730\u5740\u7b49\u3002\n# \u5b89\u88c5es\n# \u53ef\u4ee5\u4e0d\u542f\u7528ingress\uff0ckibana\u548cfilebeat\u53ea\u9700\u8981svc\u5730\u5740\nhelm repo add elastic https://helm.elastic.co\nhelm upgrade --install elasticsearch elastic/elasticsearch \\\n--version=7.17.3 \\\n--set ingress.enabled='true' \\\n--set ingress.hosts[0].host='es.local.domain' \\\n--set ingress.hosts[0].paths[0].path='\\'  \\\n--set replicas=1 \\\n--set minimumMasterNodes=1 \\\n--set esJavaOpts='-Xmx2g -Xms2g' \\\n--set resources.limits.memory='5Gi' \\\n--set volumeClaimTemplate.resources.requests.storage='100Gi' \\\n--set volumeClaimTemplate.storageClassName='nfs-client' \n\n\n# filebeat\n# \u9ed8\u8ba4\u914d\u7f6e\u4e3adaemonset\u6a21\u5f0f\uff0c\u91c7\u96c6\u6240\u6709\u8282\u70b9\u7684\u5bb9\u5668\u65e5\u5fd7\u3002\n# extraVolime\u4e3a\u5bb9\u5668\u65e5\u5fd7\u5728\u8282\u70b9\u4e0a\u7684\u5b58\u50a8\u8def\u5f84\nhelm upgrade --install filebeat elastic/filebeat \\\n--version=7.17.3 -f values.yaml \\\n--set daemonset.hostNetworking='true' \\\n--set extraVolumes[0].name='dokcerdata' \\\n--set extraVolumes[0].hostPath.path='/data/docker' \\\n--set extraVolumeMounts[0].name='dokcerdata' \\\n--set extraVolumeMounts[0].mountPath='/data/docker' \\\n--set extraVolumeMounts[0].readOnly='true' \\\n--set extraVolumes[1].name='log-center' \\\n--set extraVolumes[1].persistentVolumeClaim.claimName='log-center-pvc' \\\n--set extraVolumeMounts[1].name='log-center' \\\n--set extraVolumeMounts[1].mountPath='/tmp' -n loki\n#TODO: \u9488\u5bf9\u5bb9\u5668\u5185\u7684\u65e5\u5fd7\u6587\u4ef6\uff0c\u4f7f\u7528sidecar\u5c06filebeat\u6ce8\u5165\u4e1a\u52a1\u5bb9\u5668\u4ee5\u91c7\u96c6\u65e5\u5fd7\n\n# kibana\nhelm install kibana elastic/kibana \\\n--version 7.17.3 \\\n--set ingress.enabled='true' \\\n--set ingress.hosts[0].host='kb.local.domain' \\\n--set ingress.hosts[0].paths[0].path='/'  \n</code></pre> <p>filebeat\u914d\u7f6e\u53c2\u8003filebeat.yml</p> <ul> <li>logstash</li> </ul> <p>logstash-values.yaml</p> <pre><code>helm upgrade --install logstash elastic/logstash --version 7.17.3 \\\n-n loki \\\n-f logstash-values.yaml\n</code></pre>"},{"location":"kubernetes/k8s-platform/log/plg/","title":"Loki","text":"<p>\u5b98\u65b9</p> <p>grafana\u6240\u6709charts</p> <p>promtail\u6587\u6863 promtail charts</p>"},{"location":"kubernetes/k8s-platform/log/plg/#charts","title":"\u914d\u7f6echarts\u4ed3\u5e93","text":"<pre><code>helm repo add grafana https://grafana.github.io/helm-charts\nhelm repo update\n</code></pre>"},{"location":"kubernetes/k8s-platform/log/plg/#loki_1","title":"\u90e8\u7f72loki","text":"<p>\u75313\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li>loki: \u65e5\u5fd7\u5904\u7406\u4e2d\u5fc3\uff08\u5185\u90e8\u9644\u5e26\u4e00\u4e2aminio\uff0c\u4f5c\u4e3a\u5b9e\u9645\u65e5\u5fd7\u6570\u636e\u5b58\u50a8\u540e\u7aef\uff09</li> <li>grafana: \u5ba2\u6237\u7aef\uff0c\u65e5\u5fd7\u67e5\u8be2\u9875\u9762</li> <li>promtail: \u91c7\u96c6\u7a0b\u5e8f\u65e5\u5fd7\uff0c\u6295\u9012\u5230loki</li> </ul>"},{"location":"kubernetes/k8s-platform/log/plg/#_1","title":"\u5355\u8282\u70b9\u90e8\u7f72(\u4f18\u5148\u4f7f\u7528\uff0c\u8d44\u6e90\u4f7f\u7528\u5c11)","text":"<ul> <li> <p>\u9996\u5148\u9700\u8981\u5b89\u88c5local-path-provisioner</p> </li> <li> <p>\u5b89\u88c5</p> </li> </ul> <pre><code>#--set singleBinary.nodeSelector.'kubernetes\\.io/hostname'='k8s-node2' \\  loki\u8fd0\u884c\u8282\u70b9\uff0c\u7531\u4e8e\u672c\u673a\u5b58\u50a8\uff0c\u540e\u7eed\u4e0d\u80fd\u66f4\u6362\u8282\u70b9\n#--set minio.rootUser='' \\     minio\u7684root\u7528\u6237\u540d\n#--set minio.rootPassword='' \\    minio\u7684root\u7528\u6237\u5bc6\u7801\n#--set minio.consoleIngress.hosts[0]='loki-minio.xxx.xxx' \\    minio\u7684\u63a7\u5236\u53f0\u57df\u540d\n# singleBinary.persistence.storageClass \u4e0d\u80fd\u4f7f\u7528nfs\uff0c\u6709\u6027\u80fd\u8981\u6c42\n#--set minio.customCommands[0].command='ilm add --expiry-days 180 myminio/chunks'   \u8bbe\u7f6e\u65e5\u5fd7\u4fdd\u7559\u65f6\u95f4\uff0c\u793a\u4f8b\u4e3a\u4fdd\u7559180\u5929\n\n# loki 5.47.2\nhelm upgrade --install loki grafana/loki -n loki \\\n--create-namespace \\\n--version 5.47.2 \\\n--set loki.auth_enabled=false \\\n--set monitoring.selfMonitoring.enabled=false \\\n--set monitoring.selfMonitoring.grafanaAgent.installOperator=false \\\n--set test.enabled=false \\\n--set monitoring.lokiCanary.enabled=false \\\n--set singleBinary.replicas=1 \\\n--set singleBinary.persistence.size='20Gi' \\\n--set singleBinary.persistence.storageClass='local-path' \\\n--set singleBinary.nodeSelector.'kubernetes\\.io/hostname'='k8s-node2' \\\n--set loki.commonConfig.replication_factor=1 \\\n--set singleBinary.resources.limits.cpu=1500m \\\n--set singleBinary.resources.limits.memory=1500Mi \\\n--set singleBinary.resources.requests.cpu=500m \\\n--set singleBinary.resources.requests.memory=500Mi \\\n--set minio.resources.limits.cpu=1000m \\\n--set minio.resources.limits.memory=1Gi \\\n--set minio.resources.requests.cpu=100m \\\n--set minio.resources.requests.memory=128Mi \\\n--set minio.enabled=true \\\n--set minio.mode='standalone' \\\n--set minio.persistence.storageClass='nfs-client' \\\n--set minio.persistence.size='300Gi' \\\n--set minio.rootUser='' \\\n--set minio.rootPassword='' \\\n--set minio.consoleIngress.enabled=true \\\n--set minio.consoleIngress.hosts[0]='loki-minio.xxx.xxx' \\\n--set minio.consoleIngress.ingressClassName=nginx \\\n--set minio.customCommands[0].command='ilm add --expiry-days 180 myminio/chunks' \\\n--set-string minio.customCommandJob.annotations.\"helm\\.sh/hook-weight\"=\"5\" \\\n--set-string minio.customCommandJob.annotations.\"helm\\.sh/hook\"=\"post-install\" \\\n--set podDisruptionBudget=''\n# \u5982\u679c--set singleBinary.replicas=1\u65f6\n#--set loki.commonConfig.replication_factor=1 \\\n</code></pre>"},{"location":"kubernetes/k8s-platform/log/plg/#loki_2","title":"\u4e8c\u3001loki\u53ef\u6269\u5c55\u65b9\u5f0f\u90e8\u7f72","text":""},{"location":"kubernetes/k8s-platform/log/plg/#lokioperatorpromtailk8s","title":"\u65b9\u5f0f\u4e00\uff1a\u5b89\u88c5loki\uff0c\u4e0d\u542f\u7528operator\uff0c\u5173\u95ed\u81ea\u76d1\u63a7\uff0c\u4f7f\u7528promtail\u6536\u96c6\u6574\u4e2ak8s\u7684\u65e5\u5fd7","text":"<pre><code># loki 5.15.0\nhelm upgrade --install loki grafana/loki -n loki \\\n--set minio.enabled=true \\\n--set loki.auth_enabled=false \\\n--set monitoring.selfMonitoring.enabled=false \\\n--set monitoring.selfMonitoring.grafanaAgent.installOperator=false \\\n--set test.enabled=false \\\n--set minio.persistence.storageClass='nfs-client' \\\n--set minio.persistence.size='200Gi' \\\n--set minio.rootUser='' \\\n--set minio.rootPassword='' \\\n--set minio.consoleIngress.enabled=true \\\n--set minio.consoleIngress.hosts[0]='loki-minio.xxx.xxx' \\\n--set minio.consoleIngress.ingressClassName=nginx \\\n</code></pre>"},{"location":"kubernetes/k8s-platform/log/plg/#lokioperatorcrpodlogsyamlcrk8spod","title":"\u65b9\u5f0f\u4e8c\uff1a\u5b89\u88c5loki\uff0c\u4f7f\u7528operator\uff0c\u9700\u8981\u7f16\u5199cr\uff0c\u53c2\u8003PodLogs.yaml\uff0c\u901a\u8fc7cr\u63a7\u5236\u6536\u96c6k8s\u91cc\u54ea\u4e9bpod\u7684\u65e5\u5fd7","text":"<p>PodLogs.yaml</p> <pre><code># loki 4.6.1\nhelm upgrade --install loki grafana/loki -n loki \\\n--set minio.enabled=true \\\n--set loki.auth_enabled=false\n</code></pre>"},{"location":"kubernetes/k8s-platform/log/plg/#loki_3","title":"loki\u53ef\u9009\u53c2\u6570","text":"<pre><code># loki\u526f\u672c\u6570\u914d\u7f6e\uff0c\u9700\u8981\u6839\u636epod\u6570\u91cf\u8c03\u6574\uff0c\u9ed8\u8ba43\uff0c\u5373\u9700\u89813\u4e2apod\uff0c\u4e14\u81f3\u5c11\u67092\u4e2apod\u5b58\u6d3b\u65f6\u624d\u80fd\u6b63\u5e38\u5de5\u4f5c\u3002\u5982\u679c\u8bbe\u7f6e\u4e3a1\uff0c\u5219\u53ef\u4ee5\u8c03\u6574pod\u6570\u91cf\u4e3a1\n--set read.replicas=1 \\\n--set write.replicas=1 \\\n--set backend.replicas=1 \\\n--set loki.commonConfig.replication_factor=1 \\\n\n\n# \u5404\u7ec4\u4ef6pvc\u914d\u7f6e\uff0cminio\u4e3a\u65e5\u5fd7\u5b58\u50a8\u540e\u7aef\uff0cread\u548cwrite\u7684pvc\u53ea\u7528\u4e8e\u4e34\u65f6\u5b58\u50a8\uff0c\u4f46\u4e3a\u4e86\u907f\u514d\u91cd\u542f\u5bfc\u81f4\u6570\u636e\u90e8\u5206\u4e22\u5931\uff0c\u6240\u4ee5\u8fd8\u662f\u9700\u8981\u6302\u8f7dpvc\n--set minio.persistence.storageClass='nfs-client' \\\n--set minio.persistence.size='200Gi' \\\n--set write.persistence.storageClass='nfs-client' \\\n--set write.persistence.size='20Gi' \\\n--set read.persistence.storageClass='nfs-client' \\\n--set read.persistence.size='20Gi' \\\n--set backend.persistence.storageClass='nfs-client' \\\n--set backend.persistence.size='20Gi' \\\n\n\n# serviceMonitor\u9ed8\u8ba4\u5f00\u542f\uff0c\u6ca1\u6709promtheus\u65f6\u53ef\u5173\u95ed\n# \u8001\u7248\u672c\u4e2d\u4e3a--set serviceMonitor.enabled=false \\\n--set monitoring.serviceMonitor.enabled=false\n--set serviceMonitor.enabled=false \n\n# minio\u8ba4\u8bc1\u914d\u7f6e\n--set minio.rootUser='' \\\n--set minio.rootPassword='' \\\n\n\n# minio bucket\u7b56\u7565\u914d\u7f6e policy\nminio:\n  buckets:\n    - name: chunks\n      policy: none\n      purge: false\n    - name: ruler\n      policy: none\n      purge: false\n    - name: admin\n      policy: none\n      purge: false\n\n\n# \u542f\u7528table manager\u6765\u7ba1\u7406\u5b58\u50a8\u8868\u7684\u751f\u547d\u5468\u671f\uff0chttps://grafana.com/docs/loki/latest/operations/storage/table-manager/\n# \u540e\u7aef\u5b58\u50a8\u4e3a\u5bf9\u8c61\u5b58\u50a8\u65f6\u65e0\u6548\uff0c\u9700\u8981\u901a\u8fc7\u8bbe\u7f6e\u5b58\u50a8\u6876\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\u3002\n--set tableManager.enabled=true \\\n# \u5982\u679c\u5b89\u88c54.10.0\u7248\u672c\uff0c\u4e0d\u652f\u6301\u4ee5\u4e0b2\u4e2a\u53c2\u6570\uff0c\u9700\u8981\u5b89\u88c5\u4ee5\u540e\u624b\u5de5\u4fee\u6539`kubectl edit cm -n loki loki`\n--set tableManager.retention_deletes_enabled=true \\\n--set tableManager.retention_period=744h \\\n\n\n# \u5173\u95edloki-canary\uff08loki\u7cfb\u7edf\u5206\u6790\u7ec4\u4ef6\uff0c\u914d\u7f6eprometheus+grafana\u4f7f\u7528\uff09\n--set monitoring.lokiCanary.enabled=false \\\n</code></pre>"},{"location":"kubernetes/k8s-platform/log/plg/#promtail","title":"\u90e8\u7f72promtail","text":"<pre><code># promtail 6.15.5\n# \u6ce8\u610f\uff1a\u9ed8\u8ba4\u914d\u7f6edocker\u5bb9\u5668\u65e5\u5fd7\u8def\u5f84\u4e3a/var/lib/docker/containers\uff0c\u53ef\u6839\u636e\u5b9e\u9645\u73af\u5883\u60c5\u51b5\u5c06\u6b63\u786e\u7684docker\u8def\u5f84\u6dfb\u52a0\u914d\u7f6e\u8fdb\u53bb\u5373\u53ef\nhelm upgrade --install promtail grafana/promtail -n loki \\\n--version 6.15.5 \\\n--set configmap.enabled=true \\\n--set serviceMonitor.enabled=false \\\n--set tolerations[0].operator='Exists' \n\n\n# \u9ed8\u8ba4tolerations\uff0c\u975e\u5fc5\u987b\n--set tolerations[0].key='node-role.kubernetes.io/master' \\\n--set tolerations[0].operator='Exists' \\\n--set tolerations[0].effect='NoSchedule' \\\n--set tolerations[1].key='node-role.kubernetes.io/control-plane' \\\n--set tolerations[1].operator='Exists' \\\n--set tolerations[1].effect='NoSchedule' \\\n\n\n# docker\u6570\u636e\u76ee\u5f55\u4e0d\u662f\u9ed8\u8ba4\u65f6\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e\u4ee5\u4f7f\u7a0b\u5e8f\u80fd\u8bfb\u53d6\u5230\u65e5\u5fd7\n--set extraVolumes[0].name='containers2' \\\n--set extraVolumes[0].hostPath.path='/data/docker/containers' \\\n--set extraVolumeMounts[0].name='containers2' \\\n--set extraVolumeMounts[0].mountPath='/data/docker/containers' \\\n--set extraVolumeMounts[0].readOnly=true \\\n</code></pre>"},{"location":"kubernetes/k8s-platform/log/plg/#grafana","title":"\u90e8\u7f72grafana","text":"<pre><code>kubectl create secret generic grafana-admin -n loki \\\n--from-literal=admin-user=admin \\\n--from-literal=admin-password='xxxx'\n\nhelm repo add grafana https://grafana.github.io/helm-charts\nhelm repo update\nhelm upgrade --install grafana grafana/grafana -n loki \\\n--version 7.3.7 \\\n--set ingress.enabled=true \\\n--set ingress.hosts[0]='grafana.site.domain' \\\n--set ingress.ingressClassName=nginx \\\n--set persistence.enabled=true \\\n--set persistence.storageClassName='nfs-client'  \\\n--set initChownData.enabled=false \\\n--set admin.existingSecret=grafana-admin \\\n--set datasources.\"datasources\\.yaml\".apiVersion=\"1\" \\\n--set datasources.\"datasources\\.yaml\".datasources[0].name='Loki' \\\n--set datasources.\"datasources\\.yaml\".datasources[0].type='loki' \\\n--set datasources.\"datasources\\.yaml\".datasources[0].url='http://loki-gateway' \\\n--set datasources.\"datasources\\.yaml\".datasources[0].access='proxy' \\\n--set datasources.\"datasources\\.yaml\".datasources[0].isDefault=true \n</code></pre>"},{"location":"kubernetes/k8s-platform/log/plg/#sidecar","title":"sidecar\u793a\u4f8b","text":"<p>infoplus-sts.yaml</p> <p>promtail-sidecar.yaml</p>"},{"location":"kubernetes/k8s-platform/log/plg/#grafana_1","title":"grafana\u67e5\u8be2","text":"<pre><code># \u89e3\u6790json\u683c\u5f0f\u65e5\u5fd7\uff0c\u53ea\u8f93\u51falog\u5185\u5bb9\n{} | json | line_format `{{.log}}`\n</code></pre>"},{"location":"kubernetes/k8s-platform/log/plg/#helm-values","title":"\u914d\u7f6e\u6570\u636e\u6e90(\u914d\u7f6e\u65b9\u6cd5\u8bf4\u660e\uff0c\u9ed8\u8ba4\u5df2\u901a\u8fc7helm values\u8bbe\u7f6e)","text":"<p>\u8bbf\u95eegrafana\u9875\u9762</p> <p> </p> <p>http://loki-gateway </p> <p></p>"},{"location":"kubernetes/k8s-platform/log/plg/#helm-values_1","title":"\u914d\u7f6e\u6570\u636e\u751f\u547d\u5468\u671f(\u914d\u7f6e\u65b9\u6cd5\u8bf4\u660e\uff0c\u9ed8\u8ba4\u5df2\u901a\u8fc7helm values\u8bbe\u7f6e)","text":"<p>\u8bbf\u95eeminio console\u9875\u9762\uff0c\u8bbf\u95ee\u65b9\u5f0f\u4e3a\u4ee5\u4e0b\u4e09\u4e2a\u53c2\u6570\u8bbe\u7f6e</p> <pre><code>--set minio.rootUser='' \\\n--set minio.rootPassword='' \\\n--set minio.consoleIngress.hosts[0]='loki-minio.xxx.xxx' \\\n</code></pre> <p></p> <p></p> <p>\u8bbe\u7f6e\u6570\u636e\u4fdd\u7559\u591a\u5c11\u5929</p> <p></p>"},{"location":"kubernetes/k8s-platform/log/plg/installLokiViaBitnami/","title":"helm\u90e8\u7f72(bitnami)","text":""},{"location":"kubernetes/k8s-platform/log/plg/installLokiViaBitnami/#lokipromtail","title":"loki\u4e00\u4f53\u5316\u5305\uff0c\u5305\u542bpromtail","text":"<p>charts\u4ed3\u5e93\u5730\u5740 </p> <pre><code>helm repo add bitnami https://charts.bitnami.com/bitnami\n\nhelm upgrade --install grafana-loki bitnami/grafana-loki -n loki \n\n# loki\u5bf9\u63a5grafana\n# https://grafana.com/docs/loki/latest/operations/grafana/\n</code></pre>"},{"location":"kubernetes/k8s-platform/log/pvc/%E9%80%9A%E8%BF%87pvc%E6%8C%81%E4%B9%85%E5%8C%96%E5%AE%B9%E5%99%A8%E5%86%85%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6/","title":"\u901a\u8fc7pvc\u6301\u4e45\u5316\u5bb9\u5668\u5185\u65e5\u5fd7\u6587\u4ef6","text":""},{"location":"kubernetes/k8s-platform/log/pvc/%E9%80%9A%E8%BF%87pvc%E6%8C%81%E4%B9%85%E5%8C%96%E5%AE%B9%E5%99%A8%E5%86%85%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6/#_1","title":"\u914d\u7f6e","text":""},{"location":"kubernetes/k8s-platform/log/pvc/%E9%80%9A%E8%BF%87pvc%E6%8C%81%E4%B9%85%E5%8C%96%E5%AE%B9%E5%99%A8%E5%86%85%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6/#1","title":"1. \u914d\u7f6e\u670d\u52a1","text":"<pre><code>#\u5b58\u50a8\u670d\u52a1\u5668\u5b89\u88c5nfs\u670d\u52a1\nyum -y install nfs-utils\n\n#\u5728\u5b58\u50a8\u670d\u52a1\u5668\u4e2d\uff0c\u521b\u5efa\u6302\u8f7d\u76ee\u5f55\nmkdir -p /data/logs\n\nvim /etc/exports\n/data/kubernetes 192.168.0.0/24(rw,async,no_root_squash)\n/data/logs 192.168.0.0/24(rw,async,no_root_squash)\n\nexportfs -arv &amp;&amp; showmount -e \n\n#\u914d\u7f6e\u65e5\u5fd7\u81ea\u52a8\u5f52\u6863\u6e05\u7406\u811a\u672c\nchmod +x log_auto_handle.sh\n(crontab -l; echo '0 3 * * * log_auto_handle.sh &amp;&gt; /dev/null') | crontab     #\u5b9e\u9645\u914d\u7f6e\u65f6\u9700\u8981\u7edd\u5bf9\u8def\u5f84\n</code></pre>"},{"location":"kubernetes/k8s-platform/log/pvc/%E9%80%9A%E8%BF%87pvc%E6%8C%81%E4%B9%85%E5%8C%96%E5%AE%B9%E5%99%A8%E5%86%85%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6/#2","title":"2. \u90e8\u7f72","text":"<pre><code># https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/tree/master/charts/nfs-subdir-external-provisioner\nhelm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/\nhelm repo update\nhelm install nfs-client-log nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \\\n-n nfs-client-provisioner --create-namespace \\\n--set image.repository=willdockerhub/nfs-subdir-external-provisioner \\\n--set image.tag=v4.0.2 \\\n--set nfs.server=192.10.86.7 \\\n--set nfs.path=/data/nfs_data \\\n--set storageClass.name=nfs-client-log \\\n--set storageClass.defaultClass=true \n</code></pre>"},{"location":"kubernetes/k8s-platform/log/pvc/%E9%80%9A%E8%BF%87pvc%E6%8C%81%E4%B9%85%E5%8C%96%E5%AE%B9%E5%99%A8%E5%86%85%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6/#3java","title":"3.\u5e94\u7528\u914d\u7f6e(java)","text":"<p>deploy-log-pvc.yaml</p> <pre><code>      - env:\n        - name: JAVA_TOOL_OPTIONS\n          value: \"-Xmx1600m -Xms800m\"\n        - name: SPRING_APPLICATION_JSON\n          value: '{\"server\":{\"tomcat.accesslog\":{\"directory\":\"/apps/logs\",\"enabled\":\"true\",\"prefix\":\"accesslog\",\"suffix\":\".txt\",\"pattern\":\"%{org.apache.catalina.AccessLog.RemoteAddr}r %h %{tenantUserId}s %{JSESSIONID}c %S %{[yyyy-MM-dd HH:mm:ss.S]}t %m &amp;quot;%U&amp;quot; &amp;quot;%q&amp;quot; %s %b %D &amp;quot;%{Referer}i&amp;quot; &amp;quot;%{User-Agent}i&amp;quot;\"}}}'\n\n        resources:\n          limits:\n            cpu: 1000m\n            memory: 2Gi\n          requests:\n            cpu: 100m\n            memory: 512Mi\n\n        volumeMounts:\n        - mountPath: /apps/logs\n          name: deploy-log\n      volumes:\n        - name: deploy-log\n          persistentVolumeClaim:\n            claimName: deploy-log\n\n#statefulset\n  volumeClaimTemplates:   \n  - metadata:\n      name: sts-log\n    spec: \n      accessModes: \n      - ReadWriteMany\n      resources: \n        requests: \n          storage: 20Gi\n      storageClassName: nfs-client-log\n</code></pre>"},{"location":"kubernetes/k8s-platform/log/pvc/%E9%80%9A%E8%BF%87pvc%E6%8C%81%E4%B9%85%E5%8C%96%E5%AE%B9%E5%99%A8%E5%86%85%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6/#4","title":"4.\u7279\u6b8a\u5e94\u7528","text":"<pre><code>#infoplus\n        volumeMounts:\n        - mountPath: /usr/local/tomcat/logs\n          name: infopluslogs\n\n  volumeClaimTemplates:   \n  - metadata:\n      name: infopluslogs\n    spec: \n      accessModes: \n      - ReadWriteOnce\n      resources: \n        requests: \n          storage: 100Gi\n      storageClassName: nfs-client-log\n</code></pre>"},{"location":"kubernetes/k8s-platform/log/pvc/%E9%80%9A%E8%BF%87pvc%E6%8C%81%E4%B9%85%E5%8C%96%E5%AE%B9%E5%99%A8%E5%86%85%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6/#_2","title":"\u5b9a\u671f\u6e05\u7406","text":"<p>log_auto_handle.sh</p>"},{"location":"kubernetes/k8s-platform/metrics-server/","title":"metrics-server","text":""},{"location":"kubernetes/k8s-platform/metrics-server/#_1","title":"\u5b89\u88c5\u76d1\u63a7\u6570\u636e\u805a\u5408\u5668","text":"<p>components.yaml</p> <p>high-availability.yaml</p> <p>high-availability-1.21+.yaml</p> <pre><code>wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.6.4/components.yaml\n\n\nvim components.yaml\n...\nspec:\n...\n  template:\n    metadata:\n      labels:\n        k8s-app: metrics-server\n    spec:\n      containers:\n      - args:\n        - --cert-dir=/tmp\n        - --secure-port=4443\n        - --kubelet-preferred-address-types=InternalIP   # \u5220\u6389 ExternalIP,Hostname\u8fd9\u4e24\u4e2a\n        - --kubelet-use-node-status-port\n        - --metric-resolution=15s\n        - --kubelet-insecure-tls       #   \u52a0\u4e0a\u8be5\u542f\u52a8\u53c2\u6570\n        image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server:v0.6.4    # \u955c\u50cf\u5730\u5740\u6839\u636e\u60c5\u51b5\u4fee\u6539     \n\n\n\nkubectl apply -f components.yaml\nkubectl top \n</code></pre>"},{"location":"kubernetes/k8s-platform/metrics-server/#bitnami","title":"bitnami","text":"<pre><code>helm repo add bitnami https://charts.bitnami.com/bitnami\nhelm install metrics-server bitnami/metrics-server -n kube-system\n</code></pre>"},{"location":"kubernetes/k8s-platform/metrics-server/#chart","title":"\u5b98\u65b9chart","text":"<p>https://github.com/kubernetes-sigs/metrics-server/releases/tag/metrics-server-helm-chart-3.8.2</p> <pre><code>helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/\nhelm upgrade --install metrics-server metrics-server/metrics-server -n kube-system\n</code></pre>"},{"location":"kubernetes/k8s-platform/monitor/","title":"Prometheus","text":""},{"location":"kubernetes/k8s-platform/monitor/#install","title":"Install","text":""},{"location":"kubernetes/k8s-platform/monitor/#kube-prometheus-stack","title":"kube-prometheus-stack","text":""},{"location":"kubernetes/k8s-platform/monitor/#_1","title":"\u5355\u72ec\u5b89\u88c5","text":"<ul> <li> <p>prometheus TODO</p> </li> <li> <p>grafana</p> </li> <li> <p>alertmanager TODO</p> </li> <li> <p>kube-state-metrics.md</p> </li> </ul>"},{"location":"kubernetes/k8s-platform/monitor/#exporter","title":"Exporter","text":"<ul> <li> <p>mysql-exporter</p> </li> <li> <p>node-exporter.md</p> </li> <li> <p>blackbox-exporter.md</p> </li> </ul>"},{"location":"kubernetes/k8s-platform/monitor/#configuration","title":"Configuration","text":""},{"location":"kubernetes/k8s-platform/monitor/#alertmanager-todo","title":"alertmanager TODO","text":""},{"location":"kubernetes/k8s-platform/monitor/#note","title":"note","text":""},{"location":"kubernetes/k8s-platform/monitor/#prometheus_1","title":"\u89e6\u53d1prometheus\u91cd\u8f7d\u914d\u7f6e","text":"<pre><code>curl -X POST http://10.102.52.14:9090/-/reload\n</code></pre>"},{"location":"kubernetes/k8s-platform/monitor/dev/","title":"dev","text":""},{"location":"kubernetes/k8s-platform/monitor/dev/#metrics","title":"\u68c0\u67e5metrics\u63a5\u53e3\u7684\u6570\u636e\u683c\u5f0f\u662f\u5426\u6b63\u786e","text":"<p>curl http://ketanyun-v2.ketanyun.svc.cluster.local:8080/metrics | promtool check metrics</p> <p>\u6b63\u786e\u7684\u6570\u636e\u683c\u5f0f\u5f62\u5982\uff1a websocket{url=\"ws://192.168.128.6:8765\"} 0 container_cpu_cfs_throttled_seconds_total{container_name=\"test\",pod_name=\"test-stable\",exported_namespace=\"demo\"} 100.0</p>"},{"location":"kubernetes/k8s-platform/monitor/kube-state-metrics/","title":"kube-state-metrics","text":"<pre><code>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update\n\nhelm install [RELEASE_NAME] prometheus-community/kube-state-metrics\n</code></pre>"},{"location":"kubernetes/k8s-platform/monitor/alertmanager/","title":"Index","text":""},{"location":"kubernetes/k8s-platform/monitor/alertmanager/#alertmanager","title":"\u521b\u5efaalertmanager\u914d\u7f6e","text":"<ul> <li>alertmanagerconfig.yaml</li> </ul> <pre><code>kubectl create secret generic alertmanagerconfig-receiver-wechat-apisecret -n ops \\\n--from-literal=secret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n\nkubectl apply -f alertmanagerconfig.yaml\n</code></pre> <p>\u8be5\u65b9\u5f0f\u6dfb\u52a0\u7684\u914d\u7f6e\u9ed8\u8ba4\u6dfb\u52a0\u6240\u5728\u547d\u540d\u7a7a\u95f4\u7684matchers <pre><code>    matchers:\n    - namespace=\"ops\"\n</code></pre> \u5168\u5c40\u914d\u7f6e\u53ef\u4ee5\u914d\u7f6e<code>helm values: alertmanager.config</code></p>"},{"location":"kubernetes/k8s-platform/monitor/alertmanager/#_1","title":"\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b","text":"<ul> <li>alertmanager.yaml</li> </ul>"},{"location":"kubernetes/k8s-platform/monitor/alertmanager/#_2","title":"\u6d88\u606f\u6a21\u677f","text":"<ul> <li>templates</li> </ul>"},{"location":"kubernetes/k8s-platform/monitor/alertmanager/#adapter","title":"\u90e8\u7f72\u4f01\u5fae\u7fa4\u673a\u5668\u4ebaadapter","text":"<p>webhook-adapter.yaml</p>"},{"location":"kubernetes/k8s-platform/monitor/exporters/node-exporter/","title":"node-exporter","text":"<pre><code>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update\n\nhelm install [RELEASE_NAME] prometheus-community/prometheus-node-exporter\n</code></pre>"},{"location":"kubernetes/k8s-platform/monitor/exporters/blackbox-exporter/","title":"blackbox-exporter","text":"<ul> <li>values.yaml</li> </ul> <pre><code>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update\n\nhelm upgrade --install kube-prometheus-stack-blackbox-exporter \\\nprometheus-community/prometheus-blackbox-exporter \\\n-n ops --create-namespace \\\n-f values.yaml\n</code></pre>"},{"location":"kubernetes/k8s-platform/monitor/exporters/mysql-exporter/","title":"Index","text":"<pre><code>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update\n\nhelm upgrade --install local-mysql-exporter prometheus-community/prometheus-mysql-exporter -n developer \\\n--set serviceMonitor.enabled='true' \\\n--set mysql.user='root' \\\n--set mysql.pass='qqq...123' \\\n--set mysql.host='192.168.0.204' \\\n--set mysql.port='3306'\n</code></pre>"},{"location":"kubernetes/k8s-platform/monitor/grafana/","title":"\u90e8\u7f72grafana","text":"","tags":["monitor","dashboard"]},{"location":"kubernetes/k8s-platform/monitor/grafana/#helm","title":"\u4f7f\u7528helm\u90e8\u7f72","text":"","tags":["monitor","dashboard"]},{"location":"kubernetes/k8s-platform/monitor/grafana/#charts","title":"\u5b98\u65b9charts","text":"<ul> <li>values.yaml</li> </ul> <pre><code>kubectl create secret generic grafana-admin -n ops \\\n--from-literal=admin-user=admin \\\n--from-literal=admin-password='xxxx'\n\nhelm repo add grafana https://grafana.github.io/helm-charts\nhelm repo update\nhelm upgrade --install grafana grafana/grafana \\\n--version 8.4.5 -n ops --create-namespace \\\n-f values.yaml\n</code></pre>","tags":["monitor","dashboard"]},{"location":"kubernetes/k8s-platform/monitor/grafana/#dashboards","title":"dashboards","text":"<ul> <li>Node Exporter Full</li> <li>Felix Dashboard (Calico)</li> <li>Loki stack monitoring (Promtail, Loki)</li> <li>Blackbox Exporter (HTTP prober)</li> <li>MinIO Dashboard</li> </ul>","tags":["monitor","dashboard"]},{"location":"kubernetes/k8s-platform/monitor/kube-prometheus-stack/","title":"kube-prometheus-stack","text":"<p>20240816</p> <ul> <li>doc</li> <li>charts</li> </ul>"},{"location":"kubernetes/k8s-platform/monitor/kube-prometheus-stack/#prerequisites","title":"Prerequisites","text":"<ul> <li>Kubernetes 1.19+</li> <li>Helm 3+</li> </ul>"},{"location":"kubernetes/k8s-platform/monitor/kube-prometheus-stack/#install","title":"Install","text":"<ul> <li>values.yaml</li> <li>values-origin-61.9.0.yaml</li> </ul> <pre><code>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update\n\n#kubectl patch storageclass nfs-client -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}'\n\nhelm show values prometheus-community/kube-prometheus-stack --version 61.9.0\n</code></pre> <ul> <li>\u5b89\u88c5</li> </ul> <pre><code>kubectl create secret generic grafana-admin -n ops \\\n--from-literal=admin-user=admin \\\n--from-literal=admin-password='xxxx'\n\nhelm upgrade --install kube-prometheus-stack \\\nprometheus-community/kube-prometheus-stack \\\n--version 61.9.0 -n ops --create-namespace \\\n-f values.yaml\n</code></pre> <ul> <li>grafana\u5355\u72ec\u5b89\u88c5</li> </ul> <p>grafana</p> <pre><code>helm upgrade --install kube-prometheus-stack \\\nprometheus-community/kube-prometheus-stack \\\n--version 61.9.0 -n ops --create-namespace \\\n--set grafana.enabled=false \\\n--set grafana.forceDeployDatasources=true \\\n--set grafana.forceDeployDashboards=true \\\n-f values.yaml\n</code></pre> <ul> <li>thanos</li> </ul> <pre><code>--set thanosRuler.enabled=true \\\n--set thanosRuler.ingress.enabled=true \\\n--set thanosRuler.ingress.hosts[0]=thanosruler.local.domain \\\n--set thanosRuler.thanosRulerSpec.replicas=1\n</code></pre>"},{"location":"kubernetes/k8s-platform/rancher/","title":"\u90e8\u7f72","text":""},{"location":"kubernetes/k8s-platform/rancher/#rancher","title":"\u90e8\u7f72rancher","text":"<p>\u6ce8\u610f\uff1arancher\u5bf9\u96c6\u7fa4\u53ef\u80fd\u6709\u5f71\u54cd\uff0c\u6b63\u5f0f\u73af\u5883\u5b89\u88c5\u8bf7\u4ee5\u5371\u9669\u64cd\u4f5c\u770b\u5f85\uff0c\u901a\u77e5\u9879\u76ee\uff0c\u7ea6\u5b9a\u64cd\u4f5c\u65f6\u95f4</p>"},{"location":"kubernetes/k8s-platform/rancher/#helm","title":"helm\u90e8\u7f72\uff08\u5efa\u8bae\uff09","text":"<p>Rancher Helm Chart Options</p> <pre><code>helm repo add rancher-stable https://releases.rancher.com/server-charts/stable\nhelm upgrade --install rancher rancher-stable/rancher \\\n-n cattle-system --create-namespace \\\n--version=2.6.14 \\\n--set hostname=rancher.local.domain \\\n--set ingress.tls.source=secret \\\n--set bootstrapPassword='xxxxxxx' \\\n--set replicas=1\n</code></pre>"},{"location":"kubernetes/k8s-platform/rancher/#yaml","title":"yaml\u90e8\u7f72\uff08\u4e0d\u5efa\u8bae\uff09","text":"<p>rancher.yaml</p> <pre><code>kubectl create ns rancher\nkubectl -n rancher create serviceaccount rancher \nkubectl create clusterrolebinding rancher --clusterrole=cluster-admin --serviceaccount=rancher:rancher \nkubectl apply -f rancher.yaml\n</code></pre>"},{"location":"kubernetes/k8s-platform/rancher/#rancher_1","title":"\u5378\u8f7drancher","text":"<p>\u4e0d\u80fd\u76f4\u63a5\u5220\u9664rancher\uff0c\u4f7f\u7528\u8be5\u811a\u672c\u5220\u9664\uff1ahttps://github.com/rancher/rancher-cleanup</p>"},{"location":"kubernetes/k8s-platform/tengine-ingress/","title":"Tengine-Ingress","text":""},{"location":"kubernetes/k8s-platform/tengine-ingress/#_1","title":"\u5b89\u88c5","text":"<ul> <li>\u76f4\u63a5\u4f7f\u7528 Tengine-Ingress \u63d0\u4f9b\u7684\u955c\u50cf\uff0c\u955c\u50cf\u57fa\u4e8eAnolis OS\u548cAlpine OS \uff0c\u652f\u6301 AMD64 \u548c ARM64 \u67b6\u6784\u3002</li> </ul> <pre><code>docker pull tengine-ingress-registry.cn-hangzhou.cr.aliyuncs.com/tengine/tengine-ingress:1.1.0\ndocker pull tengine-ingress-registry.cn-hangzhou.cr.aliyuncs.com/tengine/tengine-ingress:1.1.0-alpine\n</code></pre> <ul> <li>install.yaml</li> </ul> <pre><code>kubectl apply -f install.yaml\n</code></pre>"},{"location":"linux/alpine/","title":"Alpine","text":""},{"location":"linux/alpine/#_1","title":"\u4fee\u6539\u8f6f\u4ef6\u6e90","text":"<pre><code>sed -i s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g /etc/apk/repositories\n</code></pre>"},{"location":"linux/command/","title":"\u5e38\u7528\u547d\u4ee4","text":"","tags":["shell","linux","cli"]},{"location":"linux/command/#tcpdump","title":"tcpdump","text":"<pre><code>tcpdump -e -vvv\ntcpdump -e -vvv -w a.cap\ntcpdump -e -vvv host IP port PORT \ntcpdump -i eht0\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/command/#_2","title":"\u68c0\u6d4b\u57df\u540d\u8bc1\u4e66\u4fe1\u606f","text":"<pre><code># \u975esni\nopenssl s_client -connect \u57df\u540d:443 \n# sni\nopenssl s_client -connect authserver.jssvc.edu.cn:443 -servername authserver.jssvc.edu.cn\n\nopenssl x509 -in &lt;\u8bc1\u4e66\u8bf7\u6c42\u6587\u4ef6&gt; -noout -dates\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/command/#centosiptables","title":"centos\u9632\u706b\u5899\u914d\u7f6e\uff1aiptables","text":"<pre><code># \u67e5\u770biptables\u89c4\u5219\uff0c\u9ed8\u8ba4\u67e5\u770bfilter\u8868\niptables -nL\n\n# \u67e5\u770bnat\u8868\u89c4\u5219\niptables -t nat -nL\n\n# \u53ef\u4ee5\u5217\u51fa\u5e8f\u5217\u53f7\uff0c\u5728\u63d2\u5165\u6216\u8005\u5220\u9664\u7684\u65f6\u5019\u5c31\u4e0d\u7528\u81ea\u5df1\u53bb\u6570\u4e86\niptables -nL --line-numbers \n\n# \u53ef\u4ee5\u67e5\u770b\u5230\u5305\u8fc7\u6ee4\u7684\u6d41\u91cf\u7edf\u8ba1\uff0c\u8bbf\u95ee\u6b21\u6570\u7b49\niptables -nvL --line-numbers\n\n# \u63d2\u5165\u4e00\u6761\u89c4\u5219\uff0c\u9ed8\u8ba4\u5728\u7b2c\u4e00\u6761\u63d2\u5165\niptables -I INPUT -s 192.168.1.0/24 -j ACCEPT\n\n# \u5728\u6307\u5b9a\u4f4d\u7f6e\u63d2\u5165\niptables -I INPUT 2 -s 192.168.2.0/24 -p tcp --sport 45612 -j ACCEPT\n\n# \u5728INPUT\u6700\u540e\u8ffd\u52a0\u4e00\u6761\u8bb0\u5f55\u3002\niptables -A INPUT -s 192.168.2.0/24 -j ACCEPT\n\n# \u5220\u9664\u7b2c7\u6761\u8bb0\u5f55\niptables -D INPUT 7\n\n# \u66ff\u6362\u4e00\u6761\u89c4\u5219\niptables -R INPUT 3 -s 192.168.3.0/24 -p tcp --dport 80 -j ACCEPT\n\n# \u6307\u5b9a\u534f\u8bae\niptables -I INPUT -p icmp -j ACCEPT\n\n# \u9488\u5bf9\u7aef\u53e3\u5f00\u653e\uff08\u9700\u8981\u6307\u660e\u534f\u8bae\uff09\niptables -I INPUT -p tcp --dport 22 -j ACCEPT\n\n# \u62d2\u7edd\u6240\u6709\uff0c\u9700\u8981\u653e\u5230\u6700\u540e\u4e00\u6761\niptables -A INPUT -j DROP\n\n# \u4fee\u6539FORWARD\u94fe\u7684\u9ed8\u8ba4\u7b56\u7565\u8bbe\u7f6e\u4e3aDROP\niptables -t filter -P FORWARD DROP   #-t\u6307\u5b9a\u6240\u8981\u64cd\u4f5c\u7684\u8868\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a\uff0c\u5219\u9ed8\u8ba4\u7684\u8868\u4e3afilter.\n\n# \u5141\u8bb8\u8bbf\u95ee\u516c\u7f51\niptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT\n\n# \u6e05\u7a7a\u5f53\u524d\u89c4\u5219\niptables -F\n\n# \u4fdd\u5b58\u89c4\u5219\niptables-save &gt; /etc/sysconfig/iptables\n\n# \u4ece\u6587\u4ef6\u91cc\u9762\u6062\u590diptables\u89c4\u5219\niptables-restore &lt; /etc/sysconfig/iptables\n\n# \u8bbe\u7f6e\u6c38\u4e45\u751f\u6548\n# \u9700\u8981\u5b89\u88c5iptables-services\u5e76\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\uff0c\u540e\u7eed\u670d\u52a1\u5668\u91cd\u542f\u65f6\u4f1a\u81ea\u52a8\u8bfb\u53d6/etc/sysconfig/iptables\u4e2d\u7684\u89c4\u5219\u914d\u7f6e\nsystemctl stop firewalld\nsystemctl disable firewalld\nyum install iptables-services\nsystemctl enable iptables.service\niptables-save &gt; /etc/sysconfig/iptables\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/command/#centosfirewalld-cmd","title":"centos\u9632\u706b\u5899\u914d\u7f6e\uff1afirewalld-cmd","text":"<pre><code>#\u67e5\u770b\u5f53\u524d\u6240\u6709\u89c4\u5219\nfirewall-cmd --list-all\n\n#\u5355\u72ec\u67e5\u770b\u7aef\u53e3\u767d\u540d\u5355\u5217\u8868\nfirewall-cmd --zone=public --list-ports\n\n# \u65b0\u5efa\u6c38\u4e45\u89c4\u5219\uff0c\u5f00\u653e192.168.1.1\u5355\u4e2a\u6e90IP\u7684\u8bbf\u95ee\nfirewall-cmd --permanent --zone=trusted --add-source=192.168.1.1\n\n# \u65b0\u5efa\u6c38\u4e45\u89c4\u5219\uff0c\u5f00\u653e192.168.1.0/24\u6574\u4e2a\u6e90IP\u6bb5\u7684\u8bbf\u95ee\nfirewall-cmd --permanent --add-source=192.168.1.0/24\n\n# \u79fb\u9664\u4e0a\u8ff0\u89c4\u5219\nfirewall-cmd --permanent --remove-source=192.168.1.1\n\n# \u9488\u5bf9ip\u5f00\u653e\u7aef\u53e3\nfirewall-cmd --permanent --add-rich-rule=\"rule family=\"ipv4\" source address=\"10.64.132.10\" port protocol=\"tcp\" port=\"3306\" accept\"\n\n# \u5f00\u653ehttp\u670d\u52a1\u548chttps\u670d\u52a1\nfirewall-cmd --permanent --add-service=http\nfirewall-cmd --permanent --add-service=https\n\n# \u79fb\u9664\u4e0a\u8ff0\u89c4\u5219\nfirewall-cmd --permanent --remove-service=http\n\n#\u91cd\u65b0\u52a0\u8f7dfirewall\nfirewall-cmd --reload\n\n#\u91cd\u542ffirewalld\nsystemctl restart firewalld\n\n\n# \u5f00\u542f\u9632\u706b\u5899\u540ekeepalived\u8111\u88c2\nfirewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface eth0 --destination 224.0.0.18 --protocol vrrp -j ACCEPT\nfirewall-cmd --reload\nsystemctl restart keepalived\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/command/#ubunutufw","title":"ubunut\u9632\u706b\u5899\u914d\u7f6e\uff1aufw","text":"<pre><code># k8s\u8282\u70b9\u9632\u706b\u5899\u914d\u7f6e\u53c2\u8003\n# \u6240\u6709\u8282\u70b9\u4e4b\u95f4\u4e92\u76f8\u4e0d\u9650\u5236\uff0c\u96c6\u7fa4pod\u548csvc CIDR\u4e0d\u9650\u5236\uff0cnode\u8282\u70b9\u5141\u8bb8\u6240\u6709\u6765\u6e90\u8bbf\u95ee\u672c\u673a80\u548c443\uff0c\u5176\u4ed6\u7aef\u53e3\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u653e\u901a\nufw enable\nufw allow http\nufw allow https\nufw allow from 192.168.3.212\nufw allow from 192.168.3.213\nufw allow from 192.168.3.214\nufw allow from 192.168.3.215\nufw allow from 192.168.3.216\nufw allow from 192.168.3.217\nufw allow from 192.168.3.218\nufw allow from 192.168.3.219\nufw allow from 100.64.0.0/16 to 100.65.0.0/16\nufw allow from 192.168.3.219 to 192.168.3.218 port 3306 proto tcp\nufw allow from 192.168.3.219 to 192.168.3.219 port 3306 proto tcp\n</code></pre> <pre><code># \u6574\u4e2a\u73af\u5883\u6240\u6709\u670d\u52a1\u5668\nufw allow 1723\nufw allow from 192.168.103.125\nufw allow from 192.168.103.126\nufw allow from 192.168.103.127\nufw allow from 192.168.103.128\nufw allow from 192.168.103.129\nufw allow from 192.168.103.130\nufw allow from 192.168.103.171\nufw allow from 192.168.103.173\nufw allow from 192.168.103.177\nufw allow from 192.168.103.178\nufw allow from 192.168.103.179\n\n# node\nufw allow http\nufw allow https\n\n# k8s\u6240\u6709\u8282\u70b9\nufw allow from 10.95.0.0/16 to 10.96.0.0/16\nufw allow from 10.96.0.0/16 to 10.95.0.0/16\n\n\n# \u4e3b\u5e93\nufw allow from 192.168.103.16 to 192.168.103.177 port 3306 proto tcp\n\n# \u4ece\u5e93\nufw allow from 192.168.103.156 to 192.168.103.178 port 3306 proto tcp\nufw allow from 192.168.103.113 to 192.168.103.178 port 3306 proto tcp\nufw allow from 192.168.103.234 to 192.168.103.178 port 3306 proto tcp\nufw allow from 192.168.103.114 to 192.168.103.178 port 3306 proto tcp\nufw allow from 192.168.103.116 to 192.168.103.178 port 3306 proto tcp\nufw allow from 192.168.103.90 to 192.168.103.178 port 3306 proto tcp\n\n\nufw enable\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/command/#arp","title":"\u5f3a\u5236\u5237\u65b0arp","text":"<pre><code># 20230508 \u817e\u8baf\u4e91HAVIP\u4f7f\u7528keepalived\u914d\u7f6e\u540e\uff0c\u5176\u4ed6\u670d\u52a1\u5668\u65e0\u6cd5\u5b66\u4e60\u5230vip\u7684MAC\uff0c\u53ef\u4ee5\u5728vip\u6240\u5728\u670d\u52a1\u5668\u4f7f\u7528\u8be5\u547d\u4ee4\u5904\u7406\narping -c 10 -U 172.17.1.119 -I eth0\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/command/#ssh","title":"ssh\u96a7\u9053","text":"<pre><code># https://www.im050.com/posts/415\nnohup ssh -D 0.0.0.0:1337 -f -C -q -N zhdong@gpt.ketanyun.com &amp;\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/command/#ab","title":"ab","text":"<p>ab\u662fapachebench\u547d\u4ee4\u7684\u7f29\u5199\u3002</p> <p>ab\u7684\u539f\u7406\uff1aab\u547d\u4ee4\u4f1a\u521b\u5efa\u591a\u4e2a\u5e76\u53d1\u8bbf\u95ee\u7ebf\u7a0b\uff0c\u6a21\u62df\u591a\u4e2a\u8bbf\u95ee\u8005\u540c\u65f6\u5bf9\u67d0\u4e00URL\u5730\u5740\u8fdb\u884c\u8bbf\u95ee\u3002\u5b83\u7684\u6d4b\u8bd5\u76ee\u6807\u662f\u57fa\u4e8eURL\u7684\uff0c\u56e0\u6b64\uff0c\u5b83\u65e2\u53ef\u4ee5\u7528\u6765\u6d4b\u8bd5apache\u7684\u8d1f\u8f7d\u538b\u529b\uff0c\u4e5f\u53ef\u4ee5\u6d4b\u8bd5nginx\u3001lighthttp\u3001tomcat\u3001IIS\u7b49\u5176\u5b83Web\u670d\u52a1\u5668\u7684\u538b\u529b\u3002</p> <p>\u5176\u4e2d-n\u4ee3\u8868\u6bcf\u6b21\u5e76\u53d1\u91cf\uff0c-c\u4ee3\u8868\u603b\u5171\u53d1\u9001\u7684\u6570\u91cf</p> <p><code>ab -n 300 -c 300 http://192.168.0.10/</code> \uff08-n\u53d1\u51fa300\u4e2a\u8bf7\u6c42\uff0c-c\u6a21\u62df300\u5e76\u53d1\uff0c\u76f8\u5f53800\u4eba\u540c\u65f6\u8bbf\u95ee\uff0c\u540e\u9762\u662f\u6d4b\u8bd5url\uff09</p> <p><code>ab -t 60 -c 100 http://192.168.0.10/</code> \u572860\u79d2\u5185\u53d1\u8bf7\u6c42\uff0c\u4e00\u6b21100\u4e2a\u8bf7\u6c42\u3002</p> <pre><code>Document Path:          /  ###\u8bf7\u6c42\u7684\u8d44\u6e90\nDocument Length:        50679 bytes  ###\u6587\u6863\u8fd4\u56de\u7684\u957f\u5ea6\uff0c\u4e0d\u5305\u62ec\u76f8\u5e94\u5934\n\nConcurrency Level:      3000   ###\u5e76\u53d1\u4e2a\u6570\nTime taken for tests:   30.449 seconds   ###\u603b\u8bf7\u6c42\u65f6\u95f4\nComplete requests:      3000     ###\u603b\u8bf7\u6c42\u6570\nFailed requests:        0     ###\u5931\u8d25\u7684\u8bf7\u6c42\u6570\nWrite errors:           0\nTotal transferred:      152745000 bytes\nHTML transferred:       152037000 bytes\nRequests per second:    98.52 [#/sec] (mean)      ###\u5e73\u5747\u6bcf\u79d2\u7684\u8bf7\u6c42\u6570\nTime per request:       30449.217 [ms] (mean)     ###\u5e73\u5747\u6bcf\u4e2a\u8bf7\u6c42\u6d88\u8017\u7684\u65f6\u95f4\nTime per request:       10.150 [ms] (mean, across all concurrent requests)  ###\u4e0a\u9762\u7684\u8bf7\u6c42\u9664\u4ee5\u5e76\u53d1\u6570\nTransfer rate:          4898.81 [Kbytes/sec] received   ###\u4f20\u8f93\u901f\u7387\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/command/#nc","title":"nc","text":"<pre><code>apt install netcat -y\n</code></pre> <pre><code># \u521b\u5efaTCP\u670d\u52a1\u5668\n## -l \u76d1\u542c\u5730\u5740 \u7aef\u53e3\nnc -l 127.0.0.1 8080\n\n# \u5ba2\u6237\u7aef\u4ee5TCP\u534f\u8bae\u8fde\u63a5\u5230\u670d\u52a1\u7aef\nnc 127.0.0.1 8080\n</code></pre> <ul> <li>\u6d4b\u8bd5udp\u7aef\u53e3</li> </ul> <pre><code># netcat \u6d4b\u8bd5udp\u7aef\u53e3\n## -v \u8be6\u7ec6\u4fe1\u606f\n## -u udp\nnc -vu 114.114.114.114 53\n</code></pre> <ul> <li>\u4f20\u8f93\u6587\u4ef6</li> </ul> <pre><code># \u6e90\u670d\u52a1\u5668\ncat file | nc -l 1234\n\n# \u76ee\u6807\u670d\u52a1\u5668\nnc host_ip 1234 &gt; file\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/command/#find","title":"find","text":"<pre><code>find /logs ! -path '/logs/messengers/*' -name \"*.tgz\" -type f -mtime +180 -print -delete\nfind /logs ! -path '/logs/messengers/*' -name \"*.log\" -type f -mtime +2 -print -exec tar -zcvf {}.tgz -C /logs {} --remove-files \\;\n</code></pre> <p>find\u547d\u4ee4\u7684\u7ed3\u5c3e\u7b26\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a</p> <ol> <li> <p><code>;</code>\uff08\u5206\u53f7\uff09\uff1a\u8868\u793a\u6307\u4ee4\u7ed3\u675f\u3002\u8fd9\u662f\u6700\u5e38\u89c1\u7684\u7ed3\u5c3e\u7b26\uff0c\u7528\u4e8e\u5355\u4e2a\u547d\u4ee4\u7684\u7ed3\u675f\uff0c\u5728\u547d\u4ee4\u884c\u4e0a\u4f7f\u7528\u65f6\u9700\u8981\u7528\u53cd\u659c\u6760<code>\\\\</code>\u8fdb\u884c\u8f6c\u4e49\u3002    \u793a\u4f8b\uff1a<code>find /path/to/search -name \u201c*.txt\u201d -exec echo {} \\;</code></p> </li> <li> <p><code>+</code>\uff08\u52a0\u53f7\uff09\uff1a\u8868\u793a\u591a\u4e2a\u6307\u4ee4\u7ed3\u675f\uff0c\u5c06\u5339\u914d\u5230\u7684\u6587\u4ef6\u4ee5\u53c2\u6570\u5217\u8868\u7684\u5f62\u5f0f\u4f20\u9012\u7ed9\u540e\u9762\u7684\u6307\u4ee4\u3002\u8fd9\u79cd\u7ed3\u5c3e\u7b26\u5728\u5904\u7406\u5927\u91cf\u6587\u4ef6\u65f6\u6548\u7387\u66f4\u9ad8\uff0c\u56e0\u4e3a\u5b83\u5c06\u591a\u4e2a\u6587\u4ef6\u4e00\u6b21\u6027\u4f20\u9012\u7ed9\u6307\u4ee4\u800c\u4e0d\u662f\u6bcf\u4e2a\u6587\u4ef6\u5206\u522b\u8c03\u7528\u6307\u4ee4\u3002\u4f7f\u7528\u52a0\u53f7\u7ed3\u5c3e\u7b26\u65f6\uff0c\u5fc5\u987b\u5c06\u52a0\u53f7\u7528\u5f15\u53f7\u62ec\u8d77\u6765\uff0c\u4ee5\u9632\u6b62shell\u5bf9\u5176\u8fdb\u884c\u89e3\u91ca\u3002    \u793a\u4f8b\uff1a<code>find /path/to/search -name \u201c*.txt\u201d -exec echo {} +</code></p> </li> <li> <p><code>\\;</code>\uff08\u8f6c\u4e49\u5206\u53f7\uff09\uff1a\u5728\u547d\u4ee4\u884c\u4e0a\u4f7f\u7528\u5206\u53f7\u4f5c\u4e3a\u7ed3\u5c3e\u7b26\u65f6\uff0c\u9700\u8981\u4f7f\u7528\u53cd\u659c\u6760\u5bf9\u5206\u53f7\u8fdb\u884c\u8f6c\u4e49\uff0c\u4ee5\u9632\u6b62shell\u5bf9\u5176\u8fdb\u884c\u89e3\u91ca\u3002\u8fd9\u79cd\u65b9\u5f0f\u4e0e\u4f7f\u7528\u5355\u4e2a\u5206\u53f7\u4f5c\u4e3a\u7ed3\u5c3e\u7b26\u7684\u6548\u679c\u76f8\u540c\u3002    \u793a\u4f8b\uff1a<code>find /path/to/search -name \u201c*.txt\u201d -exec echo {} \\;</code></p> </li> </ol>","tags":["shell","linux","cli"]},{"location":"linux/frp/","title":"\u5185\u7f51\u7a7f\u900f","text":"","tags":["network","frp"]},{"location":"linux/frp/#_2","title":"\u5b89\u88c5","text":"<p>Release</p> <ul> <li>\u5177\u5907\u516c\u7f51IP\u7684\u670d\u52a1\u5668\u5b89\u88c5</li> </ul> <pre><code>tar -xf frp_0.53.2_linux_amd64.tar.gz\ncd frp_0.53.2_linux_amd64/\n\nsudo cp frps /usr/local/bin/\nsudo mkdir /etc/frp\n#sudo cp frps.toml /etc/frp\n\nsudo tee /etc/frp/frps.toml &lt;&lt; 'EOF'\nbindPort = 7000\n#vhostHTTPPort = 80\n#vhostHTTPSPort = 443\nEOF\n\nsudo tee /etc/systemd/system/frps.service &lt;&lt; 'EOF'\n[Unit]\n# \u670d\u52a1\u540d\u79f0\uff0c\u53ef\u81ea\u5b9a\u4e49\nDescription = frp server\nAfter = network.target syslog.target\nWants = network.target\n\n[Service]\nType = simple\n# \u542f\u52a8frps\u7684\u547d\u4ee4\uff0c\u9700\u4fee\u6539\u4e3a\u60a8\u7684frps\u7684\u5b89\u88c5\u8def\u5f84\nExecStart = /usr/local/bin/frps -c /etc/frp/frps.toml\n\n[Install]\nWantedBy = multi-user.target\nEOF\n</code></pre> <ul> <li>\u5185\u7f51\u7684\u670d\u52a1\u5668\u5b89\u88c5</li> </ul> <pre><code>tar -xf frp_0.53.2_linux_amd64.tar.gz\ncd frp_0.53.2_linux_amd64/\n\nsudo cp frpc /usr/local/bin/\nsudo mkdir /etc/frp\n#sudo cp frpc.toml /etc/frp\n\nsudo tee /etc/frp/frpc.toml &lt;&lt; 'EOF'\nserverAddr = \"x.x.x.x\"\nserverPort = 7000\n\n[[proxies]]\nname = \"https\"\ntype = \"tcp\"\nlocalIP = \"127.0.0.1\"\nlocalPort = 443\nremotePort = 443\n[[proxies]]\nname = \"http\"\ntype = \"tcp\"\nlocalIP = \"127.0.0.1\"\nlocalPort = 80\nremotePort = 80\nEOF\n\nsudo tee /etc/systemd/system/frpc.service &lt;&lt; 'EOF'\n[Unit]\n# \u670d\u52a1\u540d\u79f0\uff0c\u53ef\u81ea\u5b9a\u4e49\nDescription = frp client\nAfter = network.target syslog.target\nWants = network.target\n\n[Service]\nType = simple\n# \u542f\u52a8frps\u7684\u547d\u4ee4\uff0c\u9700\u4fee\u6539\u4e3a\u60a8\u7684frps\u7684\u5b89\u88c5\u8def\u5f84\nExecStart = /usr/local/bin/frpc -c /etc/frp/frpc.toml\n\n[Install]\nWantedBy = multi-user.target\nEOF\n</code></pre> <pre><code># \u542f\u52a8frp\nsudo systemctl start frps\n# \u505c\u6b62frp\nsudo systemctl stop frps\n# \u91cd\u542ffrp\nsudo systemctl restart frps\n# \u67e5\u770bfrp\u72b6\u6001\nsudo systemctl status frps\n\nsudo systemctl enable frps --now\nsudo systemctl enable frpc --now\n</code></pre>","tags":["network","frp"]},{"location":"linux/note/","title":"Note","text":"","tags":["shell","linux","cli"]},{"location":"linux/note/#_1","title":"\u8bbe\u7f6e\u7cfb\u7edf\u4ee3\u7406","text":"<pre><code>sudo tee /etc/profile.d/custom_proxy.sh &lt;&lt; 'EOF'\nexport no_proxy=127.0.0.1,192.168.*,172.31.*,172.30.*,172.29.*,172.28.*,172.27.*,172.26.*,172.25.*,172.24.*,172.23.*,172.22.*,172.21.*,172.20.*,172.19.*,172.18.*,172.17.*,172.16.*,10.*,127.*,localhost,$(awk -F[\\#] '{print $1}' /etc/hosts | sed -r /^$/d | awk '{res=res$2\",\"}END{print res}')\nexport NO_PROXY=127.0.0.1,192.168.*,172.31.*,172.30.*,172.29.*,172.28.*,172.27.*,172.26.*,172.25.*,172.24.*,172.23.*,172.22.*,172.21.*,172.20.*,172.19.*,172.18.*,172.17.*,172.16.*,10.*,127.*,localhost,$(awk -F[\\#] '{print $1}' /etc/hosts | sed -r /^$/d | awk '{res=res$2\",\"}END{print res}')\nexport HTTPS_PROXY=http://192.168.182.1:29998\nexport https_proxy=http://192.168.182.1:29998\nexport HTTP_PROXY=http://192.168.182.1:29998\nexport http_proxy=http://192.168.182.1:29998\nEOF\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/note/#_2","title":"\u5207\u6362\u4e2d\u6587\u53ca\u6dfb\u52a0\u4e2d\u6587\u5b57\u4f53","text":"<pre><code># \u67e5\u770b\u7cfb\u7edf\u8bed\u8a00\nlocale\n\n# \u5982\u679c\u7cfb\u7edf\u8bed\u8a00\u4e0d\u662f\u201czh_CN.UTF-8\u201d\u7684\u8bdd\uff0c\u5219\u6267\u884c\u6b65\u9aa42\u4fee\u6539\u7cfb\u7edf\u8bed\u8a00\u4e3a\u201czh_CN.UTF-8\u201d\n# centos\nvi  /etc/locale.conf\n# ubuntu\nvim /etc/default/locale\n\n# \u6dfb\u52a0\nexport LC_ALL=\"zh_CN.UTF-8\"\n\n# \u7acb\u5373\u751f\u6548\nsource /etc/default/locale\n\n# \u518d\u6b21\u67e5\u770b\nlocale\n</code></pre> <pre><code># \u4ecewindows C\u76d8\u5b57\u4f53\u76ee\u5f55C:\\Windows\\Fonts\u83b7\u53d6\u5b57\u4f53\u6587\u4ef6\n\n# linux \u670d\u52a1\u5668\u521b\u5efa\u5b57\u4f53\u5b58\u653e\u76ee\u5f55\nmkdir -p /usr/share/fonts/truetype   \n\n# \u4fee\u6539\u6743\u9650\nchmod  -R  755  /usr/share/fonts/truetype\n\n# \u52a0\u8f7d\u7f13\u5b58\nfc-cache\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/note/#_3","title":"\u65f6\u95f4\u540c\u6b65","text":"","tags":["shell","linux","cli"]},{"location":"linux/note/#centos6","title":"centos6","text":"<pre><code>vim /etc/ntp.conf\n\n# \u7acb\u5373\u627e\u670d\u52a1\u5668\u540c\u6b65\u65f6\u95f4\uff0c\u5371\u9669\u64cd\u4f5c\uff01\u65f6\u95f4\u5dee\u5f02\u8f83\u5927\u65f6\u76f4\u63a5\u540c\u6b65\u53ef\u80fd\u4f1a\u51fa\u95ee\u9898\nntpd -gq\n\nservice ntpd start \n# \u5f00\u673a\u81ea\u542f\nchkconfig ntpd on \n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/note/#centos7","title":"centos7","text":"<pre><code>vim /etc/chronyd.conf\n\n#\u67e5\u770b\u65f6\u95f4\u540c\u6b65\u6e90\uff1a\nchronyc sources -v\n\nsystemctl start chronyd\n\n#\u7acb\u5373\u624b\u5de5\u540c\u6b65,\u5371\u9669\u64cd\u4f5c\uff01\u65f6\u95f4\u5dee\u5f02\u8f83\u5927\u65f6\u76f4\u63a5\u540c\u6b65\u53ef\u80fd\u4f1a\u51fa\u95ee\u9898\nchronyc -a makestep\n\nsystemctl enable chronyd\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/note/#ubuntu","title":"ubuntu","text":"<pre><code>vim /etc/chrony/chronyd.conf\n\n#\u67e5\u770b\u65f6\u95f4\u540c\u6b65\u6e90\uff1a\nchronyc sources -v\n\nsystemctl start chronyd\n\n#\u7acb\u5373\u624b\u5de5\u540c\u6b65,\u5371\u9669\u64cd\u4f5c\uff01\u65f6\u95f4\u5dee\u5f02\u8f83\u5927\u65f6\u76f4\u63a5\u540c\u6b65\u53ef\u80fd\u4f1a\u51fa\u95ee\u9898\nchronyc -a makestep\n\nsystemctl enable chronyd\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/note/#rsync","title":"rsync\u589e\u91cf\u540c\u6b65","text":"<ul> <li>\u4f7f\u7528rsync\u534f\u8bae\uff0c\u540c\u6b65\u670d\u52a1\u7aef\u6587\u4ef6</li> </ul> <pre><code>~$ rsync rsync://mirrors.tuna.tsinghua.edu.cn/kubernetes\n\ndrwxr-xr-x              4 2020/03/02 10:28:26 .\ndrwxr-xr-x              4 2020/03/02 11:33:16 apt\ndrwxr-xr-x              3 2020/03/02 14:19:34 yum\n</code></pre> <pre><code>RSYNC_OPTS=\"-aHvh --no-o --no-g --stats --exclude .~tmp~/ --delete --delete-excluded --delete-after --delay-updates --safe-links --timeout=120 --contimeout=120\"\nupstream=\"rsync://mirrors.tuna.tsinghua.edu.cn/kubernetes/\"\ndest=\"$DIR\"\n\nrsync ${RSYNC_OPTS} \"$upstream\" \"$dest\"\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/note/#_4","title":"\u7cfb\u7edf\u65e5\u5fd7","text":"<pre><code>dmesg\n\njournalctl -f\n\njournalctl -xe\n\njournalctl -xeu kubelet\n</code></pre>","tags":["shell","linux","cli"]},{"location":"linux/redis/","title":"redis","text":""},{"location":"linux/redis/#rdb-aof","title":"rdb \u5207\u6362 aof","text":"<pre><code>redis-cli\n\n# \u5c06\u5f53\u524d\u6570\u636e\u5199\u5165rdb\n&gt; save \n\n# \u52a8\u6001\u5f00\u542faof\uff0c\u6ce8\u610f\u540c\u65f6\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u9632\u6b62\u91cd\u542f\u540e\u5931\u6548\n&gt; config set appendonly \"yes\"\n\n# \u5c06\u6570\u636e\u5199\u5165aof\u6587\u4ef6\n&gt; save\n\n# \u5230\u6570\u636e\u76ee\u5f55\u786e\u8ba4\u6587\u4ef6\u5927\u5c0f\uff0caof\u548crdb\u6587\u4ef6\u5927\u5c0f\u5e94\u5927\u81f4\u76f8\u7b49\ncd /data\n\n# \u91cd\u542fredis\u9a8c\u8bc1\n</code></pre>"},{"location":"linux/service/","title":"Service","text":""},{"location":"linux/service/#nginxservice","title":"nginx.service","text":"<p>pidFile\u548cnginx\u6267\u884c\u6587\u4ef6\u6839\u636e\u7f16\u8bd1\u5b89\u88c5\u53ef\u80fd\u4f4d\u4e8e\u4e0d\u540c\u7684\u76ee\u5f55</p> <pre><code>vim /lib/systemd/system/nginx.service\n</code></pre> <pre><code>[Unit]\nDescription=The NGINX HTTP and reverse proxy server\nAfter=syslog.target network-online.target remote-fs.target nss-lookup.target\nWants=network-online.target\n\n[Service]\nRestart=always\nType=forking\nPIDFile=/usr/local/nginx/logs/nginx.pid\nExecStartPre=/usr/local/nginx/sbin/nginx -t\nExecStart=/usr/local/nginx/sbin/nginx\nExecReload=/usr/local/nginx/sbin/nginx -s reload\nExecStop=/bin/kill -s QUIT $MAINPID\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <pre><code>[Unit]\nDescription=tunasync-manager\nDocumentation=https://github.com/tuna/tunasync/blob/master/docs/zh_CN/get_started.md\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nExecStartPre=/bin/mkdir -p /data/tunasync\nExecStartPre=/bin/chown mirrors:mirrors -R /data/tunasync\nExecStart=/usr/local/bin/tunasync manager --config /home/mirrors/tunasync_demo/conf/manager.conf\nExecStop=/bin/kill -s QUIT $MAINPID\nUser=mirrors\nGroup=mirrors\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <pre><code>[Unit]\nDescription=tunasync-worker\nDocumentation=https://github.com/tuna/tunasync/blob/master/docs/zh_CN/get_started.md\nWants=network-online.target\nAfter=network-online.target\nAfter=tunasync-manager.service\nRequires=tunasync-manager.service\n\n[Service]\nExecStartPre=/bin/mkdir -p /data/tunasync_demo\nExecStartPre=/bin/mkdir -p /data/tunasync/log\nExecStartPre=/bin/chown mirrors:mirrors -R /data/tunasync_demo\nExecStartPre=/bin/chown mirrors:mirrors -R /data/tunasync/log\nExecStart=/usr/local/bin/tunasync worker --config /home/mirrors/tunasync_demo/conf/worker.conf\nExecReload=/usr/local/bin/tunasynctl reload -w test_worker\nExecStop=/bin/kill -s QUIT $MAINPID\nUser=mirrors\nGroup=mirrors\n\n[Install]\nWantedBy=multi-user.target\n</code></pre>"},{"location":"linux/service/#registrysocket","title":"registry.socket","text":"<p><code>vim /lib/systemd/system/registry.socket</code></p> <pre><code>[Unit]\nDescription=Distribution registry\n\n[Socket]\nListenStream=5000\n\n[Install]\nWantedBy=sockets.target\n</code></pre> <p><code>vim /lib/systemd/system/registry.service</code></p> <pre><code>[Unit]\nDescription=Distribution registry\nAfter=docker.service\nRequires=docker.service\n\n[Service]\n#TimeoutStartSec=0\nRestart=always\nExecStartPre=-/usr/bin/docker stop %N\nExecStartPre=-/usr/bin/docker rm %N\nExecStart=/usr/bin/docker run --name %N \\\n    -v /data/registry:/var/lib/registry \\\n    -p 5000:5000 \\\n    registry:2\n\n[Install]\nWantedBy=multi-user.target\n</code></pre>"},{"location":"linux/%E5%86%85%E6%A0%B8%E5%8D%87%E7%BA%A7/","title":"\u5185\u6838\u5347\u7ea7","text":""},{"location":"linux/%E5%86%85%E6%A0%B8%E5%8D%87%E7%BA%A7/#ubuntu","title":"ubuntu","text":"<ul> <li> <p>(\u53ef\u9009\uff0c\u670d\u52a1\u5668\u6709\u6b63\u786e\u7684\u6e90\u914d\u7f6e\u5373\u53ef)\u914d\u7f6e\u8f6f\u4ef6\u6e90</p> </li> <li> <p>\u67e5\u770b\u5185\u6838\u5efa\u8bae\u5347\u7ea7\u7684\u6700\u65b0\u7248\u672c</p> </li> </ul> <pre><code>apt update\napt list --upgradable | grep linux-image-generic\n# \u5982\u679c\u663e\u793a\u7684\u7248\u672c\u6ee1\u8db3\u8981\u6c42\uff0c\u5219\napt install linux-image-generic\nupdate-grub\n# \u91cd\u542f\u670d\u52a1\u5668\uff0c\u4f7f\u7528\u65b0\u5185\u6838\nreboot\n# \u91cd\u542f\u540e\u9a8c\u8bc1\u5185\u6838\u7248\u672c\nuname -r\n</code></pre> <ul> <li>\u5982\u679c\u4e0a\u4e00\u6b65\u663e\u793a\u7684\u5185\u6838\u7248\u672c\u4e0d\u6ee1\u8db3\u8981\u6c42\uff0c\u53ef\u67e5\u627e\u6240\u6709\u7248\u672c</li> </ul> <pre><code>apt search linux-image | grep -B 1 \"Signed kernel image generic\" | grep -v \"Signed kernel image generic\" | sort\n\n# \u5b89\u88c5\u6307\u5b9a\u7248\u672c\uff0c\u4f8b\u5982\napt install linux-image-5.4.0-xxx-generic\nupdate-grub\n# \u91cd\u542f\u670d\u52a1\u5668\uff0c\u4f7f\u7528\u65b0\u5185\u6838\nreboot\n# \u91cd\u542f\u540e\u9a8c\u8bc1\u5185\u6838\u7248\u672c\nuname -r\n</code></pre>"},{"location":"linux/%E5%86%85%E6%A0%B8%E5%8D%87%E7%BA%A7/#centos","title":"centos","text":"<p>\u56fd\u4ea7\u7684\u57fa\u4e8ecentos\u7684\u7cfb\u7edf\u4e5f\u4e00\u6837</p> <ul> <li> <p>\u4e0b\u8f7d\u5185\u6838rpm</p> </li> <li> <p>centos7</p> </li> <li> <p>centos8</p> <p>\u4e0b\u8f7d<code>kernel-lt</code>\u7684\u6700\u65b0\u7248\uff0c\u4f8b\u5982<code>kernel-lt-5.4.277-1.el7.elrepo.x86_64.rpm</code></p> <p>lt:longterm\u7684\u7f29\u5199\uff1a\u957f\u671f\u7ef4\u62a4\u7248\uff1b ml:mainline\u7684\u7f29\u5199\uff1a\u6700\u65b0\u7a33\u5b9a\u7248\uff1b</p> </li> <li> <p>\u5b89\u88c5</p> </li> </ul> <pre><code>rpm -ivh kernel-lt-5.4.277-1.el7.elrepo.x86_64.rpm\n</code></pre> <ul> <li>\u67e5\u770b\u6240\u6709\u53ef\u7528\u5185\u6838\u7248\u672c</li> </ul> <pre><code>[root@localhost ~]# grubby --info=ALL | grep ^kernel\nkernel=/boot/vmlinuz-5.4.277-1.el7.elrepo.x86_64\nkernel=/boot/vmlinuz-3.10.0-1160.102.1.el7.x86_64\nkernel=/boot/vmlinuz-5.4.260-1.el7.elrepo.x86_64\nkernel=/boot/vmlinuz-3.10.0-1160.el7.x86_64\nkernel=/boot/vmlinuz-0-rescue-69d2f2d6d668455496e22a24b94e137e\n</code></pre> <ul> <li>\u67e5\u770b\u76ee\u524d\u5185\u6838\u7248\u672c</li> </ul> <pre><code>[root@localhost ~]# grubby --default-kernel\n/boot/vmlinuz-5.4.260-1.el7.elrepo.x86_64\n</code></pre> <ul> <li>\u8bbe\u7f6e\u5185\u6838\u7248\u672c</li> </ul> <pre><code>grubby --set-default '/boot/vmlinuz-5.4.277-1.el7.elrepo.x86_64'\n</code></pre> <ul> <li>\u91cd\u542f\u9a8c\u8bc1</li> </ul> <pre><code>reboot \nuname -r \n</code></pre>"},{"location":"linux/%E5%B8%B8%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%B0%83%E4%BC%98/","title":"\u5e38\u7528\u4e2d\u95f4\u4ef6\u8c03\u4f18","text":""},{"location":"linux/%E5%B8%B8%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%B0%83%E4%BC%98/#nginx","title":"nginx","text":"<ul> <li>\u9690\u85cfnginx\u8f6f\u4ef6\u7248\u672c\u53f7\u4fe1\u606f</li> <li>\u4fee\u6539nginx\u8fd0\u884c\u7528\u6237</li> <li>\u53c2\u6570\u4f18\u5316\uff1aworker\u8fdb\u7a0b\u6570\u3001\u8fdb\u7a0b\u7ed1\u6838</li> </ul> <pre><code>worker_processes  8;\nworker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;\n</code></pre> <ul> <li> <p>\u5355\u8fdb\u7a0b\u5141\u8bb8\u7684\u5ba2\u6237\u7aef\u6700\u5927\u8fde\u63a5\u6570\u3001worker\u8fdb\u7a0b\u6700\u5927\u6253\u5f00\u6587\u4ef6\u6570</p> </li> <li> <p>\u9650\u5236\u6587\u4ef6\u4e0a\u4f20\u5927\u5c0f\u3001\u5f00\u542fgzip</p> </li> <li> <p>\u65e5\u5fd7\u5207\u5272</p> </li> </ul>"},{"location":"linux/%E5%B8%B8%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%B0%83%E4%BC%98/#redis","title":"redis","text":"<ul> <li>\u901a\u8fc7\u6162\u65e5\u5fd7\u83b7\u53d6\u6267\u884c\u6162\u7684\u547d\u4ee4</li> <li>\u5f00\u542f lazy-free \u673a\u5236\uff0c\u9632\u6b62\u96c6\u4e2d\u8fc7\u671f\uff08\u4e3b\u52a8\u8fc7\u671f key \u7684\u5b9a\u65f6\u4efb\u52a1\uff0c\u662f\u5728 Redis \u4e3b\u7ebf\u7a0b\u4e2d\u6267\u884c\u7684\uff0c\u5982\u679c\u51fa\u73b0\u4e86\u9700\u8981\u5927\u91cf\u5220\u9664\u8fc7\u671f key \u7684\u60c5\u51b5\uff0c\u90a3\u4e48\u6b64\u65f6\u5e94\u7528\u7a0b\u5e8f\u5728\u8bbf\u95ee Redis \u65f6\uff0c\u5fc5\u987b\u8981\u7b49\u5f85\u8fd9\u4e2a\u8fc7\u671f\u4efb\u52a1\u6267\u884c\u7ed3\u675f\uff0cRedis \u624d\u53ef\u4ee5\u670d\u52a1\u8fd9\u4e2a\u5ba2\u6237\u7aef\u8bf7\u6c42\uff09</li> <li>\u5173\u95ed\u5185\u5b58\u5927\u53f6</li> <li>\u5173\u95edswap</li> </ul>"},{"location":"linux/%E5%B8%B8%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%B0%83%E4%BC%98/#mysql","title":"mysql","text":"<ul> <li>innodb_buffer_pool_size \u670d\u52a1\u5668\u5185\u5b58\u768470%</li> <li>\u78c1\u76d8io\u901f\u5ea6</li> <li>\u5145\u5206\u4f7f\u7528\u7d22\u5f15</li> <li>\u907f\u514d\u5f00\u542fgeneral log</li> </ul>"},{"location":"linux/%E7%AD%89%E4%BF%9D/","title":"\u7b49\u4fdd","text":""},{"location":"linux/%E7%AD%89%E4%BF%9D/#1","title":"1\u672a\u8bbe\u7f6e\u5bc6\u7801\u590d\u6742\u5ea6\u7b56\u7565","text":"<pre><code>1.  \u4fee\u6539/etc/security/pwquality.conf\u6587\u4ef6, \u5728ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 \u90093\u79cd\uff0c\u8ffd\u52a0\u5230password requisite pam_cracklib.so\u540e\u9762\uff0c\u6dfb\u52a0\u5230\u914d\u7f6e\u6587\u4ef6\u4e2d\u3002\n2.   \n\u6ce8\uff1aucredit\uff1a\u5927\u5199\u5b57\u6bcd\u4e2a\u6570\uff1blcredit\uff1a\u5c0f\u5199\u5b57\u6bcd\u4e2a\u6570\uff1bdcredit\uff1a\u6570\u5b57\u4e2a\u6570\uff1bocredit\uff1a\u7279\u6b8a\u5b57\u7b26\u4e2a\u6570\n\u53c2\u8003\u94fe\u63a5\uff1ahttps://www.cnblogs.com/Kevin-1967/p/9542104.html\n</code></pre>"},{"location":"linux/%E7%AD%89%E4%BF%9D/#2","title":"2\u672a\u8bbe\u7f6e\u5bc6\u7801\u6700\u5c0f\u957f\u5ea6\u3001\u8fc7\u671f\u7b56\u7565","text":"<pre><code>/etc/login.defs\n\nPASS_MAX_DAYS   90\nPASS_MIN_DAYS   1\nPASS_MIN_LEN    8\nPASS_WARN_AGE   7\n</code></pre>"},{"location":"linux/%E7%AD%89%E4%BF%9D/#3","title":"3\u672a\u8bbe\u7f6e\u767b\u5f55\u5931\u8d25\u5904\u7406\u3001\u8d85\u65f6\u9000\u51fa\u7b56\u7565","text":"<pre><code>1. vim /etc/pam.d/login\nauth  required  pam_tally2.so   deny=5  unlock_time=300 even_deny_root root_unlock_time=300\n\u542b\u4e49\uff1a\u672c\u5730\u767b\u5f55\u65f6\u8fde\u7eed\u8f93\u95195\u6b21\u5bc6\u7801\u540e\uff0c\u666e\u901a\u7528\u6237\u9501\u5b9a300\u79d2\uff0croot\u7528\u6237\u9501\u5b9a300\u79d2\n2. vim /etc/pam.d/sshd \n#%PAM-1.0 \nauth       required     pam_tally2.so        deny=5  unlock_time=300 even_deny_root root_unlock_time=300\n\n\u542b\u4e49\uff1a\u8fdc\u7a0b\u767b\u5f55\u65f6\u8fde\u7eed\u8f93\u95195\u6b21\u5bc6\u7801\u540e\uff0c\u666e\u901a\u7528\u6237\u9501\u5b9a300\u79d2\uff0croot\u7528\u6237\u9501\u5b9a300\u79d2\n3. \u5728/etc/profile \u540e\u9762\u6dfb\u52a0\nexport TMOUT=300\n\u542b\u4e49\uff1a\u64cd\u4f5c\u65f6\u95f4\u7a7a\u95f2\u8fbe\u5230300\u79d2\u540e\uff0c\u7528\u6237\u81ea\u52a8\u9000\u51fa\n\n\u53c2\u8003\u94fe\u63a5\uff1ahttps://www.cnblogs.com/charon2/p/10436092.html\n</code></pre>"},{"location":"linux/Ubuntu/note/","title":"Note","text":""},{"location":"linux/Ubuntu/note/#ip","title":"\u914d\u7f6e\u9759\u6001IP","text":"<pre><code>vim /etc/netplan/\u00b7\u00b7\u00b7.ymal\n# This is the network config written by 'subiquity'\nnetwork:\n  ethernets:\n    ens33:\n      dhcp4: true\n    ens37:\n      dhcp4: no\n      addresses: [192.168.1.11/24]\n      optional: true\n#     gateway4: 192.168.0.1\n      nameservers:\n        addresses: [223.5.5.5,223.6.6.6]\n  version: 2\n\n\nnetplan apply\n</code></pre>"},{"location":"linux/Ubuntu/note/#_1","title":"\u5fd8\u8bb0\u5bc6\u7801","text":"<p>https://blog.csdn.net/zhuwade/article/details/121853685</p>"},{"location":"linux/Ubuntu/note/#root","title":"\u542f\u7528root\u767b\u5f55","text":"<p>https://blog.csdn.net/qq_29537425/article/details/116146693</p> <pre><code>sudo passwd root\n\nsudo vim /etc/ssh/sshd_config \n\n#Authentication\nPermitRootLogin yes\n\nPasswordAuthentication yes\n\nsudo systemctl restart ssh\n</code></pre>"},{"location":"linux/Ubuntu/note/#dpkgcentosrpm","title":"dpkg\uff08\u7c7b\u4f3ccentos\u7684rpm\uff09","text":"<p>dpkg [\u53c2\u6570] \u5e38\u7528\u53c2\u6570\uff1a -i  \u5b89\u88c5\u8f6f\u4ef6\u5305 -r  \u5220\u9664\u8f6f\u4ef6\u5305 -l  \u663e\u793a\u5df2\u5b89\u88c5\u8f6f\u4ef6\u5305\u5217\u8868 -L  \u663e\u793a\u4e8e\u8f6f\u4ef6\u5305\u5173\u8054\u7684\u6587\u4ef6 -c  \u663e\u793a\u8f6f\u4ef6\u5305\u5185\u6587\u4ef6\u5217\u8868</p>"},{"location":"linux/Ubuntu/note/#_2","title":"\u5237\u65b0\u78c1\u76d8","text":"<pre><code>[root@IChen~]#ls /sys/class/scsi_host/\nhost0 host1 host2\n[root@IChen~]#echo \"---\" &gt; /sys/class/scsi_host/host0/scan \n-bash: echo: write error: Invalid argument\n[root@IChen~]#echo \"- - -\" &gt; /sys/class/scsi_host/host0/scan \n[root@IChen~]#echo \"- - -\" &gt; /sys/class/scsi_host/host1/scan \n[root@IChen~]#echo \"- - -\" &gt; /sys/class/scsi_host/host2/scan \n[root@IChen~]#fdisk -l\n\n\n#!/bin/bash\ncd /sys/class/scsi_host\nfor i in $(ls)\ndo\n  echo \"- - -\" &gt; /sys/class/scsi_host/$i/scan\ndone\n</code></pre>"},{"location":"linux/Ubuntu/note/#ca","title":"\u66f4\u65b0\u670d\u52a1\u5668ca\u8bc1\u4e66\u5e93","text":"<pre><code>apt install ca-certificates --reinstall\n</code></pre>"},{"location":"linux/shell/note/","title":"Note","text":"","tags":["shell","linux"]},{"location":"linux/shell/note/#_1","title":"\u811a\u672c\u6267\u884c\u7684\u51e0\u79cd\u65b9\u5f0f","text":"<ol> <li>\u5f53\u524dshell\u6267\u884c</li> </ol> <pre><code>source filename\n\n. filename\n</code></pre> <p>\u4e0d\u521b\u5efasubshell\uff0c\u5728\u5f53\u524dshell\u73af\u5883\u4e0b\u8bfb\u53d6\u5e76\u6267\u884cfilename\u4e2d\u7684\u547d\u4ee4\uff0c\u76f8\u5f53\u4e8e\u987a\u5e8f\u6267\u884cfilename\u91cc\u9762\u7684\u547d\u4ee4</p> <ol> <li>\u65b0\u5efa\u5b50shell\u6267\u884c</li> </ol> <pre><code>bash filename\n\n./filename\n</code></pre> <p>\u521b\u5efasubshell\uff0c\u5728\u5f53\u524dbash\u73af\u5883\u4e0b\u518d\u65b0\u5efa\u4e00\u4e2a\u5b50shell\u6267\u884cfilename\u4e2d\u7684\u547d\u4ee4\u3002 \u5b50shell\u7ee7\u627f\u7236shell\u7684\u53d8\u91cf\uff0c\u4f46\u5b50shell\u4e0d\u80fd\u4f7f\u7528\u7236shell\u7684\u53d8\u91cf\uff0c\u9664\u975e\u4f7f\u7528export \u3010\u5907\u6ce8\uff1a\u8fd9\u548c\u547d\u540d\u7a7a\u95f4\u662f\u76f8\u4f3c\u7684\u9053\u7406\uff0c\u751a\u81f3\u548cc\u4e2d\u7684\u51fd\u6570\u4e5f\u6709\u4e9b\u7c7b\u4f3c\u3011</p> <pre><code>\u5b50Shell\u4ece\u7236Shell\u7ee7\u627f\u5f97\u6765\u7684\u5c5e\u6027\u5982\u4e0b\uff1a\n\n    \u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\n    \u73af\u5883\u53d8\u91cf\n    \u6807\u51c6\u8f93\u5165\u3001\u6807\u51c6\u8f93\u51fa\u548c\u6807\u51c6\u9519\u8bef\u8f93\u51fa\n    \u6240\u6709\u5df2\u6253\u5f00\u7684\u6587\u4ef6\u6807\u8bc6\u7b26\n    \u5ffd\u7565\u7684\u4fe1\u53f7\n\n\u5b50Shell\u4e0d\u80fd\u4ece\u7236Shell\u7ee7\u627f\u7684\u5c5e\u6027\uff0c\u5f52\u7eb3\u5982\u4e0b\uff1a\n\n    \u9664\u73af\u5883\u53d8\u91cf\u548c.bashrc\u6587\u4ef6\u4e2d\u5b9a\u4e49\u53d8\u91cf\u4e4b\u5916\u7684Shell\u53d8\u91cf\n    \u672a\u88ab\u5ffd\u7565\u7684\u4fe1\u53f7\u5904\u7406\n</code></pre> <ol> <li> <p><code>$(commond)</code> \u5b83\u7684\u4f5c\u7528\u662f\u8ba9\u547d\u4ee4\u5728\u5b50shell\u4e2d\u6267\u884c</p> </li> <li> <p><code>commond</code> \u548c$(commond)\u5dee\u4e0d\u591a\u3002 \u3010\u8fd9\u91cc\u7684\u201c ` \u201d\u7b26\u53f7\u662f\u6487\uff08\u53cd\u5355\u5f15\u53f7\uff09\uff0c\u4e0d\u662f\u5355\u5f15\u53f7\uff0c\u662f\u952e\u76d8\u4e0aEsc\u6309\u952e\u4e0b\u9762\u7684\u90a3\u4e2a\u952e\u3002\u3011</p> </li> <li> <p><code>exec commond</code> \u66ff\u6362\u5f53\u524d\u7684shell\u5374\u6ca1\u6709\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8fdb\u7a0b\u3002\u8fdb\u7a0b\u7684pid\u4fdd\u6301\u4e0d\u53d8 \u4f5c\u7528: shell\u7684\u5185\u5efa\u547d\u4ee4exec\u5c06\u5e76\u4e0d\u542f\u52a8\u65b0\u7684shell\uff0c\u800c\u662f\u7528\u8981\u88ab\u6267\u884c\u547d\u4ee4\u66ff\u6362\u5f53\u524d\u7684shell\u8fdb\u7a0b\uff0c\u5e76\u4e14\u5c06\u8001\u8fdb\u7a0b\u7684\u73af\u5883\u6e05\u7406\u6389\uff0c\u800c\u4e14exec\u547d\u4ee4\u540e\u7684\u5176\u5b83\u547d\u4ee4\u5c06\u4e0d\u518d\u6267\u884c\u3002 \u5f53\u5728\u4e00\u4e2ashell\u91cc\u9762\u6267\u884cexec ls\u540e\uff0c\u4f1a\u5217\u51fa\u4e86\u5f53\u524d\u76ee\u5f55\uff0c\u7136\u540e\u8fd9\u4e2ashell\u5c31\u81ea\u5df1\u9000\u51fa\u4e86\u3002\uff08\u540e\u7eed\u547d\u4ee4\u4e0d\u518d\u6267\u884c\uff09 \u56e0\u4e3a\u8fd9\u4e2ashell\u5df2\u88ab\u66ff\u6362\u4e3a\u4ec5\u6267\u884cls\u547d\u4ee4\u7684\u8fdb\u7a0b\uff0c\u6267\u884c\u7ed3\u675f\u81ea\u7136\u4e5f\u5c31\u9000\u51fa\u4e86\u3002 \u9700\u8981\u7684\u65f6\u5019\u53ef\u4ee5\u7528sub shell \u907f\u514d\u8fd9\u4e2a\u5f71\u54cd\uff0c\u4e00\u822c\u5c06exec\u547d\u4ee4\u653e\u5230\u4e00\u4e2ashell\u811a\u672c\u91cc\u9762\uff0c\u7528\u4e3b\u811a\u672c\u8c03\u7528\u8fd9\u4e2a\u811a\u672c\uff0c\u8c03\u7528\u70b9\u5904\u53ef\u4ee5\u7528bash a.sh\uff08a.sh\u5c31\u662f\u5b58\u653e\u8be5\u547d\u4ee4\u7684\u811a\u672c\uff09\uff0c\u8fd9\u6837\u4f1a\u4e3aa.sh\u5efa\u7acb\u4e00\u4e2asub shell\u53bb\u6267\u884c\uff0c\u5f53\u6267\u884c\u5230exec\u540e\uff0c\u8be5\u5b50\u811a\u672c\u8fdb\u7a0b\u5c31\u88ab\u66ff\u6362\u6210\u4e86\u76f8\u5e94\u7684exec\u7684\u547d\u4ee4\u3002</p> </li> </ol>","tags":["shell","linux"]},{"location":"linux/shell/note/#shellcheck","title":"shellcheck","text":"","tags":["shell","linux"]},{"location":"linux/shell/note/#_2","title":"\u5b89\u88c5","text":"<ul> <li>debian/ubuntu</li> </ul> <pre><code>sudo apt install shellcheck\n</code></pre> <ul> <li>centos</li> </ul> <pre><code>sudo yum -y install epel-release\nsudo yum install ShellCheck\n</code></pre> <ul> <li>vim</li> </ul> <pre><code>mkdir -p ~/.vim/pack/git-plugins/start\ngit clone --depth 1 https://github.com/dense-analysis/ale.git ~/.vim/pack/git-plugins/start/ale\n</code></pre> <ul> <li>VSCode\uff1a\u901a\u8fc7 vscode-shellcheck \u5b89\u88c5\u3002</li> </ul>","tags":["shell","linux"]},{"location":"linux/shell/note/#_3","title":"\u4f7f\u7528","text":"<pre><code>shellcheck yourscript\n</code></pre>","tags":["shell","linux"]},{"location":"linux/shell/note/#set-o-pipefail","title":"set -o pipefail","text":"<p>\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u7ba1\u9053\u547d\u4ee4\uff08\u7531\u591a\u4e2a\u547d\u4ee4\u901a\u8fc7\u7ba1\u9053\u7b26 | \u8fde\u63a5\u800c\u6210\u7684\u547d\u4ee4\uff09\u7684\u9000\u51fa\u72b6\u6001\u662f\u6700\u540e\u4e00\u4e2a\u547d\u4ee4\u7684\u9000\u51fa\u72b6\u6001\uff0c\u800c\u4e0d\u8003\u8651\u524d\u9762\u7684\u547d\u4ee4\u662f\u5426\u6267\u884c\u6210\u529f\u3002</p> <pre><code>command1 | command2\n</code></pre> <p>\u5982\u679c command1 \u5931\u8d25\uff08\u8fd4\u56de\u975e\u96f6\u9000\u51fa\u72b6\u6001\uff09\uff0c\u4f46 command2 \u6210\u529f\uff08\u8fd4\u56de\u96f6\u9000\u51fa\u72b6\u6001\uff09\uff0c\u90a3\u4e48\u6574\u4e2a\u7ba1\u9053\u547d\u4ee4\u7684\u9000\u51fa\u72b6\u6001\u662f 0\uff08\u6210\u529f\uff09\u3002</p> <p>\u4f46\u662f\u5982\u679c\u4f60\u4f7f\u7528\u4e86set -o pipefail\uff0c\u90a3\u4e48\u5982\u679c command1 \u5931\u8d25\uff0c\u6574\u4e2a\u7ba1\u9053\u547d\u4ee4\u7684\u9000\u51fa\u72b6\u6001\u5c31\u662f command1 \u7684\u9000\u51fa\u72b6\u6001\uff0c\u5373\u4f7f command2 \u6210\u529f\u3002</p>","tags":["shell","linux"]},{"location":"linux/shell/note/#flock","title":"flock","text":"<p>https://blog.csdn.net/weixin_31748605/article/details/116879655</p> <pre><code>*/5 * * * * flock -xn /tmp/lock -c 'start.sh &gt;/dev/null 2&gt;&amp;1'\n</code></pre> <ul> <li>e.g.</li> </ul> <pre><code>(\nflock -s 200\n\n# ... commands executed under lock ...\necho $$\n\n) 200&gt;/var/lock/mylockfile\n</code></pre> <pre><code>#!/bin/bash\n\n{\n\nflock -n 3\n\n[ $? -eq 1 ] &amp;&amp; { echo fail; exit; }\n\necho $$\n\n} 3&lt;&gt;mylockfile\n</code></pre>","tags":["shell","linux"]},{"location":"linux/shell/yq/","title":"Yq","text":"<pre><code>---\nbob:\n  item1:\n    cats: bananas\n  item2:\n    cats: apples\n</code></pre> <pre><code>yq eval '.bob.*.cats' sample.yaml\n</code></pre> <pre><code>- bananas\n- apples\n</code></pre>"},{"location":"mysql/note/","title":"Note","text":"","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#1","title":"1.\u6388\u6743","text":"<pre><code>create database `sys` character set 'utf8mb4' collate 'utf8mb4_general_ci';\n\n-- create user dashboard@'%' identified by '';\ngrant all privileges on `sys`.* to  sys@'%' identified by '';\nflush privileges;\n\nuse \nsource \n</code></pre>","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#2mysql","title":"2.mysql\u67e5\u770b\u67d0\u5e93\u8868\u5927\u5c0f","text":"<p>\u67e5\u8be2\u6240\u6709\u6570\u636e\u5e93\u5360\u7528\u78c1\u76d8\u7a7a\u95f4\u5927\u5c0f\uff1a</p> <pre><code>select TABLE_SCHEMA, concat(truncate(sum(data_length)/1024/1024,2),' MB') as data_size,\nconcat(truncate(sum(index_length)/1024/1024,2),'MB') as index_size\nfrom information_schema.tables\ngroup by TABLE_SCHEMA\norder by data_length desc;\n</code></pre> <p>\u67e5\u8be2\u5355\u4e2a\u5e93\u4e2d\u6240\u6709\u8868\u78c1\u76d8\u5360\u7528\u5927\u5c0f\uff1a</p> <pre><code>-- \u6ce8\u610f\u66ff\u6362TestDB\u4e3a\u6570\u636e\u5e93\u540d\nselect TABLE_NAME, concat(truncate(data_length/1024/1024,2),' MB') as data_size,\nconcat(truncate(index_length/1024/1024,2),' MB') as index_size\nfrom information_schema.tables where TABLE_SCHEMA = 'TestDB'\ngroup by TABLE_NAME\norder by data_length desc;\n</code></pre>","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#3","title":"3. \u4e3b\u4ece\u5f02\u5e38\u5904\u7406\u65b9\u6cd5","text":"","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#4","title":"4. \u67e5\u770b\u8fde\u63a5\u60c5\u51b5","text":"<pre><code>-- \u975esleep\u8fde\u63a5\nselect * from information_schema.`PROCESSLIST` p where p.COMMAND != \"sleep\" ORDER BY p.TIME DESC;\n\n-- \u6309\u7528\u6237\u548cIP\u7edf\u8ba1\u8fde\u63a5\u60c5\u51b5\nselect USER,SUBSTRING_INDEX(HOST, ':', 1) as ip, count(1) as count  from information_schema.PROCESSLIST p GROUP BY  ip, USER  ORDER BY count DESC;\n</code></pre>","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#5","title":"5. \u540e\u53f0\u6267\u884c\u547d\u4ee4","text":"<pre><code>nohup mysql -usa -pabcd1234 -e 'source /db.sql' &amp;\nnohup mysql -uroot -p1qaz@WSX -h192.168.1.11 -P32614 -e 'ALTER TABLE `dj1910`.`polls_choice` add INDEX choice_text(`choice_text`)' &gt;/dev/null 2&gt;&amp; 1 &amp;\n</code></pre>","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#6-mysqlprepared-statement-needs-to-be-re-prepared","title":"6. mysql:Prepared statement needs to be re-prepared\u89e3\u51b3\u529e\u6cd5","text":"","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#7","title":"7. \u5907\u4efd","text":"<pre><code># \u6392\u9664\u4e00\u4e9b\u5e93\nmysql -uroot -p'P@ssw0rd01!' -h192.171.225.227 -N -e \"show databases;\"|grep -Ev \"information_schema|performance_schema|mysql\"|xargs mysqldump -uroot -p'P@ssw0rd01!' -h192.171.225.227 --databases &gt; yewu-20220928.sql\n</code></pre>","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#8","title":"8. \u6062\u590d","text":"<pre><code># \u4ece\u5907\u4efdsql\u4e2d\u8fc7\u6ee4\ncat 2023-02-23_all.sql | sed -n '/INSERT INTO `ykpjgl` VALUES/p' &gt; /tmp/xxx.sql\n</code></pre>","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#9","title":"9. \u4fee\u6539\u7528\u6237\u5bc6\u7801","text":"<pre><code>ALTER USER root@'%' IDENTIFIED BY 'xxxx';\n</code></pre>","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#10","title":"10. \u4e3b\u4ece\u6062\u590d","text":"<pre><code>-- primary\u6267\u884c\nshow master status;\n\ncreate user 'replicater1'@'%' identified by 'xxxx';\n\n-- \u4ec5MySQL\uff0c\u9047\u5230\u62a5\u9519\u65f6\nALTER USER 'replicater1'@'%' IDENTIFIED WITH mysql_native_password BY 'xxxx';\n\ngrant replication slave on *.* to 'replicater1'@'%';\n\n-- secondary\u6267\u884c\nstop slave;\nreset slave;\nchange master to MASTER_HOST='10.81.40.146',MASTER_PORT=3306,MASTER_USER='replicater1',MASTER_PASSWORD='xxxx',MASTER_LOG_FILE='mysql_bin.000012',MASTER_LOG_POS=4112;\nstart slave;\nshow slave status \\G\n\n\nstop slave; \nset global sql_slave_skip_counter =1; \nstart slave; \nshow slave status \\G\n</code></pre> <pre><code>xtrabackup --defaults-file=/etc/my.cnf --backup --user=root --password=xxxx --target-dir=/mnt/full-$(date +%F-%H%M)\nxtrabackup --prepare --target-dir=/home/infoplus/full-2023-07-06-0957\nxtrabackup --defaults-file=/etc/my.cnf --copy-back --target-dir=/home/infoplus/full-2023-07-06-0957\n</code></pre>","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#mariadb-backup","title":"mariadb-backup\u70ed\u5907\u548c\u589e\u91cf\u5907\u4efd","text":"<p>MariaDB\u57fa\u4e8epercona xtrabackup\u5f00\u53d1\u4e86\u5b83\u81ea\u5df1\u7684\u5907\u4efd\u5de5\u5177\uff1aMariaDB Backup\u3002\u5b83\u57fa\u4e8extrabackup\u5f00\u53d1\uff0c\u6240\u4ee5\u6240\u7528\u65b9\u6cd5\u57fa\u672c\u548cxtrabackup\u76f8\u540c\uff0c\u53ea\u662f\u6709\u4e9b\u81ea\u5df1\u7684\u7279\u6027\u3002</p> <pre><code>apt install mariadb-backup\n\nyum install MariaDB-backup\n</code></pre> <ul> <li>\u547d\u4ee4\u4f7f\u7528\u53c2\u8003</li> </ul> <p>\u5b98\u65b9\u6587\u6863</p> <pre><code>mariabackup --defaults-file=/etc/my.cnf --backup  --user=backupuser  --password='tany' -S /tmp/mysql.sock --target-dir=/data/backup\n#\u5168\u91cf\u5907\u4efd, \u9700\u8981\u6307\u5b9a\u65b0\u76ee\u5f55\uff0c\u6587\u4ef6\u76f4\u63a5\u653e\u5728\u76ee\u5f55\u91cc\uff0c\u4e0d\u50cfxtra\u90a3\u6837\u81ea\u52a8\u65b0\u5efa\u4ee5\u65e5\u671f\u547d\u540d\u7684\u76ee\u5f55\uff1b\nmariabackup --defaults-file=/etc/my.cnf --backup  --user=backupuser  --password='tany' -S /tmp/mysql.sock --incremental-basedir=/data/backup/ --target-dir=/data/backup/backup2\n#\u7b2c\u4e00\u6b21\u589e\u91cf\u5907\u4efd\uff1b\nmariabackup --defaults-file=/etc/my.cnf --backup  --user=backupuser  --password='tany' -S /tmp/mysql.sock --incremental-basedir=/data/backup/backup2/ --target-dir=/data/backup/backup3\n#\u7b2c\u4e8c\u6b21\u589e\u91cf\u5907\u4efd\uff1b\nservice mysqld stop     #\u6062\u590d\u524d\uff0c\u505c\u6b62mysql;\nmv /data/mysql /data/mysql.bak  #\u6e05\u9664\u539f\u6765\u6570\u636e\u6587\u4ef6\uff1b\ncp -r /data/backup /data/backup.bak     #\u5907\u4efd\u5907\u4efd\u6587\u4ef6\uff1b\ncd /data/backup\nmv backup2 ../          #\u8c03\u6574\u76ee\u5f55\u4f4d\u7f6e\uff1b\nmv backup3 ../          #\u8c03\u6574\u76ee\u5f55\u4f4d\u7f6e\uff0c\u5907\u4efd\u65f6\u6307\u5b9a\u5907\u4efd\u76ee\u5f55/data/backup*\u66f4\u65b9\u4fbf\uff1b\n</code></pre> <ul> <li>\u5907\u4efd\u548c\u6062\u590d\u6848\u4f8b</li> </ul> <pre><code># \u5168\u91cf\u5907\u4efd\nmariabackup --defaults-file=/mnt/my.cnf --backup --user=root --password='1qaz@WSX' --host=172.19.205.0 --port=3306 --target-dir=/mnt/backup/full-$(date +%F-%H%M)\n# \u589e\u91cf\u5907\u4efd1\nmariabackup --defaults-file=/mnt/my.cnf --backup --user=root --password='1qaz@WSX' --host=172.19.205.0 --port=3306 --incremental-basedir=/mnt/backup/full-$(date +%F-%H%M) --target-dir=/mnt/backup/backup1-$(date +%F-%H%M)\n# \u589e\u91cf\u5907\u4efd2\nmariabackup --defaults-file=/mnt/my.cnf --backup --user=root --password='1qaz@WSX' --host=172.19.205.0 --port=3306 --incremental-basedir=/mnt/backup/backup1-$(date +%F-%H%M) --target-dir=/mnt/backup/backup2-$(date +%F-%H%M)\n\n\n# \u6062\u590d\u51c6\u5907\nmariabackup --prepare --target-dir=/mnt/backup/full-$(date +%F-%H%M)\n# \u6062\u590d\u51c6\u59071\nmariabackup --prepare --target-dir=/mnt/backup/full-$(date +%F-%H%M) --incremental-dir=/mnt/backup/backup1-$(date +%F-%H%M)\n# \u6062\u590d\u51c6\u59072\nmariabackup --prepare --target-dir=/mnt/backup/full-$(date +%F-%H%M) --incremental-dir=/mnt/backup/backup2-$(date +%F-%H%M)\n# \u6062\u590d\u505c\u6b62\u6570\u636e\u5e93\nsystemctl stop mysqld\n\ncd /var/lib/mysql\nrm -rf *\n\nmariabackup --copy-back --target-dir=/mnt/backup/full-$(date +%F-%H%M)\n\nchown -R mysql:mysql /var/lib/mysql/\n\nsystemctl start mysqld\n</code></pre>","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#mariadbmariabackup","title":"\u5bb9\u5668\u5316mariadb\u5982\u4f55\u4f7f\u7528mariabackup","text":"<p>\u5c06mariadb\u7684\u6570\u636e\u76ee\u5f55\u6302\u8f7d\u8fdb\u6267\u884c\u5907\u4efd\u7684\u5bb9\u5668\u5b9e\u73b0</p> <pre><code># \u5fc5\u987b\u5728\u6570\u636e\u5e93\u5b58\u50a8\u76ee\u5f55\u6240\u5728\u8282\u70b9\u8fd0\u884c\n# extraVolumes[0].hostPath.path\u662f\u6570\u636e\u5e93\u6570\u636e\u5b58\u50a8\u76ee\u5f55\u5728\u8282\u70b9\u4e0a\u7684\u8def\u5f84\n# extraVolumeMounts[0].mountPath\u5fc5\u987b\u662f\u6570\u636e\u5e93\u53d8\u91cfdatadir\uff08show VARIABLES like 'datadir'\uff09\u7684\u503c\n# extraVolumes[1].hostPath.path\u662f\u5907\u4efd\u5230\u4e3b\u673a\u4e0a\u7684\u8fd9\u4e2a\u76ee\u5f55\n# extraVolumeMounts[1].mountPath\u662f\u5907\u4efd\u5230\u8fd9\u4e2a\u76ee\u5f55\n# extraVolumes[2].configMap.name\u662fmariadb\u914d\u7f6e\u6587\u4ef6\u7684cm\n# \nhelm upgrade --install mariabackup ./demo -n default \\\n--set nodeAffinityPreset.type='hard' \\\n--set nodeAffinityPreset.key='kubernetes.io/hostname' \\\n--set nodeAffinityPreset.values[0]='k8s-master1' \\\n--set lifecycleHooks.postStart.exec.command[0]='/bin/bash' \\\n--set lifecycleHooks.postStart.exec.command[1]='-c' \\\n--set lifecycleHooks.postStart.exec.command[2]='yum -y install MariaDB-backup || yum makecache &amp;&amp; yum -y install MariaDB-backup' \\\n--set extraVolumes[0].hostPath.path='/data/kubernetes/default-data-mariadb-local-0-pvc-7616153b-00dc-421c-9c19-c9afc9db0dd6/data' \\\n--set extraVolumes[0].name='datadir' \\\n--set extraVolumeMounts[0].name='datadir' \\\n--set extraVolumeMounts[0].mountPath='/bitnami/mariadb/data/' \\\n--set extraVolumeMounts[0].readOnly='true' \\\n--set extraVolumes[1].hostPath.path='/opt/backup' \\\n--set extraVolumes[1].name='bakdir' \\\n--set extraVolumeMounts[1].name='bakdir' \\\n--set extraVolumeMounts[1].mountPath='/mnt/backup' \\\n--set extraVolumes[2].configMap.name='mariadb-local' \\\n--set extraVolumes[2].name='mariadb-config' \\\n--set extraVolumeMounts[2].name='mariadb-config' \\\n--set extraVolumeMounts[2].mountPath='/mnt/my.cnf' \\\n--set extraVolumeMounts[2].subPath='my.cnf'\n\n# \u5f85\u5bb9\u5668\u542f\u52a8\u540e\u767b\u5f55\u5bb9\u5668\u6267\u884c\nmariabackup --defaults-file=/mnt/my.cnf --backup --user=root --password='1qaz@WSX' --host=172.19.205.0 --port=3306 --target-dir=/mnt/backup/full-$(date +%F-%H%M)\n# \u6267\u884c\u5b8c\u6210\u540e\u5907\u4efd\u6587\u4ef6\u5728/opt/backup\n</code></pre>","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#11","title":"11. \u538b\u6d4b","text":"<pre><code>mysqlslap -h10.96.105.230 -uroot -p'1qaz@WSX' \\\n--concurrency=200 --iterations=10 --auto-generate-sql --auto-generate-sql-load-type=mixed \\\n--auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=150000 \n\n\nmysqlslap  -h192.168.182.16 -uroot -p'1qaz@WSX' \\\n--concurrency=200 --iterations=10 --auto-generate-sql --auto-generate-sql-load-type=mixed \\\n--auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=150000 \n</code></pre> <pre><code># k8s nfs\nroot@k8s-node1:~# mysqlslap -h10.96.105.230 -uroot -p'1qaz@WSX' \\\n&gt; --concurrency=200 --iterations=10 --auto-generate-sql --auto-generate-sql-load-type=mixed \\\n&gt; --auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=150000 \nBenchmark\n        Running for engine innodb\n        Average number of seconds to run all queries: 9.370 seconds\n        Minimum number of seconds to run all queries: 8.559 seconds\n        Maximum number of seconds to run all queries: 10.447 seconds\n        Number of clients running queries: 200\n        Average number of queries per client: 750\n\nroot@k8s-node1:~# mysqlslap -h10.96.105.230 -uroot -p'1qaz@WSX' --concurrency=200 --iterations=10 --auto-generate-sql --auto-generate-sql-load-type=mixed --auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=150000 \nBenchmark\n        Running for engine innodb\n        Average number of seconds to run all queries: 9.204 seconds\n        Minimum number of seconds to run all queries: 8.545 seconds\n        Maximum number of seconds to run all queries: 10.759 seconds\n        Number of clients running queries: 200\n        Average number of queries per client: 750\n\nroot@k8s-node1:~# mysqlslap -h10.96.105.230 -uroot -p'1qaz@WSX' --concurrency=200 --iterations=10 --auto-generate-sql --auto-generate-sql-load-type=mixed --auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=150000 \nBenchmark\n        Running for engine innodb\n        Average number of seconds to run all queries: 9.932 seconds\n        Minimum number of seconds to run all queries: 8.094 seconds\n        Maximum number of seconds to run all queries: 16.321 seconds\n        Number of clients running queries: 200\n        Average number of queries per client: 750\n\n# k8s \u4e3b\u673a\u5b58\u50a8\nroot@k8s-node1:~# mysqlslap -h10.96.250.214 -uroot -p'1qaz@WSX' \\\n&gt; --concurrency=200 --iterations=10 --auto-generate-sql --auto-generate-sql-load-type=mixed \\\n&gt; --auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=150000 \nBenchmark\n        Running for engine innodb\n        Average number of seconds to run all queries: 7.098 seconds\n        Minimum number of seconds to run all queries: 6.645 seconds\n        Maximum number of seconds to run all queries: 8.038 seconds\n        Number of clients running queries: 200\n        Average number of queries per client: 750\n\nroot@k8s-node1:~# mysqlslap -h10.96.250.214 -uroot -p'1qaz@WSX' --concurrency=200 --iterations=10 --auto-generate-sql --auto-generate-sql-load-type=mixed --auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=150000 \nBenchmark\n        Running for engine innodb\n        Average number of seconds to run all queries: 7.053 seconds\n        Minimum number of seconds to run all queries: 6.571 seconds\n        Maximum number of seconds to run all queries: 7.505 seconds\n        Number of clients running queries: 200\n        Average number of queries per client: 750\n\nroot@k8s-node1:~# mysqlslap -h10.96.250.214 -uroot -p'1qaz@WSX' --concurrency=200 --iterations=10 --auto-generate-sql --auto-generate-sql-load-type=mixed --auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=150000 \nBenchmark\n        Running for engine innodb\n        Average number of seconds to run all queries: 6.695 seconds\n        Minimum number of seconds to run all queries: 6.182 seconds\n        Maximum number of seconds to run all queries: 7.050 seconds\n        Number of clients running queries: 200\n        Average number of queries per client: 750\n\n\n# \u865a\u62df\u5316\nroot@k8s-node1:~# mysqlslap  -h192.168.182.16 -uroot -p'1qaz@WSX' \\\n&gt; --concurrency=200 --iterations=10 --auto-generate-sql --auto-generate-sql-load-type=mixed \\\n&gt; --auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=150000 \nBenchmark\n        Running for engine innodb\n        Average number of seconds to run all queries: 5.742 seconds\n        Minimum number of seconds to run all queries: 5.386 seconds\n        Maximum number of seconds to run all queries: 6.781 seconds\n        Number of clients running queries: 200\n        Average number of queries per client: 750\n\nroot@k8s-node1:~# mysqlslap  -h192.168.182.16 -uroot -p'1qaz@WSX' --concurrency=200 --iterations=10 --auto-generate-sql --auto-generate-sql-load-type=mixed --auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=150000 \nBenchmark\n        Running for engine innodb\n        Average number of seconds to run all queries: 5.741 seconds\n        Minimum number of seconds to run all queries: 5.031 seconds\n        Maximum number of seconds to run all queries: 6.400 seconds\n        Number of clients running queries: 200\n        Average number of queries per client: 750\n\nroot@k8s-node1:~# mysqlslap  -h192.168.182.16 -uroot -p'1qaz@WSX' --concurrency=200 --iterations=10 --auto-generate-sql --auto-generate-sql-load-type=mixed --auto-generate-sql-add-autoincrement --engine=innodb --number-of-queries=150000 \nBenchmark\n        Running for engine innodb\n        Average number of seconds to run all queries: 5.594 seconds\n        Minimum number of seconds to run all queries: 5.067 seconds\n        Maximum number of seconds to run all queries: 6.030 seconds\n        Number of clients running queries: 200\n        Average number of queries per client: 750\n</code></pre>","tags":["mysql","mariadb","database"]},{"location":"mysql/note/#_1","title":"\u67e5\u770b\u9501\u8868","text":"<pre><code>SELECT * FROM information_schema.INNODB_TRX; \n\nkill trx_mysql_thread_id;\n</code></pre>","tags":["mysql","mariadb","database"]},{"location":"mysql/ubuntu%E5%8D%87%E7%BA%A7mysql/","title":"ubuntu 14.04 mysql5.5 \u5347\u7ea7 mysql5.7","text":""},{"location":"mysql/ubuntu%E5%8D%87%E7%BA%A7mysql/#_1","title":"\u5347\u7ea7\u524d\u68c0\u67e5\uff0c\u6709\u9519\u8bef\u9700\u5148\u89e3\u51b3","text":"<pre><code>mysqlcheck -u root -p --all-databases --check-upgrade\n</code></pre>"},{"location":"mysql/ubuntu%E5%8D%87%E7%BA%A7mysql/#ubuntu1604mysqlapt","title":"\u5347\u7ea7\u64cd\u4f5c\u7cfb\u7edf\u5230ubuntu16.04\uff0cmysql\u4f1a\u8ddf\u968fapt\u6e90\u5347\u7ea7\uff0c\u6ce8\u610f\u5347\u7ea7\u524d\u5907\u4efd\u6570\u636e\uff0c\u5907\u4efd\u6570\u636e\u5e93\u914d\u7f6e\u6587\u4ef6","text":"<ul> <li> <p>\u53ef\u9009\u4fee\u6539\u8f6f\u4ef6\u6e90 https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/</p> </li> <li> <p>\u6267\u884c\u5347\u7ea7</p> </li> </ul> <pre><code>apt update\napt dist-upgrade\n\nreboot\n\n# \u4e2d\u95f4\u63d0\u793a\u662f\u5426\u91cd\u542f\u670d\u52a1\u9009yes\ndo-release-upgrade\n\n# \u9a8c\u8bc1\nlsb_release -a \n</code></pre>"},{"location":"mysql/ubuntu%E5%8D%87%E7%BA%A7mysql/#ubuntu-1604-mysql57-mysql80","title":"ubuntu 16.04 mysql5.7 \u5347\u7ea7 mysql8.0","text":""},{"location":"mysql/ubuntu%E5%8D%87%E7%BA%A7mysql/#_2","title":"\u5347\u7ea7\u524d\u68c0\u67e5\uff0c\u6709\u9519\u8bef\u9700\u5148\u89e3\u51b3","text":"<pre><code>mysqlcheck -u root -p --all-databases --check-upgrade\n</code></pre>"},{"location":"mysql/ubuntu%E5%8D%87%E7%BA%A7mysql/#_3","title":"\u5907\u4efd\u6570\u636e\uff0c\u5907\u4efd\u6570\u636e\u5e93\u914d\u7f6e\u6587\u4ef6","text":""},{"location":"mysql/ubuntu%E5%8D%87%E7%BA%A7mysql/#mysql80","title":"\u6dfb\u52a0mysql8.0\u8f6f\u4ef6\u6e90","text":"<p>\u5b98\u65b9\u5730\u5740(\u6216\u8005\u6309\u4e0b\u9762\u547d\u4ee4\u6267\u884c)</p> <ul> <li>\u914d\u7f6eapt\u6e90</li> </ul> <pre><code>wget https://dev.mysql.com/get/mysql-apt-config_0.8.30-1_all.deb\n\n# \u5b89\u88c5\u8fc7\u7a0b\u4e2d\u6709\u4e24\u6b21\u63d0\u793a\uff0c\u5047\u5982\u9700\u8981\u9009\u62e9\u64cd\u4f5c\u7cfb\u7edf\uff0c\u53ef\u4ee5\u968f\u610f\u9009\u4e00\u4e2aubuntu\u3002\u7b2c\u4e8c\u4e2a\u76f4\u63a5\u9009OK\ndpkg -i mysql-apt-config_0.8.30-1_all.deb\n</code></pre> <ul> <li>ubuntu16.04\u8fd8\u9700\u8981\u624b\u5de5\u4fee\u6539</li> </ul> <pre><code># \u4fee\u6539\u6587\u4ef6\u4e2d\u7684\u53d1\u884c\u7248\u540d\u79f0\u4e3aubuntu16.04\u7684xenial\uff0c\u4fee\u6539\u7248\u672c\u4e3a8.0\nvim /etc/apt/sources.list.d/mysql.list\n</code></pre> <ul> <li>\u4fee\u6539\u540e</li> </ul> <pre><code>### THIS FILE IS AUTOMATICALLY CONFIGURED ###\n# You may comment out entries below, but any other modifications may be lost.\n# Use command 'dpkg-reconfigure mysql-apt-config' as root for modifications.\ndeb [signed-by=/usr/share/keyrings/mysql-apt-config.gpg] http://repo.mysql.com/apt/ubuntu/ xenial mysql-apt-config\ndeb [signed-by=/usr/share/keyrings/mysql-apt-config.gpg] http://repo.mysql.com/apt/ubuntu/ xenial mysql-8.0\ndeb [signed-by=/usr/share/keyrings/mysql-apt-config.gpg] http://repo.mysql.com/apt/ubuntu/ xenial mysql-tools\n#deb [signed-by=/usr/share/keyrings/mysql-apt-config.gpg] http://repo.mysql.com/apt/ubuntu/ xenial mysql-tools-preview\ndeb-src [signed-by=/usr/share/keyrings/mysql-apt-config.gpg] http://repo.mysql.com/apt/ubuntu/ xenial mysql-8.0\n</code></pre> <ul> <li>\u5378\u8f7d\u8001\u7684mysql5.7</li> </ul> <pre><code>apt remove mysql-server\napt autoremove\n</code></pre> <ul> <li>\u5b89\u88c5mysql8.0</li> </ul> <pre><code>apt install mysql-server\n</code></pre> <ul> <li> <p>\u767b\u5f55\u6570\u636e\u5e93\u6d4b\u8bd5</p> </li> <li> <p>\u6d4b\u8bd5\u5e94\u7528\u7a0b\u5e8f</p> </li> </ul> <p>\u5982\u679c\u53d1\u73b0\u6709\u95ee\u9898\uff0c\u53ef\u4ee5\u5378\u8f7dmysql8.0\uff0c\u5728\u5b89\u88c5\u524d\u6e05\u7a7a\u6570\u636e\u76ee\u5f55\uff0c\u5b89\u88c5\u540e\uff0c\u518d\u4f7f\u7528\u5907\u4efd\u7684sql\u6587\u4ef6\u5bfc\u5165\u6570\u636e</p>"},{"location":"mysql/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/","title":"\u95ee\u9898\u8bb0\u5f55","text":"","tags":["mysql","mariadb","database"]},{"location":"mysql/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/#1118-row-size-too-large-8126-changing-some-columns-to-text-or-blob-may-help-in-current-row-format-blob-prefix-of-0-bytes-is-stored-inline","title":"1118 - Row size too large (&gt; 8126). Changing some columns to TEXT or BLOB may help. In current row format, BLOB prefix of 0 bytes is stored inline.","text":"<p>innodb_file_per_table=1</p> <p>innodb_file_format=Barracuda</p> <p>innodb_file_format_check = ON</p> <p>innodb_log_file_size = 512M</p> <p>innodb_strict_mode = 0</p> <p>\u4e00\u5b9a\u8981\u52a0\u6700\u540e\u4e00\u4e2a</p>","tags":["mysql","mariadb","database"]},{"location":"nginx/note/","title":"Note","text":"","tags":["nginx","proxy","web"]},{"location":"nginx/note/#ingress-nginx","title":"ingress-nginx\u751f\u6210","text":"<p>ingress-nginx.conf</p>","tags":["nginx","proxy","web"]},{"location":"nginx/%E5%A4%96%E9%83%A8nginx%E4%BB%A3%E7%90%86%E5%88%B0ingress-nginx/","title":"\u5916\u90e8nginx\u4ee3\u7406\u5230ingress nginx","text":"<pre><code>upstream clusertaskcenter {\n     server 192.168.241.66:80;\n     server 192.168.241.67:80;\n     server 192.168.241.68:80;\n     server 192.168.241.69:80;\n     server 192.168.241.70:80;\n     server 192.168.241.71:80;\n\n}\n\nserver\n{\n    listen 80;\n    listen  443 ssl;\n    server_name *;\n        ssl_certificate \"/etc/pki/nginx/tls.crt\";\n        ssl_certificate_key \"/etc/pki/nginx/tls.key\";\n\n        ssl_session_timeout  10m;\n        ssl_ciphers HIGH:!aNULL:!MD5:!RC4;\n        ssl_prefer_server_ciphers on;\n\n    # proxy_ssl_server_name on; \n    # proxy_ssl_protocols SSLv3;\n    # proxy_redirect     off;        \n        proxy_set_header   X-Real-IP    $remote_addr;\n        proxy_set_header   X-Forwarded-For   $remote_addr;\n        proxy_set_header   X-Forwarded-Proto https;\n        proxy_set_header   X-Forwarded-Port 443;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"Upgrade\";\n\n        proxy_set_header Connection \"\";\n        proxy_set_header Host $host;\n\n        # error_log /var/log/nginx/infoplus_error.log warn;\n        # access_log  /var/log/nginx/infoplus-ssl-access.log  main;\n\n\n\n    location  / {\n        proxy_pass      http://clusertaskcenter:80;\n    }\n\n }\n</code></pre>"},{"location":"oracle/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/","title":"\u95ee\u9898\u8bb0\u5f55","text":"","tags":["oracle","database"]},{"location":"oracle/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/#_1","title":"\u95ee\u9898\u8bb0\u5f55","text":"","tags":["oracle","database"]},{"location":"oracle/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/#1ora-12899","title":"1.ORA-12899","text":"<p>\u53c2\u8003\uff1a https://www.cnblogs.com/bingo1717/p/7803359.html </p> <p>\u6267\u884csql\u6587\u4ef6\u65f6\uff0c\u5ba2\u6237\u7aef\u7684\u5b57\u7b26\u96c6\u73af\u5883\u53d8\u91cf\u548c\u6570\u636e\u5e93\u4e0d\u4e00\u81f4\u5bfc\u81f4 - \u89e3\u51b3\u65b9\u6cd5\uff1a 1. \u67e5\u770b\u6570\u636e\u5e93\u5b57\u7b26\u96c6\uff0c\u767b\u5f55\u6570\u636e\u5e93\u6267\u884c\u5982\u4e0b\u67e5\u8be2: select userenv('language') from dual;</p> <ol> <li> <p>vi .bash_profile LANG=\"zh_CN.UTF-8\" export LANG NLS_LANG=\"AMERICAN_AMERICA.AL32UTF8\"  #\u503c\u4fee\u6539\u4e3a\u7b2c\u4e00\u6b65\u4e2d\u83b7\u53d6\u7684\u5b57\u7b26\u96c6 export NLS_LANG</p> </li> <li> <p>source .bash_profile \u7136\u540e\u518d\u6267\u884csql\u6587\u4ef6\u5373\u53ef</p> </li> </ol>","tags":["oracle","database"]},{"location":"oracle/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/#2-ora-65096-invalid-common-user-or-role-name","title":"2. ORA-65096: invalid common user or role name","text":"<ul> <li>\u6267\u884c\u4ee5\u4e0b\u8bed\u53e5\u518d\u521b\u5efa\u7528\u6237</li> </ul> <pre><code>alter session set \"_ORACLE_SCRIPT\"=true;\n</code></pre>","tags":["oracle","database"]},{"location":"oracle/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/#_2","title":"\u95ee\u9898\u8bb0\u5f55","text":"<ul> <li>\u767b\u5f55\u8d85\u7ba1</li> </ul> <pre><code>sqlplus / as sysdba\n\nsqlplus system/n4rpYKviqm3LSTTKVMQR\n</code></pre> <pre><code>-- \u67e5\u770bdatafile\u8def\u5f84\nselect name from v$datafile;\n\nNAME\n--------------------------------------------------------------------------------\n/u02/app/oracle/oradata/ORCLCDB/orclpdb1/system01.dbf\n/u02/app/oracle/oradata/ORCLCDB/orclpdb1/sysaux01.dbf\n/u02/app/oracle/oradata/ORCLCDB/orclpdb1/undotbs01.dbf\n/u02/app/oracle/oradata/ORCLCDB/orclpdb1/users01.dbf\n/u02/app/oracle/oradata/ORCLCDB/orclpdb1/USR_UMMP.dbf\n\n\n-- \u521b\u5efa\u8868\u7a7a\u95f4\ncreate tablespace USR_FASYS datafile '/u02/app/oracle/oradata/ORCLCDB/orclpdb1/USR_FASYS.dbf' size 10000m;\n\n\n-- \u521b\u5efa\u7528\u6237\ncreate user USR_FASYS identified by \"mZJIgiwbQlZpHPDc\" default tablespace USR_FASYS;\n\n\n-- \u6388\u6743\ngrant resource,connect to USR_FASYS;\ngrant create any table to USR_FASYS;\ngrant select any table to USR_FASYS;\ngrant import full database to USR_FASYS;\ngrant unlimited tablespace to USR_FASYS;\n\n-- \u63d0\u4ea4\u4fee\u6539\ncommit;\n</code></pre>","tags":["oracle","database"]},{"location":"oracle/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/#_3","title":"\u94fe\u63a5\u6570\u636e\u5e93","text":"<pre><code>sqlplus USR_UMMP/HUx0_xRAxlp@localhost/PROD.local\n</code></pre>","tags":["oracle","database"]},{"location":"oracle/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/#sql","title":"\u5bfc\u5165sql\u6587\u4ef6","text":"<pre><code>sqlplus USR_UMMP/HUx0_xRAxlp@localhost/PROD.local\n</code></pre> <ul> <li>@\u6587\u4ef6\u5bfc\u5165</li> </ul> <pre><code>@data.sql\n</code></pre> <pre><code>commit;\n</code></pre>","tags":["oracle","database"]},{"location":"oracle/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/#_4","title":"\u67e5\u770b\u6240\u6709\u8868\u7a7a\u95f4","text":"<pre><code>select tablespace_name, sum(bytes)/1024/1024 from dba_data_files group by tablespace_name;\n</code></pre>","tags":["oracle","database"]},{"location":"oracle/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/#_5","title":"\u67e5\u770b\u8d26\u53f7\u6709\u6548\u671f\u914d\u7f6e","text":"<pre><code>select * from dba_profiles s where s.profile='DEFAULT' and resource_name='PASSWORD_LIFE_TIME';\n</code></pre> <ul> <li>\u8bbe\u7f6e\u5bc6\u7801\u6c38\u4e0d\u8fc7\u671f</li> </ul> <pre><code>ALTER PROFILE DEFAULT LIMIT PASSWORD_LIFE_TIME UNLIMITED;\n</code></pre>","tags":["oracle","database"]},{"location":"pgsql/note/","title":"Note","text":"","tags":["pgsql","postgresql","database"]},{"location":"pgsql/note/#1","title":"1. \u5e38\u7528\u547d\u4ee4","text":"<pre><code>-- \u767b\u5f55\u6570\u636e\u5e93\npsql -U postgres -d database_name -h serverhost\n</code></pre> <pre><code>-- \u5217\u51fa\u6570\u636e\u5e93\n\\l\n\n-- \u5217\u51fatablespace\n\\db\n\n-- \u5207\u6362\u6570\u636e\u5e93\n\\c database_name\n\n-- \u5217\u51fa\u5f53\u524d\u6570\u636e\u5e93\u7684\u6240\u6709\u8868\n\\d\n\n-- \u5217\u51fa\u6240\u6709\u7528\u6237\n\\du\n\n-- \u5f53\u524d\u603b\u5171\u6b63\u5728\u4f7f\u7528\u7684\u8fde\u63a5\u6570\nselect count(1) from pg_stat_activity;\n\n-- \u663e\u793a\u7cfb\u7edf\u5141\u8bb8\u7684\u6700\u5927\u8fde\u63a5\u6570\nshow max_connections;\n\n-- \u521b\u5efa\u6570\u636e\u5e93\nCREATE DATABASE dbname\n\n-- \u5220\u9664\u6570\u636e\u5e93\nDROP DATABASE dbname\n\n-- \u521b\u5efa\u65b0\u8d26\u6237\nCREATE USER demo WITH PASSWORD 'xxxxxx';\n\n-- \u521b\u5efa\u65b0\u6570\u636e\u5e93\u5e76\u5c06 OWNER \u8bbe\u7f6e\u4e3a\u65b0\u521b\u5efa\u7684\u5e10\u6237\nCREATE DATABASE $dbname OWNER $username;\n\n-- \u5c06\u7528\u6237\u8bbe\u7f6e\u4e3a\u6570\u636e\u5e93OWNER\nALTER DATABASE demo OWNER TO demo;\n\n-- \u7ed9\u65b0\u7528\u6237\u6388\u6743\nGRANT ALL PRIVILEGES ON DATABASE demo TO demo;\n\n-- \u5bfc\u5165\u6587\u4ef6\npsql -U $username -h 10.116.147.14 -d $dbname -f public.sql\n</code></pre> <ul> <li>\u521b\u5efa\u53ea\u8bfb\u7528\u6237</li> </ul> <pre><code>-- \u521b\u5efa\u65b0\u8d26\u6237\nCREATE USER data_governance_analysis WITH PASSWORD 'qqqqq';\n\n-- \u7ed9\u65b0\u7528\u6237\u6388\u6743\u53ea\u8bfb\u6a21\u5f0f\nalter user data_governance_analysis set default_transaction_read_only=on;\n-- \u5207\u6362\u5230\u5e93gra\n\\c gra\n-- \u8d4b\u6743select\u6743\u9650\ngrant select on all tables in schema public to data_governance_analysis;\n</code></pre> <ul> <li>\u547d\u4ee4\u884c\u5bfc\u5165sql\u6587\u4ef6</li> </ul> <pre><code>psql -d pias -U postgres -f /home/postgres/public.sql\n</code></pre> <ul> <li>\u5bfc\u51fa\u6570\u636e</li> </ul> <pre><code>pg_dump -p 5432 -U postgres -d gravity -t t_corona_org  -f t_corona_org.sql\n</code></pre>","tags":["pgsql","postgresql","database"]},{"location":"web/bootstrap/","title":"Bootstrap","text":"<p>https://getbootstrap.com/ </p>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/","title":"01 \u57fa\u7840","text":""},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#_1","title":"\u6807\u9898","text":"<pre><code>&lt;!--\u6807\u9898--&gt;\n&lt;h1&gt;This is title&lt;/h1&gt;\n</code></pre>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#_2","title":"\u659c\u4f53","text":"<pre><code>&lt;!--\u659c\u4f53--&gt;\n&lt;em&gt;This is title&lt;/em&gt;\n</code></pre>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#_3","title":"\u6bb5\u843d","text":"<pre><code>&lt;!--\u6bb5\u843d--&gt;\n&lt;p&gt;main page&lt;/p&gt;\n</code></pre>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#doc","title":"\u751f\u6210\u521d\u59cb\u5316doc\u9875\u9762","text":"<pre><code>&lt;!--\u751f\u6210doc\u9875\u9762\uff0c\u8f93\u5165doc\u7136\u540etab--&gt;\ndoc\n</code></pre>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#_4","title":"\u65e0\u5e8f\u5217\u8868","text":"<pre><code>&lt;!--\u65e0\u5e8f\u5217\u8868ul--&gt;\n    &lt;ul&gt;\n        &lt;li&gt;t1&lt;/li&gt;\n        &lt;li&gt;tables&lt;/li&gt;\n    &lt;/ul&gt;\n</code></pre>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#_5","title":"\u6709\u5e8f\u5217\u8868","text":"<pre><code>&lt;!--\u6709\u5e8f\u5217\u8868ol--&gt;\n&lt;ol&gt;\n    &lt;li&gt;1&lt;/li&gt;\n    &lt;li&gt;2&lt;/li&gt;\n    &lt;li&gt;3&lt;/li&gt;\n&lt;/ol&gt;\n</code></pre>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#divspan","title":"\u9875\u9762\u5206\u533adiv\uff0c\u5c0f\u578b\u5206\u533aspan","text":"<pre><code>&lt;!--\u9875\u9762\u5206\u533adiv\uff0c\u5c0f\u578b\u5206\u533aspan--&gt;\n    &lt;div style=\"color: crimson\"&gt;\n        &lt;p&gt;1&lt;/p&gt;\n        &lt;p&gt;2&lt;/p&gt;\n    &lt;/div&gt;\n    &lt;div&gt;\n        &lt;p&gt;sentence &lt;span style=\"color: brown\"&gt;three&lt;/span&gt;&lt;/p&gt;\n    &lt;/div&gt;\n</code></pre>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#_6","title":"\u56fe\u50cf","text":"<pre><code>&lt;!--\u56fe\u50cf--&gt;\n&lt;!--src\u4e3a\u56fe\u7247\u8def\u5f84+\u540d\u79f0\uff0calt\u4e3asrc\u5931\u6548\u662f\u663e\u793a\u7684\u5185\u5bb9\uff0c\u4e5f\u53ef\u4ee5\u662f\u53e6\u4e00\u5f20\u56fe\u7247--&gt;\n    &lt;img src=\"static/1 (13).jpg\" alt=\"\u79cb\u548c\u67ef\u57fa13.jpg\"&gt;\n\n&lt;!--\u951a\u6807\u8bb0\uff0c\u7528\u4e8e\u9875\u9762\u8df3\u8f6c\uff0c\u4f8b\u5982\u70b9\u51fb\u56fe\u7247\u8df3\u8f6c\u5230google--&gt;\n    &lt;a href=\"https://google.com\"&gt;\n        &lt;img src=\"static/1 (13).jpg\" alt=\"\u79cb\u548c\u67ef\u57fa13.jpg\"&gt;\n    &lt;/a&gt;\n</code></pre>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#_7","title":"\u8868\u683c","text":"<pre><code>&lt;!--\u8868\u683c--&gt;\n&lt;!--border\u8868\u683c\u8fb9\u6846--&gt;\n&lt;!--thead\u8868\u5934--&gt;\n&lt;!--th\u8868\u5934\u7684\u6bcf\u4e00\u5217--&gt;\n&lt;!--tr\u8868\u683c\u7684\u6bcf\u4e00\u884c--&gt;\n&lt;!--td\u6bcf\u4e00\u884c\u7684\u6bcf\u5217--&gt;\n&lt;table border=\"\"&gt;\n    &lt;thead&gt;\n        &lt;th&gt;col 1&lt;/th&gt;\n        &lt;th&gt;col 2&lt;/th&gt;\n        &lt;th&gt;col 3&lt;/th&gt;\n    &lt;/thead&gt;\n    &lt;tr&gt;\n        &lt;td&gt;entry 1&lt;/td&gt;\n        &lt;td&gt;entry 2&lt;/td&gt;\n        &lt;td&gt;entry 3&lt;/td&gt;\n    &lt;/tr&gt;\n&lt;/table&gt;\n</code></pre>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#form","title":"form\u8868\u5355","text":"<pre><code>&lt;!--form\u8868\u5355--&gt;\n&lt;!--1--&gt;\n&lt;form action=\"other.html\"&gt;\n    &lt;label for=\"uname\"&gt;Username:&lt;/label&gt;\n    &lt;input type=\"text\" name=\"uname\" id=\"uname\"&gt;&lt;br&gt;&lt;br&gt;\n\n    &lt;label for=\"passwd\"&gt;Password:&lt;/label&gt;\n    &lt;input type=\"text\" name=\"passwd\" id=\"passwd\"&gt;\n\n    &lt;br&gt;&lt;br&gt;\n    &lt;input type=\"submit\" value=\"\u63d0\u4ea4\"&gt;\n&lt;/form&gt;\n\n&lt;!--2\u8f93\u5165\u6846--&gt;\n&lt;form action=\"other.html\"&gt;\n    &lt;label for=\"email\"&gt;Email:&lt;/label&gt;\n    &lt;input type=\"email\" name=\"email\" id=\"email\" placeholder=\"You email\"&gt;&lt;br&gt;\n\n    &lt;label for=\"pw\"&gt;Password:&lt;/label&gt;\n    &lt;input type=\"password\" name=\"pw\" id=\"pw\"&gt;&lt;br&gt;\n\n    &lt;input type=\"submit\" value=\"\u767b\u5f55\"&gt;\n&lt;/form&gt;\n\n&lt;!--3.\u5355\u9009--&gt;\n&lt;h1&gt;Feedback&lt;/h1&gt;\n&lt;form action=\"other.html\"&gt;\n    &lt;p&gt;Are you from Inside or Outside China?&lt;/p&gt;\n    &lt;label for=\"in\"&gt;Inside:&lt;/label&gt;\n    &lt;input type=\"radio\" name=\"location\" id=\"in\" value=\"in\"&gt;&lt;br&gt;\n\n    &lt;label for=\"out\"&gt;Outside:&lt;/label&gt;\n    &lt;input type=\"radio\" name=\"location\" id=\"out\" value=\"out\"&gt;\n\n    &lt;br&gt;\n    &lt;input type=\"submit\" value=\"\u63d0\u4ea4\"&gt;\n&lt;/form&gt;\n\n&lt;!--4.\u4e0b\u62c9\u83dc\u5355--&gt;\n&lt;h1&gt;How wa your service?&lt;/h1&gt;\n&lt;form action=\"other.html\"&gt;\n    &lt;select name=\"stars\" id=\"\"&gt;\n        &lt;option value=\"Great\"&gt;3&lt;/option&gt;\n        &lt;option value=\"OK\"&gt;2&lt;/option&gt;\n        &lt;option value=\"Bad\"&gt;1&lt;/option&gt;\n    &lt;/select&gt;\n\n    &lt;br&gt;\n    &lt;input type=\"submit\" value=\"\u63d0\u4ea4\"&gt;\n&lt;/form&gt;\n\n&lt;!--5.\u6587\u672c\u533a\u57df--&gt;\n&lt;h1&gt;Any other Comments?&lt;/h1&gt;\n&lt;form action=\"other.html\"&gt;\n    &lt;label for=\"comments\"&gt;Please Input Your comments:&lt;/label&gt;&lt;br&gt;\n    &lt;textarea name=\"comments\" id=\"comments\" cols=\"30\" rows=\"10\"&gt;&lt;/textarea&gt;\n\n    &lt;br&gt;\n    &lt;input type=\"submit\" value=\"\u63d0\u4ea4\"&gt;\n&lt;/form&gt;\n</code></pre>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#css","title":"\u8fde\u63a5css\u6837\u5f0f\u8868","text":"<pre><code>&lt;!--link\u6807\u8bb0--&gt;\n&lt;html&gt;\n&lt;head&gt;\n    &lt;meta charset=\"UTF-8\"&gt;\n    &lt;meta name=\"viewport\" content=\"width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0\"&gt;\n    &lt;meta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\"&gt;\n    &lt;link rel=\"stylesheet\" href=\"static/css/master.css\"&gt;\n    &lt;title&gt;Document&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;h1&gt;Heading Here&lt;/h1&gt;\n    &lt;h2&gt;Heading Two&lt;/h2&gt;\n\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#css_1","title":"css\u7f16\u5199","text":"<p>.\u5f00\u5934\u8868\u793a\u81ea\u5b9a\u4e49class</p>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#idstyle","title":"\u5f00\u5934\u8868\u793a\u4e3a\u5bf9\u5e94id\u7684\u8d44\u6e90\u6307\u5b9astyle","text":"<p><pre><code>div{\n    color: orange;\n}\n.myclass{\n    color: red;\n}\n#one{\n    color: blue;\n}\n</code></pre> <pre><code>&lt;p id=\"one\"&gt;Outside a div&lt;/p&gt;\n\n&lt;div class=\"myclass\"&gt;\n    &lt;p&gt;Inside a div&lt;/p&gt;\n&lt;/div&gt;\n\n&lt;div&gt;\n    &lt;p&gt;Second div&lt;/p&gt;\n&lt;/div&gt;\n\n&lt;p id=\"two\" class=\"myclass\"&gt;Inside a div and this is a &lt;span&gt;span&lt;/span&gt;&lt;/p&gt;\n</code></pre></p>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#_8","title":"\u5b57\u4f53","text":"<p><pre><code>body{\n    font-family: Tahoma;\n    font-size: 90%;\n}\n\ndiv{\n    font-size: 16px;\n}\n\np{\n  font-size: 2em;\n}\n</code></pre> <pre><code>&lt;html&gt;\n&lt;head&gt;\n    &lt;meta charset=\"UTF-8\"&gt;\n    &lt;meta name=\"viewport\" content=\"width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0\"&gt;\n    &lt;meta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\"&gt;\n    &lt;link rel=\"stylesheet\" href=\"static/css/master.css\"&gt;\n    &lt;title&gt;Document&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n\n&lt;h1&gt;Welcome&lt;/h1&gt;\n    &lt;div class=\"stuff\"&gt;\n\n        &lt;p&gt;Text&lt;/p&gt;\n        &lt;p&gt;More&lt;/p&gt;\n\n    &lt;/div&gt;\n\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre></p>"},{"location":"web/html/01-%E5%9F%BA%E7%A1%80/#css-box-models","title":"css box models","text":"<p><pre><code>#up{\n    text-align: center;\n    border: 10px solid blue;\n    margin-bottom: 100px;\n    margin-left: 100px;\n}\n\n#down{\n    text-align: center;\n    border: 10px solid red;\n    padding-top: 20px;\n    padding-right: 40px;\n}\n</code></pre> <pre><code>&lt;html&gt;\n&lt;head&gt;\n    &lt;meta charset=\"UTF-8\"&gt;\n    &lt;meta name=\"viewport\" content=\"width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0\"&gt;\n    &lt;meta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\"&gt;\n    &lt;link rel=\"stylesheet\" href=\"static/css/master.css\"&gt;\n    &lt;title&gt;Document&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n\n    &lt;h1 id=\"up\"&gt;UP&lt;/h1&gt;\n    &lt;h2 id=\"down\"&gt;DOWN&lt;/h2&gt;\n\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre></p>"},{"location":"web/vue/","title":"vue","text":"","tags":["web","vue"]},{"location":"web/vue/#install","title":"install","text":"<pre><code># \u5b89\u88c5\u6700\u65b0\u7a33\u5b9a\u7248\nnpm init vue@latest\n\n# \u5b89\u88c5\u4f9d\u8d56\ncd vue-project\nnpm install\n\n# \u683c\u5f0f\u5316\u4ee3\u7801\nnpm run format\n\n# \u542f\u52a8\u5f00\u53d1\u670d\u52a1\u5668\nnpm run dev\n</code></pre>","tags":["web","vue"]},{"location":"windows/ubuntu-wsl/","title":"ubuntu wsl","text":"","tags":["os","win","wsl"]},{"location":"windows/ubuntu-wsl/#cloud-init","title":"cloud init","text":"","tags":["os","win","wsl"]},{"location":"windows/windows/","title":"Windows\u6587\u6863","text":"","tags":["os","win"]},{"location":"windows/windows/#win11","title":"\u5378\u8f7dwin11\u5de6\u4e0b\u89d2","text":"<pre><code>winget uninstall MicrosoftWindows.Client.WebExperience_cw5n1h2txyewy\n</code></pre>","tags":["os","win"]},{"location":"windows/windows/#windowsnetsh","title":"windows\u7f51\u7edc\u8f6c\u53d1netsh","text":"<pre><code># \u67e5\u770b\u5df2\u914d\u7f6e\u7684\u6240\u6709\u8f6c\u53d1\nnetsh interface portproxy show all\n\n# \u6dfb\u52a0\u8f6c\u53d1\uff0clisten\u5730\u5740+\u7aef\u53e3\u8f6c\u53d1\u5230connect\u5730\u5740+\u7aef\u53e3\nnetsh interface portproxy add v6tov4 listenport=80 listenaddress=2409:8a1e:70c2:4af0:41a1:144c:88aa:2441 connectaddress=192.168.182.50 connectport=80\nnetsh interface portproxy add v6tov4 listenport=443 listenaddress=2409:8a1e:70c2:4af0:41a1:144c:88aa:2441 connectaddress=192.168.182.50 connectport=443\n\n# \u67e5\u770b\u521a\u624d\u914d\u7f6e\u7684\u8f6c\u53d1\nnetsh interface portproxy show v6tov4\n\n# \u67e5\u770b\u672c\u673a\u76d1\u542c\u7aef\u53e3\uff0c\u8fc7\u6ee4\nnetstat -ano | findstr \":80\"\n\n# \u5220\u9664\u4e0a\u9762\u7684\u914d\u7f6e\nnetsh interface portproxy delete v6tov4 listenport=80 listenaddress=2409:8a1e:70c2:4af0:41a1:144c:88aa:2441\n</code></pre>","tags":["os","win"]}]}