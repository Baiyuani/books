# Kubernetes 存储体系架构

如下图所示，左边的 YAML 模板定义了一个 StatefulSet 的一个应用，其中定义了一个名为 disk-pvc 的 volume，挂载到 Pod 内部的目录是 /data。disk-pvc 是一个 PVC 类型的数据卷，其中定义了一个 storageClassName。

![img](https://edu.aliyun.com/files/course/2021/04-06/160543767619328163.png)

右图是数据卷挂载的过程，主要分为 6 步

- **第一步**：用户创建一个包含 PVC的 Pod；

 

- **第二步**：PV Controller 会不断观察 ApiServer，如果它发现一个 PVC 已经创建完毕但仍然是未绑定的状态，它就会试图把一个 PV 和 PVC 绑定；

 

PV Controller 首先会在集群内部找到一个适合的 PV 进行绑定，如果未找到相应的 PV，就调用 Volume Plugin 去做 Provision。Provision 就是从远端上一个具体的存储介质创建一个 Volume，并且在集群中创建一个 PV 对象，然后将此 PV 和 PVC 进行绑定；

 

- **第三步**：通过 Scheduler 完成一个调度功能。

 

我们知道，当一个 Pod 运行的时候，需要选择一个 Node，这个节点的选择就是由 Scheduler 来完成的。Scheduler 进行调度的时候会有多个参考量，比如 Pod 内部所定义的 nodeSelector、nodeAffinity 这些定义以及 Volume 中所定义的一些标签等。

 

我们可以在数据卷中添加一些标准，这样使用这个 pv 的 Pod 就会由于标签的限制，被调度器调度到期望的节点上。

 

- **第四步**：如果有一个 Pod 调度到某个节点之后，它所定义的 PV 还没有被挂载（Attach），此时 AD Controller 就会调用 VolumePlugin，把远端的 Volume 挂载到目标节点中的设备上（如：/dev/vdb）；

 

- **第五步：**当 Volum Manager 发现一个 Pod 调度到自己的节点上并且 Volume 已经完成了挂载，它就会执行 mount 操作，将本地设备（也就是刚才得到的 /dev/vdb）挂载到 Pod 在节点上的一个子目录中。同时它也可能会做一些像格式化、是否挂载到 GlobalPath 等这样的附加操作。

 

- **第六步**：绑定操作，就是将已经挂载到本地的 Volume 映射到容器中。



## Kubernetes 的存储架构



![img](https://edu.aliyun.com/files/course/2021/04-06/160617957718804316.png)

 

- **PV Controller**: 负责 PV/PVC 的绑定、生命周期管理，并根据需求进行数据卷的 Provision/Delete 操作；

 

- **AD Controller**： 负责存储设备的 Attach/Detach 操作，将设备挂载到目标节点；

 

- **Volume Manager**： 管理卷的 Mount/Unmount 操作、卷设备的格式化以及挂载到一些公用目录上的操作；

 

- **Volume Plugins**：它主要是对上面所有挂载功能的实现。

 

PV Controller、AD Controller、Volume Manager 主要是进行操作的调用，而具体操作则是由 Volume Plugins 实现的。

 

- **Scheduler**： 实现对 Pod 的调度能力，会根据一些存储相关的的定义去做一些存储相关的调度。

 

